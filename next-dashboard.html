<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایستگاه کار - نظام تندیس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Leaflet (for maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Cropper.js (for image cropping) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        body {
            font-family: 'Vazirmatn', 'Tahoma', sans-serif;
            background-color: #f8fafc;
        }
        .workstation-wrapper { display: flex; height: 100vh; max-height: 100vh; background-color: #ffffff; }
        #mainNavSidebar { width: 288px; background-color: #f1f5f9; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; transition: width 0.3s ease; }
        #mainContentArea { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #pageContent { flex-grow: 1; overflow-y: auto; padding: 1.5rem 2rem; }
        #pageContent::-webkit-scrollbar { width: 8px; }
        #pageContent::-webkit-scrollbar-track { background: #f1f5f9; }
        #pageContent::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 8px; }
        #pageContent::-webkit-scrollbar-thumb:hover { background: #64748b; }
        #advertisementSidebar { width: 288px; background-color: #f1f5f9; border-right: 1px solid #e2e8f0; transition: width 0.3s ease; }
        .main-nav-link { display: flex; align-items: center; padding: 0.875rem 1.25rem; border-radius: 0.5rem; color: #475569; font-weight: 600; transition: all 0.2s ease-in-out; border-right: 4px solid transparent; }
        .main-nav-link:hover { background-color: #e2e8f0; color: #1e293b; }
        .main-nav-link.active { background-color: #e0f2fe; color: #0c4a6e; border-right-color: #0ea5e9; }
        .main-nav-link i { margin-left: 0.75rem; width: 20px; text-align: center; }
        .stat-card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); display: flex; align-items: center; }
        .project-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .project-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); }
        .accordion-item { border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 1rem; overflow: hidden; }
        .accordion-header { background-color: #f8fafc; padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .accordion-header:hover { background-color: #f1f5f9; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; background-color: white; padding: 0 1.5rem; }
        .accordion-content.open { padding: 1.5rem; max-height: 3000px; transition: max-height 0.5s ease-in, padding 0.5s ease-in; }
        .accordion-icon { transition: transform 0.3s ease; }
        .accordion-header.open .accordion-icon { transform: rotate(180deg); }
        #slideshowContainer { position: relative; width: 100%; height: 200px; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        #slideshowContainer img { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: opacity 1s ease-in-out; }
        #slideshowContainer img.active { opacity: 1; }
        #slideshowNav { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .slide-nav-dot { width: 10px; height: 10px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s ease; }
        .slide-nav-dot.active { background-color: white; }
        .profile-field-group { margin-bottom: 1rem; }
        .profile-field-label { display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 0.25rem; }
        .profile-field-value { display: block; width: 100%; background-color: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.625rem 0.875rem; color: #1e293b; font-weight: 500; }
        .edit-mode-input { width: 100%; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.625rem 0.875rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .edit-mode-input:focus { border-color: #0ea5e9; background-color: white; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); outline: none; }
        .map-container { height: 220px; border-radius: 0.5rem; border: 1px solid #cbd5e1; }
        .content-view { display: none; }
        .content-view.active { display: block; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 48px; height: 48px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(15, 23, 42, 0.6); }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 2rem 2.5rem; border: none; width: 90%; max-width: 600px; border-radius: 0.75rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        #cropperContainer { width: 100%; height: 400px; overflow: hidden; background: #f1f1f1; }
        #cropperContainer img { max-width: 100%; height: auto; }
        .cropper-view-box { box-shadow: 0 0 0 1px #39f; border-radius: 50%; outline: 0; }
        .cropper-face { background-color: inherit !important; }
        .cropper-line, .cropper-point.point-n, .cropper-point.point-s, .cropper-point.point-e, .cropper-point.point-w { display: none; }
        @media (max-width: 1023px) { #mainNavSidebar, #advertisementSidebar { display: none; } }
    </style>
</head>
<body class="bg-slate-50">

    <div id="loadingModal" class="fixed inset-0 z-50 flex items-center justify-center" style="background-color: rgba(255, 255, 255, 0.9);">
        <div class="flex flex-col items-center bg-white p-8 rounded-xl shadow-2xl text-center">
            <div class="flex items-center justify-center mb-4">
                <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="Tandis Shahraavand Logo" class="h-16 w-16" onerror="this.onerror=null;this.src='https://placehold.co/64x64/1D4ED8/FFFFFF?text=T';">
                <div class="mr-4">
                    <h1 class="font-black text-3xl text-blue-700 text-center">نظام تندیس</h1>
                    <p class="font-extrabold pt-1 text-sm text-center" style="color: #CB9214;">تدارک نیازمندی دقیق و یکپارچه ساختمان</p>
                </div>
            </div>
            <div class="spinner my-4"></div>
            <p id="loadingModalText" class="text-lg font-semibold text-gray-700">در حال بارگذاری اطلاعات...</p>
        </div>
    </div>

    <div id="appContainer" class="workstation-wrapper hidden">
        <aside id="mainNavSidebar" class="p-5">
            <div class="text-center mb-8">
                <div id="profileImageContainer" class="relative w-32 h-32 mx-auto mb-3 group cursor-pointer">
                    <img id="userProfileImage" src="" alt="عکس پروفایل" class="w-full h-full object-cover rounded-full border-4 border-white shadow-lg">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-full">
                        <i class="fas fa-camera fa-lg"></i>
                        <span class="mr-2">تغییر عکس</span>
                    </div>
                </div>
                <h2 id="userProfileName" class="text-lg font-bold text-slate-800"></h2>
                <p id="userProfileRole" class="text-sm font-medium text-sky-600"></p>
            </div>
            <nav id="mainNav" class="flex flex-col space-y-2 flex-grow">
                <a href="#dashboard" data-view="dashboard" class="main-nav-link active"><i class="fas fa-tachometer-alt"></i><span>داشبورد</span></a>
                <a href="#profile" data-view="profile" class="main-nav-link"><i class="fas fa-user-circle"></i><span>پروفایل من</span></a>
            </nav>
            <div class="mt-auto border-t border-slate-300 pt-4 space-y-2">
                <a href="#settings" data-view="settings" class="main-nav-link"><i class="fas fa-cog"></i><span>تنظیمات</span></a>
                <a href="#" id="logoutButton" class="main-nav-link hover:bg-red-100 hover:text-red-700"><i class="fas fa-sign-out-alt"></i><span>خروج از حساب</span></a>
            </div>
        </aside>

        <main id="mainContentArea">
            <header class="p-4 border-b border-slate-200 bg-white flex justify-between items-center">
                <h1 id="pageTitle" class="text-xl font-bold text-slate-800">داشبورد</h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button class="text-slate-500 hover:text-sky-600"><i class="fas fa-bell"></i></button>
                    <button class="text-slate-500 hover:text-sky-600"><i class="fas fa-envelope"></i></button>
                </div>
            </header>
            <div id="pageContent">
                <div id="dashboard-view" class="content-view active">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                         <div class="stat-card">
                            <div class="p-4 bg-sky-100 text-sky-600 rounded-full"><i class="fas fa-briefcase fa-2x"></i></div>
                            <div class="mr-4"><p class="text-slate-500 text-sm">پروژه‌های فعال</p><p id="activeProjectsCount" class="text-2xl font-bold text-slate-800">0</p></div>
                        </div>
                        <div class="stat-card">
                            <div class="p-4 bg-green-100 text-green-600 rounded-full"><i class="fas fa-check-circle fa-2x"></i></div>
                            <div class="mr-4"><p class="text-slate-500 text-sm">پروژه‌های تکمیل شده</p><p id="completedProjectsCount" class="text-2xl font-bold text-slate-800">0</p></div>
                        </div>
                        <div class="stat-card">
                            <div class="p-4 bg-amber-100 text-amber-600 rounded-full"><i class="fas fa-file-signature fa-2x"></i></div>
                            <div class="mr-4"><p class="text-slate-500 text-sm">درخواست‌های جدید</p><p id="newRequestsCount" class="text-2xl font-bold text-slate-800">0</p></div>
                        </div>
                        <div class="stat-card">
                            <div class="p-4 bg-red-100 text-red-600 rounded-full"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
                            <div class="mr-4"><p class="text-slate-500 text-sm">هشدارهای مهم</p><p id="alertsCount" class="text-2xl font-bold text-slate-800">0</p></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-slate-700 mb-4">خلاصه پروژه‌ها</h2>
                        <div id="projectsContainer" class="space-y-4"></div>
                    </div>
                </div>
                <div id="profile-view" class="content-view"></div>
                <div id="settings-view" class="content-view">
                    <h2 class="text-lg font-semibold text-slate-700 mb-4">تنظیمات حساب کاربری</h2>
                    <p class="text-slate-500">این بخش برای تنظیمات اطلاع‌رسانی‌ها، تغییر رمز عبور و سایر موارد مربوط به حساب کاربری در آینده در نظر گرفته شده است.</p>
                </div>
            </div>
        </main>

        <aside id="advertisementSidebar" class="p-5 space-y-6">
            <div class="text-center">
                <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="لوگوی نظام تندیس" class="w-20 h-20 mx-auto mb-2" onerror="this.onerror=null;this.src='https://placehold.co/80x80/1D4ED8/FFFFFF?text=T';">
                <h3 class="text-lg font-bold text-slate-800">نظام تندیس</h3>
                <p class="text-xs text-slate-500">پلتفرم ارتباطی مهندسان و کارفرمایان</p>
            </div>
            <div id="slideshowContainer">
                 <div id="slideshowNav"></div>
            </div>
            <div class="text-center p-4 bg-white rounded-lg shadow-sm">
                <h4 class="font-semibold text-slate-700 mb-2">فرصت‌های ویژه</h4>
                <p class="text-sm text-slate-500">از آخرین آگهی‌ها و فرصت‌های شغلی در حوزه تخصصی خود مطلع شوید.</p>
                <button class="mt-3 w-full bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600 transition-colors">مشاهده آگهی‌ها</button>
            </div>
        </aside>
    </div>

    <!-- Cropper Modal -->
    <div id="cropperModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">برش و تنظیم عکس پروفایل</h3>
            <div id="cropperContainer">
                <img id="imageToCrop" src="">
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="cancelCropButton" class="py-2 px-4 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors text-sm font-bold">انصراف</button>
                <button id="cropButton" class="py-2 px-4 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors text-sm font-bold">برش و ذخیره</button>
            </div>
        </div>
    </div>
    <input type="file" id="profileImageInput" class="hidden" accept="image/*">

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwki2B837CsbVqmeHpX-yAt3dpq44A7KoGYQ-Pycuy8eye3lg9_I7s7q-kY-WsHAO5d/exec'; // <-- آدرس اسکریپت خود را اینجا قرار دهید

        // --- DOM Elements ---
        const loadingModal = document.getElementById('loadingModal');
        const loadingModalText = document.getElementById('loadingModalText');
        const appContainer = document.getElementById('appContainer');
        const pageTitle = document.getElementById('pageTitle');
        const userProfileImage = document.getElementById('userProfileImage');
        const profileImageContainer = document.getElementById('profileImageContainer');
        const profileImageInput = document.getElementById('profileImageInput');
        const userProfileName = document.getElementById('userProfileName');
        const userProfileRole = document.getElementById('userProfileRole');
        const mainNav = document.getElementById('mainNav');
        const contentViews = document.querySelectorAll('.content-view');
        const profileViewContainer = document.getElementById('profile-view');
        const projectsContainer = document.getElementById('projectsContainer');
        const activeProjectsCountEl = document.getElementById('activeProjectsCount');
        const completedProjectsCountEl = document.getElementById('completedProjectsCount');
        const newRequestsCountEl = document.getElementById('newRequestsCount');
        const alertsCountEl = document.getElementById('alertsCount');
        const slideshowContainer = document.getElementById('slideshowContainer');
        const slideshowNav = document.getElementById('slideshowNav');
        const cropperModal = document.getElementById('cropperModal');
        const imageToCrop = document.getElementById('imageToCrop');
        const cropButton = document.getElementById('cropButton');
        const cancelCropButton = document.getElementById('cancelCropButton');

        // --- State ---
        let currentUserEmail = '';
        let originalUserData = {}; 
        let slideshowInterval;
        let cropper;
        
        const slideshowImages = [
            'https://images.unsplash.com/photo-1581092921462-6839b3b896fd?w=600&auto=format&fit=crop',
            'https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=600&auto=format&fit=crop',
            'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=600&auto=format&fit=crop',
            'https://images.unsplash.com/photo-1606744443904-431c4a07373f?w=600&auto=format&fit=crop'
        ];
        let currentSlideIndex = 0;

        const mockProjects = [
            { title: 'پروژه مسکونی برج باغ', location: 'زعفرانیه، تهران', status: 'active', progress: 75, client: 'شرکت ساختمانی آرمان' },
            { title: 'مجتمع تجاری آرتمیس', location: 'فرمانیه، تهران', status: 'active', progress: 40, client: 'هلدینگ تجاری پاسارگاد' },
            { title: 'ویلا لواسان', location: 'لواسان، تهران', status: 'completed', progress: 100, client: 'شخصی' },
            { title: 'درخواست نظارت ساختمان', location: 'شهرک غرب، تهران', status: 'request', progress: 0, client: 'شخصی' }
        ];

        // --- Functions ---

        async function initializeWorkstation() {
            if (SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
                loadingModalText.innerHTML = 'خطا: آدرس گوگل اسکریپت تنظیم نشده است.';
                return;
            }
            const urlParams = new URLSearchParams(window.location.search);
            currentUserEmail = urlParams.get('email');
            if (!currentUserEmail) {
                loadingModalText.textContent = 'خطا: ایمیل کاربر مشخص نشده است. لطفاً دوباره وارد شوید.';
                return;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?func=getUserProfile&email=${encodeURIComponent(currentUserEmail)}`);
                if (!response.ok) throw new Error(`خطای شبکه: ${response.statusText}`);
                const result = await response.json();

                if (result.success && result.data) {
                    originalUserData = JSON.parse(JSON.stringify(result.data));
                    populateUserProfile(originalUserData);
                    populateDashboard(mockProjects);
                    populateProfileView(originalUserData);
                    initializeSlideshow();

                    appContainer.classList.remove('hidden');
                    loadingModal.style.display = 'none';
                } else {
                    throw new Error(result.message || 'خطا در دریافت اطلاعات پروفایل.');
                }
            } catch (error) {
                loadingModalText.textContent = `خطا در بارگذاری اطلاعات: ${error.message}`;
                console.error("Initialization failed:", error);
            }
        }

        function convertGoogleDriveUrl(url) {
            if (!url || !url.includes('drive.google.com')) return url;
            const fileId = url.match(/d\/(.+?)\//);
            if (fileId && fileId[1]) {
                return `https://drive.google.com/uc?export=view&id=${fileId[1]}`;
            }
            return url;
        }

        function populateUserProfile(data) {
            const profilePicUrl = data.personal["عکس پروفایل"];
            userProfileImage.src = convertGoogleDriveUrl(profilePicUrl) || 'https://placehold.co/128x128/EBF4FF/2196F3?text=User';
            userProfileName.textContent = `${data.personal["نام"] || ''} ${data.personal["نام خانوادگی"] || ''}`;
            userProfileRole.textContent = data.role || '';
        }

        function populateDashboard(projects) {
            let activeCount = 0, completedCount = 0, requestCount = 0;
            projectsContainer.innerHTML = '';
            projects.forEach(project => {
                if (project.status === 'active') activeCount++;
                else if (project.status === 'completed') completedCount++;
                else if (project.status === 'request') requestCount++;
                projectsContainer.appendChild(createProjectCard(project));
            });
            activeProjectsCountEl.textContent = activeCount;
            completedProjectsCountEl.textContent = completedCount;
            newRequestsCountEl.textContent = requestCount;
            alertsCountEl.textContent = 1;
        }

        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'project-card flex items-center p-4';
            let statusClass, statusText, iconClass;
            switch(project.status) {
                case 'active': statusClass = 'bg-sky-100 text-sky-700'; statusText = 'فعال'; iconClass = 'fas fa-tasks'; break;
                case 'completed': statusClass = 'bg-green-100 text-green-700'; statusText = 'تکمیل شده'; iconClass = 'fas fa-check-double'; break;
                case 'request': statusClass = 'bg-amber-100 text-amber-700'; statusText = 'درخواست جدید'; iconClass = 'fas fa-file-signature'; break;
            }
            card.innerHTML = `
                <div class="p-3 rounded-lg ${statusClass} ml-4"><i class="${iconClass} fa-lg"></i></div>
                <div class="flex-grow">
                    <h3 class="font-bold text-slate-800">${project.title}</h3>
                    <p class="text-sm text-slate-500">${project.client} - ${project.location}</p>
                </div>
                <div class="w-32 text-center mx-4">
                    <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="bg-sky-500 h-2.5 rounded-full" style="width: ${project.progress}%"></div></div>
                    <p class="text-xs text-slate-500 mt-1">${project.progress}% پیشرفت</p>
                </div>
                <div class="text-xs font-semibold py-1 px-3 rounded-full ${statusClass}">${statusText}</div>
                <button class="mr-4 text-slate-400 hover:text-slate-700"><i class="fas fa-ellipsis-v"></i></button>`;
            return card;
        }

        function populateProfileView(userData) {
            profileViewContainer.innerHTML = '';
            const { role, ...profileSections } = userData;
            for (const sectionKey in profileSections) {
                const sectionInfo = getPersianSectionInfo(sectionKey);
                const sectionData = profileSections[sectionKey];
                if (sectionData && Object.keys(sectionData).length > 0) {
                     profileViewContainer.appendChild(createAccordionItem(sectionInfo, sectionKey, sectionData, userData.role));
                }
            }
        }
        
        function getPersianSectionInfo(key) {
            const titles = { 
                personal: { title: 'مشخصات فردی', icon: 'fa-user' },
                contact: { title: 'اطلاعات تماس', icon: 'fa-address-card' },
                professional: { title: 'اطلاعات حرفه‌ای', icon: 'fa-briefcase' },
                documents: { title: 'مدارک بارگذاری شده', icon: 'fa-file-alt' }
            };
            return titles[key] || { title: key, icon: 'fa-info-circle' };
        }

        function createAccordionItem(sectionInfo, key, data, userRole) {
            const item = document.createElement('div');
            item.className = 'accordion-item';
            item.dataset.sectionKey = key;
            const isEditable = key !== 'documents';

            const editButtonHtml = isEditable 
                ? `<button data-action="edit" class="text-sm font-semibold text-sky-600 hover:text-sky-800 mr-4"><i class="fas fa-pencil-alt ml-2"></i>ویرایش</button>` 
                : '';

            item.innerHTML = `
                <div class="accordion-header">
                    <div class="flex items-center">
                        <i class="fas ${sectionInfo.icon} text-slate-500 ml-3"></i>
                        <span class="font-bold text-slate-700">${sectionInfo.title}</span>
                    </div>
                    <div class="flex items-center">
                        ${editButtonHtml}
                        <i class="fas fa-chevron-down accordion-icon"></i>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="data-container">
                        <!-- Content is generated dynamically -->
                    </div>
                    ${isEditable ? `
                    <div class="edit-buttons-container hidden mt-4 text-left">
                        <button data-action="cancel" class="py-2 px-4 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors text-sm font-bold">انصراف</button>
                        <button data-action="save" class="py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm font-bold mr-2">ذخیره تغییرات</button>
                    </div>` : ''}
                </div>`;
            
            const dataContainer = item.querySelector('.data-container');
            if (key === 'professional') {
                dataContainer.innerHTML = createProfessionalProfileView(data, userRole);
            } else {
                dataContainer.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-x-6');
                dataContainer.innerHTML = Object.entries(data)
                    .filter(([label]) => label !== "عکس پروفایل")
                    .map(([label, value]) => createProfileField(label, value, data)).join('');
            }

            return item;
        }

        function createProfileField(label, value, sectionData) {
            let fieldHtml = '';
            const isAddressField = label.toLowerCase().includes('آدرس');
            
            if (isAddressField) {
                 const mapId = `map-${label.replace(/[\s/()]/g, '-')}`;
                 const latKey = Object.keys(sectionData).find(k => k.toLowerCase().includes('lat')) || '';
                 const lngKey = Object.keys(sectionData).find(k => k.toLowerCase().includes('lng')) || '';
                 fieldHtml = `
                    <div class="profile-field-group md:col-span-2">
                        <label class="profile-field-label">${label}</label>
                        <div class="profile-field-value">${value || '---'}</div>
                        <div id="${mapId}" class="map-container mt-2" data-lat-key="${latKey}" data-lng-key="${lngKey}"></div>
                    </div>
                 `;
            } else if (label.toLowerCase().includes('پروانه') || label.toLowerCase().includes('کارت ملی') || label.toLowerCase().includes('رزومه')) {
                 fieldHtml = `
                    <div class="profile-field-group">
                        <label class="profile-field-label">${label}</label>
                        <div class="profile-field-value">
                            ${value ? `<a href="${value}" target="_blank" class="text-sky-600 hover:underline">مشاهده فایل</a>` : '---'}
                        </div>
                    </div>`;
            } else {
                fieldHtml = `
                    <div class="profile-field-group" data-label="${label}">
                        <label class="profile-field-label">${label}</label>
                        <div class="profile-field-value">${value || '---'}</div>
                    </div>`;
            }
            return fieldHtml;
        }

        function createProfessionalProfileView(data, userRole) {
            if (userRole === 'مهندس') {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6 pt-4">
                        <div class="profile-field-group" data-label="licenseFirstIssueDate"><label class="profile-field-label">تاریخ اولین صدور پروانه</label><div class="profile-field-value">${data.licenseFirstIssueDate || '---'}</div></div>
                        <div class="profile-field-group" data-label="licenseStartDate"><label class="profile-field-label">تاریخ شروع اعتبار پروانه</label><div class="profile-field-value">${data.licenseStartDate || '---'}</div></div>
                        <div class="profile-field-group" data-label="licenseValidity"><label class="profile-field-label">مدت اعتبار پروانه (سال)</label><div class="profile-field-value">${data.licenseValidity || '---'}</div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6 pt-6">
                        <div class="profile-field-group" data-label="licenseNumber"><label class="profile-field-label">شماره پروانه</label><div class="profile-field-value">${data.licenseNumber || '---'}</div></div>
                        <div class="profile-field-group" data-label="membershipNumber"><label class="profile-field-label">شماره عضویت</label><div class="profile-field-value">${data.membershipNumber || '---'}</div></div>
                        <div class="profile-field-group" data-label="licenseActivityProvince"><label class="profile-field-label">استان فعالیت پروانه</label><div class="profile-field-value">${data.licenseActivityProvince || '---'}</div></div>
                    </div>
                    <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-5">
                        <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
                            <label class="text-sm font-medium text-slate-700">پروانه طراحی</label>
                            <div class="profile-field-group" data-label="designLicenseGrade"><label class="profile-field-label text-xs">پایه</label><div class="profile-field-value">${data.designLicenseGrade || 'ندارد'}</div></div>
                            <div class="profile-field-group" data-label="designExecutorType"><label class="profile-field-label text-xs">نوع صلاحیت</label><div class="profile-field-value">${data.designExecutorType || '---'}</div></div>
                        </div>
                        <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
                            <label class="text-sm font-medium text-slate-700">پروانه نظارت</label>
                            <div class="profile-field-group" data-label="supervisionLicenseGrade"><label class="profile-field-label text-xs">پایه</label><div class="profile-field-value">${data.supervisionLicenseGrade || 'ندارد'}</div></div>
                            <div class="profile-field-group" data-label="supervisionExecutorType"><label class="profile-field-label text-xs">نوع صلاحیت</label><div class="profile-field-value">${data.supervisionExecutorType || '---'}</div></div>
                        </div>
                        <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
                            <label class="text-sm font-medium text-slate-700">پروانه اجرا</label>
                            <div class="profile-field-group" data-label="executionLicenseGrade"><label class="profile-field-label text-xs">پایه</label><div class="profile-field-value">${data.executionLicenseGrade || 'ندارد'}</div></div>
                            <div class="profile-field-group" data-label="executionExecutorType"><label class="profile-field-label text-xs">نوع صلاحیت</label><div class="profile-field-value">${data.executionExecutorType || '---'}</div></div>
                        </div>
                    </div>
                `;
            } else { // Employer view
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6 pt-4">
                        <div class="profile-field-group" data-label="employerCompanyName"><label class="profile-field-label">نام شرکت</label><div class="profile-field-value">${data.employerCompanyName || '---'}</div></div>
                        <div class="profile-field-group" data-label="employerCompanyRegNumber"><label class="profile-field-label">شماره ثبت شرکت</label><div class="profile-field-value">${data.employerCompanyRegNumber || '---'}</div></div>
                    </div>
                    <div class="profile-field-group md:col-span-2 mt-4" data-label="employerCompanyAddress">
                        <label class="profile-field-label">آدرس شرکت</label>
                        <div class="profile-field-value">${data.employerCompanyAddress || '---'}</div>
                        <div id="map-employerCompanyAddress" class="map-container mt-2"></div>
                    </div>
                `;
            }
        }
        
        function handleProfileViewClick(e) {
            const header = e.target.closest('.accordion-header');
            const editButton = e.target.closest('button[data-action="edit"]');
            const saveButton = e.target.closest('button[data-action="save"]');
            const cancelButton = e.target.closest('button[data-action="cancel"]');

            if (header && !editButton) toggleAccordion(header);
            else if (editButton) toggleEditMode(editButton.closest('.accordion-item'), true);
            else if (saveButton) saveProfileChanges(saveButton.closest('.accordion-item'));
            else if (cancelButton) toggleEditMode(cancelButton.closest('.accordion-item'), false, true);
        }

        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            header.classList.toggle('open');
            content.classList.toggle('open');
            if (header.classList.contains('open')) {
                const sectionKey = header.closest('.accordion-item').dataset.sectionKey;
                initializeProfileMaps(originalUserData, sectionKey);
            }
        }

        function toggleEditMode(accordionItem, isEditing, shouldRevert = false) {
            const dataContainer = accordionItem.querySelector('.data-container');
            const buttonsContainer = accordionItem.querySelector('.edit-buttons-container');
            const fieldGroups = dataContainer.querySelectorAll('.profile-field-group');
            const sectionKey = accordionItem.dataset.sectionKey;

            if (isEditing) {
                fieldGroups.forEach(group => {
                    const label = group.dataset.label;
                    if (!label) return;
                    const valueDiv = group.querySelector('.profile-field-value');
                    const currentValue = originalUserData[sectionKey][label] || '';
                    valueDiv.innerHTML = `<input type="text" class="edit-mode-input" data-original-value="${currentValue}" value="${currentValue}">`;
                });
                if(buttonsContainer) buttonsContainer.classList.remove('hidden');
            } else { 
                fieldGroups.forEach(group => {
                    const label = group.dataset.label;
                    if (!label) return;
                    const valueDiv = group.querySelector('.profile-field-value');
                    const input = valueDiv.querySelector('input');
                    if (input) {
                        valueDiv.textContent = shouldRevert ? input.dataset.originalValue : input.value;
                    }
                });
                if(buttonsContainer) buttonsContainer.classList.add('hidden');
            }
        }
        
        async function saveProfileChanges(accordionItem) {
            const sectionKey = accordionItem.dataset.sectionKey;
            const fieldGroups = accordionItem.querySelectorAll('.profile-field-group');
            const updatedSectionData = { ...originalUserData[sectionKey] };

            fieldGroups.forEach(group => {
                const label = group.dataset.label;
                const input = group.querySelector('input');
                if (input && label) {
                    updatedSectionData[label] = input.value;
                }
            });

            const saveButton = accordionItem.querySelector('button[data-action="save"]');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ذخیره...';

            try {
                const payload = {
                    action: 'updateSection',
                    email: currentUserEmail,
                    sectionKey: sectionKey,
                    sectionData: updatedSectionData
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                originalUserData[sectionKey] = updatedSectionData;
                toggleEditMode(accordionItem, false, false);
                alert('اطلاعات با موفقیت ذخیره شد.');

            } catch (error) {
                alert(`خطا در ذخیره اطلاعات: ${error.message}`);
                toggleEditMode(accordionItem, false, true);
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'ذخیره تغییرات';
            }
        }

        profileViewContainer.addEventListener('click', handleProfileViewClick);

        function handleNavClick(e) {
            e.preventDefault();
            const navLink = e.target.closest('.main-nav-link');
            if (!navLink) return;
            const viewName = navLink.dataset.view;
            document.querySelector('#mainNav .active, .mt-auto .active')?.classList.remove('active');
            navLink.classList.add('active');
            pageTitle.textContent = navLink.querySelector('span').textContent;
            contentViews.forEach(view => view.classList.toggle('active', view.id === `${viewName}-view`));
        }
        mainNav.parentElement.addEventListener('click', handleNavClick);

        function initializeSlideshow() {
            slideshowContainer.innerHTML = ''; 
            slideshowNav.innerHTML = '';
            
            slideshowImages.forEach((src, index) => {
                const img = document.createElement('img');
                img.src = src;
                img.alt = `تبلیغ ${index + 1}`;
                slideshowContainer.appendChild(img);

                const dot = document.createElement('div');
                dot.className = 'slide-nav-dot';
                dot.dataset.index = index;
                dot.addEventListener('click', () => {
                    showSlide(index);
                    resetSlideshowInterval();
                });
                slideshowNav.appendChild(dot);
            });
            showSlide(0);
            resetSlideshowInterval();
        }

        function showSlide(index) {
            const images = slideshowContainer.querySelectorAll('img');
            const dots = slideshowNav.querySelectorAll('.slide-nav-dot');
            
            images.forEach(img => img.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));

            currentSlideIndex = index;
            if(images[currentSlideIndex]) images[currentSlideIndex].classList.add('active');
            if(dots[currentSlideIndex]) dots[currentSlideIndex].classList.add('active');
        }

        function resetSlideshowInterval() {
            clearInterval(slideshowInterval);
            slideshowInterval = setInterval(() => {
                const nextIndex = (currentSlideIndex + 1) % slideshowImages.length;
                showSlide(nextIndex);
            }, 5000);
        }
        
        function initializeProfileMaps(userData, sectionToInit) {
            const addressFields = [
                { key: 'contact', label: 'آدرس', latKey: 'engineerResidentialLat', lngKey: 'engineerResidentialLng'},
                { key: 'professional', label: 'آدرس دفتر', latKey: 'officeMapLat', lngKey: 'officeMapLng'},
                { key: 'professional', label: 'آدرس دفتر شرکت', latKey: 'companyOfficeMapLat', lngKey: 'companyOfficeMapLng'}
            ];

            addressFields.forEach(field => {
                if (sectionToInit && field.key !== sectionToInit) return;

                const sectionData = userData[field.key];
                if (sectionData && sectionData[field.label]) {
                    const lat = parseFloat(sectionData[field.latKey]);
                    const lng = parseFloat(sectionData[field.lngKey]);
                    const mapId = `map-${field.label.replace(/[\s/()]/g, '-')}`;
                    const mapContainer = document.getElementById(mapId);
                    
                    if (mapContainer && !mapContainer._leaflet_id && !isNaN(lat) && !isNaN(lng)) {
                         const map = L.map(mapId).setView([lat, lng], 15);
                         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                         L.marker([lat, lng]).addTo(map);
                    }
                }
            });
        }
        
        // --- Cropper Logic ---
        profileImageContainer.addEventListener('click', () => {
            profileImageInput.click();
        });

        profileImageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = () => {
                    imageToCrop.src = reader.result;
                    cropperModal.style.display = 'block';
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1, viewMode: 1, background: false,
                        responsive: true, restore: true, checkOrientation: true,
                        modal: true, guides: true, center: true, highlight: false,
                        cropBoxMovable: true, cropBoxResizable: true, toggleDragModeOnDblclick: false,
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        cancelCropButton.addEventListener('click', () => {
            cropperModal.style.display = 'none';
            if(cropper) cropper.destroy();
            profileImageInput.value = '';
        });

        cropButton.addEventListener('click', () => {
            if (cropper) {
                cropButton.disabled = true;
                cropButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> در حال پردازش...';
                const canvas = cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' });
                canvas.toBlob((blob) => {
                    // Here you would upload the blob to your server/Google Script
                    // For now, we'll just display it locally
                    const imageUrl = URL.createObjectURL(blob);
                    userProfileImage.src = imageUrl;
                    
                    // Reset UI
                    cropperModal.style.display = 'none';
                    if(cropper) cropper.destroy();
                    profileImageInput.value = '';
                    cropButton.disabled = false;
                    cropButton.innerHTML = 'برش و ذخیره';
                    alert("عکس پروفایل به صورت محلی تغییر کرد. برای ذخیره دائمی، باید این عکس به سرور ارسال شود.");

                }, 'image/png');
            }
        });

        initializeWorkstation();
    });
    </script>
</body>
</html>
