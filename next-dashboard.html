<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایستگاه کاری - پروفایل کاربر</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Cropper.js for Image Editing -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f0f2f5;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0, 1, 0, 1);
        }
        .accordion-content.open {
            max-height: 4000px; /* Increased for potentially long forms */
            transition: max-height 1s ease-in-out;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .map-container { height: 300px; width: 100%; border-radius: 0.5rem; z-index: 1; }
        #image-to-crop { max-width: 100%; display: block; }
        
        /* Styles to match dashboard form */
        .profile-input, .profile-select, .profile-textarea {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.625rem 0.875rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            line-height: 1.5;
            width: 100%;
        }
        .profile-input:disabled, .profile-select:disabled, .profile-textarea:disabled {
            background-color: #f1f5f9;
            color: #64748b;
            cursor: not-allowed;
        }
        .profile-input:focus, .profile-select:focus, .profile-textarea:focus {
            border-color: #0ea5e9;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
            outline: none;
        }
        .cropper-view-box {
            box-shadow: 0 0 0 1px #39f;
            border-radius: 50%;
            outline: 0;
        }
        .cropper-face {
            background-color: inherit !important;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col p-4 fixed h-full right-0">
            <!-- Slideshow -->
            <div class="relative mb-4">
                <div id="slideshow-container">
                    <img src="https://placehold.co/600x400/334155/ffffff?text=تصویر+۱" class="w-full h-32 object-cover rounded-lg slideshow-image" data-index="0">
                    <img src="https://placehold.co/600x400/475569/ffffff?text=تصویر+۲" class="w-full h-32 object-cover rounded-lg slideshow-image hidden" data-index="1">
                    <img src="https://placehold.co/600x400/64748B/ffffff?text=تصویر+۳" class="w-full h-32 object-cover rounded-lg slideshow-image hidden" data-index="2">
                </div>
                <div id="slideshow-dots" class="absolute bottom-2 left-1/2 -translate-x-1/2 flex space-x-2">
                    <!-- Dots generated by JS -->
                </div>
            </div>

            <!-- User Info -->
            <div class="flex items-center mb-6">
                <img id="sidebar-profile-pic" src="https://placehold.co/100x100/94a3b8/ffffff?text=User" alt="عکس پروفایل" class="w-12 h-12 rounded-full ml-3 border-2 border-sky-400">
                <div>
                    <p id="sidebar-user-name" class="font-bold">نام کاربر</p>
                    <p id="sidebar-user-role" class="text-sm text-gray-400">نقش کاربر</p>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-grow">
                <a href="dashboard.html" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md transition-colors">
                    <i class="fa-solid fa-tachometer-alt w-6 text-center ml-3"></i>
                    داشبورد
                </a>
                <a href="#" class="flex items-center px-4 py-2 bg-gray-900 text-white rounded-md transition-colors">
                    <i class="fa-solid fa-user-tie w-6 text-center ml-3"></i>
                    ایستگاه کاری
                </a>
            </nav>

            <!-- Footer Menu -->
            <div>
                <a href="#" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md transition-colors">
                    <i class="fa-solid fa-cog w-6 text-center ml-3"></i>
                    تنظیمات
                </a>
                <a href="#" id="logout-button" class="flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md transition-colors">
                    <i class="fa-solid fa-sign-out-alt w-6 text-center ml-3"></i>
                    خروج از سیستم
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="mr-64 flex-1 p-8 overflow-y-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">ایستگاه کاری شما</h1>
            
            <div id="profile-accordion" class="space-y-4">

                <!-- Section 1: Personal Information -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <button class="accordion-header w-full text-right p-4 flex justify-between items-center font-semibold text-lg text-gray-700 hover:bg-gray-50">
                        <span><i class="fas fa-user-circle ml-3 text-indigo-500"></i>مشخصات فردی</span>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div class="accordion-content" data-section-key="personal">
                        <div class="p-6 border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Fields will be populated by JS, IDs must match registration form -->
                            <div>
                                <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">نام</label>
                                <input type="text" id="firstName" name="firstName" class="profile-input" disabled>
                            </div>
                            <div>
                                <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">نام خانوادگی</label>
                                <input type="text" id="lastName" name="lastName" class="profile-input" disabled>
                            </div>
                            <div>
                                <label for="nationalId" class="block text-sm font-medium text-gray-700 mb-1">کد ملی</label>
                                <input type="text" id="nationalId" name="nationalId" class="profile-input" disabled>
                            </div>
                             <div>
                                <label for="dob" class="block text-sm font-medium text-gray-700 mb-1">تاریخ تولد</label>
                                <input type="text" id="dob" name="dob" class="profile-input" disabled>
                            </div>
                             <div>
                                <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">جنسیت</label>
                                <input type="text" id="gender" name="gender" class="profile-input" disabled>
                            </div>
                             <div>
                                <label for="mobile" class="block text-sm font-medium text-gray-700 mb-1">تلفن موبایل</label>
                                <input type="tel" id="mobile" name="mobile" class="profile-input" disabled>
                            </div>
                        </div>
                        <div class="px-6 py-4 bg-gray-50 text-left">
                            <button class="edit-btn bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">ویرایش</button>
                            <button class="save-btn hidden bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">ذخیره</button>
                            <button class="cancel-btn hidden bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">انصراف</button>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Contact Information -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <button class="accordion-header w-full text-right p-4 flex justify-between items-center font-semibold text-lg text-gray-700 hover:bg-gray-50">
                        <span><i class="fas fa-map-marker-alt ml-3 text-green-500"></i>اطلاعات تماس و آدرس</span>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div class="accordion-content" data-section-key="contact">
                        <div class="p-6 border-t border-gray-200 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">شماره تلفن ثابت</label>
                                    <input type="tel" id="phone" name="phone" class="profile-input" disabled>
                                </div>
                                <div>
                                    <label for="postalCode" class="block text-sm font-medium text-gray-700 mb-1">کدپستی</label>
                                    <input type="text" id="postalCode" name="postalCode" class="profile-input" disabled>
                                </div>
                                <div>
                                    <label for="province" class="block text-sm font-medium text-gray-700 mb-1">استان سکونت</label>
                                    <input type="text" id="province" name="province" class="profile-input" disabled>
                                </div>
                                <div>
                                    <label for="city" class="block text-sm font-medium text-gray-700 mb-1">شهر سکونت</label>
                                    <input type="text" id="city" name="city" class="profile-input" disabled>
                                </div>
                            </div>
                            <div>
                                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">آدرس</label>
                                <textarea id="address" name="address" rows="3" class="profile-textarea" disabled></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">موقعیت مکانی شما روی نقشه</label>
                                <div id="map" class="map-container"></div>
                            </div>
                        </div>
                        <div class="px-6 py-4 bg-gray-50 text-left">
                           <button class="edit-btn bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">ویرایش</button>
                           <button class="save-btn hidden bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">ذخیره</button>
                           <button class="cancel-btn hidden bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">انصراف</button>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Professional Information -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <button class="accordion-header w-full text-right p-4 flex justify-between items-center font-semibold text-lg text-gray-700 hover:bg-gray-50">
                        <span><i class="fas fa-briefcase ml-3 text-yellow-500"></i>اطلاعات حرفه‌ای</span>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div class="accordion-content" data-section-key="professional">
                        <div class="p-6 border-t border-gray-200">
                            <!-- Engineer Specific Fields (IDs match engineerForm) -->
                            <div id="engineer-fields" class="hidden space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label for="licenseFirstIssueDate" class="block text-sm font-medium text-gray-700 mb-1">تاریخ اولین صدور پروانه</label>
                                        <input type="text" id="licenseFirstIssueDate" name="licenseFirstIssueDate" class="profile-input" disabled>
                                    </div>
                                    <div>
                                        <label for="licenseStartDate" class="block text-sm font-medium text-gray-700 mb-1">تاریخ شروع اعتبار</label>
                                        <input type="text" id="licenseStartDate" name="licenseStartDate" class="profile-input" disabled>
                                    </div>
                                    <div>
                                        <label for="licenseValidity" class="block text-sm font-medium text-gray-700 mb-1">مدت اعتبار (سال)</label>
                                        <input type="number" id="licenseValidity" name="licenseValidity" class="profile-input" disabled>
                                    </div>
                                    <div>
                                        <label for="licenseNumber" class="block text-sm font-medium text-gray-700 mb-1">شماره پروانه</label>
                                        <input type="text" id="licenseNumber" name="licenseNumber" class="profile-input" disabled>
                                    </div>
                                    <div>
                                        <label for="membershipNumber" class="block text-sm font-medium text-gray-700 mb-1">شماره عضویت</label>
                                        <input type="text" id="membershipNumber" name="membershipNumber" class="profile-input" disabled>
                                    </div>
                                    <div>
                                        <label for="licenseActivityProvince" class="block text-sm font-medium text-gray-700 mb-1">استان فعالیت</label>
                                        <input type="text" id="licenseActivityProvince" name="licenseActivityProvince" class="profile-input" disabled>
                                    </div>
                                </div>
                                <!-- Other engineer fields can be added here following the same pattern -->
                            </div>
                            <!-- Employer Specific Fields (IDs match employerForm) -->
                            <div id="employer-fields" class="hidden space-y-6">
                                 <div class="flex items-center mb-4">
                                    <input type="checkbox" id="employerHasCompany" name="employerHasCompany" class="h-4 w-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500 profile-input" disabled>
                                    <label for="employerHasCompany" class="mr-2 block text-sm text-gray-700">شرکت دارم (شخص حقوقی هستم)</label>
                                </div>
                                <div id="employerCompanyFields" class="space-y-6">
                                    <div>
                                        <label for="employerCompanyName" class="block text-sm font-medium text-gray-700 mb-1">نام شرکت</label>
                                        <input type="text" id="employerCompanyName" name="employerCompanyName" class="profile-input" disabled>
                                    </div>
                                    <div>
                                        <label for="employerCompanyRegNumber" class="block text-sm font-medium text-gray-700 mb-1">شماره ثبت شرکت</label>
                                        <input type="text" id="employerCompanyRegNumber" name="employerCompanyRegNumber" class="profile-input" disabled>
                                    </div>
                                     <div>
                                        <label for="employerCompanyAddress" class="block text-sm font-medium text-gray-700 mb-1">آدرس شرکت</label>
                                        <textarea id="employerCompanyAddress" name="employerCompanyAddress" rows="3" class="profile-textarea" disabled></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="px-6 py-4 bg-gray-50 text-left">
                            <button class="edit-btn bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">ویرایش</button>
                            <button class="save-btn hidden bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">ذخیره</button>
                            <button class="cancel-btn hidden bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">انصراف</button>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Profile Picture -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <button class="accordion-header w-full text-right p-4 flex justify-between items-center font-semibold text-lg text-gray-700 hover:bg-gray-50">
                        <span><i class="fas fa-camera-retro ml-3 text-red-500"></i>ویرایش عکس پروفایل</span>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </button>
                    <div class="accordion-content" data-section-key="picture">
                        <div class="p-6 border-t border-gray-200">
                            <div class="flex flex-col items-center">
                                <div class="w-48 h-48 rounded-full overflow-hidden bg-gray-200 mb-4 border-4 border-gray-300">
                                    <img id="profile-preview" src="https://placehold.co/200x200/e2e8f0/94a3b8?text=Profile+Pic" alt="پیش‌نمایش پروفایل" class="w-full h-full object-cover">
                                </div>
                                <input type="file" id="image-input" accept="image/*" class="hidden">
                                <button onclick="document.getElementById('image-input').click()" class="bg-indigo-500 text-white px-6 py-2 rounded-md hover:bg-indigo-600">انتخاب عکس جدید</button>
                                
                                <div id="cropper-container" class="mt-6 w-full hidden">
                                    <p class="text-center mb-2">عکس خود را برش دهید</p>
                                    <div class="max-w-md mx-auto bg-gray-100 p-2 rounded-lg">
                                        <img id="image-to-crop">
                                    </div>
                                    <div class="text-center mt-4">
                                        <button id="crop-and-save-button" class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600">برش و ذخیره</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Leaflet JS for Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- GLOBAL VARIABLES ---
            let map;
            let marker;
            let cropper;
            let originalUserData = {}; // To store the initial data for cancellation

            // --- INITIALIZATION ---
            function initializePage() {
                // Get user email from URL, which is needed for the backend call
                const urlParams = new URLSearchParams(window.location.search);
                const userEmail = urlParams.get('email');

                if (!userEmail) {
                    alert('خطا: ایمیل کاربر مشخص نشده است.');
                    return;
                }

                // In a real app, you would call the backend here
                showLoading(true);
                google.script.run
                    .withSuccessHandler(data => {
                        showLoading(false);
                        if(data.success) {
                            originalUserData = data.data; // Store the pristine data
                            populateAllData(originalUserData);
                        } else {
                            alert('خطا در دریافت اطلاعات: ' + data.message);
                        }
                    })
                    .withFailureHandler(error => {
                        showLoading(false);
                        alert('خطای سرور: ' + error.message);
                    })
                    .getUserProfile(userEmail);
                
                setupAccordion();
                setupSlideshow();
                setupEditButtons();
                setupImageCropper();
            }
            
            function showLoading(isLoading) {
                // You can implement a more sophisticated loading spinner here
                document.body.style.cursor = isLoading ? 'wait' : 'default';
            }

            // --- DATA POPULATION ---
            function populateAllData(userData) {
                if (!userData || !userData.stepsData) {
                    console.error("User data or stepsData is missing.");
                    return;
                }
                
                const role = userData.role;
                const step1 = userData.stepsData.step1 || {};
                const step2 = userData.stepsData.step2 || {};
                const step3 = userData.stepsData.step3 || {};
                const files = userData.files || {};
                
                const fullName = `${step1.firstName || ''} ${step1.lastName || ''}`.trim();

                // Populate sidebar
                document.getElementById('sidebar-user-name').textContent = fullName || 'کاربر';
                document.getElementById('sidebar-user-role').textContent = role === 'engineer' ? 'مهندس' : 'کارفرما';
                const profilePicUrl = files.applicantImage?.fileUrl || 'https://placehold.co/100x100/94a3b8/ffffff?text=User';
                document.getElementById('sidebar-profile-pic').src = profilePicUrl;
                document.getElementById('profile-preview').src = profilePicUrl;

                // Populate Section 1: Personal Info
                document.getElementById('firstName').value = step1.firstName || '';
                document.getElementById('lastName').value = step1.lastName || '';
                document.getElementById('nationalId').value = step1.nationalId || '';
                document.getElementById('dob').value = step1.dob || ''; // Assuming dob is stored directly
                document.getElementById('gender').value = step1.gender || '';
                document.getElementById('mobile').value = step1.mobile || '';

                // Populate Section 2: Contact Info
                document.getElementById('phone').value = step2.phone || '';
                document.getElementById('postalCode').value = step2.postalCode || '';
                document.getElementById('province').value = step2.province || '';
                document.getElementById('city').value = step2.city || '';
                document.getElementById('address').value = step2.address || '';
                
                // Initialize map with residential address coordinates
                const lat = step2.residentialLat || 35.6892; // Default to Tehran
                const lng = step2.residentialLng || 51.3890;
                initializeMap(lat, lng);

                // Populate Section 3: Professional Info based on role
                if (role === 'engineer') {
                    document.getElementById('engineer-fields').classList.remove('hidden');
                    document.getElementById('employer-fields').classList.add('hidden');
                    
                    document.getElementById('licenseFirstIssueDate').value = step3.licenseFirstIssueDate || '';
                    document.getElementById('licenseStartDate').value = step3.licenseStartDate || '';
                    document.getElementById('licenseValidity').value = step3.licenseValidity || '';
                    document.getElementById('licenseNumber').value = step3.licenseNumber || '';
                    document.getElementById('membershipNumber').value = step3.membershipNumber || '';
                    document.getElementById('licenseActivityProvince').value = step3.licenseActivityProvince || '';

                } else if (role === 'employer') {
                    document.getElementById('employer-fields').classList.remove('hidden');
                    document.getElementById('engineer-fields').classList.add('hidden');
                    
                    const hasCompany = step3.employerHasCompany || false;
                    const companyFieldsContainer = document.getElementById('employerCompanyFields');
                    document.getElementById('employerHasCompany').checked = hasCompany;
                    companyFieldsContainer.style.display = hasCompany ? 'block' : 'none';

                    document.getElementById('employerCompanyName').value = step3.employerCompanyName || '';
                    document.getElementById('employerCompanyRegNumber').value = step3.employerCompanyRegNumber || '';
                    document.getElementById('employerCompanyAddress').value = step3.employerCompanyAddress || '';
                }
            }
            
            // --- MAP LOGIC ---
            function initializeMap(lat, lng) {
                if (document.getElementById('map')._leaflet_id) return; // Already initialized
                
                map = L.map('map').setView([lat, lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);
                
                marker = L.marker([lat, lng], { draggable: true }).addTo(map)
                    .bindPopup('موقعیت شما')
                    .openPopup();
                
                marker.on('dragend', function(event){
                    var position = marker.getLatLng();
                    console.log(`New position: ${position.lat}, ${position.lng}`);
                    // In edit mode, you would update hidden input fields here
                });
            }

            // --- UI INTERACTIONS ---
            function setupAccordion() {
                const headers = document.querySelectorAll('.accordion-header');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('.fa-chevron-down');
                        
                        const isOpen = content.classList.contains('open');
                        
                        // Close all accordions
                        document.querySelectorAll('.accordion-content.open').forEach(openContent => {
                            openContent.classList.remove('open');
                            openContent.previousElementSibling.querySelector('.fa-chevron-down').classList.remove('rotate-180');
                        });
                        
                        // Toggle the clicked one
                        if (!isOpen) {
                            content.classList.add('open');
                            icon.classList.add('rotate-180');
                            if (content.contains(document.getElementById('map'))) {
                                setTimeout(() => map.invalidateSize(), 500);
                            }
                        }
                    });
                });
                if(headers.length > 0) headers[0].click();
            }
            
            function setupSlideshow() {
                const container = document.getElementById('slideshow-container');
                const images = container.querySelectorAll('.slideshow-image');
                const dotsContainer = document.getElementById('slideshow-dots');
                let currentIndex = 0;

                if (images.length === 0) return;

                images.forEach((_, index) => {
                    const dot = document.createElement('button');
                    dot.classList.add('w-3', 'h-3', 'rounded-full', 'bg-gray-400', 'opacity-50', 'hover:opacity-100', 'transition-opacity');
                    dot.addEventListener('click', () => showSlide(index));
                    dotsContainer.appendChild(dot);
                });

                const dots = dotsContainer.querySelectorAll('button');

                function showSlide(index) {
                    images[currentIndex].classList.add('hidden');
                    dots[currentIndex].classList.remove('opacity-100', 'bg-white');
                    dots[currentIndex].classList.add('opacity-50', 'bg-gray-400');
                    currentIndex = index;
                    images[currentIndex].classList.remove('hidden');
                    dots[currentIndex].classList.add('opacity-100', 'bg-white');
                    dots[currentIndex].classList.remove('opacity-50', 'bg-gray-400');
                }
                setInterval(() => showSlide((currentIndex + 1) % images.length), 5000);
                showSlide(0);
            }

            function setupEditButtons() {
                document.querySelectorAll('.accordion-content').forEach(section => {
                    const editBtn = section.querySelector('.edit-btn');
                    const saveBtn = section.querySelector('.save-btn');
                    const cancelBtn = section.querySelector('.cancel-btn');
                    const inputs = section.querySelectorAll('.profile-input, .profile-select, .profile-textarea');

                    editBtn.addEventListener('click', () => {
                        inputs.forEach(input => input.disabled = false);
                        editBtn.classList.add('hidden');
                        saveBtn.classList.remove('hidden');
                        cancelBtn.classList.remove('hidden');
                    });

                    cancelBtn.addEventListener('click', () => {
                        populateAllData(originalUserData); // Restore original data
                        inputs.forEach(input => input.disabled = true);
                        editBtn.classList.remove('hidden');
                        saveBtn.classList.add('hidden');
                        cancelBtn.classList.add('hidden');
                    });

                    saveBtn.addEventListener('click', () => {
                        const sectionKey = section.dataset.sectionKey;
                        const sectionData = {};
                        inputs.forEach(input => {
                            if (input.name) {
                                sectionData[input.name] = input.type === 'checkbox' ? input.checked : input.value;
                            }
                        });
                        
                        showLoading(true);
                        google.script.run
                            .withSuccessHandler(response => {
                                showLoading(false);
                                if(response.status === 'success') {
                                    alert('اطلاعات با موفقیت ذخیره شد.');
                                    // Update original data with new data
                                    originalUserData.stepsData[sectionKey] = sectionData;
                                    inputs.forEach(input => input.disabled = true);
                                    editBtn.classList.remove('hidden');
                                    saveBtn.classList.add('hidden');
                                    cancelBtn.classList.add('hidden');
                                } else {
                                    alert('خطا در ذخیره سازی: ' + response.message);
                                }
                            })
                            .withFailureHandler(error => {
                                showLoading(false);
                                alert('خطای سرور هنگام ذخیره سازی: ' + error.message);
                            })
                            .updateProfileSection({
                                email: new URLSearchParams(window.location.search).get('email'),
                                sectionKey: sectionKey,
                                sectionData: sectionData
                            });
                    });
                });
            }

            function setupImageCropper() {
                const imageInput = document.getElementById('image-input');
                const imageToCrop = document.getElementById('image-to-crop');
                const cropperContainer = document.getElementById('cropper-container');
                const cropButton = document.getElementById('crop-and-save-button');

                imageInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files && files.length > 0) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            imageToCrop.src = reader.result;
                            cropperContainer.classList.remove('hidden');
                            if (cropper) cropper.destroy();
                            cropper = new Cropper(imageToCrop, {
                                aspectRatio: 1,
                                viewMode: 1,
                                background: false,
                                modal: true,
                                guides: true,
                                center: true,
                                cropBoxMovable: true,
                                cropBoxResizable: true,
                            });
                        };
                        reader.readAsDataURL(files[0]);
                    }
                });

                cropButton.addEventListener('click', () => {
                    if (cropper) {
                        const canvas = cropper.getCroppedCanvas({ width: 256, height: 256 });
                        canvas.toBlob((blob) => {
                            const reader = new FileReader();
                            reader.readAsDataURL(blob); 
                            reader.onloadend = function() {
                                const base64data = reader.result;                
                                // Here you would call google.script.run to upload the base64data
                                console.log("Base64 image data ready to be sent to server.");
                                // For now, just update the preview
                                document.getElementById('profile-preview').src = base64data;
                                document.getElementById('sidebar-profile-pic').src = base64data;
                                cropperContainer.classList.add('hidden');
                                cropper.destroy();
                                alert('عکس پروفایل به‌روز شد (شبیه‌سازی).');
                            }
                        }, 'image/png');
                    }
                });
            }

            // --- Run Initialization ---
            initializePage();
        });
    </script>
</body>
</html>
