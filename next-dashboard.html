<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایستگاه کار - نظام تندیس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Leaflet (for maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Cropper.js (for image cropping) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- Persian Datepicker -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    <script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <style>
        body {
            font-family: 'Vazirmatn', 'Tahoma', sans-serif;
            background-color: #f8fafc;
        }
        .workstation-wrapper { display: flex; height: 100vh; max-height: 100vh; background-color: #ffffff; }
        #mainNavSidebar { width: 288px; background-color: #f1f5f9; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; transition: width 0.3s ease; }
        #mainContentArea { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #pageContent { flex-grow: 1; overflow-y: auto; padding: 1.5rem 2rem; }
        #pageContent::-webkit-scrollbar { width: 8px; }
        #pageContent::-webkit-scrollbar-track { background: #f1f5f9; }
        #pageContent::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 8px; }
        #pageContent::-webkit-scrollbar-thumb:hover { background: #64748b; }
        #advertisementSidebar { width: 288px; background-color: #f1f5f9; border-right: 1px solid #e2e8f0; transition: width 0.3s ease; }
        .main-nav-link { display: flex; align-items: center; padding: 0.875rem 1.25rem; border-radius: 0.5rem; color: #475569; font-weight: 600; transition: all 0.2s ease-in-out; border-right: 4px solid transparent; }
        .main-nav-link:hover { background-color: #e2e8f0; color: #1e293b; }
        .main-nav-link.active { background-color: #e0f2fe; color: #0c4a6e; border-right-color: #0ea5e9; }
        .main-nav-link i { margin-left: 0.75rem; width: 20px; text-align: center; }
        #slideshowContainer { position: relative; width: 100%; height: 200px; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        #slideshowContainer img { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: opacity 1s ease-in-out; }
        #slideshowContainer img.active { opacity: 1; }
        #slideshowNav { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10; }
        .slide-nav-dot { width: 10px; height: 10px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s ease; border: 1px solid rgba(0,0,0,0.2); }
        .slide-nav-dot.active { background-color: white; }
        
        .content-view { display: none; }
        .content-view.active { display: block; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 48px; height: 48px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(15, 23, 42, 0.6); }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 2rem 2.5rem; border: none; width: 90%; max-width: 600px; border-radius: 0.75rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        #cropperContainer { width: 100%; height: 400px; overflow: hidden; background: #f1f1f1; }
        #cropperContainer img { max-width: 100%; height: auto; }
        
        /* --- Profile Form Styles --- */
        .profile-form-step { display: none; }
        .profile-form-step.active { display: block; }
        .profile-step-indicator { display: flex; align-items: center; padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s ease; }
        .profile-step-indicator:hover { background-color: #e2e8f0; }
        .profile-step-indicator.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: 600; }
        .profile-step-indicator .step-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #cbd5e1; color: #475569; margin-left: 0.75rem; }
        .profile-step-indicator.active .step-icon { background-color: #0ea5e9; color: white; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn-primary { background-color: #0ea5e9; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #0284c7; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #059669; }
        .btn-secondary { background-color: #e2e8f0; color: #1e293b; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        #profileForm input, #profileForm select, #profileForm textarea { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.625rem 0.875rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        #profileForm input:focus, #profileForm select:focus, #profileForm textarea:focus { border-color: #0ea5e9; background-color: white; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); outline: none; }
        #profileForm input:disabled, #profileForm select:disabled, #profileForm textarea:disabled { background-color: #e2e8f0; cursor: not-allowed; color: #64748b; border-color: #e2e8f0; }
        .map-container { height: 220px; border-radius: 0.5rem; border: 1px solid #cbd5e1; z-index: 1; }
        @media (max-width: 1023px) { #mainNavSidebar, #advertisementSidebar { display: none; } }
    </style>
</head>
<body class="bg-slate-50">

    <div id="loadingModal" class="fixed inset-0 z-50 flex items-center justify-center" style="background-color: rgba(255, 255, 255, 0.9);">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <p id="loadingModalText" class="text-lg font-semibold text-gray-700 mt-4">در حال بارگذاری اطلاعات...</p>
        </div>
    </div>

    <div id="appContainer" class="workstation-wrapper hidden">
        <aside id="mainNavSidebar" class="p-5">
            <div class="text-center mb-8">
                <div id="profileImageContainer" class="relative w-32 h-32 mx-auto mb-3 group cursor-pointer">
                    <img id="userProfileImage" src="https://placehold.co/128x128/EBF4FF/2196F3?text=User" alt="عکس پروفایل" class="w-full h-full object-cover rounded-full border-4 border-white shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/128x128/EBF4FF/2196F3?text=Error';">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-full">
                        <i class="fas fa-camera fa-lg"></i>
                        <span class="mr-2">تغییر عکس</span>
                    </div>
                </div>
                <h2 id="userProfileName" class="text-lg font-bold text-slate-800"></h2>
                <p id="userProfileRole" class="text-sm font-medium text-sky-600"></p>
            </div>
            <nav id="mainNav" class="flex flex-col space-y-2 flex-grow">
                <a href="#dashboard" data-view="dashboard" class="main-nav-link active"><i class="fas fa-tachometer-alt"></i><span>داشبورد</span></a>
                <a href="#profile" data-view="profile" class="main-nav-link"><i class="fas fa-user-circle"></i><span>پروفایل من</span></a>
            </nav>
            <div class="mt-auto border-t border-slate-300 pt-4 space-y-2">
                <a href="#settings" data-view="settings" class="main-nav-link"><i class="fas fa-cog"></i><span>تنظیمات</span></a>
                <a href="#" id="logoutButton" class="main-nav-link hover:bg-red-100 hover:text-red-700"><i class="fas fa-sign-out-alt"></i><span>خروج از حساب</span></a>
            </div>
        </aside>

        <main id="mainContentArea">
            <header class="p-4 border-b border-slate-200 bg-white flex justify-between items-center">
                <h1 id="pageTitle" class="text-xl font-bold text-slate-800">داشبورد</h1>
            </header>
            <div id="pageContent">
                <div id="dashboard-view" class="content-view active">
                    <!-- Dashboard content will be here -->
                </div>
                
                <div id="profile-view" class="content-view">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">پروفایل کاربری</h2>
                        <div>
                            <button id="editProfileButton" class="btn btn-primary"><i class="fas fa-edit"></i> ویرایش اطلاعات</button>
                            <button id="saveProfileButton" class="btn btn-success hidden"><i class="fas fa-save"></i> ذخیره تغییرات</button>
                            <button id="cancelEditButton" class="btn btn-secondary hidden ml-2"><i class="fas fa-times"></i> انصراف</button>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8">
                        <div id="profileStepsNav" class="w-full lg:w-1/4">
                            <!-- Step indicators will be populated by JS -->
                        </div>
                        
                        <div class="flex-grow">
                            <form id="profileForm">
                                <!-- Form steps will be populated by JS -->
                            </form>
                        </div>
                    </div>
                </div>

                <div id="settings-view" class="content-view">
                    <h2 class="text-lg font-semibold text-slate-700 mb-4">تنظیمات</h2>
                </div>
            </div>
        </main>

        <aside id="advertisementSidebar" class="p-5 space-y-6">
            <!-- Ads sidebar content -->
        </aside>
    </div>

    <div id="cropperModal" class="modal">
        <!-- Cropper modal content -->
    </div>
    <input type="file" id="profileImageInput" class="hidden" accept="image/*">

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwURZkNTH6OZ78JqPWXqOBeAdWsgrj2lhPn16Yn0jdJ537qCioVAsofUJrbV6qvvG0N/exec';

        // --- DOM Elements ---
        const loadingModal = document.getElementById('loadingModal');
        const appContainer = document.getElementById('appContainer');
        const userProfileImage = document.getElementById('userProfileImage');
        const userProfileName = document.getElementById('userProfileName');
        const userProfileRole = document.getElementById('userProfileRole');
        const mainNav = document.getElementById('mainNav');
        const contentViews = document.querySelectorAll('.content-view');
        const editProfileButton = document.getElementById('editProfileButton');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const profileForm = document.getElementById('profileForm');
        const profileStepsNav = document.getElementById('profileStepsNav');
        
        // --- State ---
        let currentUserEmail = '';
        let originalUserData = {};
        let isEditMode = false;
        let currentProfileStep = 1;
        let maps = {};

        // --- INITIALIZATION ---
        async function initializeWorkstation() {
            loadingModal.style.display = 'flex';
            const urlParams = new URLSearchParams(window.location.search);
            currentUserEmail = urlParams.get('email');
            if (!currentUserEmail) {
                loadingModal.innerHTML = '<p>خطا: ایمیل کاربر مشخص نشده است.</p>';
                return;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?func=getUserProfile&email=${encodeURIComponent(currentUserEmail)}`);
                const result = await response.json();

                if (result.status === "success" && result.data?.stepsData?.step1) {
                    originalUserData = result.data;
                    populateStaticInfo(originalUserData);
                    buildProfileForm(originalUserData);
                    populateProfileForm(originalUserData);
                    setFormEditState(false);
                    appContainer.classList.remove('hidden');
                } else {
                    throw new Error(result.message || 'پاسخ سرور معتبر نیست یا اطلاعات پروفایل یافت نشد.');
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                loadingModal.innerHTML = `<p>خطا در بارگذاری اطلاعات: ${error.message}</p>`;
            } finally {
                loadingModal.style.display = 'none';
            }
        }

        function populateStaticInfo(data) {
            const profilePicUrl = data.files?.applicantImage?.fileUrl;
            userProfileImage.src = convertGoogleDriveUrl(profilePicUrl) || 'https://placehold.co/128x128/EBF4FF/2196F3?text=User';
            const firstName = data.stepsData?.step1?.engineerFirstName || data.stepsData?.step1?.employerFirstName || '';
            const lastName = data.stepsData?.step1?.engineerLastName || data.stepsData?.step1?.employerLastName || '';
            userProfileName.textContent = `${firstName} ${lastName}`;
            userProfileRole.textContent = data.role === 'engineer' ? 'مهندس' : 'کارفرما';
        }

        // --- PROFILE FORM BUILDING & MANAGEMENT ---
        function buildProfileForm(data) {
            const role = data.role;
            const stepDefs = getStepDefinitions(role);

            profileStepsNav.innerHTML = '';
            profileForm.innerHTML = '';

            stepDefs.forEach(step => {
                const indicator = document.createElement('div');
                indicator.className = 'profile-step-indicator';
                indicator.dataset.step = step.id;
                indicator.innerHTML = `<div class="step-icon"><i class="fas ${step.icon}"></i></div><span>${step.label}</span>`;
                indicator.addEventListener('click', () => showProfileStep(step.id));
                profileStepsNav.appendChild(indicator);

                const stepContainer = document.createElement('div');
                stepContainer.id = `profile-step-${step.id}`;
                stepContainer.className = 'profile-form-step';
                stepContainer.innerHTML = step.contentHtml;
                profileForm.appendChild(stepContainer);
            });
            
            initializeDatePickers('#profileForm');
            showProfileStep(1);
        }

        function showProfileStep(stepId) {
            currentProfileStep = stepId;
            document.querySelectorAll('.profile-form-step').forEach(s => s.classList.remove('active'));
            document.getElementById(`profile-step-${stepId}`).classList.add('active');

            document.querySelectorAll('.profile-step-indicator').forEach(ind => {
                ind.classList.toggle('active', parseInt(ind.dataset.step) === stepId);
            });
            
            initializeMapsForSection(stepId, originalUserData.role);
        }

        function populateProfileForm(data) {
            const role = data.role;
            const prefix = role === 'engineer' ? 'engineer' : 'employer';
            
            // Populate all fields based on originalUserData
            // Step 1
            const step1 = data.stepsData?.step1 || {};
            setInputValue(`profile-${prefix}FirstName`, step1.engineerFirstName || step1.employerFirstName);
            setInputValue(`profile-${prefix}LastName`, step1.engineerLastName || step1.employerLastName);
            setInputValue(`profile-${prefix}NationalId`, step1.engineerNationalId || step1.employerNationalId);
            setInputValue(`profile-${prefix}Dob`, step1.engineerDob || step1.employerDob, true);
            setInputValue(`profile-${prefix}Gender`, step1.engineerGender || step1.employerGender);
            setInputValue(`profile-${prefix}Mobile`, step1.engineerMobile || step1.employerMobile);

            // Step 2
            const step2 = data.stepsData?.step2 || {};
            setInputValue(`profile-${prefix}Phone`, step2.engineerPhone || step2.employerPhone);
            setInputValue(`profile-${prefix}PostalCode`, step2.engineerPostalCode || step2.employerPostalCode);
            setInputValue(`profile-${prefix}Province`, step2.engineerProvince || step2.employerProvince);
            setInputValue(`profile-${prefix}City`, step2.engineerCity || step2.employerCity);
            setInputValue(`profile-${prefix}ResidentialAddress`, step2.engineerResidentialAddress || step2.employerAddress);
            setInputValue(`profile-${prefix}ResidentialLat`, step2.engineerResidentialLat || step2.employerAddressLat);
            setInputValue(`profile-${prefix}ResidentialLng`, step2.engineerResidentialLng || step2.employerAddressLng);

            // Step 3
            const step3 = data.stepsData?.step3 || {};
            if (role === 'engineer') {
                setInputValue('profile-licenseFirstIssueDate', step3.licenseFirstIssueDate, true);
                setInputValue('profile-licenseStartDate', step3.licenseStartDate, true);
                setInputValue('profile-licenseValidity', step3.licenseValidity);
                setInputValue('profile-licenseNumber', step3.licenseNumber);
                setInputValue('profile-membershipNumber', step3.membershipNumber);
                setInputValue('profile-licenseActivityProvince', step3.licenseActivityProvince);
                setInputValue('profile-hasDesignLicense', step3.hasDesignLicense);
                setInputValue('profile-designLicenseGrade', step3.designLicenseGrade);
                setInputValue('profile-designExecutorType', step3.designExecutorType);
                // ... and so on for all engineer fields
            } else {
                setInputValue('profile-employerHasCompany', step3.employerHasCompany);
                setInputValue('profile-employerCompanyName', step3.employerCompanyName);
                setInputValue('profile-employerCompanyRegNumber', step3.employerCompanyRegNumber);
                setInputValue('profile-employerCompanyAddress', step3.employerCompanyAddress);
                setInputValue('profile-employerCompanyAddressLat', step3.employerCompanyAddressLat);
                setInputValue('profile-employerCompanyAddressLng', step3.employerCompanyAddressLng);
            }
            
            // Step 4
            const docContainer = document.getElementById('profile-step-4')?.querySelector('.document-links');
            if (docContainer) {
                docContainer.innerHTML = '';
                const files = data.files || {};
                const fileKeys = role === 'engineer' 
                    ? { workPermitPdf: 'پروانه اشتغال', nationalIdCardImageEngineer: 'کارت ملی' }
                    : { employerNationalIdCardImage: 'کارت ملی', employerOtherDocs: 'رزومه' };
                
                for (const key in fileKeys) {
                    if (files[key]?.fileUrl) {
                        const link = document.createElement('a');
                        link.href = files[key].fileUrl;
                        link.target = '_blank';
                        link.className = 'text-sky-600 hover:underline block mb-2';
                        link.textContent = `مشاهده ${fileKeys[key]}`;
                        docContainer.appendChild(link);
                    }
                }
            }
        }
        
        function setFormEditState(isEditing) {
            isEditMode = isEditing;
            profileForm.querySelectorAll('input, select, textarea').forEach(el => {
                el.disabled = !isEditing;
            });
            editProfileButton.classList.toggle('hidden', isEditing);
            saveProfileButton.classList.toggle('hidden', !isEditing);
            cancelEditButton.classList.toggle('hidden', !isEditing);
        }

        editProfileButton.addEventListener('click', () => setFormEditState(true));
        cancelEditButton.addEventListener('click', () => {
            populateProfileForm(originalUserData);
            setFormEditState(false);
        });
        saveProfileButton.addEventListener('click', saveProfileChanges);
        
        async function saveProfileChanges() {
            const updatedStepsData = collectFormData();
            
            const payload = {
                action: 'updateFullProfile',
                email: currentUserEmail,
                stepsData: updatedStepsData
            };
            
            saveProfileButton.disabled = true;
            saveProfileButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ذخیره سازی...';

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'خطا در سرور');
                
                originalUserData.stepsData = updatedStepsData;
                setFormEditState(false);
                alert('تغییرات با موفقیت ذخیره شد.');

            } catch (error) {
                alert(`خطا در ذخیره سازی: ${error.message}`);
            } finally {
                saveProfileButton.disabled = false;
                saveProfileButton.innerHTML = '<i class="fas fa-save"></i> ذخیره تغییرات';
            }
        }
        
        function collectFormData() {
            const data = { step1: {}, step2: {}, step3: {}, step4: {} };
            const role = originalUserData.role;
            const prefix = role === 'engineer' ? 'engineer' : 'employer';

            // Step 1
            data.step1[`${prefix}FirstName`] = getInputValue(`profile-${prefix}FirstName`);
            data.step1[`${prefix}LastName`] = getInputValue(`profile-${prefix}LastName`);
            // ... collect all other fields for all steps
            
            return data;
        }

        // --- HELPERS ---
        function setInputValue(id, value, isDate = false) {
            const el = document.getElementById(id);
            if (el) {
                if (el.type === 'checkbox') {
                    el.checked = !!value;
                } else if (el.type === 'radio') {
                    const radioGroup = document.querySelectorAll(`input[name="${el.name}"]`);
                    radioGroup.forEach(r => r.checked = (r.value === value));
                } else if (isDate && value) {
                    // For date pickers, set both display and hidden value
                    const displayInput = $(`#${id}`);
                    const valueInput = displayInput.next('.jalali-datepicker-value');
                    displayInput.val(new persianDate(new Date(value)).format('YYYY/MM/DD'));
                    valueInput.val(value);
                }
                else {
                    el.value = value || '';
                }
            }
        }
        function getInputValue(id, isDate = false) {
            const el = document.getElementById(id);
            if (el) {
                if (el.type === 'checkbox') return el.checked;
                if (isDate) return $(el).next('.jalali-datepicker-value').val();
                return el.value;
            }
            return null;
        }
        function convertGoogleDriveUrl(url) {
            if (!url || typeof url !== 'string' || !url.includes('drive.google.com')) return url;
            const fileIdMatch = url.match(/(?:d\/|id=)([-\w]{25,})/);
            if (fileIdMatch && fileIdMatch[1]) return `https://drive.google.com/uc?export=view&id=${fileIdMatch[1]}`;
            return url;
        }
        
        function getStepDefinitions(role) {
            const prefix = role === 'engineer' ? 'engineer' : 'employer';
            // This function will return the full HTML for each step, mirroring dashboard.html
            // For brevity, this is a simplified version. The actual implementation needs the full fieldset.
            const commonStep1 = `<h3 class="font-bold text-lg mb-4">مشخصات فردی</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">نام</label><input type="text" id="profile-${prefix}FirstName" name="engineerFirstName"></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">نام خانوادگی</label><input type="text" id="profile-${prefix}LastName" name="engineerLastName"></div>
                <!-- ... other step 1 fields ... -->
            </div>`;
            const commonStep2 = `<h3 class="font-bold text-lg mb-4">اطلاعات تماس</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div><label class="block text-sm font-medium text-slate-700 mb-1">تلفن ثابت</label><input type="tel" id="profile-${prefix}Phone" name="engineerPhone"></div>
                 <div class="md:col-span-2"><div id="map-profile-residential" class="map-container"></div></div>
            </div>`;
            const engineerStep3 = `<h3 class="font-bold text-lg mb-4">اطلاعات حرفه‌ای</h3><!-- ... engineer fields ... -->`;
            const employerStep3 = `<h3 class="font-bold text-lg mb-4">اطلاعات شرکت</h3><!-- ... employer fields ... -->`;
            const step4 = `<h3 class="font-bold text-lg mb-4">مدارک</h3><div class="document-links"></div><div class="mt-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">آپلود فایل جدید (در صورت نیاز)</label>
                <input type="file" id="profile-new-doc" class="w-full"></div>`;

            if (role === 'engineer') {
                return [
                    { id: 1, icon: 'fa-user', label: 'مشخصات فردی', contentHtml: commonStep1 },
                    { id: 2, icon: 'fa-map-marker-alt', label: 'اطلاعات تماس', contentHtml: commonStep2 },
                    { id: 3, icon: 'fa-id-card', label: 'اطلاعات حرفه‌ای', contentHtml: engineerStep3 },
                    { id: 4, icon: 'fa-cloud-upload-alt', label: 'مدارک', contentHtml: step4 }
                ];
            } else {
                 return [
                    { id: 1, icon: 'fa-user-tie', label: 'مشخصات فردی', contentHtml: commonStep1 },
                    { id: 2, icon: 'fa-address-book', label: 'اطلاعات تماس', contentHtml: commonStep2 },
                    { id: 3, icon: 'fa-building', label: 'اطلاعات شرکت', contentHtml: employerStep3 },
                    { id: 4, icon: 'fa-id-badge', label: 'مدارک', contentHtml: step4 }
                ];
            }
        }
        
        function initializeMapsForSection(stepId, role) {
            const prefix = role === 'engineer' ? 'engineer' : 'employer';
            if (stepId === 2) {
                const lat = getInputValue(`profile-${prefix}ResidentialLat`);
                const lng = getInputValue(`profile-${prefix}ResidentialLng`);
                initMap('map-profile-residential', parseFloat(lat), parseFloat(lng), `profile-${prefix}ResidentialLat`, `profile-${prefix}ResidentialLng`);
            }
            if (stepId === 3 && role === 'employer') {
                 const lat = getInputValue('profile-employerCompanyAddressLat');
                 const lng = getInputValue('profile-employerCompanyAddressLng');
                 initMap('map-profile-company', parseFloat(lat), parseFloat(lng), 'profile-employerCompanyAddressLat', 'profile-employerCompanyAddressLng');
            }
        }
        
        function initMap(mapId, lat, lng, latInputId, lngInputId) {
            const mapContainer = document.getElementById(mapId);
            if (!mapContainer) return;
            if (maps[mapId]) maps[mapId].remove();
            
            const validLat = !isNaN(lat) && lat ? lat : 35.7219;
            const validLng = !isNaN(lng) && lng ? lng : 51.3347;

            const map = L.map(mapId).setView([validLat, validLng], 13);
            maps[mapId] = map;
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const marker = L.marker([validLat, validLng], { draggable: true }).addTo(map);

            marker.on('dragend', function(e) {
                if (!isEditMode) {
                    marker.setLatLng([validLat, validLng]);
                    return;
                }
                const newLatLng = e.target.getLatLng();
                setInputValue(latInputId, newLatLng.lat);
                setInputValue(lngInputId, newLatLng.lng);
            });
            
             setTimeout(() => map.invalidateSize(), 100);
        }

        function initializeDatePickers(containerSelector) {
            $(`${containerSelector} .jalali-datepicker-display`).each(function() {
                var $displayInput = $(this);
                var $valueInput = $displayInput.next('.jalali-datepicker-value');
                $displayInput.persianDatepicker({
                    format: 'YYYY/MM/DD',
                    altField: $valueInput,
                    altFormat: 'YYYY-MM-DD',
                    observer: true,
                    autoClose: true
                });
            });
        }

        // --- Event Listeners & Initial Call ---
        mainNav.addEventListener('click', (e) => {
            const navLink = e.target.closest('.main-nav-link');
            if (!navLink) return;
            e.preventDefault();
            const viewName = navLink.dataset.view;
            document.querySelector('#mainNav .active')?.classList.remove('active');
            navLink.classList.add('active');
            contentViews.forEach(view => view.classList.toggle('active', view.id === `${viewName}-view`));
        });

        initializeWorkstation();
    });
    </script>
</body>
</html>
