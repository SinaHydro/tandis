<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایستگاه کاری - نظام تندیس</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (for maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- <link rel="stylesheet" href="./leaflet.css"/> -->
    <!-- <script src="./leaflet.js"></script> -->
    
    <!-- Font Awesome (for icons) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css"/>
    
    <!-- Cropper.js (for image cropping) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script src="./jquery.min.js"></script>
    <link rel="stylesheet" href="./kamadatepicker.min.css">
    <script src="./kamadatepicker.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-color-dark: #1976D2;
            --special-color: #FFA000;      /* Golden Orange */
            --special-color-dark: #F57C00;   /* Darker Golden Orange */
            --notification-badge-color: #ef4444;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8fafc; }
        .workstation-wrapper {
            display: flex;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }
        .main-content-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content-body { flex-grow: 1; overflow-y: auto; padding: 1.5rem 1rem; }
        /* --- MODIFICATION: Main sidebar width changed --- */
        .sidebar { width: 220px; flex-shrink: 0; background-color: #f1f5f9; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow-y: auto; }
        @media (max-width: 1024px) { .sidebar { display: none; } }
        .sidebar-profile-section { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #cbd5e1; }
        .sidebar-profile-image-container { position: relative; width: 35px; height: 35px; flex-shrink: 0; }
        .sidebar-profile-image { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid var(--primary-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sidebar-profile-image-edit-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; opacity: 0; transition: opacity 0.3s ease; cursor: pointer; }
        .sidebar-profile-image-container:hover .sidebar-profile-image-edit-overlay { opacity: 1; }
        .sidebar-profile-details { margin-right: 1rem; text-align: right; }
        .sidebar-profile-name { font-size: 1.05rem; font-weight: 700; color: #1e293b; }
        .sidebar-profile-role { font-size: 0.85rem; font-weight: 500; color: var(--primary-color); margin-top: 0.25rem; }
        .sidebar-nav { padding: 1rem; flex-grow: 1; }
        .nav-item { display: flex; align-items: center; padding: 0.75rem 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; color: #475569; font-weight: 500; transition: all 0.2s ease; cursor: pointer; position: relative; }
        .nav-item i { margin-left: 0.75rem; width: 20px; text-align: center; }
        .nav-item:hover { background-color: #e2e8f0; color: #1e293b; }
        .nav-item.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 6px -1px rgba(33, 150, 243, 0.2); }
        .notification-badge { position: absolute; top: 0; right: 0; background-color: var(--notification-badge-color); color: white; border-radius: 50%; width: 6px; height: 6px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .sidebar-profile-section .nav-item i { margin-left: 0; }
        .nav-item.btn-special-project { background-color: var(--special-color); color: white; font-weight: 700; justify-content: center; }
        .nav-item.btn-special-project:hover { background-color: var(--special-color-dark); }
        .nav-item.btn-special-project.active { background-color: var(--special-color-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }

        .sidebar-footer { padding: 1rem; margin-top: auto; border-top: 1px solid #e2e8f0; }
        /* --- MODIFICATION: Advertisement sidebar width changed --- */
        .advertisement-sidebar {
            width: 270px;                  /* ۱. عرض سایدبار ثابت می‌شود */
            flex-shrink: 0;                /* ۲. از کوچک شدن سایدبار جلوگیری می‌کند */
            margin: 2rem 1rem 5rem 1rem;      /* ۳. حاشیه بیرونی (بالا، راست، پایین، چپ) */
            height: calc(100vh - 7rem);    /* ۴. ارتفاع برای جا دادن حاشیه عمودی تنظیم می‌شود */
            background-color: white;
            border-radius: 1rem; /* 16px */
            padding: 1.5rem; /* 24px */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            align-self: center;
            justify-content: center;
        }
        @media (max-width: 1280px) { .advertisement-sidebar { display: none; } }
        .slideshow-container { position: relative; border-radius: 0.5rem; overflow: hidden; }
        .slide-image { width: 100%; display: none; aspect-ratio: 4/5; object-fit: cover; }
        .slide-image.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0.4; } to { opacity: 1; } }
        .slide-dots { text-align: center; padding-top: 0.75rem; }
        .dot { cursor: pointer; height: 10px; width: 10px; margin: 0 4px; background-color: #cbd5e1; border-radius: 50%; display: inline-block; transition: background-color 0.3s ease; }
        .dot.active, .dot:hover { background-color: var(--primary-color); }
        .profile-section { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; margin-bottom: 1.5rem; /*overflow: hidden;*/ }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; cursor: pointer; user-select: none; background-color: #fdfdfe; border-bottom: none; border-radius: 0.75rem; transition: all 0.2s ease; }
        .section-header.open { border-bottom-color: #e2e8f0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom: none; border-bottom: 1px solid #e2e8f0;}
        .section-title { font-size: 1.1rem; font-weight: 600; color: #334155; }
        .section-title i { margin-left: 0.75rem; color: var(--primary-color); }
        .section-toggle-icon { transition: transform 0.3s ease; }
        .section-header.open .section-toggle-icon { transform: rotate(180deg); }
        .section-content { padding: 1.5rem; display: none; }
        .section-content.open { display: block; }
        .section-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }
        label.required-field::after { content: "*"; color: red; margin-right: 4px; }   
        .password-input-container { position: relative; }
        .password-toggle-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6b7280; }
        /* استایل جدید برای دکمه‌های انتخاب قیمت */
        .price-btn { padding: 0.75rem; border: 2px solid #e2e8f0; /* slate-200 */ border-radius: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; background-color: #f8fafc; /* slate-50 */ color: #475569; /* slate-600 */ font-size: 0.9rem; line-height: 1.4; }
        .price-btn:hover { border-color: #3b82f6; /* blue-500 */ background-color: #eff6ff; /* blue-50 */}
        .price-btn.active { border-color: #2563eb; /* blue-600 */ background-color: #dbeafe; /* blue-100 */ color: #1e3a8a; /* blue-900 */ font-weight: 600; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);}
        /* استایل جدید برای کادرهای متنی بلند (توضیحات و آدرس) */
        textarea[name*="Address"] { border: 1px solid #cbd5e1; padding: 0.75rem 1rem; border-radius: 0.375rem; }
        textarea[name*="Address"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2); outline: none; padding: 0.75rem 1rem; }
        input[type="text"], input[type="date"], input[type="tel"], input[type="number"], input[type="password"] { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.375rem;  padding: 0.875rem 1rem; /* حاشیه داخلی استاندارد */ transition: all 0.2s ease; width: 100%; height: 2.75rem; /* ارتفاع استاندارد */}
        /* مرحله ۲: استایل اختصاصی فقط برای دکمه‌های کشویی (با حاشیه داخلی بیشتر) */
        select { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0 1.25rem; /* حاشیه داخلی بیشتر فقط برای چپ و راست */ transition: all 0.2s ease; width: 100%; height: 2.75rem; /* ارتفاع را با بقیه یکسان نگه می‌داریم */ -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        input[type="password"] { padding-left: 2.5rem; }
        input:focus, textarea:focus, select:focus, input[type="password"]:focus { border-color: var(--primary-color); background-color: white; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2); outline: none; }
        input:disabled, select:disabled, textarea:disabled { background-color: #eef2f7; color: #64748b; cursor: not-allowed; border-color: #e2e8f0; } 
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-color-dark); }
        .btn-secondary { background-color: #e2e8f0; color: #1e293b; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-success:hover { background-color: #16a34a; }
        .btn-special { background-color: var(--special-color); color: white; }
        .btn-special:hover { background-color: var(--special-color-dark); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .map-container { height: 250px; border-radius: 0.5rem; border: 1px solid #cbd5e1; z-index: 1; }
        .map-info-display { background-color: #e0f2fe; border: 1px solid #bae6fd; color: #0c4a6e; padding: 0.75rem; border-radius: 0.375rem; font-size: 0.8rem; }
        .file-preview-container { width: 100%; height: 12rem; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 0.375rem; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f8fafc; }
        .file-preview-container img, .file-preview-container iframe { width: 100%; height: 100%; object-fit: cover; border: none; }
        .file-preview-container i { font-size: 2rem; color: #94a3b8; margin-bottom: 0.5rem; }
        .modal { display: none; align-items: center; justify-content: center; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .modal-content { background-color: #ffffff; margin: auto; padding: 2rem; border: none; width: 90%; max-width: 500px; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        #cropperModal .modal-content { max-width: 90vw; width: 600px; }
        #cropperContainer { width: 100%; height: 400px; overflow: hidden; background: #f1f1f1; }
        #cropperContainer img { max-width: 100%; height: auto; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 32px; height: 32px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #welcome-loader { display: flex; flex-direction: row; align-items: stretch; justify-content: center; position: fixed; inset: 0; z-index: 9999; background: linear-gradient(135deg, #FDFEFF 0%, #FCFDFF 50%, #EFF9FF 100%); transition: opacity 0.5s ease-out; }
        .welcome-banner { width: 20vw; max-width: 220px; min-width:150px; background-color: rgba(255,255,255,0.5); display: none; align-items: center; justify-content: center; overflow: hidden; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.03); margin: 2rem; height: calc(100vh - 8rem); } 
        .welcome-banner img { width: 100%; height: 100%; object-fit: cover; }
        .welcome-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        @media (min-width: 1024px) { .welcome-banner { display: flex; } }
        .project-card, .activity-card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.3s ease; }
        .project-card:hover, .activity-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .price-highlight { background-color: #f0fdf4; }
        .commission-highlight { background-color: #f8fafc; }
        .frosode-badge { background-color: #fef2f2; color: #dc2626; }
        .frosode-badge-container { text-align: center; }
        #project-list-container, #my-activities-container, #engineers-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }      
        #filter-container .grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; }
        @media (min-width: 768px) { #filter-container .grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1280px) { #filter-container .grid { grid-template-columns: repeat(4, 1fr); } }

        .neumorphic-card { background: #ffffff; border-radius: 20px; box-shadow: 8px 8px 16px #e0e0e0, -8px -8px 16px #ffffff; padding: 20px; margin: 20px auto; width: 100%; max-width: 800px; } 
        .neumorphic-button { background: #ffffff; border: none; border-radius: 10px; box-shadow: 4px 4px 8px #e0e0e0, -4px -4px 8px #ffffff; padding: 8px 16px; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; } 
        .neumorphic-button:hover { box-shadow: 2px 2px 4px #e0e0e0, -2px -2px 4px #ffffff; }
        .progress-bar { height: 6px; border-radius: 3px; background-color: #e9ecef; width: 100%; } 
        .progress-fill { height: 100%; border-radius: 3px; background-color: #3b82f6; transition: width 0.3s ease; }
        .needs-help { background-color: #fee2e2; padding: 4px 8px; border-radius: 4px; color: #dc2626; font-size: 0.875rem; }
        /* Notification Panel Styles */
        .notification-item { border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s ease; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item.unread { background-color: #eff6ff; font-weight: 600; }
        .notification-item:hover { background-color: #f8fafc; }
        .notification-item .dot { width: 10px; height: 10px; background-color: var(--primary-color); border-radius: 50%; flex-shrink: 0; }
        /* --- NEW: Info Box Style --- */
        .info-box { background-color: #e0f2fe; /* light-blue */ border-right: 4px solid #0ea5e9; /* sky-500 */ padding: 0.5rem; justify-content: center; border-radius: 0.375rem; display: flex; align-items: flex-start; gap: 0.75rem; }
        .info-box i { color: #0284c7; /* sky-600 */ font-size: 1.25rem; margin-top: 0.25rem; }
        .info-box p { font-size: 0.875rem; color: #0c4a6e; /* sky-900 */ line-height: 1.6; }
        /* --- NEW: Sidebar Footer Style --- */
        .sidebar-brand-footer { margin-top: auto; /* این دستور جادویی، این بخش را به پایین هل می‌دهد */ display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem; border-top: 1px solid #e2e8f0; }
        .sidebar-brand-footer img { width: 40px; height: 40px; object-fit: contain; flex-shrink: 0; }
        .sidebar-brand-footer div { font-size: 0.75rem; color: #475569; line-height: 1.4; }
        .sidebar-brand-footer strong { font-weight: 600; color: #1e293b; }
        .custom-price-container { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.5rem; /* پدینگ کمتر برای جا دادن اینپوت */ }
        .custom-price-input { margin-top: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; padding: 0.25rem 0.5rem; width: 90%; text-align: center; background-color: white; }
        /* --- استایل‌های جدید برای فیلتر و مرتب‌سازی پیشرفته --- */
        .filter-sort-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; padding: 0.75rem; background-color: #ffffff; border-radius: 0.75rem; border: 1px solid #e2e8f0; margin-bottom: 1.5rem; }
        .filter-group { position: relative; }
        .filter-btn, .sort-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; background-color: #ffffff; color: #475569; font-weight: 500; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .filter-btn:hover, .sort-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .filter-btn.active, .sort-btn.active { background-color: var(--primary-color); border-color: var(--primary-color); color: white; }
        .filter-btn .close-icon, .sort-btn .close-icon { font-size: 0.8em; margin-right: -0.25rem; margin-left: 0.25rem; opacity: 0.7;}
        .filter-btn .close-icon:hover { opacity: 1; }
        .filter-dropdown { position: absolute; top: 100%; right: 0; z-index: 10; min-width: 200px; background-color: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 0.5rem; max-height: 250px; overflow-y: auto; display: none; /* به صورت پیش‌فرض مخفی است */ }
        .filter-dropdown-item { padding: 0.75rem 1rem; cursor: pointer; }
        .filter-dropdown-item:hover { background-color: #f1f5f9; }
        .profile-header-container { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 2rem 1rem; margin-bottom: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .profile-header-image-wrapper { position: relative; width: 128px; height: 128px; cursor: pointer; }
        .profile-header-image { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 0 4px var(--primary-color), 0 10px 25px -5px rgba(0,0,0,0.2); }
        .profile-header-edit-icon {position: absolute; bottom: 5px; right: 5px; background-color: white; color: var(--primary-color); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease;}
        .profile-header-image-wrapper:hover .profile-header-edit-icon { transform: scale(1.1); }
        .nav-icon-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            color: #475569; /* slate-600 */
            transition: all 0.2s ease-in-out;
            font-size: 1.25rem; /* اندازه آیکن */
        }

/* نسخه جدید استایل هاور: پس‌زمینه تغییر نمی‌کند و یک درخشش نارنجی به آیکن اضافه می‌شود */
        .nav-icon-btn:hover {
            filter: drop-shadow(0 0 4px var(--special-color));
        }
        
        /* نسخه جدید استایل فعال: پس‌زمینه حذف شده و فقط رنگ آیکن آبی می‌شود */
        .nav-icon-btn.active {
            color: var(--primary-color);
            background-color: transparent; /* پس‌زمینه شفاف می‌شود */
        }

        /* استایل خاص برای دکمه بزرگ ثبت پروژه/فعالیت */
        .nav-icon-btn.special-btn {
            color: var(--special-color); /* فقط رنگ آیکن نارنجی می‌شود */
            font-size: 1.75rem;
        }
        
        .nav-tooltip {
            position: absolute;
            bottom: 110%; /* بالای دکمه */
            left: 50%;
            transform: translateX(-50%);
            background-color: #334155; /* slate-700 */
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        
        .nav-icon-btn.group:hover .nav-tooltip {
            opacity: 1;
        }
        .nav-icon-btn:focus {
            outline: none;
            box-shadow: none;
        }

        /* --- استایل‌های جدید برای کارت‌های داشبورد --- */
        .main-card {
            transition: transform 0.2s ease-in-out;
            border-width: 4px;
        }
        .main-card:hover {
            transform: scale(1.02);
        }
        .main-card:active {
            transform: scale(0.99);
        }
        .card-content {
            transition: filter 0.4s ease-in-out;
            filter: grayscale(100%);
        }
        .main-card:hover .card-content {
            filter: grayscale(0%);
        }
        .main-card:hover .icon-link i {
             filter: drop-shadow(0 0 5px rgba(250, 204, 21, 0.9)); /* درخشش زرد آیکن */
        }
        .description-text {
            transition: opacity 0.5s ease-in-out;
            min-height: 50px; /* برای جلوگیری از تغییر ارتفاع کارت */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* در حالت موبایل، توضیحات همیشه آشکار باشند */
        @media (max-width: 768px) {
            .description-text {
                opacity: 1 !important;
                display: block; /* برای نمایش بهتر متن‌های طولانی */
            }
        }
/* --- استایل‌های جدید برای لیست پروژه‌های کارفرما --- */
        .project-accordion .project-row {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            overflow: visible;
        }
        .project-accordion .project-header {
            display: grid;
            /* ستون‌ها برای جای دادن "مدت قرارداد" آپدیت شد */
            grid-template-columns: 20px repeat(6, 1fr) 120px;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            background-color: #ffffff;
            transition: background-color 0.2s ease;
            gap: 1rem;
        }
        .project-accordion .project-header:hover {
            background-color: #f8fafc;
        }
        .project-accordion .header-item strong {
            color: #1e293b;
            font-weight: 600;
        }
        .project-accordion .header-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }
        .project-accordion .project-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            background-color: #ffffff;
        }
        .project-accordion .project-row.open .project-body {
            max-height: 500px; /* ارتفاع تقریبی برای نمایش محتوا */
            border-top: 1px solid #e2e8f0;
            overflow: visible;
        }
        .project-row.closed-project {
            opacity: 0.6;
            background-color: #f8fafc; /* رنگ پس‌زمینه کمی متفاوت */
        }
        .applicant-row {
            display: grid;
            /* چیدمان جدید برای مشخصات مهندس */
            grid-template-columns: 20px repeat(6, 1fr) 120px;
            gap: 1rem;
            align-items: center;
        }
        .applicant-row:last-child {
            border-bottom: none;
        }
        .project-accordion .header-item {
            font-size: 0.875rem; /* اندازه فونت پایه برای آیتم‌ها */
            color: #1e293b;     /* رنگ پیش‌فرض برای مقادیر */
        }
        .project-accordion .header-item > span {
            font-size: 0.75rem;  /* اندازه فونت کوچکتر برای لیبل */
            color: #64748b;      /* رنگ خاکستری برای لیبل */
        }
        .project-accordion .header-item > span,
        .project-accordion .header-item > strong {
            display: block;      /* هر کدام را به یک بلوک تمام-عرض تبدیل می‌کند */
            line-height: 1.4;    /* فاصله بین دو سطر را تنظیم می‌کند */
        }
                /* --- کد جدید برای اصلاح گوشه‌های گرد --- */
        .project-accordion .project-header {
            /* در حالت بسته، همه گوشه‌ها گرد هستند */
            border-radius: 0.75rem;
        }
        .project-row.open .project-header {
            /* در حالت باز، فقط گوشه‌های بالایی گرد هستند */
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .project-row.open .project-body {
            /* در حالت باز، فقط گوشه‌های پایینی گرد هستند */
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }
        .action-btn-container {
            position: relative;
            display: flex;
            justify-content: center;
        }
        .action-options {
            position: absolute;
            bottom: 100%; /* << باز شدن به سمت بالا */
            top: auto;     /* << این خط برای اطمینان اضافه شد */
            left: 0;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 10;
            margin-bottom: 0.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 150px;
        }
        .action-options a {
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            transition: background-color 0.2s ease;
        }
        .action-options a:hover { background-color: #f1f5f9; }
        #loading-overlay { z-index: 9999; }
        
        .interaction-list { padding: 0.5rem; }
        .interaction-list h5 { font-weight: 600; color: #1e293b; background-color: #e2e8f0; padding: 0.5rem 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .interaction-row { 
            display: grid; 
            /* ستون اول: 40px، ستون آخر: 120px، بقیه مساوی */
            grid-template-columns: 20px repeat(6, 1fr) 120px;
            gap: 1rem; 
            align-items: center; 
            padding: 1rem; 
            border-bottom: 1px solid #e2e8f0; 
            justify-content: center;
        }
        .interaction-row:last-child { border-bottom: none; }
        
        .status-badge {
            display: flex;  
            justify-content: center;
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }
        .status-pending { background-color: #f1f5f9; color: #475569; border: 1px solid #475569; }
        .status-accepted { background-color: #dcfce7; color: #166534; border: 1px solid #166534; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; border: 1px solid #991b1b; }
        .status-reviewing { background-color: #fef9c3; color: #854d0e; border: 1px solid #854d0e; }

        /* رنگ پس‌زمینه برای هدر لیست‌ها */
        .list-header-incoming { background-color: #e0f2fe !important; border: 1px solid #93c5fd; padding: 0.75rem 1rem; border-radius: 0.5rem; } /* آبی کم‌رنگ */
        .list-header-outgoing { background-color: #f0fdf4 !important; border: 1px solid #86efac; padding: 0.75rem 1rem; border-radius: 0.5rem; } /* سبز کم‌رنگ */
        .list-header-suggestions { background-color: #fefce8 !important; border: 1px solid #fde047; padding: 0.75rem 1rem; border-radius: 0.5rem; } /* زرد کم‌رنگ */
        .list-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #94a3b8; /* slate-400 */
        }
        .list-toggle-btn i {
            transition: transform 0.3s ease;
        }
        .list-toggle-btn.collapsed i {
            transform: rotate(-90deg);
        }
        .interaction-list-content.collapsed {
            display: none;
        }
        .engineer-field-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .engineer-field-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .engineer-field-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }
        /* --- استایل‌های جدید برای کادربندی لیست‌ها --- */
        .list-group {
            border: 1px solid #e2e8f0; /* یک حاشیه خاکستری دور کل گروه */
            border-radius: 0.75rem;     /* گوشه‌های گرد برای کل گروه */
            overflow: hidden;         /* اطمینان از اینکه محتوای داخلی از گوشه‌های گرد بیرون نمی‌زند */
            margin-top: 1rem;         /* ایجاد فاصله بین گروه‌های لیست */
        }
        .list-group .interaction-list-content {
            background-color: #ffffff; /* پس‌زمینه سفید برای محتوای لیست */
        }
        .list-group h5 {
            border-bottom: 1px solid rgba(0,0,0,0.1); /* یک خط جداکننده بین هدر و محتوا */
        }

    </style>
</head>
<body class="hidden">

    <div id="welcome-loader">
        <div class="welcome-banner">
             <img src="https://images.unsplash.com/photo-1657450717464-b2989dd69a66?w=600&auto=format&fit=crop&q=60" 
                  alt="گل‌های آبی" onerror="this.onerror=null;this.src='https://placehold.co/220x500/EBF4FF/2196F3?text=Flowers';">
        </div>
        <div class="welcome-content">
            <div class="flex items-center justify-center mb-6">
                <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="لوگوی تندیس" class="h-24 w-24 ml-4" loading="lazy">
                <div class="text-center">
                    <h1 class="text-4xl font-black text-blue-800">نظام تندیس</h1>
                    <p class="text-lg font-bold text-yellow-600 mt-1">تدارک نیازمندی دقیق و یکپارچه ساختمان</p>
                </div>
            </div>
            <div class="spinner mb-4"></div>
            <h2 id="welcome-message" class="text-xl font-semibold text-slate-700 mb-2">خوش آمدید!</h2>
            <p class="text-slate-600">پلتفرم تخصصی ارتباط مهندسان و کارفرمایان ساختمانی</p>
        </div>
         <div class="welcome-banner">
             <img src="https://images.unsplash.com/photo-1657450717464-b2989dd69a66?w=600&auto=format&fit=crop&q=60" 
                  alt="گل‌های آبی" onerror="this.onerror=null;this.src='https://placehold.co/220x500/FFF3E0/FFB300?text=Flowers';">
        </div>
    </div>

    <div class="workstation-wrapper">
        <aside class="advertisement-sidebar">
             <div class="flex items-center gap-4 mb-6 pb-6 border-b border-slate-300 justify-center">
                <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="لوگوی تندیس" class="w-16 h-16 mb-2 rounded-md object-contain">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-blue-800">نظام تندیس</h2>
                    <p class="text-sm font-bold text-yellow-600 mt-1">تـدارک نیـازمنـدی</p>
                    <p class="text-sm font-bold text-yellow-600 mt-1">دقیق و یکپارچه ساختمان</p>
                </div>
            </div>
            <!-- --- NEW: Info Box --- -->
            <div id="info-box-container-R" class="info-box mb-4">
                <p id="info-box-text-R"></p>
            </div>
            <!-- --- NEW: slide show --- -->
            <div class="slideshow-container">
                <div id="slideshow-R" class="slideshow-container"></div>
                <div id="slide-dots-container-R" class="slide-dots"></div>
            </div>
            <!-- --- NEW: Sidebar Footer --- -->
            <div class="sidebar-brand-footer">
                <img src="https://shahraavand.ir/images/logoT.png" alt="لوگوی شرکت شهرآوند">
                <div class="text-center">
                    <strong>شرکت مهـندسین مشاور</strong><br>
                    <strong>شـهرآوند تبـریز</strong><br>
                    طراحی و نظارت ساختمان
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content-area">
            
            <div id="dashboardContent" class="content-body"></div>
            <div id="profileContent" class="content-body" style="display: none;"></div>
            <div id="notificationsContent" class="content-body" style="display: none;"></div>
            <div id="projectsContent" class="content-body" style="display: none;"></div>
            <div id="myActivitiesContent" class="content-body" style="display: none;"></div>
            <div id="engineersContent" class="content-body" style="display: none;"></div>
            <div id="settingsContent" class="content-body" style="display: none;">
                <div class="profile-section">
                    <div class="section-header !cursor-default">
                        <h3 class="section-title"><i class="fas fa-key"></i>تغییر رمز عبور</h3>
                    </div>
                    <div class="section-content open">
                        <form id="changePasswordForm">
                            <div class="space-y-4 max-w-lg mx-auto p-4">
                                <div>
                                    <label for="currentPassword" class="block text-sm font-medium text-slate-700 mb-1 required-field">رمز عبور فعلی</label>
                                    <div class="password-input-container">
                                        <input type="password" id="currentPassword" name="currentPassword" required class="mt-1">
                                        <i class="fas fa-eye password-toggle-icon" data-target="currentPassword"></i>
                                    </div>
                                </div>
                                <div>
                                    <label for="newPassword" class="block text-sm font-medium text-slate-700 mb-1 required-field">رمز عبور جدید</label>
                                    <div class="password-input-container">
                                        <input type="password" id="newPassword" name="newPassword" required class="mt-1">
                                        <i class="fas fa-eye password-toggle-icon" data-target="newPassword"></i>
                                    </div>
                                </div>
                                <div>
                                    <label for="confirmNewPassword" class="block text-sm font-medium text-slate-700 mb-1 required-field">تکرار رمز عبور جدید</label>
                                    <div class="password-input-container">
                                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required class="mt-1">
                                        <i class="fas fa-eye password-toggle-icon" data-target="confirmNewPassword"></i>
                                    </div>
                                </div>
                                <div class="pt-4">
                                     <button type="submit" class="btn btn-primary w-full justify-center">
                                        <i class="fas fa-save"></i>
                                        <span id="savePasswordBtnText">ذخیره تغییرات</span>
                                        <div id="savePasswordSpinner" class="spinner !w-5 !h-5 !border-2 hidden"></div>
                                     </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="createProjectContent" class="content-body" style="display: none;"></div>
            <div id="createActivityContent" class="content-body" style="display: none;"></div>
            
            <div id="bottom-nav" class="w-full mt-auto pt-4">
                <div class="bg-white rounded-2xl my-1 mx-4 shadow-lg max-w-4xl mx-auto">
                    <div class="rounded-xl p-2 h-full w-full flex items-center text-slate-700 font-semibold">
                        
                        <div class="p-1 bg-slate-100 rounded-xl">
                             <a href="#" id="refresh-nav-item" class="nav-icon-btn group">
                                <i class="fas fa-sync-alt"></i><div class="nav-tooltip">بروزرسانی</div>
                            </a>
                        </div>

                        <span id="desktop-date" class="text-sm hidden sm:block mx-4"></span>
                        <div class="flex-grow"></div>

                        <div class="flex items-center justify-center gap-x-1">
                            <a href="#" id="home-nav-item" data-view="dashboard" class="nav-icon-btn group"><i class="fas fa-home"></i><div class="nav-tooltip">خانه</div></a>
                            <a href="#" id="search-nav-item" data-view="" class="nav-icon-btn group" style="display: none;"><i class="fas fa-search"></i><div class="nav-tooltip"></div></a>
                            <a href="#" id="create-project-nav-item" data-view="create-project" class="nav-icon-btn special-btn group" style="display: none;"><i class="far fa-square-plus"></i><div class="nav-tooltip">ثبت پروژه جدید</div></a>
                            <a href="#" id="create-activity-nav-item" data-view="create-activity" class="nav-icon-btn special-btn group" style="display: none;"><i class="far fa-square-plus"></i><div class="nav-tooltip">ثبت فعالیت جدید</div></a>
                            <a href="#" id="my-items-nav-item" data-view="" class="nav-icon-btn group" style="display: none;"><i class="fas fa-briefcase"></i><div class="nav-tooltip"></div></a>
                            <a href="#" id="profile-nav-item" data-view="profile" class="nav-icon-btn group"><i class="fas fa-user-circle"></i><div class="nav-tooltip">پروفایل</div></a>
                            
                            <a href="#" id="notifications-nav-item" data-view="notifications" class="nav-icon-btn group relative"><i class="fas fa-bell"></i><span id="notification-badge" class="notification-badge !-top-1 !-right-1"></span><div class="nav-tooltip">پیام‌ها</div></a>
                            <a href="#" id="settings-nav-item" data-view="settings" class="nav-icon-btn group"><i class="fas fa-cog"></i><div class="nav-tooltip">تنظیمات</div></a>
                            <a href="#" id="logout-nav-item" class="nav-icon-btn group"><i class="fas fa-sign-out-alt"></i><div class="nav-tooltip">خروج</div></a>
                        </div>
                        
                        <div class="flex-grow"></div>

                        <span id="desktop-time" class="text-sm hidden sm:block pl-2"></span>

                        <div class="p-1 bg-slate-100 rounded-xl"> <a href="https://instagram.com/moje3wom" target="_blank" class="nav-icon-btn group">
                                <i class="fab fa-instagram"></i><div class="nav-tooltip">اینستاگرام</div>
                            </a>
                        </div>
                        </div>
                </div>
            </div>
        </main>
        
        <aside class="advertisement-sidebar">
             <div class="flex items-center gap-4 mb-6 pb-6 border-b border-slate-300 justify-center">
                <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="لوگوی تندیس" class="w-16 h-16 mb-2 rounded-md object-contain">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-blue-800">نظام تندیس</h2>
                    <p class="text-sm font-bold text-yellow-600 mt-1">تـدارک نیـازمنـدی</p>
                    <p class="text-sm font-bold text-yellow-600 mt-1">دقیق و یکپارچه ساختمان</p>
                </div>
            </div>
            <!-- --- NEW: Info Box --- -->
            <div id="info-box-container" class="info-box mb-4">
                <p id="info-box-text"></p>
            </div>
            <!-- --- NEW: slide show --- -->
            <div class="slideshow-container">
                <div id="slideshow" class="slideshow-container"></div>
                <div id="slide-dots-container" class="slide-dots"></div>
            </div>
            <!-- --- NEW: Sidebar Footer --- -->
            <div class="sidebar-brand-footer">
                <img src="https://shahraavand.ir/images/logoT.png" alt="لوگوی شرکت شهرآوند">
                <div class="text-center">
                    <strong>شرکت مهـندسین مشاور</strong><br>
                    <strong>شـهرآوند تبـریز</strong><br>
                    طراحی و نظارت ساختمان
                </div>
            </div>
        </aside>
    </div>

    <!-- Modals -->
    <div id="cropperModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">برش و تنظیم عکس پروفایل</h3>
            <div id="cropperContainer">
                <img id="imageToCrop" src="">
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="cancelCropButton" class="btn btn-secondary"><i class="fas fa-times"></i>انصراف</button>
                <button id="cropAndSaveButton" class="btn btn-primary"><i class="fas fa-crop-alt"></i>برش و ذخیره</button>
            </div>
        </div>
    </div>
    <div id="messageModal" class="modal">
        <div class="modal-content text-center">
            <div id="modalIconContainer" class="mb-4 text-5xl"></div>
            <p id="modalMessageText" class="text-slate-700 text-base"></p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="modalConfirmBtn" class="btn btn-primary"><i class="fas fa-check"></i>تایید</button>
                <button id="modalCancelBtn" class="btn btn-secondary"><i class="fas fa-times"></i>انصراف</button>
            </div>
        </div>
    </div>
     <div id="notificationModal" class="modal">
        <div class="modal-content !max-w-2xl text-right">
            <h3 id="notificationModalTitle" class="text-xl font-bold mb-2 text-slate-800"></h3>
            <p id="notificationModalMeta" class="text-sm text-slate-500 mb-4"></p>
            <div id="notificationModalBody" class="text-slate-700 text-base leading-relaxed max-h-96 overflow-y-auto border-t border-b py-4 my-4"></div>
            <div class="mt-6 flex justify-center">
                <button id="notificationModalCloseBtn" class="btn btn-primary"><i class="fas fa-check mr-2"></i>متوجه شدم</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="modal" style="display: none;">
        <div class="bg-white/80 backdrop-blur-sm rounded-xl p-8 flex flex-col items-center gap-y-4">
            <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="لوگوی تندیس" class="h-20 w-20">
            <h3 class="text-xl font-bold text-blue-800">نظام تندیس</h3>
            <p class="text-slate-600">لطفاً کمی صبر کنید...</p>
            <div class="spinner"></div>
        </div>
    </div>
    

    <div id="selectionModal" class="modal">
        <div class="modal-content">
            <h3 id="selectionModalTitle" class="text-xl font-bold mb-4"></h3>
            <div id="selectionModalBody" class="max-h-96 overflow-y-auto">
                </div>
            <div class="mt-6 flex justify-center">
                <button id="selectionModalCloseBtn" class="btn btn-secondary"><i class="fas fa-times mr-2"></i>انصراف</button>
            </div>
        </div>
    </div>

    <script>
    (async function() {
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVSyGbIGSg4Aao6-dT5QrbU9nEqbLvFdFrTn1F4CZA5uWedpqAakBS8itzbn6bQosT/exec'; // GSA v.90

        const SLIDESHOW_CONTENT_R = [
            { 
                imageUrl: 'https://images.unsplash.com/photo-1739467561973-e5015d7f9561?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHx0b3BpYy1mZWVkfDI4M3xNOGpWYkxiVFJ3c3x8ZW58MHx8fHx8', 
                caption: 'ارتباط مستقیم مهندسان و کارفرمایان ساختمانی.' 
            },
            { 
                imageUrl: 'https://images.unsplash.com/photo-1751908934325-5be793566bcc?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHx0b3BpYy1mZWVkfDQyfE04alZiTGJUUndzfHxlbnwwfHx8fHw%3D', 
                caption: 'آمادگی خود را به کارفرمایان اعلام کنید.' 
            },
            { 
                imageUrl: 'https://images.unsplash.com/photo-1746444342182-fc6679dd3b4d?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHx0b3BpYy1mZWVkfDE0OXxNOGpWYkxiVFJ3c3x8ZW58MHx8fHx8', 
                caption: 'بهترین مهندسان را برای پروژه‌تان پیدا کنید.' 
            }
        ];     

        const SLIDESHOW_CONTENT_L = [
            { 
                imageUrl: 'https://images.unsplash.com/photo-1552734839-86b2d246fe63?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGVuZ2luZWVyJTIwYWN0aXZpdHl8ZW58MHwxfDB8fHwy', 
                caption: 'بازار کار تخصصی صنعت ساختمان.' 
            },
            { 
                imageUrl: 'https://images.unsplash.com/photo-1519626504899-7a03a8a9ab51?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjV8fGVuZ2luZWVyJTIwYWN0aXZpdHl8ZW58MHwxfDB8fHwy', 
                caption: 'همکاری سریع و مطمئن را تجربه کنید.' 
            },
            { 
                imageUrl: 'https://images.unsplash.com/photo-1517868092398-d187f20933a9?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NTd8fGVuZ2luZWVyJTIwYWN0aXZpdHl8ZW58MHwxfDB8fHwy', 
                caption: 'با تندیس، ارتباط مستقیم با بهترین مهندسان.' 
            }
        ]; 
        
        const PROVINCES = ["آذربایجان شرقی", "آذربایجان غربی", "اردبیل", "اصفهان", "البرز", "ایلام", "بوشهر", "تهران", "چهارمحال و بختیاری", "خراسان جنوبی", "خراسان رضوی", "خراسان شمالی", "خوزستان", "زنجان", "سمنان", "سیستان و بلوچستان", "فارس", "قزوین", "قم", "کردستان", "کرمان", "کرمانشاه", "کهگیلویه و بویراحمد", "گلستان", "گیلان", "لرستان", "مازندران", "مرکزی", "هرمزگان", "همدان", "یزد"];
            const priceOptions = [
                { label: 'ساختمان 1 تا 2 طبقه', default: '10,700', index: 1 }, 
                { label: 'ساختمان 3 تا 5 طبقه', default: '12,500', index: 2 },
                { label: 'ساختمان 6 تا 7 طبقه', default: '12,780', index: 3 }, 
                { label: 'ساختمان 8 تا 10 طبقه', default: '13,950', index: 4 },
                { label: 'ساختمان 11 تا 12 طبقه', default: '14,280', index: 5 }, 
                { label: 'ساختمان 13 تا 15 طبقه', default: '14,880', index: 6 },
                { label: 'ساختمان بالای 16 طبقه', default: '15,920', index: 7 },
            ];
        // --- STATE ---
        let userData = null;
        let cropper = null;
        let currentSlide = 0;
        let activeMaps = {};
        let fetchedProjects = [];
        let fetchedActivities = [];
        let fetchedEngineersActivities = [];
        let appliedProjectIds = new Set();
        let requestedCooperationIds = new Set();
        let currentActivityData = {};
        let fetchedNotifications = [];
        let currentView = 'dashboard';
        let projectMap, projectMarker;
        let engineerActivities = [];

        // --- DOM ELEMENTS ---
        const welcomeLoader = document.getElementById('welcome-loader');
        const welcomeMessage = document.getElementById('welcome-message');
        const allContentBodies = document.querySelectorAll('.content-body');
        // const mainHeaderTitle = document.getElementById('main-header-title');
        // const sidebarProfileImage = document.getElementById('sidebarProfileImage');
        // const profileImageInput = document.getElementById('profileImageInput');
        const dashboardContent = document.getElementById('dashboardContent');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const infoBoxText = document.getElementById('info-box-text');
        
        // --- HELPER FUNCTIONS ---
        function showLoader() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoader() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        function generateProvinceOptions(selectedValue, addSarasari = false) {
            let options = '<option value="">انتخاب استان</option>';
            if (addSarasari) {
                options += `<option value="سراسری" ${"سراسری" === selectedValue ? 'selected' : ''}>سراسری (کشوری)</option>`;
            }
            PROVINCES.forEach(province => {
                options += `<option value="${province}" ${province === selectedValue ? 'selected' : ''}>${province}</option>`;
            });
            return options;
        }
        
        function formatTimeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);
            const months = Math.round(days / 30.44);

            if (seconds < 60) return 'لحظاتی پیش';
            if (minutes < 60) return `${minutes} دقیقه پیش`;
            if (hours < 24) return `${hours} ساعت پیش`;
            if (days < 30) return `${days} روز پیش`;
            if (months < 12) return `${months} ماه پیش`;
            
            return new Date(dateString).toLocaleDateString('fa-IR');
        }

        function getDirectDriveLink(url) {
            if (!url || typeof url !== 'string') return '';
            const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (!match || !match[1]) return url;
            const fileId = match[1];
            return `https://lh3.googleusercontent.com/d/${fileId}`;
        }
        
        function getDirectDriveLinkForPdf(url) {
             if (!url || typeof url !== 'string') return '';
            const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (!match || !match[1]) return url;
            const fileId = match[1];
            return `https://drive.google.com/file/d/${fileId}/preview`;
        }

        function showModal(message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('messageModal');
            const modalMessageText = document.getElementById('modalMessageText');
            const modalIconContainer = document.getElementById('modalIconContainer');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            modalMessageText.textContent = message;
            let iconHtml = '';
            let confirmIcon = '<i class="fas fa-check"></i>';
            switch(type) {
                case 'error': iconHtml = `<i class="fas fa-times-circle text-red-500"></i>`; break;
                case 'success': iconHtml = `<i class="fas fa-check-circle text-green-500"></i>`; break;
                case 'confirm': 
                    iconHtml = `<i class="fas fa-question-circle text-yellow-500"></i>`;
                    confirmIcon = '<i class="fas fa-check"></i>';
                    break;
                default: iconHtml = `<i class="fas fa-info-circle text-blue-500"></i>`; break;
            }
            modalIconContainer.innerHTML = iconHtml;
            
            const closeModal = () => modal.style.display = 'none';

            if (onConfirm && typeof onConfirm === 'function') {
                modalConfirmBtn.style.display = 'inline-flex';
                modalCancelBtn.style.display = 'inline-flex';
                modalConfirmBtn.innerHTML = `${confirmIcon}<span class="mr-2">تایید</span>`;
                modalConfirmBtn.onclick = () => {
                    closeModal();
                    onConfirm();
                };
                modalCancelBtn.onclick = closeModal;
            } else {
                modalConfirmBtn.style.display = 'inline-flex';
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.innerHTML = `${confirmIcon}<span class="mr-2">متوجه شدم</span>`;
                modalConfirmBtn.onclick = closeModal;
            }

            modal.style.display = 'flex';
        }

        async function fetchUserProfile(email) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getUserProfile&email=${encodeURIComponent(email)}`);
                if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
                const result = await response.json();
                if (result.success) return result.data;
                throw new Error(result.message || "Could not find user profile.");
            } catch (error) {
                console.error("Error fetching user profile:", error);
                welcomeLoader.innerHTML = `<p class="text-red-600 font-bold text-center p-8">${error.message}</p>`;
                return null;
            }
        }

        async function updateProfileSection(sectionKey, sectionData) {
            welcomeLoader.style.opacity = '1';
            welcomeLoader.style.display = 'flex';
            try {
                const payload = { action: 'updateSection', email: userData.email, sectionKey, sectionData };
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal('اطلاعات با موفقیت ذخیره شد.', 'success');
                    const updatedData = await fetchUserProfile(userData.email);
                    if (updatedData) {
                        userData = { ...updatedData, email: userData.email };
                        renderProfile();
                    }
                    return true;
                }
                throw new Error(result.message || "Failed to update profile.");
            } catch (error) {
                console.error("Error updating profile section:", error);
                showModal(`خطا در ذخیره‌سازی: ${error.message}`, 'error');
                return false;
            } finally {
                 welcomeLoader.style.opacity = '0';
                 setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
            }
        }

function getProfileHeaderHTML(userData) {
    const directImageUrl = getDirectDriveLink(userData.files.applicantImage.fileUrl);
    const imgSrc = directImageUrl || 'https://placehold.co/128x128/2196F3/FFFFFF?text=U';

    return `
        <div class="profile-header-container">
            <label for="profileImageInput" class="profile-header-image-wrapper">
                <img id="mainProfileImage" src="${imgSrc}" alt="عکس پروفایل" class="profile-header-image" onerror="this.src='https://placehold.co/128x128/2196F3/FFFFFF?text=U';">
                <div class="profile-header-edit-icon">
                    <i class="fas fa-camera"></i>
                </div>
            </label>
        </div>
    `;
}
        
        function createSlideshow(slideshowId, dotsId, infoBoxId, contentArray) {
            const slideshowContainer = document.getElementById(slideshowId);
            const dotsContainer = document.getElementById(dotsId);
            const infoBoxText = document.getElementById(infoBoxId);
            
            if (!slideshowContainer || !dotsContainer || !infoBoxText || contentArray.length === 0) return;

            let slideIndex = 0;

            // ایجاد اسلایدها و دات‌ها
            contentArray.forEach((content, index) => {
                const img = document.createElement('img');
                img.src = content.imageUrl;
                img.alt = `Slide ${index + 1}`;
                img.className = 'slide-image';
                slideshowContainer.appendChild(img);

                const dot = document.createElement('span');
                dot.className = 'dot';
                dot.addEventListener('click', () => showSlide(index));
                dotsContainer.appendChild(dot);
            });

            const slides = slideshowContainer.querySelectorAll('.slide-image');
            const dots = dotsContainer.querySelectorAll('.dot');

            function showSlide(n) {
                slideIndex = n;
                if (slideIndex >= slides.length) slideIndex = 0;
                if (slideIndex < 0) slideIndex = slides.length - 1;

                slides.forEach(slide => slide.classList.remove('active'));
                dots.forEach(dot => dot.classList.remove('active'));

                slides[slideIndex].classList.add('active');
                dots[slideIndex].classList.add('active');
                infoBoxText.textContent = contentArray[slideIndex].caption;
            }

            // شروع اسلایدشو
            showSlide(0);
            setInterval(() => {
                showSlide(slideIndex + 1);
            }, 5000 + Math.random() * 1000); // افزودن یک تاخیر تصادفی کوچک برای عدم هماهنگی
        }
        
        function setupRoleSpecificUI(userData) {
            if (!userData || !userData.role) return;

            // دکمه‌های عمومی جدید
            const myItemsBtn = document.getElementById('my-items-nav-item');
            const searchBtn = document.getElementById('search-nav-item');
            const myItemsTooltip = myItemsBtn.querySelector('.nav-tooltip');
            const searchTooltip = searchBtn.querySelector('.nav-tooltip');

            // دکمه‌های مخصوص هر نقش
            const createProjectNavItem = document.getElementById('create-project-nav-item');
            const createActivityNavItem = document.getElementById('create-activity-nav-item');

            if (userData.role === 'employer') {
                // تنظیم دکمه "آیتم‌های من" برای کارفرما
                myItemsBtn.style.display = 'flex';
                myItemsBtn.dataset.view = 'projects';
                if (myItemsTooltip) myItemsTooltip.textContent = 'پروژه‌های من';

                // تنظیم دکمه "جستجو" برای کارفرما
                searchBtn.style.display = 'flex';
                searchBtn.dataset.view = 'engineers';
                if (searchTooltip) searchTooltip.textContent = 'جستجوی مهندس';

                // نمایش دکمه ثبت پروژه
                createProjectNavItem.style.display = 'flex';
                createActivityNavItem.style.display = 'none';

            } else if (userData.role === 'engineer') {
                // تنظیم دکمه "آیتم‌های من" برای مهندس
                myItemsBtn.style.display = 'flex';
                myItemsBtn.dataset.view = 'my-activities';
                if (myItemsTooltip) myItemsTooltip.textContent = 'فعالیت‌های من';

                // تنظیم دکمه "جستجو" برای مهندس
                searchBtn.style.display = 'flex';
                searchBtn.dataset.view = 'projects';
                if (searchTooltip) searchTooltip.textContent = 'جستجوی پروژه';

                // نمایش دکمه ثبت فعالیت
                createProjectNavItem.style.display = 'none';
                createActivityNavItem.style.display = 'flex';
            }
        }


        function updateBottomNavProfileIcon(userData) {
            // آدرس عکس پروفایل کاربر را از اطلاعات دریافتی می‌خوانیم
            const profileImageUrl = getDirectDriveLink(userData.files?.applicantImage?.fileUrl);
            const profileBtn = document.getElementById('profile-nav-item');

            // اگر آدرس عکس وجود داشت و دکمه پروفایل هم در صفحه بود
            if (profileImageUrl && profileBtn) {
                const icon = profileBtn.querySelector('i'); // آیکن فعلی را پیدا می‌کنیم
                
                if (icon) {
                    const img = document.createElement('img'); // یک تگ عکس جدید می‌سازیم
                    img.src = profileImageUrl;
                    img.alt = 'عکس پروفایل';
                    // با این کلاس‌ها، عکس به شکل دایره و هم‌اندازه دکمه در می‌آید
                    img.className = 'w-7 h-7 object-cover rounded-full';
                    
                    // اگر عکس به هر دلیلی لود نشد، دوباره آیکن را نمایش بده
                    img.onerror = () => {
                        img.replaceWith(icon);
                    };

                    // عکس جدید را جایگزین آیکن می‌کنیم
                    icon.replaceWith(img);
                }
            }
        }

function renderProfile() {
            if (!userData) return;
            const profileContent = document.getElementById('profileContent');

            const name = `${userData.stepsData.step1.engineerFirstName || userData.stepsData.step1.employerFirstName || ''} ${userData.stepsData.step1.engineerLastName || userData.stepsData.step1.employerLastName || ''}`;
            const roleText = userData.role === 'engineer' ? 'مهندس' : 'کارفرما';
            const directImageUrl = getDirectDriveLink(userData.files.applicantImage.fileUrl);
            const imgSrc = directImageUrl || 'https://placehold.co/128x128/2196F3/FFFFFF?text=U';

            const profileSideColumnHtml = `
                <div class="profile-header-container text-center">
                    <label for="profileImageInput" class="profile-header-image-wrapper">
                        <img id="mainProfileImage" src="${imgSrc}" alt="عکس پروفایل" class="profile-header-image" onerror="this.src='https://placehold.co/128x128/2196F3/FFFFFF?text=U';">
                        <div class="profile-header-edit-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                    </label>
                    <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
                    <div class="mt-4">
                        <h2 class="text-2xl font-bold text-slate-800">${name.trim() ? name : 'کاربر'}</h2>
                        <p class="text-md font-semibold text-sky-600">${roleText}</p>
                        <p class="text-sm text-slate-500 mt-2">${userData.email}</p>
                    </div>
                    <div class="mt-6 pt-6 border-t border-slate-200 w-full flex items-center justify-center gap-4">
                        <a data-view="settings" class="nav-icon-btn group">
                            <i class="fas fa-cog !ml-0"></i>
                            <div class="nav-tooltip">تنظیمات</div>
                        </a>
                        <a href="#" id="logoutButton" class="nav-icon-btn group">
                            <i class="fas fa-sign-out-alt !ml-0"></i>
                            <div class="nav-tooltip">خروج</div>
                        </a>
                    </div>
                </div>`;

            const sections = [
                { id: 'personal', title: 'مشخصات فردی', icon: 'fa-user-circle', content: getPersonalFieldsHTML(userData.stepsData.step1, userData.role) },
                { id: 'contact', title: 'اطلاعات تماس', icon: 'fa-address-card', content: getContactFieldsHTML(userData.stepsData.step2, userData.role) },
                { id: 'professional', title: 'اطلاعات حرفه‌ای', icon: 'fa-briefcase', content: getProfessionalFieldsHTML(userData.stepsData.step3, userData.role) },
                { id: 'documents', title: 'مدارک', icon: 'fa-file-alt', content: getDocumentsHTML(userData.files, userData.role) }
            ];

            let sectionsHtml = '';
            sections.forEach(section => {
                sectionsHtml += getSectionHTML(section.id, section.title, section.icon, section.content);
            });

            profileContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">${profileSideColumnHtml}</div>
                    <div class="lg:col-span-2 space-y-6">${sectionsHtml}</div>
                </div>
            `;
            
            attachSectionEventListeners();

            const firstSectionHeader = profileContent.querySelector('.section-header');
            if (firstSectionHeader && !firstSectionHeader.classList.contains('open')) {
                firstSectionHeader.click();
            }
            
            profileContent.querySelector('a[data-view="settings"]').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('settings-nav-item').click();
            });

            profileContent.querySelector('#logoutButton').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('logout-nav-item').click();
            });

            initializeCropper();
        }
        
        function getSectionHTML(id, title, icon, content) {
            return `
                <div id="section-${id}" class="profile-section">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas ${icon}"></i>${title}</h3>
                        <div class="flex items-center gap-4">
                            <button data-action="edit" data-section="${id}" class="btn btn-secondary !p-2 text-sm"><i class="fas fa-edit mr-1"></i> ویرایش</button>
                            <button type="button" data-action="cancel" data-section="${id}" class="btn btn-secondary hidden"><i class="fas fa-times mr-2"></i>انصراف</button>
                            <button type="button" data-action="save" data-section="${id}" class="btn btn-primary hidden"><i class="fas fa-save mr-2"></i>ذخیره</button>
                            <i class="fas fa-chevron-down section-toggle-icon"></i>
                        </div>
                    </div>
                    <div class="section-content">
                        <form id="form-${id}">
                            ${content}
                        </form>
                    </div>
                </div>
            `;
        }
        
function getPersonalFieldsHTML(data, role) {
    const prefix = role === 'engineer' ? 'engineer' : 'employer';
    const jalaliDob = data[`${prefix}Dob`] || '';

    return `<div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">
        <div><label class="block text-sm font-medium text-slate-700 mb-1">نام</label><input type="text" name="${prefix}FirstName" value="${data[`${prefix}FirstName`] || ''}" disabled></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">نام خانوادگی</label><input type="text" name="${prefix}LastName" value="${data[`${prefix}LastName`] || ''}" disabled></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">کدملی</label><input type="text" name="${prefix}NationalId" value="${data[`${prefix}NationalId`] || ''}" disabled></div>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">تاریخ تولد</label>
            <input type="text" id="${prefix}Dob" name="${prefix}Dob" value="${jalaliDob}" class="kama-datepicker" placeholder="YYYY-MM-DD" disabled>
        </div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">جنسیت</label><select name="${prefix}Gender" disabled><option value="مرد" ${data[`${prefix}Gender`] === 'مرد' ? 'selected' : ''}>مرد</option><option value="زن" ${data[`${prefix}Gender`] === 'زن' ? 'selected' : ''}>زن</option></select></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">تلفن موبایل</label><input type="tel" name="${prefix}Mobile" value="${data[`${prefix}Mobile`] || ''}" disabled></div>
    </div>`;
}
        
function getContactFieldsHTML(data, role) {
    const prefix = role === 'engineer' ? 'engineer' : 'employer';
    const address = (role === 'employer' ? data.employerAddress : data.engineerResidentialAddress) || '';
    const mapId = `${prefix}LocationMap`; // شناسه نقشه: engineerLocationMap یا employerLocationMap

    return `<div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5">
        <div><label class="block text-sm font-medium text-slate-700 mb-1">تلفن ثابت</label><input type="text" name="${prefix}Phone" value="${data[`${prefix}Phone`] || ''}" disabled></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">کدپستی</label><input type="text" name="${prefix}PostalCode" value="${data[`${prefix}PostalCode`] || ''}" disabled></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">استان</label><select name="${prefix}Province" disabled>${generateProvinceOptions(data[`${prefix}Province`])}</select></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">شهر</label><input type="text" name="${prefix}City" value="${data[`${prefix}City`] || ''}" disabled></div>
    </div>
    <div class="mt-6">
        <label class="block text-sm font-medium text-slate-700 mb-1">آدرس سکونت</label>
        <div id="${mapId}" class="map-container w-full mb-2"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <textarea name="${prefix}Address" rows="3" class="w-full" disabled>${address}</textarea>
            <div id="${mapId}Info" class="map-info-display p-3 rounded-md">
                ${(role === 'employer' ? data.employerAddressNeighborhood : data.engineerResidentialNeighborhood) ? `<p>${(role === 'employer' ? data.employerAddressNeighborhood : data.engineerResidentialNeighborhood)}</p>` : `<span class="text-slate-500 italic">موقعیت مکانی روی نقشه مشخص نشده است.</span>`}
            </div>
        </div>
        <input type="hidden" name="${mapId}Lat" value="${(role === 'employer' ? data.employerAddressLat : data.engineerResidentialLat) || ''}">
        <input type="hidden" name="${mapId}Lng" value="${(role === 'employer' ? data.employerAddressLng : data.engineerResidentialLng) || ''}">
        <input type="hidden" name="${mapId}Neighborhood" value="${(role === 'employer' ? data.employerAddressNeighborhood : data.engineerResidentialNeighborhood) || ''}">
    </div>`;
}
        
function getProfessionalFieldsHTML(data, role) {
    if (role === 'employer') {
        const hasCompany = data.employerHasCompany;
        if (!hasCompany) {
            return '<p class="text-slate-500">این کارفرما به عنوان شخص حقیقی فعالیت می‌کند.</p>';
        }
        const mapId = 'employerCompanyMap'; // شناسه نقشه
        return `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">نام شرکت</label><input type="text" name="employerCompanyName" value="${data.employerCompanyName || ''}" disabled></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">شماره ثبت شرکت</label><input type="text" name="employerCompanyRegNumber" value="${data.employerCompanyRegNumber || ''}" disabled></div>
            </div>
            <div class="mt-6">
                <label class="block text-sm font-medium text-slate-700 mb-1">آدرس شرکت</label>
                <div id="${mapId}" class="map-container w-full mb-2"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea name="employerCompanyAddress" rows="3" class="w-full" disabled>${data.employerCompanyAddress || ''}</textarea>
                    <div id="${mapId}Info" class="map-info-display p-3 rounded-md">
                        ${data.employerCompanyAddressNeighborhood ? `<p>${data.employerCompanyAddressNeighborhood}</p>` : `<span class="text-slate-500 italic">موقعیت مکانی روی نقشه مشخص نشده است.</span>`}
                    </div>
                </div>
                <input type="hidden" name="${mapId}Lat" value="${data.employerCompanyAddressLat || ''}">
                <input type="hidden" name="${mapId}Lng" value="${data.employerCompanyAddressLng || ''}">
                <input type="hidden" name="${mapId}Neighborhood" value="${data.employerCompanyAddressNeighborhood || ''}">
            </div>
        `;
    }

    if (role === 'engineer') {
        return getProfessionalFieldsHTMLEditable(data, true);
    }
    return '<p class="text-slate-500">اطلاعات حرفه‌ای برای این کاربر یافت نشد.</p>';
}

function getProfessionalFieldsHTMLEditable(data, isDisabled) {
    const disabledAttr = isDisabled ? 'disabled' : '';
    const gradeMap = { '3': 'پایه ۳', '2': 'پایه ۲', '1': 'پایه ۱', 'arshad': 'پایه ارشد' };
    const executorTypeMap = { 'individual': 'حقیقی', 'legal': 'حقوقی', 'none': 'فعالیت ندارم' };

    // مقادیر تاریخ شمسی را مستقیماً از داده‌ها می‌خوانیم. دیگر نیازی به تبدیل نیست.
    const jalaliFirstIssueDate = data.licenseFirstIssueDate || '';
    const jalaliStartDate = data.licenseStartDate || '';

    const createGradeSelect = (name, selected, disabled) => {
        let options = '<option value="">انتخاب پایه</option>';
        for (const [key, value] of Object.entries(gradeMap)) {
            options += `<option value="${key}" ${key === selected ? 'selected' : ''}>${value}</option>`;
        }
        return `<select name="${name}" ${disabled} class="block w-full sm:text-sm bg-slate-100 mb-2">${options}</select>`;
    };

    const createExecutorRadios = (name, selected, disabled) => {
        let radios = '';
        for (const [key, value] of Object.entries(executorTypeMap)) {
            radios += `<label class="inline-flex items-center"><input type="radio" name="${name}" value="${key}" ${key === selected ? 'checked' : ''} ${disabled} class="form-radio h-3 w-3 text-sky-600"><span class="mr-1 ml-1">${value}</span></label>`;
        }
        return `<div class="flex flex-col space-y-1 text-xs">${radios}</div>`;
    };
            
    return `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6">
        <div>
            <label for="licenseFirstIssueDate" class="block text-sm font-medium text-slate-700 mb-1 required-field">تاریخ اولین صدور پروانه</label>
            <input type="text" id="licenseFirstIssueDate" name="licenseFirstIssueDate" value="${jalaliFirstIssueDate}" class="kama-datepicker" placeholder="YYYY-MM-DD" ${disabledAttr}>
        </div>
        <div>
            <label for="licenseStartDate" class="block text-sm font-medium text-slate-700 mb-1 required-field">تاریخ شروع اعتبار پروانه</label>
            <input type="text" id="licenseStartDate" name="licenseStartDate" value="${jalaliStartDate}" class="kama-datepicker" placeholder="YYYY-MM-DD" ${disabledAttr}>
        </div>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1 required-field">مدت اعتبار پروانه (سال)</label>
            <input type="number" name="licenseValidity" min="1" required class="mt-1 block w-full sm:text-sm" value="${data.licenseValidity || ''}" ${disabledAttr}>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6 pt-6">
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1 required-field">شماره پروانه</label>
            <input type="text" name="licenseNumber" required class="mt-1 block w-full sm:text-sm" placeholder="0-13-30-012345" maxlength="14" value="${data.licenseNumber || ''}" ${disabledAttr}>
        </div>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1 required-field">شماره عضویت</label>
            <input type="text" name="membershipNumber" required class="mt-1 block w-full sm:text-sm" value="${data.membershipNumber || ''}" ${disabledAttr}>
        </div>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1 required-field">استان فعالیت پروانه</label>
            <select name="licenseActivityProvince" required class="mt-1 block w-full sm:text-sm" ${disabledAttr}>
                ${generateProvinceOptions(data.licenseActivityProvince, true)}
            </select>
        </div>
    </div>
    <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-5">
        <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
            <div class="flex items-center space-x-2 space-x-reverse mb-1">
                <input type="checkbox" name="hasDesignLicense" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.hasDesignLicense ? 'checked' : ''} ${disabledAttr}>
                <label class="text-sm font-medium text-slate-700">پروانه طراحی</label>
            </div>
            <div>${createGradeSelect('designLicenseGrade', data.designLicenseGrade, disabledAttr || !data.hasDesignLicense)}</div>
            <div><label class="block text-xs font-medium text-slate-600 mb-1 mt-2">نوع صلاحیت طراحی:</label>${createExecutorRadios('designExecutorType', data.designExecutorType || 'none', disabledAttr)}</div>
        </div>
        <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
            <div class="flex items-center space-x-2 space-x-reverse mb-1">
                <input type="checkbox" name="hasSupervisionLicense" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.hasSupervisionLicense ? 'checked' : ''} ${disabledAttr}>
                <label class="text-sm font-medium text-slate-700">پروانه نظارت</label>
            </div>
            <div>${createGradeSelect('supervisionLicenseGrade', data.supervisionLicenseGrade, disabledAttr || !data.hasSupervisionLicense)}</div>
            <div><label class="block text-xs font-medium text-slate-600 mb-1 mt-2">نوع صلاحیت نظارت:</label>${createExecutorRadios('supervisionExecutorType', data.supervisionExecutorType || 'none', disabledAttr)}</div>
        </div>
        <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
            <div class="flex items-center space-x-2 space-x-reverse mb-1">
                <input type="checkbox" name="hasExecutionLicense" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.hasExecutionLicense ? 'checked' : ''} ${disabledAttr}>
                <label class="text-sm font-medium text-slate-700">پروانه اجرا</label>
            </div>
            <div>${createGradeSelect('executionLicenseGrade', data.executionLicenseGrade, disabledAttr || !data.hasExecutionLicense)}</div>
            <div><label class="block text-xs font-medium text-slate-600 mb-1 mt-2">نوع صلاحیت اجرا:</label>${createExecutorRadios('executionExecutorType', data.executionExecutorType || 'none', disabledAttr)}</div>
        </div>
    </div>
    <div id="legalExecutorFields" class="mt-8 space-y-6 bg-slate-100 p-5 rounded-lg border border-slate-200">
        <h3 class="text-md font-semibold">اطلاعات شرکت حقوقی</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1 required-field">نام شرکت حقوقی</label>
                <input type="text" name="companyName" class="mt-1 block w-full sm:text-sm" value="${data.companyName || ''}" ${disabledAttr}>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">شماره ثبت شرکت</label>
                <input type="text" name="companyRegNumber" class="mt-1 block w-full sm:text-sm" value="${data.companyRegNumber || ''}" ${disabledAttr}>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">آدرس دفتر شرکت</label>
            <div id="companyOfficeMap" class="map-container w-full mb-2 min-h-[220px]"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <textarea name="companyOfficeAddress" rows="3" class="mt-1 block w-full sm:text-sm" ${disabledAttr}>${data.companyOfficeAddress || ''}</textarea>
                <div id="companyOfficeMapInfo" class="map-info-display p-3 rounded-md">
                    ${data.companyOfficeMapNeighborhood || 'موقعیت مکانی روی نقشه مشخص نشده است.'}
                </div>
            </div>
            <input type="hidden" name="companyOfficeMapLat" value="${data.companyOfficeMapLat || ''}">
            <input type="hidden" name="companyOfficeMapLng" value="${data.companyOfficeMapLng || ''}">
            <input type="hidden" name="companyOfficeMapNeighborhood" value="${data.companyOfficeMapNeighborhood || ''}">
        </div>
    </div>
    <div id="individualExecutorFieldsContainer">
        <div id="individualExecutorFields" class="mt-8 bg-slate-100 p-5 rounded-lg border border-slate-200">
            <h3 class="text-md font-semibold mb-2">اطلاعات مهندس حقیقی (اجرا)</h3>
            <div class="flex items-center">
                <input type="checkbox" name="isAssistantExecutor" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.isAssistantExecutor ? 'checked' : ''} ${disabledAttr}>
                <label class="ml-2 mr-2 block text-sm text-slate-700">فقط کمک مجری هستم</label>
            </div>
        </div>
        <div class="mt-8"> 
            <div class="flex items-center mb-4">
                <input type="checkbox" name="engineerHasOfficeInfo" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.engineerHasOfficeInfo ? 'checked' : ''} ${disabledAttr}>
                <label class="ml-2 mr-2 block text-sm text-slate-700">دفتر کار دارم</label>
            </div>
            <div id="engineerOfficeInfoFields" class="space-y-6 bg-slate-100 p-5 rounded-lg border border-slate-200">
                <h3 class="text-lg font-semibold">اطلاعات دفتر کار</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1 required-field">نام دفتر کار مهندسی</label>
                        <input type="text" name="officeName" class="mt-1 block w-full sm:text-sm" value="${data.officeName || ''}" ${disabledAttr}>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1 required-field">تلفن دفتر کار</label>
                        <input type="tel" name="officePhone" class="mt-1 block w-full sm:text-sm" value="${data.officePhone || ''}" ${disabledAttr}>
                    </div>
                </div>
                <label class="block text-sm font-medium text-slate-700 mb-1">آدرس دفتر کار</label>
                <div id="officeMap" class="map-container w-full mb-2 min-h-[220px]"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea name="officeAddress" rows="3" class="mt-1 block w-full sm:text-sm" ${disabledAttr}>${data.officeAddress || ''}</textarea>
        
                    <div id="officeMapInfo" class="map-info-display p-3 rounded-md">
                        ${data.officeMapNeighborhood || 'موقعیت مکانی روی نقشه مشخص نشده است.'}
                    </div>
                </div>
                <input type="hidden" name="officeMapLat" value="${data.officeMapLat || ''}">
                <input type="hidden" name="officeMapLng" value="${data.officeMapLng || ''}">
                <input type="hidden" name="officeMapNeighborhood" value="${data.officeMapNeighborhood || ''}">
            </div>
        </div>
    </div>
    `;
}
        
        function getDocumentsHTML(data, role) {
            const nationalIdKey = role === 'engineer' ? 'nationalIdCardImageEngineer' : 'employerNationalIdCardImage';
            const workPermitKey = 'workPermitPdf';
            const resumeKey = 'employerOtherDocs';
            const nationalIdUrl = getDirectDriveLink(data[nationalIdKey]?.fileUrl);
            const workPermitUrl = getDirectDriveLinkForPdf(data[workPermitKey]?.fileUrl);
            const resumeUrl = getDirectDriveLinkForPdf(data[resumeKey]?.fileUrl);
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
            html += `<div><h4 class="font-semibold mb-2">تصویر کارت ملی</h4><div class="file-preview-container">${nationalIdUrl ? `<img src="${nationalIdUrl}" onerror="this.parentElement.innerHTML = '<i class=\\'fas fa-image text-slate-400\\'></i><p>نمایش ممکن نیست</p>';">` : `<i class="fas fa-image"></i><p>فایل یافت نشد</p>`}</div></div>`;
            if (role === 'engineer') {
                html += `<div><h4 class="font-semibold mb-2">پروانه اشتغال (PDF)</h4><div class="file-preview-container">${workPermitUrl ? `<iframe src="${workPermitUrl}"></iframe>` : '<i class="fas fa-file-pdf"></i><p>فایل یافت نشد</p>'}</div></div>`;
            }
            if (role === 'employer') {
                 html += `<div><h4 class="font-semibold mb-2">رزومه (اختیاری)</h4><div class="file-preview-container">${resumeUrl ? `<iframe src="${resumeUrl}"></iframe>` : '<i class="fas fa-file-alt"></i><p>ارسال نشده</p>'}</div></div>`;
            }
            html += '</div>';
            return html;
        }

        function attachSectionEventListeners() {
             document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('button[data-action="edit"]')) return;
                    const content = header.nextElementSibling;
                    header.classList.toggle('open');
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                    if (content.style.display === 'block') {
                        content.querySelectorAll('.map-container').forEach(mapDiv => {
                           if (!mapDiv.classList.contains('map-initialized')) {
                                initializeProfileMap(mapDiv.id, false);
                                mapDiv.classList.add('map-initialized');
                           }
                        });
                    }
                });
            });
            document.querySelectorAll('button[data-action="edit"]').forEach(b => b.addEventListener('click', handleEditClick));
            document.querySelectorAll('button[data-action="cancel"]').forEach(b => b.addEventListener('click', handleCancelClick));
            document.querySelectorAll('button[data-action="save"]').forEach(b => b.addEventListener('click', handleSaveClick));
        }

function initializeProfileMap(mapId, isEditable) {
    const mapContainer = document.getElementById(mapId);
    if (!mapContainer) return;
    const form = mapContainer.closest('form');
    if (!form) return;

    // نام دقیق فیلدها را بر اساس شناسه نقشه می‌سازیم
    const latInputName = mapId + 'Lat';
    const lngInputName = mapId + 'Lng';
    const neighborhoodInputName = mapId + 'Neighborhood';

    const latInput = form.querySelector(`input[name="${latInputName}"]`);
    const lngInput = form.querySelector(`input[name="${lngInputName}"]`);
    const neighborhoodInput = form.querySelector(`input[name="${neighborhoodInputName}"]`);

    if (!latInput || !lngInput) {
        console.error(`Inputs for map ${mapId} not found. Looked for names: ${latInputName}, ${lngInputName}`);
        return;
    };
    
    const mapInfoDiv = document.getElementById(`${mapId}Info`);
    
    if (activeMaps[mapId]) {
        activeMaps[mapId].remove();
        delete activeMaps[mapId];
    }
    
    const lat = parseFloat(latInput.value) || 38.08;
    const lng = parseFloat(lngInput.value) || 46.29;
    const map = L.map(mapId).setView([lat, lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    let marker;
    if (isEditable) {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        map.on('click', (e) => {
            marker.setLatLng(e.latlng);
            updateMapLocationUI(e.latlng.lat, e.latlng.lng, latInput, lngInput, neighborhoodInput, mapInfoDiv);
        });
        marker.on('dragend', () => {
            const ll = marker.getLatLng();
            updateMapLocationUI(ll.lat, ll.lng, latInput, lngInput, neighborhoodInput, mapInfoDiv);
        });
    } else {
        marker = L.marker([lat, lng]).addTo(map);
    }
    activeMaps[mapId] = map;
    
    setTimeout(() => map.invalidateSize(), 100);
}

        async function updateMapLocationUI(lat, lng, latInput, lngInput, neighborhoodInput, mapInfoDiv) {
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);
            if (mapInfoDiv) mapInfoDiv.innerHTML = `<span class="italic text-slate-500">در حال دریافت نام محله...</span>`;
            
            const address = await getAddressFromLatLng(lat, lng);
            if (neighborhoodInput) neighborhoodInput.value = address;
            if (mapInfoDiv) mapInfoDiv.innerHTML = `<p>${address}</p>`;
        }
        
function handleEditClick(e) {
    const sectionId = e.currentTarget.dataset.section;
    const sectionEl = document.getElementById(`section-${sectionId}`);
    if (sectionId === 'documents') {
        showModal('ویرایش مدارک در این بخش پشتیبانی نمی‌شود...', 'info');
        return;
    }

    sectionEl.querySelector('button[data-action="edit"]').classList.add('hidden');
    sectionEl.querySelector('button[data-action="save"]').classList.remove('hidden');
    sectionEl.querySelector('button[data-action="cancel"]').classList.remove('hidden');

    const formEl = sectionEl.querySelector('form');
    if (sectionId === 'professional' && userData.role === 'engineer') {
        formEl.innerHTML = getProfessionalFieldsHTMLEditable(userData.stepsData.step3, false) + formEl.querySelector('.section-actions').outerHTML;
    }

    // فعال‌سازی همه فیلدهای فرم
    formEl.querySelectorAll('input, select, textarea').forEach(el => {
        el.disabled = false;

        // فعال‌سازی تقویم KamaDatePicker
        if (el.classList.contains('kama-datepicker')) {
            kamaDatepicker(el.id, {
                format: 'YYYY-MM-DD',
                buttonsColor: "blue",
                forceFarsiDigits: true,
                markToday: true,
                gotoToday: true,
                sync: true, // تاریخ انتخاب شده را در فیلد قرار می‌دهد
                closeAfterSelect: true // پس از انتخاب، تقویم بسته می‌شود
            });
        }
    });

    formEl.querySelectorAll('.map-container').forEach(mapDiv => {
        // و به تابع سازنده نقشه دستور می‌دهد آنها را در حالت قابل ویرایش (true) بازسازی کند
        initializeProfileMap(mapDiv.id, true);
    });    

    if (sectionId === 'professional') {
        attachProfessionalFieldsListeners(formEl);
        updateProfessionalInfoVisibility(formEl);
    }

    sectionEl.querySelector('button[data-action="cancel"]').addEventListener('click', handleCancelClick);
    sectionEl.querySelector('button[data-action="save"]').addEventListener('click', handleSaveClick);
}
        
        function handleCancelClick(e) { renderProfile(); }
        
        async function handleSaveClick(e) {
            const sectionId = e.currentTarget.dataset.section;
            const form = document.getElementById(`form-${sectionId}`);
            const dataToSave = Object.fromEntries(new FormData(form).entries());
            
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                dataToSave[cb.name] = cb.checked;
            });

            await updateProfileSection(sectionId, dataToSave);
        }

        function attachProfessionalFieldsListeners(formEl) {
            formEl.querySelectorAll('input[name*="has"], input[name*="ExecutorType"], input[name="engineerHasOfficeInfo"]').forEach(el => {
                el.addEventListener('change', () => updateProfessionalInfoVisibility(formEl));
            });
        }

        function updateProfessionalInfoVisibility(formEl) {
            const getVal = (name) => formEl.querySelector(`input[name="${name}"]:checked`)?.value;
            const isChecked = (name) => formEl.querySelector(`input[name="${name}"]`)?.checked;

            const designType = getVal('designExecutorType');
            const supervisionType = getVal('supervisionExecutorType');
            const executionType = getVal('executionExecutorType');
            
            const isAnyLegal = designType === 'legal' || supervisionType === 'legal' || executionType === 'legal';
            const isAnyIndividual = designType === 'individual' || supervisionType === 'individual' || executionType === 'individual';
            const isExecutionIndividual = executionType === 'individual';

            formEl.querySelector('#legalExecutorFields').style.display = isAnyLegal ? 'block' : 'none';
            formEl.querySelector('#individualExecutorFieldsContainer').style.display = isAnyIndividual ? 'block' : 'none';
            formEl.querySelector('#individualExecutorFields').style.display = isExecutionIndividual ? 'block' : 'none';
            formEl.querySelector('#engineerOfficeInfoFields').style.display = isChecked('engineerHasOfficeInfo') ? 'block' : 'none';
            
            formEl.querySelector('select[name="designLicenseGrade"]').disabled = !isChecked('hasDesignLicense');
            formEl.querySelector('select[name="supervisionLicenseGrade"]').disabled = !isChecked('hasSupervisionLicense');
            formEl.querySelector('select[name="executionLicenseGrade"]').disabled = !isChecked('hasExecutionLicense');
        }
        
        function initializeCropper() {
            const profileImageInput = document.getElementById('profileImageInput');
            if (!profileImageInput) return; 

            profileImageInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        document.getElementById('imageToCrop').src = reader.result;
                        document.getElementById('cropperModal').style.display = 'flex';
                        if (cropper) cropper.destroy();
                        cropper = new Cropper(document.getElementById('imageToCrop'), {
                            aspectRatio: 1, viewMode: 1, background: false, responsive: true,
                            modal: true, guides: true, center: true, highlight: false,
                            cropBoxMovable: true, cropBoxResizable: true,
                        });
                    };
                    reader.readAsDataURL(files[0]);
                }
            });

            document.getElementById('cancelCropButton').addEventListener('click', () => {
                document.getElementById('cropperModal').style.display = 'none';
                if (cropper) cropper.destroy();
                profileImageInput.value = '';
            });

            document.getElementById('cropAndSaveButton').addEventListener('click', () => {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' });
                    canvas.toBlob(async (blob) => {
                        document.getElementById('cropperModal').style.display = 'none';
                        cropper.destroy();
                        await uploadCroppedImage(blob);
                    }, 'image/png');
                }
            });
        }
        
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function uploadCroppedImage(blob) {
            welcomeLoader.style.opacity = '1';
            welcomeLoader.style.display = 'flex';
            try {
                const base64Data = await blobToBase64(blob);
                const payload = {
                    action: 'updateProfilePicture',
                    email: userData.email,
                    fileData: {
                        fileName: 'profile_image.png',
                        mimeType: blob.type,
                        base64Data: base64Data
                    }
                };

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success' && result.newUrl) {
                    showModal('عکس پروفایل با موفقیت به‌روز شد.', 'success');
                    const newImageUrl = getDirectDriveLink(result.newUrl);
    
                    // آپدیت عکس کوچک سایدبار
                    sidebarProfileImage.src = newImageUrl;
    
                    // این خط جدید، عکس بزرگ پروفایل را نیز آپدیت می‌کند
                    document.getElementById('mainProfileImage').src = newImageUrl;

                    userData.files.applicantImage.fileUrl = result.newUrl;
                } else {
                    throw new Error(result.message || "Failed to upload image.");
                }
            } catch (error) {
                console.error("Error uploading cropped image:", error);
                showModal(`خطا در آپلود عکس: ${error.message}`, 'error');
            } finally {
                welcomeLoader.style.opacity = '0';
                setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
            }
        }

        // تابع شماره ۱: متخصص مرکزی (راهنمای تور)
        function switchToView(view, clickedElement) {

            currentView = view;
            
            allContentBodies.forEach(el => el.style.display = 'none');
            document.querySelectorAll('#bottom-nav .nav-icon-btn').forEach(nav => nav.classList.remove('active'));

            const toCamelCase = str => str.replace(/-./g, s => s[1].toUpperCase());
            const viewId = toCamelCase(view) + 'Content';
            const contentEl = document.getElementById(viewId);

            if (contentEl) contentEl.style.display = 'block';

            // infoBoxText.textContent = viewInfo[view] || 'اطلاعات این بخش در اینجا نمایش داده می‌شود.';
            
            // --- شروع منطق جدید و دقیق برای نمایش/مخفی‌سازی دکمه‌ها ---
            const homeBtn = document.getElementById('home-nav-item');
            const profileBtn = document.getElementById('profile-nav-item');
            const myItemsBtn = document.getElementById('my-items-nav-item');
            const searchBtn = document.getElementById('search-nav-item');
            const createProjectBtn = document.getElementById('create-project-nav-item');
            const createActivityBtn = document.getElementById('create-activity-nav-item');
            const notificationsBtn = document.getElementById('notifications-nav-item');
            const settingsBtn = document.getElementById('settings-nav-item');
            const logoutBtn = document.getElementById('logout-nav-item');

            if (view === 'dashboard') { // اگر در صفحه خانه هستیم
                // این دکمه‌ها مخفی شوند
                homeBtn.style.display = 'none';
                profileBtn.style.display = 'none';
                myItemsBtn.style.display = 'none';
                searchBtn.style.display = 'none';
                createProjectBtn.style.display = 'none';
                createActivityBtn.style.display = 'none';
                
                // این دکمه‌ها نمایش داده شوند
                notificationsBtn.style.display = 'flex';
                settingsBtn.style.display = 'flex';
                logoutBtn.style.display = 'flex';

            } else { // اگر در صفحات داخلی هستیم
                // این دکمه‌ها نمایش داده شوند
                homeBtn.style.display = 'flex';
                profileBtn.style.display = 'flex';
                // این تابع دکمه‌های مخصوص نقش کاربر را نمایش می‌دهد
                setupRoleSpecificUI(userData); 

                // این دکمه‌ها مخفی شوند
                notificationsBtn.style.display = 'none';
                settingsBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
            
            switch(view) {
                case 'dashboard': (userData.role === 'employer' ? renderEmployerDashboard : renderEngineerDashboard)(); break;
                case 'profile': if (!document.getElementById('profileContent').innerHTML.includes('profile-header-container')) renderProfile(); break;
                case 'notifications': renderNotifications(); break;
                case 'projects': (userData.role === 'employer' ? renderEmployerProjects : renderProjectMarketplace)(); break;
                case 'my-activities': renderMyActivities(); break;
                case 'engineers': renderEngineersPanel(); break;
                case 'create-project': renderProjectForm(); break;
                case 'create-activity': renderActivityForm(); break;
                case 'settings': break; 
            }

            // فقط دکمه‌ای که روی آن کلیک شده آبی (فعال) می‌شود
            if (clickedElement) {
                clickedElement.classList.add('active');
            }
        }

        // تابع شماره ۲: مدیر (فقط به دکمه‌های منوی اصلی گوش می‌دهد)
        function setupViewSwitcher() {
            // آدرس قدیمی: '.sidebar .nav-item[data-view]'
            // آدرس جدید به دکمه‌های داخل نوار فوتر اشاره می‌کند
            const navItems = document.querySelectorAll('#bottom-nav .nav-icon-btn[data-view]');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    // از نزدیکترین تگ a والد استفاده می‌کنیم تا مطمئن شویم خود دکمه انتخاب شده
                    const button = e.target.closest('a');
                    const view = button.dataset.view;
                    switchToView(view, button);
                });
            });

            // این دو دکمه چون data-view ندارند، جداگانه فعال می‌شوند
            document.getElementById('refresh-nav-item').addEventListener('click', (e) => {
                e.preventDefault();
                refreshCurrentView();
            });

            document.getElementById('logout-nav-item').addEventListener('click', (e) => {
                e.preventDefault();
                showModal('آیا می‌خواهید از حساب کاربری خود خارج شوید؟', 'confirm', () => {
                    window.location.href = window.location.pathname; 
                });
            });
        }
        
        async function refreshCurrentView() {
            // اگر صفحه فعلی مشخص نبود، کاری انجام نده
            if (!currentView) return;

            // پیدا کردن دکمه مربوط به صفحه فعلی برای فعال نگه داشتن آن
            const currentButton = document.querySelector(`.nav-icon-btn[data-view="${currentView}"]`);
            
            // پیدا کردن محتوای صفحه فعلی و نمایش یک اسپینر لودینگ
            const viewId = currentView.replace(/-./g, s => s[1].toUpperCase()) + 'Content';
            const contentEl = document.getElementById(viewId);
            if (contentEl) {
                contentEl.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            }

            // با یک تاخیر کوتاه، تابع اصلی جابجایی صفحه را دوباره صدا می‌زنیم
            // این تابع به طور خودکار تمام داده‌های جدید را از سرور دریافت و صفحه را بازسازی می‌کند
            setTimeout(() => {
                switchToView(currentView, currentButton);
            }, 100); 
        }
        
        async function handleChangePassword(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const btnText = btn.querySelector('span');
            const spinner = btn.querySelector('.spinner');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) return showModal('لطفاً تمام فیلدها را پر کنید.', 'error');
            if (newPassword !== confirmNewPassword) return showModal('رمز عبور جدید و تکرار آن یکسان نیستند.', 'error');
            if (newPassword.length < 6) return showModal('رمز عبور جدید باید حداقل ۶ کاراکتر باشد.', 'error');

            btn.disabled = true; btnText.classList.add('hidden'); spinner.classList.remove('hidden');
            try {
                const payload = { action: 'changePassword', email: userData.email, currentPassword, newPassword };
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`خطای سرور: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    changePasswordForm.reset();
                } else { throw new Error(result.message || 'خطای ناشناخته.'); }
            } catch (error) {
                showModal(error.message, 'error');
            } finally {
                btn.disabled = false; btnText.classList.remove('hidden'); spinner.classList.add('hidden');
            }
        }

        function setupPasswordToggle() {
            document.querySelectorAll('.password-toggle-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const targetId = icon.dataset.target;
                    const passwordInput = document.getElementById(targetId);
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });
        }
        
        // --- All other functions from the original file are included below ---
        // --- They are not dummy functions anymore ---

function renderProjectForm(projectData = null) {
    const createProjectContent = document.getElementById('createProjectContent');
    const isEditMode = projectData !== null;
    // ساختار جدید HTML با چیدمان درخواستی شما
    createProjectContent.innerHTML = `
        <div id="projectEditCard" class="project-card bg-white rounded-lg overflow-hidden">
            <form id="projectForm">
                ${isEditMode ? `<input type="hidden" id="ProjectID" name="ProjectID" value="${projectData.ProjectID}">` : ''}
                <div class="p-6 space-y-6">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div><label for="projectName" class="block text-gray-700 font-medium mb-1 required-field">نام پروژه</label><input type="text" id="projectName" name="projectName" required value="${projectData?.projectName || ''}"></div>
                        <div><label for="ownerName" class="block text-gray-700 font-medium mb-1 required-field">نام کامل مالک</label><input type="text" id="ownerName" name="ownerName" required value="${projectData?.ownerName || ''}"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5">
                        <div><label for="province" class="block text-gray-700 font-medium mb-1 required-field">استان</label><select id="province" name="province" required>${generateProvinceOptions(projectData?.province || '')}</select></div>
                        <div><label for="city" class="block text-gray-700 font-medium mb-1 required-field">شهر</label><input type="text" id="city" name="city" required value="${projectData?.city || ''}"></div>
                        <div><label for="district" class="block text-gray-700 font-medium mb-1 required-field">منطقه شهرداری</label><input type="number" id="district" name="district" min="1" required value="${projectData?.district || ''}"></div>
                        <div><label for="usageType" class="block text-gray-700 font-medium mb-1 required-field">کاربری ملک</label><select id="usageType" name="usageType" required><option value="مسکونی">مسکونی</option><option value="تجاری">تجاری</option><option value="اداری">اداری</option><option value="صنعتی">صنعتی</option><option value="کشاورزی">کشاورزی</option></select></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5">
                        <div><label for="fileType" class="block text-gray-700 font-medium mb-1 required-field">نوع پرونده</label><select id="fileType" name="fileType" required><option value="عادی">عادی</option><option value="فرسوده">فرسوده</option></select></div>
                        <div><label for="permitNumber" class="block text-gray-700 font-medium mb-1 required-field">شماره پروانه</label><input type="text" id="permitNumber" name="permitNumber" required value="${projectData?.permitNumber || ''}"></div>
                        <div><label for="permitValidity" class="block text-gray-700 font-medium mb-1 required-field">اعتبار پروانه (ماه)</label><input type="number" id="permitValidity" name="permitValidity" min="1" required value="${projectData?.permitValidity || ''}"></div>
                        <div><label for="contractMonths" class="block text-gray-700 font-medium mb-1 required-field">مدت قرارداد (ماه)</label><input type="number" id="contractMonths" name="contractMonths" min="1" required value="${projectData?.contractMonths || ''}"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5">
                        <div><label for="area" class="block text-gray-700 font-medium mb-1 required-field">متراژ (مترمربع)</label><input type="number" id="area" name="area" min="1" required value="${projectData?.area || ''}"></div>
                        <div><label for="area_d" class="block text-gray-700 font-medium mb-1">متراژ با اعمال بخش فرسوده</label><input type="number" id="area_d" name="area_d" min="1" value="${projectData?.area_d || ''}" disabled></div>
                        <div><label for="floors" class="block text-gray-700 font-medium mb-1 required-field">تعداد طبقات</label><input type="number" id="floors" name="floors" min="1" required value="${projectData?.floors || ''}"></div>
                        <div><label for="basementFloors" class="block text-gray-700 font-medium mb-1 required-field">طبقات زیرزمین</label><input type="number" id="basementFloors" name="basementFloors" min="0" required value="${projectData?.basementFloors || '0'}"></div>
                        
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-1 required-field">آدرس ملک</label>
                        <div class="flex items-center mb-2 text-sm text-gray-500">
                            <span>طول جغرافیایی: </span><span id="longitudeValue" class="mr-2 font-mono">...</span>
                            <span class="mr-4">عرض جغرافیایی: </span><span id="latitudeValue" class="mr-2 font-mono">...</span>
                        </div>
                        <div id="project-map" class="h-64 w-full z-10 rounded-lg border"></div>
                        <textarea id="address" name="address" rows="1" class="w-full mt-2" required placeholder="آدرس متنی در اینجا نمایش داده می‌شود...">${projectData?.address || ''}</textarea>
                        <input type="hidden" id="latitude" name="latitude" value="${projectData?.latitude || ''}">
                        <input type="hidden" id="longitude" name="longitude" value="${projectData?.longitude || ''}">
                    </div>

                    <div class="space-y-2">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">مشخصات مهندس مورد نیاز پروژه</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5 pt-2">
                            <div><label for="engineerActivity" class="block text-gray-700 font-medium mb-1 required-field">نوع فعالیت مهندس</label><select id="engineerActivity" name="engineerActivity" required><option value="طراح">طراح</option><option value="ناظر">ناظر</option><option value="مجری">مجری</option></select></div>
                            <div><label for="permitType" class="block text-gray-700 font-medium mb-1 required-field">نوع پروانه مهندس</label><select id="permitType" name="permitType" required><option value="طراح حقوقی">طراح حقوقی</option><option value="ناظر حقوقی">ناظر حقوقی</option><option value="انبوه ساز">انبوه ساز</option><option value="مجری حقوقی">مجری حقوقی</option><option value="مهندس حقیقی">مهندس حقیقی</option><option value="کاردان">کاردان</option><option value="معمارتجربی">معمارتجربی</option></select></div>
                            <div><label for="engineerRank" class="block text-gray-700 font-medium mb-1 required-field">پایه مهندس</label><select id="engineerRank" name="engineerRank" required><option value="پایه 3">پایه 3</option><option value="پایه 2">پایه 2</option><option value="پایه 1">پایه 1</option><option value="پایه ارشد">پایه ارشد</option></select></div>
                            <div><label for="structureType" class="block text-gray-700 font-medium mb-1 required-field">نوع سازه</label><select id="structureType" name="structureType" required><option value="فلزی">فلزی</option><option value="بتنی">بتنی</option></select></div>
                        </div>

                        <p class="text-sm text-slate-500">رشته‌های مهندسی مورد نیاز خود را انتخاب کرده و قیمت پیشنهادی برای هر کدام را وارد نمایید.</p>
                    </div>

                    <div id="engineer-pricing-container" class="space-y-3 border p-4 rounded-lg bg-slate-50">
                        <div class="grid grid-cols-[150px_1fr_1fr] gap-4 items-center px-2 pb-2 border-b">
                            <span class="font-bold text-sm text-slate-600">رشته مهندس</span>
                            <span class="font-bold text-sm text-slate-600 text-center">قیمت واحد (تومان)</span>
                            <span class="font-bold text-sm text-slate-600 text-center">قیمت کل رشته</span>
                        </div>

                        <div class="engineer-pricing-row grid grid-cols-[150px_1fr_1fr] gap-4 items-center" data-field="معماری">
                            <button type="button" class="engineer-field-btn w-full" data-field="معماری">معماری</button>
                            <div class="flex items-center">
                                <input type="number" name="price_معماری" class="price-input w-full text-center" value="81400" disabled>
                            </div>
                            <div class="total-price-display text-center text-slate-600 font-semibold">-</div>
                        </div>
                        <div class="engineer-pricing-row grid grid-cols-[150px_1fr_1fr] gap-4 items-center" data-field="عمران">
                            <button type="button" class="engineer-field-btn w-full" data-field="عمران">عمران</button>
                            <div class="flex items-center">
                                <input type="number" name="price_عمران" class="price-input w-full text-center" value="94500" disabled>
                            </div>
                            <div class="total-price-display text-center text-slate-600 font-semibold">-</div>
                        </div>
                        <div class="engineer-pricing-row grid grid-cols-[150px_1fr_1fr] gap-4 items-center" data-field="مکانیک">
                            <button type="button" class="engineer-field-btn w-full" data-field="مکانیک">مکانیک</button>
                            <div class="flex items-center">
                                <input type="number" name="price_مکانیک" class="price-input w-full text-center" value="44600" disabled>
                            </div>
                            <div class="total-price-display text-center text-slate-600 font-semibold">-</div>
                        </div>
                        <div class="engineer-pricing-row grid grid-cols-[150px_1fr_1fr] gap-4 items-center" data-field="برق">
                            <button type="button" class="engineer-field-btn w-full" data-field="برق">برق</button>
                            <div class="flex items-center">
                                <input type="number" name="price_برق" class="price-input w-full text-center" value="42000" disabled>
                            </div>
                            <div class="total-price-display text-center text-slate-600 font-semibold">-</div>
                        </div>
                        <div class="engineer-pricing-row grid grid-cols-[150px_1fr_1fr] gap-4 items-center" data-field="نقشه برداری">
                            <button type="button" class="engineer-field-btn w-full" data-field="نقشه برداری">تقشه برداری</button>
                            <div class="flex items-center">
                                <input type="number" name="price_نقشه" class="price-input w-full text-center" value="21750" disabled>
                            </div>
                            <div class="total-price-display text-center text-slate-600 font-semibold">-</div>
                        </div>
                        <div class="engineer-pricing-row grid grid-cols-[150px_1fr_1fr] gap-4 items-center" data-field="شهرسازی">
                            <button type="button" class="engineer-field-btn w-full" data-field="شهرسازی">شهرسازی</button>
                            <div class="flex items-center">
                                <input type="number" name="price_شهرسازی" class="price-input w-full text-center" value="9000" disabled>
                            </div>
                            <div class="total-price-display text-center text-slate-600 font-semibold">-</div>
                        </div>
                        <div class="engineer-pricing-row grid grid-cols-[150px_1fr_1fr] gap-4 items-center" data-field="ترافیک">
                            <button type="button" class="engineer-field-btn w-full" data-field="ترافیک">ترافیک</button>
                            <div class="flex items-center">
                                <input type="number" name="price_ترافیک" class="price-input w-full text-center" value="2000" disabled>
                            </div>
                            <div class="total-price-display text-center text-slate-600 font-semibold">-</div>
                        </div>
                    </div>

                    <div id="grand-total-container" class="text-left mt-4 p-4 bg-green-100 rounded-lg">
                        <span class="font-bold text-lg">مجموع کل هزینه‌ها:</span>
                        <span id="grand-total-value" class="font-bold text-lg text-green-700">۰ تومان</span>
                    </div>
                    
                    <div>
                        <label for="description" class="block text-gray-700 font-medium mb-1">توضیحات</label><textarea id="description" name="description" rows="2" class="w-full">${projectData?.description || ''}</textarea>
                    </div>
                </div>
                <div class="border-t border-gray-200 mt-6 p-4 flex justify-end gap-4">
                    <button type="button" id="cancelProjectFormBtn" class="btn btn-secondary"><i class="fas fa-times mr-2"></i>انصراف</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-2"></i>${isEditMode ? 'ذخیره تغییرات' : 'ثبت پروژه'}</button>
                </div>
            </form>
        </div>
    `;
    //<div class="flex items-center mt-2"><i class="fas fa-hand-holding-usd text-blue-500 ml-2"></i><span class="text-gray-700 font-medium">کمیسیون (۱۵٪):</span><span id="commissionPreview" class="mr-2 font-bold" style="color: var(--primary-color)"></span></div>

    // این بخش کد برای حالت ویرایش است تا مقادیر قبلی را در فیلدها قرار دهد
    if (isEditMode) {
        ['usageType', 'structureType', 'fileType', 'engineerRank', 'engineerField', 'engineerActivity', 'permitType'].forEach(id => {
            const select = document.getElementById(id);
            if (select && projectData[id]) select.value = projectData[id];
        });
    }

    attachProjectFormListeners();
}

        function getProjectCardHTML(project, role, isApplied = false) {
            const formatNumber = (num) => num ? parseFloat(num).toLocaleString('fa-IR') : '0';
            const totalPrice = (parseFloat(project.area) || 0) * (parseFloat(project.unitPrice) || 0);
            const contractMonths = parseInt(project.contractMonths) || 1;
            const commission = Math.floor(((totalPrice * 0.05 * contractMonths) / 12) / 10000) * 10000;

            let starsHtml = '';
            const starsCount = { 'پایه 3': 1, 'پایه 2': 2, 'پایه 1': 3, 'پایه ارشد': 4 }[project.engineerRank] || 1;
            for (let i = 0; i < starsCount; i++) {
                starsHtml += '<i class="fas fa-star text-yellow-400"></i>';
            }
            
            let footerHtml = '';
            if (role === 'engineer') {
                if (isApplied) {
                    footerHtml = `<button data-action="cancel-application" data-project-id="${project.ProjectID}" class="btn btn-danger w-full"><i class="fas fa-times-circle mr-2"></i>لغو درخواست همکاری</button>`;
                } else {
                    footerHtml = `<button data-action="apply" data-project-id="${project.ProjectID}" class="btn btn-success w-full"><i class="fas fa-paper-plane mr-2"></i>درخواست همکاری</button>`;
                }
            } else if (role === 'employer') {
                const isProjectOpen = project.Status === 'باز';
                const statusChangeText = isProjectOpen ? 'بستن پروژه' : 'باز کردن پروژه';
                const statusChangeAction = isProjectOpen ? 'close-project' : 'open-project';
                const statusChangeBtnClass = isProjectOpen ? 'btn-danger' : 'btn-success';
                const statusChangeIcon = isProjectOpen ? 'fa-lock' : 'fa-lock-open';
                
                footerHtml = `
                    <div class="flex gap-2 w-full">
                         <button data-action="${statusChangeAction}" data-project-id="${project.ProjectID}" class="btn ${statusChangeBtnClass} flex-1"><i class="fas ${statusChangeIcon} mr-2"></i>${statusChangeText}</button>
                         <button data-action="edit-project" data-project-id="${project.ProjectID}" class="btn btn-secondary flex-1"><i class="fas fa-edit mr-2"></i>ویرایش پروژه</button>
                    </div>
                `;
            }

            return `
            <div class="project-card bg-white rounded-lg overflow-hidden">
                <div class="bg-white p-3 border-b">
                      
                    <p class="text-sm text-slate-500">${formatTimeAgo(project.lastModifiedDate)}</p>
                </div>
                <div class="bg-green-50 grid grid-cols-3 items-center justify-between justify-items-auto p-3">
                    <div class="flex items-center"><i class="fa fa-home fas ml-2 text-green-500"></i><span class="font-semibold text-gray-900">سازه ${project.structureType} ${project.usageType}</span></div>
                    <div class="text-center">
                        <div class="flex items-center justify-center mt-1 pb-2">${starsHtml}</div>
                        <div class="flex justify-center mb-1"><div class="font-bold text-gray-900 text-xl">${project.engineerActivity} ${project.engineerRank} ${project.engineerField}</div></div>
                    </div>
                    <div class="frosode-badge-container"><span class="frosode-badge px-3 py-1 rounded-full text-sm font-medium ${project.fileType === 'فرسوده' ? '' : 'hidden'}">فرسوده</span></div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between mb-4 mt-2"><div class="text-gray-900 font-semibold"><i class="fa-ruler-combined fas mx-2 text-gray-400"></i>${formatNumber(project.area)} مترمربع</div><div class="text-gray-900 font-semibold">${project.floors} طبقه + ${project.basementFloors} طبقه زیرزمین<i class="fa-building fas mx-2 text-gray-400"></i></div></div>
                    <div class="flex justify-between mb-4"><div class="text-gray-900 font-semibold"><i class="fa-map-marker-alt fas mx-2 text-gray-400"></i>منطقه ${project.district} ${project.city}</div><div class="text-gray-900 font-semibold">مدت قرارداد: ${project.contractMonths} ماه<i class="fa-calendar-alt far mx-2 text-gray-400"></i></div></div>
                    <div class="bg-gray-50 commission-highlight p-3 rounded-2xl">
                        <div class="grid ${role === 'engineer' ? 'grid-rows-3' : 'grid-rows-2'} items-center">
                            <div class="flex items-center pb-1 pt-0 px-3"><i class="fa-tag fas ml-2 self-center text-gray-400"></i><span class="font-medium text-gray-500">قیمت واحد:</span><div class="flex-auto font-semibold text-base text-gray-500 text-left">${formatNumber(project.unitPrice)} تومان</div></div>
                            <div class="bg-green-300 mb-0 price-highlight px-5 py-3 rounded-lg"><div class="flex items-center"><i class="fa-hand-holding-usd fas ml-2 text-green-700"></i><span class="font-medium text-green-800">قیمت کل پیشنهادی:</span><div class="flex-auto font-bold mt-1 text-green-800 text-left text-xl">${formatNumber(totalPrice)} تومان</div></div></div>

                            ${role === 'engineer' ? `
                            <div class="flex items-center pb-0 pt-1 px-3">
                                <i class="fa fa-percent fas ml-2 text-gray-400"></i><span class="font-medium text-gray-500">کمیسیون:</span><div class="flex-auto font-bold mt-1 text-left text-lg" style="color: var(--primary-color)">${formatNumber(commission)} تومان</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="flex justify-between p-4 bg-gray-50 border-t">
                    ${footerHtml}
                </div>
            </div>
            `;
        }
        // <h4 class="font-bold text-lg text-slate-800">${project.projectName || 'بدون نام'}</h4>
        
        function attachProjectFormListeners() {
            // اتصال رویداد ارسال نهایی فرم
            document.getElementById('projectForm').addEventListener('submit', submitProjectData);
            
            // اتصال رویداد دکمه انصراف
            document.getElementById('cancelProjectFormBtn')?.addEventListener('click', () => {
                document.getElementById('my-items-nav-item').click(); 
            });

            // بارگذاری نقشه
            initializeProjectMap();

            // اتصال رویدادها به فیلدها و دکمه‌های بخش قیمت
            const areaInput = document.getElementById('area');
            const engineerButtons = document.querySelectorAll('.engineer-field-btn');
            const priceInputs = document.querySelectorAll('.price-input');

            // هر زمان متراژ تغییر کرد، همه قیمت‌ها را دوباره محاسبه کن
            if(areaInput) {
                areaInput.addEventListener('input', updateAllPrices);
            }

            // هر زمان روی یک دکمه رشته کلیک شد
            engineerButtons.forEach(button => {
                button.addEventListener('click', () => {
                    button.classList.toggle('active');
                    updateAllPrices(); // همه قیمت‌ها را دوباره محاسبه کن
                });
            });

            // هر زمان قیمت واحد یک رشته تغییر کرد
            priceInputs.forEach(input => {
                input.addEventListener('input', updateAllPrices);
            });

            // اجرای اولیه محاسبات در لحظه بارگذاری فرم
            updateAllPrices();

            const fileTypeSelect = document.getElementById('fileType');
            const dilapidatedAreaInput = document.getElementById('area_d');
            if (dilapidatedAreaInput) {
                dilapidatedAreaInput.addEventListener('input', updateAllPrices);
            }
            const dilapidatedAreaLabel = document.querySelector('label[for="area_d"]');
    
            if(fileTypeSelect) {
                fileTypeSelect.addEventListener('change', () => {
                    if (fileTypeSelect.value === 'فرسوده') {
                        dilapidatedAreaInput.disabled = false;
                        dilapidatedAreaLabel.classList.add('required-field');
                        // هر بار که فعال می‌شود، محاسبات را دوباره انجام بده
                        updateAllPrices(); 
                    } else {
                        dilapidatedAreaInput.disabled = true;
                        dilapidatedAreaInput.value = ''; // مقدارش را خالی کن
                        dilapidatedAreaLabel.classList.remove('required-field');
                        // هر بار که غیرفعال می‌شود، محاسبات را دوباره انجام بده
                        updateAllPrices(); 
                    }
                });
            }
        }
        async function getAddressFromLatLng(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=fa`);
                if (!response.ok) throw new Error(`Nominatim request failed: ${response.status}`);
                const data = await response.json();
                return data.display_name || 'محله یافت نشد';
            } catch (error) {
                console.error("Error fetching address: ", error);
                return 'خطا در دریافت نام محله';
            }
        }

        async function updateMapLocation(lat, lng) {
            document.getElementById('latitudeValue').textContent = lat.toFixed(4);
            document.getElementById('longitudeValue').textContent = lng.toFixed(4);
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            const addressField = document.getElementById('address');
            addressField.value = "در حال دریافت آدرس...";
            const address = await getAddressFromLatLng(lat, lng);
            addressField.value = address;
        }

        function initializeProjectMap() {
            if (projectMap) projectMap.remove();
            setTimeout(() => {
            const lat = parseFloat(document.getElementById('latitude').value) || 38.0766;
            const lng = parseFloat(document.getElementById('longitude').value) || 46.2970;
            const initialCoords = [lat, lng];
            projectMap = L.map('project-map').setView(initialCoords, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(projectMap);
            projectMarker = L.marker(initialCoords, { draggable: true }).addTo(projectMap);
            
            if (!document.getElementById('latitude').value) {
                 updateMapLocation(initialCoords[0], initialCoords[1]);
            } else {
                document.getElementById('latitudeValue').textContent = lat.toFixed(4);
                document.getElementById('longitudeValue').textContent = lng.toFixed(4);
            }

            projectMarker.on('dragend', (e) => updateMapLocation(e.target.getLatLng().lat, e.target.getLatLng().lng));
            projectMap.on('click', (e) => {
                projectMarker.setLatLng(e.latlng);
                updateMapLocation(e.latlng.lat, e.latlng.lng);
            });
                projectMap.invalidateSize();
        }, 1);
        }

function updateAllPrices() {
            // مقادیر هر دو فیلد متراژ را می‌خوانیم
            const regularArea = parseFloat(document.getElementById('area').value) || 0;
            const dilapidatedAreaInput = document.getElementById('area_d');
            const dilapidatedArea = parseFloat(dilapidatedAreaInput.value) || 0;

            // تصمیم‌گیری برای استفاده از متراژ عادی یا متراژ فرسوده در محاسبات
            const areaForCalc = !dilapidatedAreaInput.disabled && dilapidatedArea > 0 ? dilapidatedArea : regularArea;

            let grandTotal = 0;

            document.querySelectorAll('.engineer-pricing-row').forEach(row => {
                const button = row.querySelector('.engineer-field-btn');
                const priceInput = row.querySelector('.price-input');
                const totalDisplay = row.querySelector('.total-price-display');

                // بررسی می‌کنیم آیا این رشته انتخاب شده است یا نه
                if (button.classList.contains('active')) {
                    priceInput.disabled = false; // فیلد قیمت را قابل ویرایش کن
                    const unitPrice = parseFloat(priceInput.value) || 0;
                    
                    // قیمت کل رشته با متراژ صحیح محاسبه می‌شود
                    const rowTotal = areaForCalc * unitPrice;
                    
                    // نمایش قیمت کل برای این ردیف
                    totalDisplay.textContent = `${rowTotal.toLocaleString('fa-IR')} تومان`;
                    
                    // اضافه کردن به مجموع کل
                    grandTotal += rowTotal;
                } else {
                    priceInput.disabled = true; // فیلد قیمت را غیرفعال کن
                    totalDisplay.textContent = '-'; // پاک کردن قیمت کل ردیف
                }
            });

            // به‌روزرسانی نمایش مجموع کل
            document.getElementById('grand-total-value').textContent = `${grandTotal.toLocaleString('fa-IR')} تومان`;
        }
        
        function updatePriceCalculations() {
            const unitPriceInput = document.getElementById('unitPrice');
            const customPriceInput = document.getElementById('customPriceInput');

            // اگر دکمه قیمت دلخواه فعال است، مطمئن شویم که مقدار از فیلد متنی خوانده می‌شود
            if (document.querySelector('.custom-price-container.active')) {
                unitPriceInput.value = customPriceInput.value || '0';
            }

            if (!unitPriceInput) return;
            
            let price = parseFloat(unitPriceInput.value) || 0;

            const area = parseFloat(document.getElementById('area').value) || 0;
            const floors = parseInt(document.getElementById('floors').value) || 0;
            const basementFloors = parseInt(document.getElementById('basementFloors').value) || 0;
            const totalFloors = floors + basementFloors;
            const contractMonths = parseInt(document.getElementById('contractMonths').value) || 1;

            const totalPrice = area * price;
            const commission = Math.floor(((totalPrice * 0.05 * contractMonths) / 12) / 10000) * 10000;
            const toPersianNum = (num) => num.toLocaleString('fa-IR');
            
            document.getElementById('tariff-title').textContent = `تعرفه پیشنهادی برای ساختمان ${toPersianNum(totalFloors)} طبقه`;
            document.getElementById('unitPricePreview').textContent = `${toPersianNum(price)} تومان بر مترمربع`;
            document.getElementById('totalPricePreview').textContent = `${toPersianNum(totalPrice)} تومان`;
            // document.getElementById('commissionPreview').textContent = `${toPersianNum(commission)} تومان`;
        }
        
async function submitProjectData(e) {
            e.preventDefault();
            const form = document.getElementById('projectForm');
            if (!form.checkValidity()) {
                showModal('لطفاً تمام فیلدهای الزامی (*) را پر کنید.', 'error');
                form.reportValidity();
                return;
            }

            // ۱. جمع‌آوری اطلاعات پایه پروژه
            const formData = new FormData(form);
            const baseProjectData = {};
            formData.forEach((value, key) => {
                if (!key.startsWith('price_')) { // فیلدهای قیمت را جدا می‌کنیم
                    baseProjectData[key] = value;
                }
            });

            // ۲. پیدا کردن مهندسان انتخاب شده
            const selectedEngineers = [];
            document.querySelectorAll('.engineer-field-btn.active').forEach(btn => {
                const fieldName = btn.dataset.field;
                const fieldIdentifier = fieldName.replace(/\s/g, '_');
                const priceValue = formData.get(`price_${fieldIdentifier}`);
                selectedEngineers.push({ field: fieldName, price: priceValue });
            });

            if (selectedEngineers.length === 0) {
                showModal('حداقل یک رشته مهندس باید انتخاب شود.', 'error');
                return;
            }

            showLoader();

            // ۳. ایجاد یک شناسه گروه مشترک برای همه ردیف‌ها
            const projectGroupID = `G${Date.now()}`;
            
            // ۴. محاسبه ردیف تعرفه
            const area = parseFloat(baseProjectData.area) || 0;
            const totalFloors = (parseInt(baseProjectData.floors) || 0) + (parseInt(baseProjectData.basementFloors) || 0);
            const tierIndex = calculatePriceTierIndex(area, totalFloors);

            // ۵. ایجاد لیستی از درخواست‌ها برای ارسال به سرور
            const promises = selectedEngineers.map(engineer => {
                const projectDataForEngineer = { ...baseProjectData };
                projectDataForEngineer.engineerField = engineer.field;
                // ترکیب قیمت و ردیف تعرفه محاسبه شده
                projectDataForEngineer.unitPrice = `${engineer.price}|${tierIndex}`;

                const payload = {
                    action: 'createProject',
                    employerEmail: userData.email,
                    projectData: projectDataForEngineer,
                    projectGroupID: projectGroupID // ارسال شناسه گروه
                };

                return fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                }).then(res => res.json());
            });

            // ۶. ارسال همزمان همه درخواست‌ها و مدیریت نتیجه
            try {
                const results = await Promise.all(promises);
                
                const hasError = results.some(res => res.status !== 'success');

                if (hasError) {
                    throw new Error('حداقل یکی از درخواست‌ها برای ثبت رشته‌های مهندسی با خطا مواجه شد.');
                }

                showModal(`پروژه شما با ${selectedEngineers.length} ردیف مهندس با موفقیت ثبت شد.`, 'success');
                document.getElementById('my-items-nav-item').click();

            } catch (error) {
                showModal(`خطا در ثبت پروژه: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        }

        // --- Activity Logic ---
        
        function renderActivityForm(activityToEdit = null) {
            const formHtml = `<div id="activityFormContainer" class="neumorphic-card flex flex-col"></div>`;
            createActivityContent.innerHTML = formHtml;
            renderActivityEdit(activityToEdit || {});
        }

        function renderActivityEdit(data = {}) {
            const isEditMode = !!data.ActivityID;
            const container = document.getElementById('activityFormContainer');
            if (!container) return;
            
            let prices = {};
            if (data.prices) {
                try {
                    // این بخش اصلاح شده تا بر اساس ایندکس کار کند
                    const parsedPrices = JSON.parse(data.prices);
                    if (Array.isArray(parsedPrices)) {
                        parsedPrices.forEach(p => { prices[p.index] = p.price; });
                    }
                } catch(e) { console.error("Could not parse prices:", data.prices); }
            }
            
            const priceRowsHtml = priceOptions.map(opt => `
                <div class="price-row grid grid-cols-2 gap-4 items-center" data-index="${opt.index}">
                    <label class="flex items-center text-base">
                        <input type="checkbox" class="ml-4" ${isEditMode && prices[opt.index] ? 'checked' : ''}> 
                        <span>${opt.label}</span>
                    </label>
                    <input type="text" class="p-2 border border-gray-300 rounded-md text-base" value="${prices[opt.index] || opt.default}">
                </div>
            `).join('');

            const editHtml = `
                <div id="editMode" class="flex flex-col gap-4"> 
                    ${isEditMode ? `<input type="hidden" id="activityId" value="${data.ActivityID}">` : ''}
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="block text-gray-700 font-medium mb-1">استان</label><select id="province" class="w-full">${generateProvinceOptions(data.province || '')}</select></div>
                        <div><label class="block text-gray-700 font-medium mb-1">شهر</label><input type="text" id="city" class="w-full" value="${data.city || ''}"></div>
                        <div><label class="block text-gray-700 font-medium mb-1">نوع پروانه</label><select id="licenseType" class="w-full"><option>انبوه ساز</option><option>سازنده حقوقی</option><option>مهندس حقیقی</option><option>کاردان</option><option>معمارتجربی</option></select></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="block text-gray-700 font-medium mb-1">نوع فعالیت مهندس</label><select id="engineerActivity" class="w-full"><option>طراح</option><option>ناظر</option><option>مجری</option></select></div>
                        <div><label class="block text-gray-700 font-medium mb-1">پایه پروانه</label><select id="engineerLevel" class="w-full"><option>پایه 3</option><option>پایه 2</option><option>پایه 1</option><option>پایه ارشد</option></select></div>
                        <div><label class="block text-gray-700 font-medium mb-1">رشته مهندس</label><select id="engineerField" class="w-full"><option>معماری</option><option>عمران</option><option>مکانیک</option><option>برق</option><option>شهرسازی</option><option>ترافیک</option><option>نقشه برداری</option></select></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <div><label class="block text-gray-700 font-medium mb-1">حداکثر متراژ</label><input type="number" id="maxArea" class="w-full" value="${data.maxArea || '5000'}"></div>
                        <div><label class="block text-gray-700 font-medium mb-1">متراژ اشغال‌شده</label><input type="number" id="occupiedArea" class="w-full" value="${data.occupiedArea || '1250'}"></div>
                        <div><label class="block text-gray-700 font-medium mb-1">کارهای جاری</label><input type="number" id="currentProjects" class="w-full" value="${data.currentProjects || '2'}"></div>
                        <div><label class="block text-gray-700 font-medium mb-1">حداکثر کار</label><input type="number" id="maxProjects" class="w-full" value="${data.maxProjects || '4'}"></div>
                    </div>
                    <div class="mb-4"> 
                        <label class="block text-gray-700 font-medium mb-2 text-base text-center">قیمت پیشنهادی (هر متر مربع)</label>
                        <p class="text-xs text-center text-slate-500 mb-4">فقط ردیف ساختمانی که قصد همکاری دارید را انتخاب کنید و قیمت دلخواه برای همکاری را در مقابل آن وارد نمایید.</p>
                        <div id="priceRowsEdit" class="space-y-3">${priceRowsHtml}</div>
                    </div>
                    <div class="flex items-center mb-4"><input type="checkbox" id="needsHelpCheckbox" class="ml-2" ${data.needsHelp ? 'checked' : ''}><label for="needsHelpCheckbox" class="text-gray-700 text-base">نیازمند کمک مجری</label></div>
                    <div class="flex justify-end space-x-4"><button type="button" id="cancelActivityBtn" class="neumorphic-button">انصراف</button><button type="button" id="previewActivityBtn" class="neumorphic-button bg-blue-500 text-white">پیش‌نمایش و ثبت</button></div>
                </div>
            `;
            container.innerHTML = editHtml;

            if (isEditMode) {
                document.getElementById('licenseType').value = data.licenseType || 'مهندس حقیقی';
                document.getElementById('engineerLevel').value = data.engineerLevel || 'پایه 3';
                document.getElementById('engineerActivity').value = data.engineerActivity || 'ناظر';
                document.getElementById('engineerField').value = data.engineerField || 'عمران';
            }

            document.getElementById('previewActivityBtn').addEventListener('click', handlePreviewActivity);
            document.getElementById('cancelActivityBtn').addEventListener('click', () => {
                
                document.getElementById('my-items-nav-item').click();
            });
        }

        function handlePreviewActivity() {
            const isEditMode = !!document.getElementById('activityId');
            currentActivityData = {
                province: document.getElementById('province').value, city: document.getElementById('city').value,
                licenseType: document.getElementById('licenseType').value, engineerLevel: document.getElementById('engineerLevel').value,
                engineerActivity: document.getElementById('engineerActivity').value, engineerField: document.getElementById('engineerField').value,
                needsHelp: document.getElementById('needsHelpCheckbox').checked, maxArea: document.getElementById('maxArea').value,
                occupiedArea: document.getElementById('occupiedArea').value, currentProjects: document.getElementById('currentProjects').value,
                maxProjects: document.getElementById('maxProjects').value,
            };

            const prices = [];
            const priceRows = document.getElementById('priceRowsEdit').children;
            for (let row of priceRows) {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    prices.push({index: row.dataset.index, price: row.querySelector('input[type="text"]').value});
                }
            }
            currentActivityData.prices = JSON.stringify(prices);
        
            if(isEditMode) currentActivityData.ActivityID = document.getElementById('activityId').value;
        
            renderActivityPreview(currentActivityData);
        }

        function calculatePriceTierIndex(area, totalFloors) {
            if (totalFloors >= 1 && totalFloors <= 2 && area > 0 && area < 600) return 1;
            if (totalFloors >= 3 && totalFloors <= 5 && area >= 600 && area < 2000) return 2;
            if (totalFloors >= 6 && totalFloors <= 7 && area >= 2000 && area < 5000) return 3;
            if (totalFloors >= 8 && totalFloors <= 10 && area >= 2000 && area < 5000) return 4;
            if (totalFloors >= 11 && totalFloors <= 12 && area >= 5000) return 5;
            if (totalFloors >= 13 && totalFloors <= 15 && area >= 5000) return 6;
            if (totalFloors >= 16 && area >= 5000) return 7;
            return 0; // اگر در هیچ دسته‌ای نبود
        }

        function renderActivityPreview(data) {
            const container = document.getElementById('activityFormContainer');
            if (!container) return;
            
            const isEditMode = !!data.ActivityID;
            const pricesArray = JSON.parse(data.prices || '[]');
            const remainingArea = (data.maxArea || 0) - (data.occupiedArea || 0);
            const areaPercentage = data.maxArea > 0 ? (remainingArea / data.maxArea) * 100 : 0;
            const remainingProjects = (data.maxProjects || 0) - (data.currentProjects || 0);
            const projectPercentage = data.maxProjects > 0 ? (remainingProjects / data.maxProjects) * 100 : 0;

            let priceHtml = pricesArray.map(p => {
                const option = priceOptions.find(opt => opt.index == p.index);
                const label = option ? option.label : 'ردیف نامشخص';
                return `<div class="price-row grid grid-cols-2 gap-4 items-center">
                            <span>${label}</span>
                            <span class="text-left">${p.price} تومان</span>
                        </div>`;
            }).join('');
            
            const levelMap = { 'پایه 3': 1, 'پایه 2': 2, 'پایه 1': 3, 'پایه ارشد': 4 };
            const starsCount = levelMap[data.engineerLevel] || 1;
            const starsHtml = '<i class="fas fa-star text-yellow-400"></i>'.repeat(starsCount);

            const previewHtml = `
                <div class="flex flex-col">
                    <div class="bg-green-50 flex items-center justify-between mb-4 -mt-5 -mx-5 p-5" style="border-radius: 20px 20px 0px 0px; display:grid; grid-template-columns:1fr auto 1fr;"> 
                        <div class="flex items-center justify-start pr-5 space-x-2"><i class="fas fa-check-circle text-green-500" title="کاربر تایید شده"></i><span class="mr-6 pr-4 text-base">${data.licenseType}</span></div>
                        <div class="flex flex-col items-center justify-center"><span class="font-bold px-0 text-gray-800 text-lg">${data.engineerActivity} ${data.engineerLevel} ${data.engineerField}</span><div class="flex text-yellow-400">${starsHtml}</div></div>
                        <div class="place-self-end self-center text-center"><p class="font-semibold text-slate-700 text-sm">آخرین بروزرسانی:</p><p class="text-xs text-slate-500">${formatTimeAgo(data.LastModifiedDate || new Date())}</p></div>
                    </div>
                    <div class="flex flex-col gap-4">
                        <div class="flex items-center justify-between gap-2 p-2 bg-slate-100 rounded-md">
                            <div class="flex items-center gap-2"><i class="fas fa-map-marker-alt text-green-600"></i><span class="font-semibold text-slate-700">${data.province || 'استان ثبت نشده'} - ${data.city || 'شهر ثبت نشده'}</span></div>
                            ${data.needsHelp ? '<span class="needs-help">نیازمند کمک مجری</span>' : ''}
                        </div>
                        <div class="mt-2"> 
                            <div class="flex gap-4 items-center justify-between"><label class="font-medium text-base text-gray-700">متراژ کار باقی‌مانده</label><span class="text-gray-600 text-base">${remainingArea.toLocaleString('fa-IR')} متر مربع</span></div>
                            <div class="progress-bar mt-2"><div class="bg-green-500 progress-fill" style="width: ${areaPercentage}%"></div></div>
                        </div>
                        <div> 
                            <div class="flex gap-4 items-center justify-between"><label class="font-medium text-base text-gray-700">تعداد کار باقی‌مانده</label><span class="text-gray-600 text-base">${remainingProjects} از ${data.maxProjects}</span></div>
                            <div class="progress-bar mt-2"><div class="bg-blue-500 progress-fill" style="width: ${projectPercentage}%"></div></div>
                        </div>
                        <div class="bg-green-100 mt-2 pb-4 pt-5 px-5" style="border-radius: 16px;"> 
                            <label class="block font-medium mb-4 mt-0 text-base text-center text-green-900">قیمت پیشنهادی (هر متر مربع)</label>                     
                            <div class="space-y-3">${priceHtml || '<p class="text-center text-slate-500">قیمتی ثبت نشده است.</p>'}</div>
                        </div>
                        <div class="flex justify-between space-x-6 mt-4"> 
                            <button id="editActivityBtn" class="neumorphic-button text-lg"><i class="fas fa-edit"></i> ویرایش</button>
                            <button id="submitActivityBtn" class="bg-green-500 font-bold ml-1 neumorphic-button text-lg text-white"><i class="fas fa-paper-plane"></i> ${isEditMode ? 'ذخیره تغییرات' : 'ارسال معرفی فعالیت'}</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = previewHtml;

            document.getElementById('editActivityBtn').addEventListener('click', () => renderActivityEdit(data));
            document.getElementById('submitActivityBtn').addEventListener('click', submitActivityData);
        }

async function submitActivityData() {
            const button = document.getElementById('submitActivityBtn');
            button.disabled = true;
            button.innerHTML = '<div class="spinner !w-5 !h-5 !border-2"></div>';
            
            const isUpdate = !!currentActivityData.ActivityID;
            const action = isUpdate ? 'updateActivity' : 'createActivity';
            const payload = { action, engineerEmail: userData.email, activityData: currentActivityData, activityId: currentActivityData.ActivityID };
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`خطای سرور: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    currentActivityData = {};
                    
                    // --- این خط مسئول انتقال کاربر به صفحه فعالیت‌ها است ---
                    document.getElementById('my-items-nav-item').click();

                } else { throw new Error(result.message || 'خطای ناشناخته.'); }
            } catch (error) {
                 showModal(`خطا در ثبت فعالیت: ${error.message}`, 'error');
                 button.disabled = false;
                 const buttonText = isUpdate ? 'ذخیره تغییرات' : 'ارسال معرفی فعالیت';
                 button.innerHTML = `<i class="fas fa-paper-plane mr-2"></i> ${buttonText}`;
            }
        }
        
        async function renderMyActivities() {
            myActivitiesContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                // ۱. فراخوانی تابع صحیح در بک‌اند که تعداد درخواست‌ها را محاسبه می‌کند
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getEngineerDashboardData&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);

                // ۲. دسترسی به لیست فعالیت‌ها از طریق result.data.activities
                fetchedActivities = result.data.activities.sort((a,b) => new Date(b.LastModifiedDate) - new Date(a.LastModifiedDate));
                
                if (fetchedActivities.length > 0) {
                    let activitiesHtml = '<div class="project-accordion">';
                    fetchedActivities.forEach(act => {
                        const isActive = act.Status === 'فعال';
                        activitiesHtml += `
                            <div class="project-row ${!isActive ? 'closed-project' : ''}" data-activity-id="${act.ActivityID}" data-status="${act.Status}">
                                <div class="project-header">
                                    <div class="header-item"><i class="fas fa-chevron-down accordion-icon"></i></div>
                                    <div class="header-item">
                                        <strong>${act.province}</strong>
                                        <span class="text-xs text-slate-500">${act.city}</span>
                                    </div>
                                    <div class="header-item">
                                        <strong>${act.engineerActivity} ${act.engineerLevel}</strong>
                                        <span class="text-xs text-slate-500">مهندس ${act.engineerField}</span>
                                    </div>
                                    <div class="header-item">
                                        <strong>${toPersianNum((act.maxProjects || 0) - (act.currentProjects || 0))} عدد</strong>
                                        <span>کار باقیمانده</span>
                                    </div>
                                    <div class="header-item">
                                        <strong>${toPersianNum((act.maxArea || 0) - (act.occupiedArea || 0))} مترمربع</strong>
                                        <span>متراژ باقیمانده</span>
                                    </div>
                                    <div class="header-item">
                                        <strong>${act.licenseType}</strong>
                                        <span>نوع پروانه</span>
                                    </div>
                                    <div class="header-item">
                                        ${parseInt(act.incomingRequestCount) > 0 ? `<strong><i class="fas fa-envelope-open text-blue-500"> </i> ${toPersianNum(act.incomingRequestCount)}</strong>` : ''}
                                        ${parseInt(act.outgoingApplicationCount) > 0 ? `<strong><i class="fas fa-paper-plane text-green-500"> </i> ${toPersianNum(act.outgoingApplicationCount)}</strong>` : ''}
                                    </div>
                                    <div class="header-actions">
                                        <button class="btn ${isActive ? 'btn-danger' : 'btn-success'} !p-2" data-action="change-activity-status" data-new-status="${isActive ? 'غیرفعال' : 'فعال'}">
                                            <i class="fas ${isActive ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                        </button>
                                        <button class="btn btn-secondary !p-2" data-action="edit-activity">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="project-body">
                                    <div class="interaction-list-wrapper p-2"></div>
                                </div>
                            </div>`;
                    });
                    activitiesHtml += '</div>';
                    myActivitiesContent.innerHTML = activitiesHtml;
                    attachActivityRowListeners();
                } else {
                    myActivitiesContent.innerHTML = '<p class="text-center text-slate-500">شما هنوز فعالیتی ثبت نکرده‌اید.</p>';
                }
            } catch (error) {
                myActivitiesContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری فعالیت‌ها: ${error.message}</p>`;
            }
        }

        async function handleApplyFromActivity(button) {
            const { projectId, activityId, employerEmail } = button.dataset;
            showModal('آیا می‌خواهید برای این پروژه درخواست همکاری ارسال کنید؟', 'confirm', async () => {
                showLoader();
                try {
                    const payload = {
                        action: 'createInteraction',
                        ProjectID: projectId,
                        ActivityID: activityId,
                        InitiatorRole: 'Engineer',
                        InitiatorEmail: userData.email,
                        RecipientEmail: employerEmail // این فیلد در بک‌اند استفاده نمی‌شود اما ارسال آن خوب است
                    };
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    showModal(result.message, result.status);
                    if (result.status === 'success') {
                        // برای نمایش نتیجه، آکاردئون را رفرش می‌کنیم
                        const activityRow = button.closest('.project-row');
                        activityRow.classList.remove('open');
                        activityRow.querySelector('.project-body').dataset.loaded = 'false';
                        activityRow.querySelector('.project-header').click();
                    }
                } catch (error) {
                     showModal('خطا در ارسال درخواست.', 'error');
                } finally {
                    hideLoader();
                }
            });
        }

         // این تابع یک لیست از تعاملات (درخواست‌ها/پذیرش‌ها) را می‌گیرد و کد وب آن را می‌سازد.
         // این تابع قلب تپنده نمایش لیست‌های تفکیک شده در هر دو پنل کارفرما و مهندس است.
        function renderInteractionList(interactions, listType) {
            // پیام‌های پیش‌فرض برای زمانی که لیستی خالی است
            if (!interactions || interactions.length === 0) {
                const messages = {
                    incomingApps: 'هنوز درخواستی از مهندسان دریافت نشده است.',
                    outgoingReqs: 'شما هنوز درخواستی برای همکاری ارسال نکرده‌اید.',
                    incomingReqs: 'هنوز درخواستی از کارفرمایان دریافت نشده است.',
                    outgoingApps: 'شما هنوز برای پروژه‌ای درخواست همکاری ارسال نکرده‌اید.',
                    suggestions: 'مهندس واجد شرایط دیگری یافت نشد.',
                    projectSuggestions: 'پروژه واجد شرایط دیگری یافت نشد.'
                };
                return `<div class="p-4 text-center text-sm text-slate-500">${messages[listType] || ''}</div>`;
            }

            let html = '';
            interactions.forEach((item, index) => {
                let rowContent = '';
                
                // بر اساس نوع لیست، محتوای هر ردیف را به صورت اختصاصی می‌سازیم
                switch (listType) {
                    // کارفرما -> درخواست‌های دریافتی از مهندسان
                    case 'incomingApps': {
                        rowContent = `
                            <strong>${toPersianNum(index + 1)}</strong>
                            <div class="header-item">
                                <strong>${item.activityInfo?.province || '-'}</strong>
                            </div>
                            <div class="header-item">
                                <strong>${item.activityInfo?.engineerActivity || ''} ${item.activityInfo?.engineerLevel || ''}</strong>
                                <span class="text-xs text-slate-500">مهندس ${item.activityInfo?.engineerField || ''}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(item.activityInfo?.maxProjects - item.activityInfo?.currentProjects)} عدد</strong>
                                <span>کار باقیمانده</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(item.activityInfo?.maxArea - item.activityInfo?.occupiedArea)} مترمربع</strong>
                                <span>متراژ باقیمانده</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(parseFloat(item.activityInfo?.matchedUnitPrice))} تومان</strong>
                                <span>تعرفه پیشنهادی</span>
                            </div>
                            <div class="header-item">
                                <strong>${formatTimeAgo(item.Timestamp)}</strong>
                                <span>زمان ارسال</span>
                            </div>
                            <div class="action-btn-container">
                                 <button class="btn btn-secondary !py-1 !px-3 w-full" data-action="toggle-options">
                                     <i class="fas fa-reply"></i>
                                     <span>پاسخ </span>
                                 </button>
                                 <div class="action-options hidden">
                                     <a href="#" data-action="set-status" data-status="Accepted"><i class="fas fa-check-circle text-green-500"></i> پذیرش</a>
                                     <a href="#" data-action="set-status" data-status="Rejected"><i class="fas fa-times-circle text-red-500"></i> عدم پذیرش</a>
                                     <a href="#" data-action="set-status" data-status="Reviewing"><i class="fas fa-clock text-yellow-500"></i> بررسی</a>
                                 </div>
                            </div>`;
                        break;
                    }

                    // کارفرما -> درخواست‌های ارسالی به مهندسان
                    case 'outgoingReqs': {
                        const status_out = item.Status || 'Pending';
                        // تبدیل وضعیت انگلیسی به فارسی برای نمایش
                        const statusText = { 'Pending': 'در انتظار ', 'Accepted': 'پذیرفت ', 'Rejected': 'رد شد ', 'Reviewing': 'بررسی ' }[status_out] || status_out;
                        const statusClass = `status-${status_out.toLowerCase()}`;
                        const statusIcons = {
                            'Pending': 'fas fa-clock',
                            'Reviewing': 'fas fa-clock',
                            'Accepted': 'fas fa-check-circle',
                            'Rejected': 'fas fa-times-circle'
                        };
                        const statusIcon = statusIcons[status_out] || 'fas fa-question-circle';
                        
                         rowContent = `
                            <strong>${toPersianNum(index + 1)}</strong>
                            <div class="header-item">
                                <strong>${item.activityInfo?.province || '-'}</strong>
                            </div>
                            <div class="header-item">
                                <strong>${item.activityInfo?.engineerActivity || ''} ${item.activityInfo?.engineerLevel || ''}</strong>
                                <span class="text-xs text-slate-500">مهندس ${item.activityInfo?.engineerField || ''}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(item.activityInfo?.maxProjects - item.activityInfo?.currentProjects)} عدد</strong>
                                <span>کار باقیمانده</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(item.activityInfo?.maxArea - item.activityInfo?.occupiedArea)} مترمربع</strong>
                                <span>متراژ باقیمانده</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(parseFloat(item.activityInfo?.matchedUnitPrice))} تومان</strong>
                                <span>تعرفه پیشنهادی</span>
                            </div>
                            <div class="header-item">
                                <strong>${formatTimeAgo(item.Timestamp)}</strong>
                                <span>زمان ارسال</span>
                            </div>
                            <div class="flex items-center justify-center">
                                <span class="status-badge ${statusClass}"><i class="${statusIcon} pl-2"></i> ${statusText}</span>
                            </div>`;
                        break;
                    }
                    // کارفرما -> پیشنهادهای هوشمند
                    case 'suggestions': {
                        const activity = item; 
                        rowContent = `
                            <strong>${toPersianNum(index + 1)}</strong>
                            <div class="header-item">
                                <strong>${activity.province || '-'}</strong>
                            </div>
                            <div class="header-item">
                                <strong>${activity.engineerActivity || ''} ${activity.engineerLevel || ''}</strong>
                                <span class="text-xs text-slate-500">مهندس ${activity.engineerField || ''}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum((activity.maxProjects || 0) - (activity.currentProjects || 0))} عدد</strong>
                                <span>کار باقیمانده</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum((activity.maxArea || 0) - (activity.occupiedArea || 0))} مترمربع</strong>
                                <span>متراژ باقیمانده</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(parseFloat(activity.matchedUnitPrice))} تومان</strong>
                                <span>تعرفه پیشنهادی</span>
                            </div>
                             <div class="header-item">
                                <strong></strong>
                                <span></span>
                            </div>
                            <div class="action-btn-container">
                                <button class="btn btn-success !py-1 !px-3" data-action="send-request" data-activity-id="${activity.ActivityID}">
                                    <i class="fas fa-paper-plane text-green-50"></i>
                                    <span>درخواست</span>
                                </button>
                            </div>`;
                        break;
                    }
                    // مهندس -> درخواست‌های دریافتی از کارفرمایان
                    case 'incomingReqs': {
                        const p = item.projectInfo || {};
                        rowContent = `
                            <strong>${toPersianNum(index + 1)}</strong>
                            <div class="header-item">
                                <strong>${p.province}</strong>
                                <span class="text-xs text-slate-500">منطقه ${toPersianNum(p.district)} ${p.city}</span>
                            </div>
                            <div class="header-item">
                                <strong>${p.engineerActivity} ${p.engineerRank}</strong>
                                <span class="text-xs text-slate-500">مهندس ${p.engineerField}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(p.contractMonths)} ماه</strong>
                                <span>مدت قرارداد</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(p.area)} متـرمربع</strong>
                                <span>${toPersianNum(p.floors)} طـ ${parseInt(p.basementFloors) > 0 ? `+ ${toPersianNum(p.basementFloors)} زیرزمین` : ''}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(parseFloat((p.unitPrice || '|').split('|')[0]))} تومان</strong>
                                <span>تعرفه پیشنهادی</span>
                            </div>
                            <div class="header-item">
                                <strong>${formatTimeAgo(item.Timestamp)}</strong>
                                <span>زمان پیشنهاد</span>
                            </div>
                            <div class="action-btn-container">
                                 <button class="btn btn-secondary !py-1 !px-3 w-full" data-action="toggle-options">
                                     <i class="fas fa-reply"></i>
                                     <span>پاسخ </span>
                                 </button>
                                 <div class="action-options hidden">
                                     <a href="#" data-action="set-status" data-status="Accepted"><i class="fas fa-check-circle text-green-500"></i> پذیرش</a>
                                     <a href="#" data-action="set-status" data-status="Rejected"><i class="fas fa-times-circle text-red-500"></i> عدم پذیرش</a>
                                     <a href="#" data-action="set-status" data-status="Reviewing"><i class="fas fa-clock text-yellow-500"></i> بررسی</a>
                                 </div>
                            </div>`;
                        break;
                    }
                    // مهندس -> درخواست‌های ارسالی برای پروژه‌ها
                    case 'outgoingApps': {
                        const p_out = item.projectInfo || {};
                        const status_out = item.Status || 'Pending';
                        const statusText = { 'Pending': 'در انتظار ', 'Accepted': 'پذیرفت ', 'Rejected': 'رد شد ', 'Reviewing': 'بررسی ' }[status_out] || status_out;
                        const statusClass = `status-${status_out.toLowerCase()}`;
                        const statusIcons = {
                            'Pending': 'fas fa-clock',
                            'Reviewing': 'fas fa-clock',
                            'Accepted': 'fas fa-check-circle',
                            'Rejected': 'fas fa-times-circle'
                        };
                        const statusIcon = statusIcons[status_out] || 'fas fa-question-circle';
                        
                        rowContent = `
                            <strong>${toPersianNum(index + 1)}</strong>
                            <div class="header-item">
                                <strong>${p_out.province}</strong>
                                <span class="text-xs text-slate-500">منطقه ${toPersianNum(p_out.district)} ${p_out.city}</span>
                            </div>
                            <div class="header-item">
                                <strong>${p_out.engineerActivity} ${p_out.engineerRank}</strong>
                                <span class="text-xs text-slate-500">مهندس ${p_out.engineerField}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(p_out.contractMonths)} ماه</strong>
                                <span>مدت قرارداد</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(p_out.area)} متـرمربع</strong>
                                <span>${toPersianNum(p_out.floors)} طـ ${parseInt(p_out.basementFloors) > 0 ? `+ ${toPersianNum(p_out.basementFloors)} زیرزمین` : ''}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(parseFloat((p_out.unitPrice || '|').split('|')[0]))} تومان</strong>
                                <span>تعرفه پیشنهادی</span>
                            </div>
                            <div class="header-item">
                                <strong>${formatTimeAgo(item.Timestamp)}</strong>
                                <span>زمان پیشنهاد</span>
                            </div>
                            <div class="flex items-center justify-center">
                                <span class="status-badge ${statusClass}">
                                <i class="${statusIcon} pl-2"></i> ${status_out}</span>
                            </div>`;
                        break;
                    }
                        // مهندس ->  پیشنهادهای هوشمند پروژه 
                    case 'projectSuggestions': {
                        const p = item; // در این حالت، خود آیتم داده‌های پروژه است
                        rowContent = `
                            <strong>${toPersianNum(index + 1)}</strong>
                            <div class="header-item">
                                <strong>${p.province}</strong>
                                <span class="text-xs text-slate-500">منطقه ${toPersianNum(p.district)} ${p.city}</span>
                            </div>
                            <div class="header-item">
                                <strong>${p.engineerActivity} ${p.engineerRank}</strong>
                                <span class="text-xs text-slate-500">مهندس ${p.engineerField}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(p.contractMonths)} ماه</strong>
                                <span>مدت قرارداد</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(p.area)} متـرمربع</strong>
                                <span>${toPersianNum(p.floors)} طـ ${parseInt(p.basementFloors) > 0 ? `+ ${toPersianNum(p.basementFloors)} زیرزمین` : ''}</span>
                            </div>
                            <div class="header-item">
                                <strong>${toPersianNum(parseFloat((p.unitPrice || '|').split('|')[0]))} تومان</strong>
                                <span>تعرفه پیشنهادی</span>
                            </div>
                            <div class="header-item">
                                <strong></strong>
                                <span></span>
                            </div>
                             <div class="action-btn-container">
                                <button class="btn btn-success !py-1 !px-3" data-action="apply" data-project-id="${p.ProjectID}">
                                    <i class="fas fa-paper-plane text-green-50"></i>
                                    <span>درخواست</span>
                                </button>
                             </div>`;
                        break;
                    }
                }
                html += `<div class="interaction-row" data-interaction-id="${item.InteractionID}">${rowContent}</div>`;
            });
            return html;
        }
        
        // منطق باز و بسته شدن آکاردئون و واکشی اطلاعات برای صفحه "پروژه‌های من" کارفرما.
        function attachProjectRowListeners() {
            document.querySelectorAll('#projectsContent .project-row').forEach(row => {
                const header = row.querySelector('.project-header');
                header.addEventListener('click', async (e) => {
                    if (e.target.closest('button')) return;
                    if (row.dataset.status === 'بسته') {
                        const message = `برای مشاهده درخواست‌ها، نخست باید وضعیت پروژه را با دکمه <i class="fas fa-lock-open text-green-500 mx-1"></i> به حالت باز تبدیل کنید.`;
                        showModal(message, 'info');
                        return;
                    }
                    
                    const projectId = row.dataset.projectId;
                    const body = row.querySelector('.project-body');
                    const isOpen = row.classList.contains('open');

                    document.querySelectorAll('#projectsContent .project-row').forEach(otherRow => {
                        if (otherRow !== row) otherRow.classList.remove('open');
                    });

                    if (!isOpen && !body.dataset.loaded) {
                        const wrapper = body.querySelector('.interaction-list-wrapper');
                        wrapper.innerHTML = '<div class="spinner mx-auto my-4"></div>';
                        showLoader();
                        try {
                            const [detailsResponse, suggestionsResponse] = await Promise.all([
                                fetch(`${GOOGLE_SCRIPT_URL}?func=getProjectDetails&projectId=${projectId}`),
                                fetch(`${GOOGLE_SCRIPT_URL}?func=getSuggestedEngineers&projectId=${projectId}`)
                            ]);
                            const detailsResult = await detailsResponse.json();
                            const suggestionsResult = await suggestionsResponse.json();

                            let finalHtml = '';
                            if (detailsResult.success) {
                                const { incoming, outgoing } = detailsResult.data;
                                if (incoming && incoming.length > 0) {
                                    finalHtml += `
                                        <h5 class="list-header-incoming flex justify-between items-center">
                                            <span class="text-blue-700"><i class="fas fa-envelope-open text-blue-500"></i>  پیشنهادهای دریافتی (${toPersianNum(incoming.length)})</span>
                                            <button class="list-toggle-btn" data-action="toggle-list"><i class="fas fa-chevron-up text-blue-500"></i></button>
                                        </h5>
                                        <div class="interaction-list-content">${renderInteractionList(incoming, 'incomingApps')}</div>`;
                                }
                                if (outgoing && outgoing.length > 0) {
                                     finalHtml += `
                                        <h5 class="list-header-outgoing flex justify-between items-center">
                                            <span class="text-green-700"><i class="fas fa-paper-plane text-green-500"></i>  درخواست‌های ارسالی (${toPersianNum(outgoing.length)})</span>
                                            <button class="list-toggle-btn" data-action="toggle-list"><i class="fas fa-chevron-up text-green-500"></i></button>
                                        </h5>
                                        <div class="interaction-list-content">${renderInteractionList(outgoing, 'outgoingReqs')}</div>`;
                                }
                            }
                             if (suggestionsResult.success && suggestionsResult.data.length > 0) {
                                 finalHtml += `
                                    <h5 class="list-header-suggestions flex justify-between items-center">
                                        <span class="text-yellow-700"><i class="fas fa-lightbulb text-yellow-500"></i>  پیشنهادهای هوشمند (${toPersianNum(suggestionsResult.data.length)})</span>
                                        <button class="list-toggle-btn" data-action="toggle-list"><i class="fas fa-chevron-up text-yellow-500"></i></button>
                                    </h5>
                                    <div class="interaction-list-content">${renderInteractionList(suggestionsResult.data, 'suggestions')}</div>`;
                            }
                            wrapper.innerHTML = finalHtml || '<p class="text-center text-sm p-4">موردی برای نمایش وجود ندارد.</p>';
                            body.dataset.loaded = 'true';
                        } catch (error) {
                            console.error('خطا در واکشی جزئیات پروژه:', error);
                            wrapper.innerHTML = '<p class="text-center text-red-500 p-4">خطا در بارگذاری اطلاعات. لطفاً دوباره تلاش کنید.</p>';
                        } finally { 
                            hideLoader(); 
                        }
                    }
                    row.classList.toggle('open');
                });
            });
        }
        
         // منطق باز و بسته شدن آکاردئون و واکشی اطلاعات برای صفحه "فعالیت‌های من" مهندس.
function attachActivityRowListeners() {
            document.querySelectorAll('#myActivitiesContent .project-row').forEach(row => {
                const header = row.querySelector('.project-header');
                header.addEventListener('click', async (e) => {
                    if (e.target.closest('button')) return;

                    if (row.dataset.status !== 'فعال') {
                        showModal('برای مشاهده پروژه‌ها، ابتدا باید وضعیت فعالیت را به "فعال" تغییر دهید.', 'info');
                        return;
                    }

                    const activityId = row.dataset.activityId;
                    
                    if (!activityId) {
                        showModal("خطای داخلی: شناسه فعالیت در این ردیف یافت نشد.", "error");
                        return;
                    }

                    const body = row.querySelector('.project-body');
                    const wrapper = body.querySelector('.interaction-list-wrapper');
                    const isOpen = row.classList.contains('open');

                    document.querySelectorAll('#myActivitiesContent .project-row.open').forEach(otherRow => {
                        if (otherRow !== row) otherRow.classList.remove('open');
                    });

                    if (!isOpen && !body.dataset.loaded) {
                        wrapper.innerHTML = '<div class="spinner mx-auto my-4"></div>';
                        showLoader();
                        try {
                            const [detailsResponse, suggestionsResponse] = await Promise.all([
                                fetch(`${GOOGLE_SCRIPT_URL}?func=getActivityDetails&activityId=${activityId}`),
                                fetch(`${GOOGLE_SCRIPT_URL}?func=getSuggestedProjects&activityId=${activityId}`)
                            ]);
                            
                            const detailsResult = await detailsResponse.json();
                            const suggestionsResult = await suggestionsResponse.json();

                            if (!detailsResult.success || !suggestionsResult.success) {
                                throw new Error(detailsResult.message || suggestionsResult.message);
                            }

                            let finalHtml = '';
                            const detailsData = detailsResult.data || { incoming: [], outgoing: [] };
                            const suggestions = suggestionsResult.data || [];
                            const { incoming, outgoing } = detailsData;

                            // ۱. بررسی و ساخت لیست درخواست‌های دریافتی
                            if (incoming && incoming.length > 0) {
                                finalHtml += `
                                    <div class="list-group">
                                        <h5 class="list-header-incoming flex justify-between items-center">
                                            <span><i class="fas fa-envelope-open text-blue-500"></i> درخواست‌های دریافتی</span>
                                            <button class="list-toggle-btn" data-action="toggle-list"><i class="fas fa-chevron-up"></i></button>
                                        </h5>
                                        <div class="interaction-list-content">${renderInteractionList(incoming, 'incomingReqs')}</div>
                                    </div>`;
                            }
                            
                            // ۲. بررسی و ساخت لیست درخواست‌های ارسالی
                            if (outgoing && outgoing.length > 0) {
                                finalHtml += `
                                    <div class="list-group">
                                        <h5 class="list-header-outgoing flex justify-between items-center">
                                            <span><i class="fas fa-paper-plane text-green-500"></i> درخواست‌های ارسالی شما</span>
                                            <button class="list-toggle-btn" data-action="toggle-list"><i class="fas fa-chevron-up"></i></button>
                                        </h5>
                                        <div class="interaction-list-content">${renderInteractionList(outgoing, 'outgoingApps')}</div>
                                    </div>`;
                            }
                            
                            // ۳. بررسی و ساخت لیست پیشنهادهای هوشمند
                            if (suggestions && suggestions.length > 0) {
                                finalHtml += `
                                    <div class="list-group">
                                        <h5 class="list-header-suggestions flex justify-between items-center">
                                            <span><i class="fas fa-lightbulb text-yellow-500"></i> پروژه‌های پیشنهادی</span>
                                            <button class="list-toggle-btn" data-action="toggle-list"><i class="fas fa-chevron-up"></i></button>
                                        </h5>
                                        <div class="interaction-list-content">${renderInteractionList(suggestions, 'projectSuggestions', activityId)}</div>
                                    </div>`;
                            }

                            if (finalHtml === '') {
                                finalHtml = '<p class="text-center text-sm p-4 text-slate-500">موردی برای نمایش در این بخش وجود ندارد.</p>';
                            }

                            wrapper.innerHTML = finalHtml;
                            body.dataset.loaded = 'true';
                        } catch (error) {
                            wrapper.innerHTML = `<p class="text-center text-red-500 p-4">خطا در بارگذاری جزئیات: ${error.message}</p>`;
                        } finally {
                            hideLoader();
                        }
                    }
                    row.classList.toggle('open');
                });
            });
        }
        
        function renderRequesters(requesters, bodyElement) {
            if (requesters.length === 0) {
                bodyElement.innerHTML = '<div class="p-4 text-center text-slate-500">هنوز درخواستی برای این فعالیت ثبت نشده است.</div>';
                return;
            }
            let html = '';
            requesters.forEach((req, index) => {
                 html += `
                    <div class="applicant-row p-4" data-email="${req.email}">
                        <div class="header-item">
                            <strong>${toPersianNum(index + 1)}</strong>
                        </div>
                        <div class="header-item">
                            <strong>${req.name}</strong>
                            <span>نام کارفرما</span>
                        </div>
                        <div class="header-item">
                            <strong>${req.province || '-'}</strong>
                            <span>استان</span>
                        </div>
                        <div class="header-item">
                            <strong>${req.city || '-'}</strong>
                            <span>شهر</span>
                        </div>
                        <div class="header-item">
                            <strong>${formatTimeAgo(req.requestDate)}</strong>
                            <span>زمان درخواست</span>
                        </div>
                        <div class="action-btn-container">
                            <button class="btn btn-secondary !py-1 !px-3 w-full" data-action="toggle-options">
                                <i class="fas fa-reply"></i>
                                <span>پاسخ </span>
                            </button>
                            <div class="action-options hidden">
                                <a href="#" data-action="set-coop-status" data-status="Accepted"><i class="fas fa-check-circle text-green-500"></i> پذیرش</a>
                                <a href="#" data-action="set-coop-status" data-status="Rejected"><i class="fas fa-times-circle text-red-500"></i> عدم پذیرش</a>
                                <a href="#" data-action="set-coop-status" data-status="Reviewing"><i class="fas fa-clock text-yellow-500"></i> در حال بررسی</a>
                            </div>
                        </div>
                    </div>`;
            });
            bodyElement.innerHTML = html;
        }
        
        function getActivityCardHTML(data, forEmployer = false) {
            const remainingArea = (data.maxArea || 0) - (data.occupiedArea || 0);
            const areaPercentage = data.maxArea > 0 ? (remainingArea / data.maxArea) * 100 : 0;
            const remainingProjects = (data.maxProjects || 0) - (data.currentProjects || 0);
            const projectPercentage = data.maxProjects > 0 ? (remainingProjects / data.maxProjects) * 100 : 0;
            const levelMap = { 'پایه 3': 1, 'پایه 2': 2, 'پایه 1': 3, 'پایه ارشد': 4 };
            const starsCount = levelMap[data.engineerLevel] || 1;
            const starsHtml = '<i class="fas fa-star text-yellow-400"></i>'.repeat(starsCount);
            const isActive = data.Status === 'فعال';

            let footerHtml = '';
            if (forEmployer) {
                const isRequested = requestedCooperationIds.has(data.ActivityID);
                footerHtml = `<button data-action="${isRequested ? 'cancel-cooperation' : 'request-cooperation'}" data-activity-id="${data.ActivityID}" class="btn ${isRequested ? 'btn-danger' : 'btn-success'} w-full">
                    <i class="fas ${isRequested ? 'fa-times-circle' : 'fa-paper-plane'} mr-2"></i>${isRequested ? 'لغو درخواست همکاری' : 'درخواست همکاری'}</button>`;
            } else {
                footerHtml = `
                    <button data-action="change-activity-status" data-activity-id="${data.ActivityID}" data-new-status="${isActive ? 'غیرفعال' : 'فعال'}" class="btn ${isActive ? 'btn-danger' : 'btn-success'} !py-1 !px-3 text-sm"><i class="fas ${isActive ? 'fa-eye-slash' : 'fa-eye'}"></i><span>${isActive ? 'غیرفعال کن' : 'فعال کن'}</span></button>
                    <button data-action="edit-activity" data-activity-id="${data.ActivityID}" class="btn btn-secondary !py-1 !px-3 text-sm"><i class="fas fa-edit"></i><span>ویرایش</span></button>
                `;
            }

            return `
            <div class="activity-card bg-white rounded-lg overflow-hidden ${!isActive && !forEmployer ? 'opacity-60 bg-slate-50' : ''}">
                <div class="p-4 border-b">
                     <div class="flex justify-between items-start">
                     <div class="flex flex-col">
                         <div class="flex">${starsHtml}</div>
                         <h4 class="font-bold text-lg text-slate-800 mt-1">${data.engineerActivity} ${data.engineerLevel} ${data.engineerField}</h4>
                     </div>
                         ${!forEmployer ? `<span class="px-3 py-1 text-sm font-semibold rounded-full ${isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${data.Status}</span>` : `<p class="text-sm text-slate-500 text-left">آخرین ویرایش:<br>${formatTimeAgo(data.LastModifiedDate)}</p>`}
                     </div>
                </div>
                <div class="p-4 space-y-4">
                     <div class="flex items-center justify-between gap-2 p-2 bg-slate-100 rounded-md">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-green-600"></i>
                                <span class="font-semibold text-slate-700">${data.province} - ${data.city}</span>
                        </div>
                        ${data.needsHelp ? '<span class="needs-help">نیازمند کمک مجری</span>' : ''}
                     </div>
                    <div> 
                        <div class="flex gap-4 items-center justify-between text-sm">
                            <label class="font-medium text-gray-700">متراژ باقی‌مانده</label>
                                <span class="text-gray-600">${remainingArea.toLocaleString('fa-IR')} متر</span>
                        </div>
                        <div class="progress-bar mt-1">
                            <div class="progress-fill bg-green-500" style="width: ${areaPercentage}%">
                            </div>
                        </div>
                    </div>
                    <div> 
                        <div class="flex gap-4 items-center justify-between text-sm">
                            <label class="font-medium text-gray-700">کار باقی‌مانده</label>
                                <span class="text-gray-600">${remainingProjects} از ${data.maxProjects}</span>
                        </div>
                        <div class="progress-bar mt-1">
                            <div class="progress-fill bg-blue-500" style="width: ${projectPercentage}%">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 p-3 bg-gray-50 border-t">${footerHtml}</div>
            </div>`;
        }
        
        function handleEditActivity(activityId) {
            const activityToEdit = fetchedActivities.find(act => act.ActivityID === activityId);
            if (activityToEdit) {
                // دکمه مربوط به ثبت/ویرایش فعالیت در نوار ناوبری پایین را پیدا می‌کنیم
                const createActivityButton = document.getElementById('create-activity-nav-item');
                
                // از تابع اصلی برای جابجایی بین صفحات استفاده می‌کنیم
                switchToView('create-activity', createActivityButton);
                
                // حالا که صفحه ویرایش باز شده، فرم را با اطلاعات فعالیت مورد نظر پر می‌کنیم
                renderActivityForm(activityToEdit);
            }
        }
        
        async function handleChangeActivityStatus(activityId, newStatus) {
            const message = newStatus === 'غیرفعال' ? 'آیا از غیرفعال کردن این فعالیت مطمئن هستید؟' : 'آیا می‌خواهید این فعالیت را دوباره فعال کنید؟';
            showModal(message, 'confirm', async () => {
                welcomeLoader.style.opacity = '1';
                welcomeLoader.style.display = 'flex';
                try {
                    const payload = { action: 'changeActivityStatus', activityId, newStatus };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showModal(result.message, 'success');
                        renderMyActivities();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showModal(`خطا در تغییر وضعیت: ${error.message}`, 'error');
                } finally {
                    welcomeLoader.style.opacity = '0';
                    setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
                }
            });
        }

// این تابع جدید جایگزین کامل تابع renderProjectsHeader می‌شود
function renderProjectMarketplaceHeader() {
    const headerHtml = `
        <div id="filter-sort-container" class="filter-sort-bar">
            <div class="filter-group">
                <button class="filter-btn" data-filter="province">
                    <i class="fas fa-map-marker-alt"></i><span>استان</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه استان‌ها</div>
                    ${PROVINCES.map(p => `<div class="filter-dropdown-item" data-value="${p}">${p}</div>`).join('')}
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="engineerField">
                    <i class="fas fa-drafting-compass"></i><span>رشته مهندس</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه رشته‌ها</div>
                    <div class="filter-dropdown-item" data-value="معماری">معماری</div>
                    <div class="filter-dropdown-item" data-value="عمران">عمران</div>
                    <div class="filter-dropdown-item" data-value="مکانیک">مکانیک</div>
                    <div class="filter-dropdown-item" data-value="برق">برق</div>
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="engineerRank">
                    <i class="fas fa-star"></i><span>پایه مهندس</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه پایه‌ها</div>
                    <div class="filter-dropdown-item" data-value="پایه 3">پایه 3</div>
                    <div class="filter-dropdown-item" data-value="پایه 2">پایه 2</div>
                    <div class="filter-dropdown-item" data-value="پایه 1">پایه 1</div>
                    <div class="filter-dropdown-item" data-value="پایه ارشد">پایه ارشد</div>
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="engineerActivity">
                    <i class="fas fa-briefcase"></i><span>نوع فعالیت</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه فعالیت ها</div>
                    <div class="filter-dropdown-item" data-value="طراح">طراح</div>
                    <div class="filter-dropdown-item" data-value="ناظر">ناظر</div>
                    <div class="filter-dropdown-item" data-value="مجری">مجری</div>
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="permitType">
                    <i class="fas fa-id-card"></i><span>نوع پروانه</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه پروانه ها</div>
                    <div class="filter-dropdown-item" data-value="طراح حقوقی">طراح حقوقی</div>
                    <div class="filter-dropdown-item" data-value="ناظر حقوقی">ناظر حقوقی</div>
                    <div class="filter-dropdown-item" data-value="انبوه ساز">انبوه ساز</div>
                    <div class="filter-dropdown-item" data-value="مجری حقوقی">مجری حقوقی</div>
                    <div class="filter-dropdown-item" data-value="مهندس حقیقی">مهندس حقیقی</div>
                    <div class="filter-dropdown-item" data-value="کاردان">کاردان</div>
                    <div class="filter-dropdown-item" data-value="معمارتجربی">معمارتجربی</div>
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="fileType">
                    <i class="fas fa-file-alt"></i><span>نوع پرونده</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه پرونده ها</div>
                    <div class="filter-dropdown-item" data-value="عادی">عادی</div>
                    <div class="filter-dropdown-item" data-value="فرسوده">فرسوده</div>
                </div>
            </div>
            <div class="flex-grow"></div> <button class="sort-btn active" data-sort="newest"><i class="fas fa-sort-amount-down"></i>جدیدترین</button>
            <button class="sort-btn" data-sort="oldest"><i class="fas fa-sort-amount-up"></i>قدیمی‌ترین</button>
            <button class="sort-btn" data-sort="cheapest"><i class="fas fa-dollar-sign"></i>ارزان‌ترین</button>
            <button class="sort-btn" data-sort="mostExpensive"><i class="fas fa-dollar-sign"></i>گران‌ترین</button>
        </div>
        <div id="project-list-container"></div>
    `;
    projectsContent.innerHTML = headerHtml;

    // منطق جدید برای فعال‌سازی دکمه‌های هوشمند
    const activeFilters = {};
    let activeSort = 'newest';

    function applyFiltersAndSort() {
        // 1. فیلتر کردن
        let filtered = fetchedProjects.filter(p => {
            return Object.entries(activeFilters).every(([key, value]) => {
                return !value || p[key] === value;
            });
        });

        // 2. مرتب‌سازی
        filtered.sort((a, b) => {
            switch (activeSort) {
                case 'oldest': return new Date(a.SubmissionDate) - new Date(b.SubmissionDate);
                case 'cheapest': return (a.area * a.unitPrice) - (b.area * b.unitPrice);
                case 'mostExpensive': return (b.area * b.unitPrice) - (a.area * a.unitPrice);
                case 'newest':
                default:
                    return new Date(b.SubmissionDate) - new Date(a.SubmissionDate);
            }
        });

        displayProjects(filtered);
    }

    // افزودن Event Listener به دکمه‌های فیلتر
    document.querySelectorAll('.filter-group').forEach(group => {
        const button = group.querySelector('.filter-btn');
        const dropdown = group.querySelector('.filter-dropdown');
        const buttonTextSpan = button.querySelector('span');
        const originalText = buttonTextSpan.textContent;

        button.addEventListener('click', (e) => {
            if (e.target.classList.contains('close-icon')) {
                // حذف فیلتر
                delete activeFilters[button.dataset.filter];
                button.classList.remove('active');
                buttonTextSpan.textContent = originalText;
                button.querySelector('.close-icon')?.remove();
                applyFiltersAndSort();
                return;
            }
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        dropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-dropdown-item')) {
                const value = e.target.dataset.value;
                const filterKey = button.dataset.filter;

                button.querySelector('.close-icon')?.remove(); // حذف ضربدر قبلی

                if (value) {
                    activeFilters[filterKey] = value;
                    button.classList.add('active');
                    buttonTextSpan.textContent = value;
                    button.insertAdjacentHTML('beforeend', `<i class="fas fa-times close-icon"></i>`);
                } else {
                    delete activeFilters[filterKey];
                    button.classList.remove('active');
                    buttonTextSpan.textContent = originalText;
                }

                applyFiltersAndSort();
                dropdown.style.display = 'none';
            }
        });
    });

    // افزودن Event Listener به دکمه‌های مرتب‌سازی
    const sortButtons = document.querySelectorAll('.sort-btn');
    sortButtons.forEach(button => {
        button.addEventListener('click', () => {
            sortButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            activeSort = button.dataset.sort;
            applyFiltersAndSort();
        });
    });

    // بستن منوهای کشویی با کلیک در بیرون از آن‌ها
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-group')) {
            document.querySelectorAll('.filter-dropdown').forEach(d => d.style.display = 'none');
        }
    });

    applyFiltersAndSort(); // نمایش اولیه پروژه‌ها
}
        
        function displayProjects(projectsToDisplay) {
            const container = document.getElementById('project-list-container');
            if (!container) return;
            container.innerHTML = projectsToDisplay.length > 0 ? projectsToDisplay.map(p => getProjectCardHTML(p, 'engineer', appliedProjectIds.has(p.ProjectID))).join('') : '<p class="text-center text-slate-500 col-span-full">پروژه‌ای مطابق با فیلترهای شما یافت نشد.</p>';
        }

        function applyFilters() {
            const filters = {
                province: document.getElementById('filterProvince').value, city: document.getElementById('filterCity').value.trim().toLowerCase(),
                engineerField: document.getElementById('filterEngineerField').value, engineerRank: document.getElementById('filterEngineerRank').value,
                engineerActivity: document.getElementById('filterEngineerActivity').value, permitType: document.getElementById('filterPermitType').value,
            };
            const filtered = fetchedProjects.filter(p => 
                (!filters.province || p.province === filters.province) && (!filters.city || p.city.toLowerCase().includes(filters.city)) &&
                (!filters.engineerField || p.engineerField === filters.engineerField) && (!filters.engineerRank || p.engineerRank === filters.engineerRank) &&
                (!filters.engineerActivity || p.engineerActivity === filters.engineerActivity) && (!filters.permitType || p.permitType === filters.permitType)
            );
            displayProjects(filtered);
        }

        function resetFilters() {
            const filterContainer = document.getElementById('filter-container');
            if (filterContainer) {
                filterContainer.querySelectorAll('input, select').forEach(el => el.tagName === 'SELECT' ? el.selectedIndex = 0 : el.value = '');
            }
            displayProjects(fetchedProjects);
        }

async function renderProjectMarketplace() {
            projectsContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                // واکشی همزمان پروژه‌ها و فعالیت‌های مهندس
                const [projectsResponse, activitiesResponse] = await Promise.all([
                    fetch(`${GOOGLE_SCRIPT_URL}?func=getMarketplaceData&email=${encodeURIComponent(userData.email)}`),
                    fetch(`${GOOGLE_SCRIPT_URL}?func=getActivitiesByEngineer&email=${encodeURIComponent(userData.email)}`)
                ]);

                const projectsResult = await projectsResponse.json();
                const activitiesResult = await activitiesResponse.json();

                if (projectsResult.success && activitiesResult.success) {
                    fetchedProjects = projectsResult.data.openProjects || [];
                    appliedProjectIds = new Set(projectsResult.data.appliedProjectIds || []);
                    engineerActivities = activitiesResult.data || []; // ذخیره فعالیت‌های مهندس
                    renderProjectMarketplaceHeader();
                } else {
                    throw new Error('خطا در دریافت اطلاعات پروژه‌ها یا فعالیت‌ها.');
                }
            } catch (error) {
                projectsContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری: ${error.message}</p>`;
            }
        }

        function compareGrades(engineerGrade, projectGrade) {
            const gradeValues = { 'پایه 3': 1, 'پایه 2': 2, 'پایه 1': 3, 'پایه ارشد': 4 };
            const engineerValue = gradeValues[engineerGrade] || 0;
            const projectValue = gradeValues[projectGrade] || 0;
            return engineerValue >= projectValue; // اگر پایه مهندس بهتر یا مساوی بود، true برمی‌گرداند
        }

async function checkApplicationPrerequisites(projectId, button) {
    const project = fetchedProjects.find(p => p.ProjectID === projectId);
    if (!project) return;

    // جستجو برای یافتن یک فعالیت واجد شرایط
    const qualifiedActivity = engineerActivities.find(activity => {
        const isActive = activity.Status === 'فعال';
        const isActivityTypeMatch = activity.engineerActivity === project.engineerActivity;
        const isGradeSufficient = compareGrades(activity.engineerLevel, project.engineerRank);
        let isFieldMatch = activity.engineerField === project.engineerField;
        if (project.engineerActivity === 'مجری' &&
            ((project.engineerField === 'معماری' && activity.engineerField === 'عمران') ||
             (project.engineerField === 'عمران' && activity.engineerField === 'معماری'))) {
            isFieldMatch = true;
        }
        return isActive && isActivityTypeMatch && isGradeSufficient && isFieldMatch;
    });

    if (qualifiedActivity) {
        // اگر شرایط احراز شد، درخواست مستقیماً از اینجا ارسال می‌شود
        showLoader();
        try {
            const payload = {
                action: 'createInteraction', // استفاده از تابع جدید بک‌اند
                ProjectID: project.ProjectID,
                ActivityID: qualifiedActivity.ActivityID, // شناسه فعالیت واجد شرایط
                InitiatorRole: 'Engineer',
                InitiatorEmail: userData.email,
                RecipientEmail: project.EmployerEmail // ایمیل کارفرمای صاحب پروژه
            };
            const response = await fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload) 
            });
            const result = await response.json();
            showModal(result.message, result.status);

                    if (result.status === 'success') {
                        // ۱. شناسه پروژه را به لیست درخواست‌های ارسال شده اضافه می‌کنیم
                        appliedProjectIds.add(projectId);
                        
                        // ۲. کارت پروژه را پیدا کرده و آن را با دکمه جدید بازрисов می‌کنیم
                        const card = button.closest('.project-card');
                        if (card) {
                            card.outerHTML = getProjectCardHTML(project, 'engineer', true); // isApplied = true
                        }
                    }
        } catch (error) {
            showModal('خطا در ارسال درخواست همکاری.', 'error');
        } finally {
            hideLoader();
        }
    } else {
        // اگر شرایط احراز نشد، پیام راهنما نمایش داده می‌شود
        const message = 'شما فعالیت ثبت‌شده و فعالی که با نیازمندی‌های این پروژه مطابقت داشته باشد، ندارید. لطفاً ابتدا یک فعالیت مرتبط ثبت نمایید.';
        showModal(message, 'info');
    }
}
        function toPersianNum(num) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString('fa-IR');
        }
        // --- تابع جدید بررسی پیش‌نیاز برای کارفرما ---
async function checkCooperationPrerequisites(activity) {
    showLoader();
    // ۱. ابتدا از بک‌اند لیست پروژه‌های واجد شرایط را درخواست می‌کنیم
    const response = await fetch(GOOGLE_SCRIPT_URL + `?func=getMatchingProjectsForActivity&payload=${JSON.stringify({employerEmail: userData.email, activity})}`);
    const result = await response.json();
    hideLoader();

    if (result.success && result.data.length > 0) {
        // ۲. اگر پروژه واجد شرایطی بود، یک مودال برای انتخاب پروژه نمایش می‌دهیم
        // renderMatchingProjectsModal(result.data, activity.ActivityID);
        showModal('پروژه واجد شرایط یافت شد! (پیاده‌سازی مودال انتخاب پروژه)', 'success');
    } else {
        // ۳. در غیر این صورت، پیام راهنما نمایش داده می‌شود
        showModal('شما پروژه فعال و مرتبطی برای ارسال درخواست به این مهندس ندارید. لطفاً ابتدا یک پروژه مرتبط ثبت کرده یا پروژه موجود خود را فعال نمایید.', 'info');
    }
}
        async function renderEmployerProjects() {
            projectsContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getProjectsByEmployer&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);

                fetchedProjects = result.data.sort((a, b) => new Date(b.lastModifiedDate) - new Date(a.lastModifiedDate));
                if (fetchedProjects.length > 0) {
                    let projectsHtml = '<div class="project-accordion">';
                    fetchedProjects.forEach(p => {
                        const isClosed = p.Status === 'بسته';
                        projectsHtml += `
                            <div class="project-row ${isClosed ? 'closed-project' : ''}" data-status="${p.Status}" data-project-id="${p.ProjectID}">
                                <div class="project-header">
                                    <div class="header-item">
                                        <i class="fas fa-chevron-down accordion-icon"></i>
                                    </div>
                                    <div class="header-item">
                                        <strong>${p.projectName}</strong>
                                        <span class="text-xs text-slate-500">منطقه ${toPersianNum(p.district)} ${p.city}</span>
                                    </div>
                                    <div class="header-item">
                                        <strong>${p.engineerActivity} ${p.engineerRank}</strong>
                                        <span class="text-xs text-slate-500">مهندس ${p.engineerField}</span>
                                    </div>
                                    <div class="header-item">
                                        <strong>${toPersianNum(p.floors)} طبقه</strong>
                                        ${parseInt(p.basementFloors) > 0 ? `<strong>${toPersianNum(p.basementFloors)} زیرزمین</strong>` : ''}
                                    </div>
                                    <div class="header-item">
                                        <strong>${toPersianNum(p.contractMonths)} ماه</strong>
                                        <span>مدت قرارداد</span>
                                    </div>
                                    <div class="header-item">
                                        <strong>${toPersianNum(parseFloat(p.unitPrice))} تومان</strong>
                                        <span>تعرفه شما</span>
                                    </div>
                                    <div class="header-item">
                                        ${parseInt(p.incomingRequestCount) > 0 ? `<strong><i class="fas fa-envelope-open text-blue-500"> </i> ${toPersianNum(p.incomingRequestCount)}</strong>` : ''}
                                        ${parseInt(p.outgoingRequestCount) > 0 ? `<strong><i class="fas fa-paper-plane text-green-500"> </i> ${toPersianNum(p.outgoingRequestCount)}</strong>` : ''}
                                    </div>
                                    <div class="header-actions">
                                        <button class="btn ${!isClosed ? 'btn-danger' : 'btn-success'} !p-2" title="${!isClosed ? 'بستن پروژه' : 'باز کردن پروژه'}" data-action="${!isClosed ? 'close-project' : 'open-project'}">
                                            <i class="fas ${!isClosed ? 'fa-lock' : 'fa-lock-open'}"></i>
                                        </button>
                                        <button class="btn btn-secondary !p-2" title="ویرایش پروژه" data-action="edit-project">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                    <div class="project-body">
                                        <div class="interaction-list-wrapper p-2"></div>
                                    </div>
                            </div>`;
                    });
                    projectsHtml += '</div>';
                    projectsContent.innerHTML = projectsHtml;
                    attachProjectRowListeners();
                } else {
                    projectsContent.innerHTML = '<p class="text-center text-slate-500">شما هنوز پروژه‌ای ثبت نکرده‌اید.</p>';
                }
            } catch (error) {
                projectsContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری پروژه‌ها: ${error.message}</p>`;
            }
        }

                // --- تابع جدید بررسی پیش‌نیازها برای ارسال درخواست توسط کارفرما ---
        async function checkCooperationPrerequisites(activity, button) {
            showLoader();
            try {
                const payload = { employerEmail: userData.email, activity: activity };
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getMatchingProjectsForActivity&payload=${encodeURIComponent(JSON.stringify(payload))}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    renderMatchingProjectsModal(result.data, activity.ActivityID, activity.EngineerEmail);
                } else {
                    showModal('شما پروژه فعال و واجد شرایطی برای ارسال درخواست به این مهندس ندارید. لطفاً ابتدا یک پروژه مرتبط ثبت کرده یا پروژه موجود خود را فعال نمایید.', 'info');
                }
            } catch (error) {
                showModal('خطا در بررسی پروژه‌های واجد شرایط.', 'error');
            } finally {
                hideLoader();
            }
        }

        // --- توابع کمکی جدید برای مودال انتخاب پروژه ---
        function renderMatchingProjectsModal(matchingProjects, activityId, recipientEmail) {
            const modal = document.getElementById('selectionModal');
            const titleEl = document.getElementById('selectionModalTitle');
            const bodyEl = document.getElementById('selectionModalBody');
            const closeBtn = document.getElementById('selectionModalCloseBtn');

            titleEl.textContent = 'یک پروژه برای ارسال درخواست انتخاب کنید';
            
            let projectsHtml = '<div class="flex flex-col gap-y-2">';
            matchingProjects.forEach(p => {
                projectsHtml += `<a href="#" class="block p-3 bg-slate-50 hover:bg-slate-100 rounded-lg text-slate-700 font-semibold" data-project-id="${p.projectId}" data-activity-id="${activityId}" data-recipient-email="${recipientEmail}">${p.projectName}</a>`;
            });
            projectsHtml += '</div>';
            bodyEl.innerHTML = projectsHtml;

            bodyEl.onclick = function(e) {
                e.preventDefault();
                const link = e.target.closest('a');
                if (link) {
                    handleProjectSelectionForRequest(link.dataset.projectId, link.dataset.activityId, link.dataset.recipientEmail);
                    modal.style.display = 'none';
                }
            };
            
            closeBtn.onclick = () => modal.style.display = 'none';
            modal.style.display = 'flex';
        }        
        
        async function handleProjectSelectionForRequest(projectId, activityId) {
            showLoader();
            try {
                const payload = {
                    action: 'createInteraction',
                    ProjectID: projectId,
                    ActivityID: activityId,
                    InitiatorRole: 'Employer',
                    InitiatorEmail: userData.email
                };
                const response = await fetch(GOOGLE_SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'cors', 
                    cache: 'no-cache', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify(payload) 
                });
                const result = await response.json();
                showModal(result.message, result.status);

                if (result.status === 'success') {
                    // به‌روزرسانی آنی دکمه در صفحه جستجوی مهندس
                    requestedCooperationIds.add(activityId);
                    const card = document.querySelector(`.activity-card [data-activity-id="${activityId}"]`).closest('.activity-card');
                    const activityData = fetchedEngineersActivities.find(a => a.ActivityID === activityId);
                    if (card && activityData) {
                        card.outerHTML = getActivityCardHTML(activityData, true);
                    }
                }
            } catch(error) {
                 showModal('خطا در ارسال درخواست.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        function setupDashboardFeatures() {
            // فعال‌سازی کلیک روی کارت‌ها
            document.querySelectorAll('#dashboardContent .main-card').forEach(card => {
                card.addEventListener('click', e => {
                    e.preventDefault();
                    const view = card.dataset.view;
                    // پیدا کردن دکمه مربوطه در فوتر و شبیه‌سازی کلیک روی آن
                    const targetButton = document.querySelector(`#bottom-nav [data-view="${view}"]`);
                    if (targetButton) {
                        targetButton.click();
                    }
                });
            });

            // فعال‌سازی افکت توضیحات
            const cards = document.querySelectorAll('#dashboardContent .main-card.group');
            if (window.innerWidth < 1024) { // در موبایل توضیحات همیشه آشکار است
                cards.forEach(card => card.querySelector('.description-text')?.classList.remove('opacity-0'));
                return;
            }
            
            const descriptionElements = Array.from(cards).map(card => card.querySelector('.description-text')).filter(el => el && !el.textContent.trim());
            let currentDescIndex = 0;
            let cycleInterval;
            let isHovering = false;

            function startCycle() {
                if (isHovering || descriptionElements.length === 0) return;

                descriptionElements.forEach(el => el.classList.add('opacity-0'));
                
                const currentElement = descriptionElements[currentDescIndex];
                const currentText = currentElement.getAttribute('data-text');

                if (currentElement && currentText) {
                    currentElement.textContent = currentText;
                    currentElement.classList.remove('opacity-0');
                }

                cycleInterval = setTimeout(() => {
                    if (currentElement) currentElement.classList.add('opacity-0');
                    currentDescIndex = (currentDescIndex + 1) % descriptionElements.length;
                    startCycle();
                }, 9000);
            }

            cards.forEach(card => {
                const descEl = card.querySelector('.description-text');
                if (!descEl) return;

                card.addEventListener('mouseenter', () => {
                    isHovering = true;
                    clearTimeout(cycleInterval);
                    descriptionElements.forEach(el => el.classList.add('opacity-0'));
                    descEl.textContent = descEl.getAttribute('data-text');
                    descEl.classList.remove('opacity-0');
                });

                card.addEventListener('mouseleave', () => {
                    isHovering = false;
                    descEl.classList.add('opacity-0');
                    startCycle();
                });
            });

            startCycle();
        }
        
        async function renderEmployerDashboard() {
            dashboardContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getDashboardData&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                
                const { stats, projects } = result.data;
                projects.sort((a, b) => new Date(b.SubmissionDate) - new Date(a.SubmissionDate));
                let projectsListHtml = projects.slice(0, 2).map(p => `
                
                    <div class="p-2 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-sm text-gray-700 flex items-center">
                                ${p.Status === 'باز' ? '<i class="fas fa-lock-open text-green-500 ml-2" title="پروژه باز"></i>' : '<i class="fas fa-lock text-red-500 ml-2" title="پروژه بسته"></i>'}
                                ${p.projectName}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">${p.engineerActivity} ${p.engineerRank} ${p.engineerField}</p>
                        </div>
                        
                        <div class="flex items-center gap-x-3 text-slate-600">
                            ${parseInt(p.applicantCount) > 0 ? `<i class="fas fa-envelope-open text-blue-500" title="درخواست‌های دریافتی"></i><span class="font-bold text-lg">${toPersianNum(p.applicantCount)}</span>` : ''}
                            ${parseInt(p.outgoingCount) > 0 ? `<div class="border-l h-5 border-slate-300"></div><i class="fas fa-paper-plane text-green-500" title="درخواست‌های ارسالی"></i><span class="font-bold text-lg">${toPersianNum(p.outgoingCount)}</span>` : ''}
                        </div>
                    </div><hr class="border-gray-300"/>`).join('');

                if (projects.length === 0) projectsListHtml = '<p class="text-center text-slate-500 col-span-2">هنوز پروژه‌ای ثبت نکرده‌اید.</p>';
                
                dashboardContent.innerHTML = `
                    <div class="flex flex-col md:flex-row items-stretch gap-8">
                        <div class="w-full md:w-1/2 flex flex-col gap-8">
                            <a href="#" data-view="profile" class="main-card group rounded-2xl border-slate-400 p-1 shadow-lg flex-grow block">
                                <div class="card-content bg-gradient-to-b from-white to-slate-100 rounded-xl p-4 w-full flex flex-col h-full">
                                    <div class="description-text text-center text-gray-600 text-sm opacity-0" data-text="اطلاعات کاربری خود را در این بخش مشاهده و ویرایش کنید."></div>
                                    <div class="mt-auto pt-4 flex items-center justify-start"><div class="icon-link flex items-center gap-x-3 font-bold text-slate-700 p-2 rounded-lg"><i class="far fa-user-circle text-2xl text-slate-500"></i><span class="text-lg">سـلام، ${userData.stepsData.step1.employerFirstName || ''} ${userData.stepsData.step1.employerLastName || 'کاربر'}</span></div></div>
                                </div>
                            </a>
                            <a href="#" data-view="create-project" class="main-card group border-yellow-500 rounded-2xl p-1 shadow-lg flex-grow block">
                                <div class="bg-gradient-to-b from-white to-yellow-50 rounded-xl p-4 w-full flex flex-col h-full">
                                    <div class="bg-white rounded-xl border border-gray-300 overflow-hidden">
                                        <div class="p-4 flex justify-between h-24 bg-gradient-to-t from-green-100 to-white"><i class="fas fa-lock-open text-green-500 ml-2"></i><span class="text-xl font-bold text-green-700 self-end">پـروژه‌هـای بـاز </span><span class="text-3xl font-bold text-green-600 self-start">${toPersianNum(stats.open)}</span></div><hr class="border-gray-300"/>
                                        <div class="p-4 flex justify-between h-24 bg-gradient-to-t from-red-100 to-white"><i class="fas fa-lock text-red-500 ml-2"></i><span class="text-xl font-bold text-red-800 self-end">پـروژه‌هـای بسته </span><span class="text-3xl font-bold text-red-900 self-start">${toPersianNum(stats.closed)}</span></div>
                                    </div>
                                    <div class="description-text text-center text-gray-600 text-sm" data-text="یک پروژه جدید ثبت کنید تا بهترین مهندسان برای آن درخواست همکاری ارسال کنند."></div>
                                    <div class="mt-auto pt-4 flex items-center justify-start"><div class="icon-link flex items-center gap-x-2 font-bold text-orange-900 p-2 rounded-lg"><i class="far fa-square-plus text-3xl text-orange-800"></i><span class="text-xl">ثـبت پـروژه جـدید</span></div></div>
                                </div>
                            </a>
                        </div>
                        <div class="w-full md:w-1/2 flex flex-col gap-8">
                            <a href="#" data-view="projects" class="main-card group rounded-2xl border-slate-400 p-1 shadow-lg flex-grow block">
                                <div class="card-content bg-gradient-to-b from-white to-slate-100 rounded-xl p-4 w-full flex flex-col h-full">
                                    <div class="bg-white rounded-xl border border-gray-300 overflow-hidden"><h2 class="text-center text-lg font-bold p-2 text-gray-800">آخـرین پـروژه‌هـای من</h2><hr class="border-gray-300"/>${projectsListHtml}</div>
                                    <div class="description-text text-center text-gray-600 text-sm opacity-0" data-text="پروژه‌های ثبت شده خود را مدیریت کنید."></div>
                                    <div class="mt-auto pt-4 flex items-center justify-start"><div class="icon-link flex items-center gap-x-2 font-bold text-slate-700 p-2 rounded-lg"><i class="fas fa-briefcase text-2xl text-slate-500"></i><span class="text-lg">پـروژه‌هـای من</span></div></div>
                                </div>
                            </a>
                            <a href="#" data-view="engineers" class="main-card group rounded-2xl border-slate-400 p-1 shadow-lg flex-grow block">
                                <div class="card-content bg-gradient-to-b from-white to-slate-100 rounded-xl p-4 w-full flex flex-col h-full">
                                    <div class="description-text text-center text-gray-600 text-sm opacity-0" data-text="لیست مهندسان فعال را برای همکاری در پروژه‌های خود جستجو کنید."></div>
                                    <div class="mt-auto pt-4 flex items-center justify-start"><div class="icon-link flex items-center gap-x-3 font-bold text-slate-700 p-2 rounded-lg"><i class="fas fa-search text-2xl text-slate-500"></i><span class="text-lg">جسـتجـوی مهـندس</span></div></div>
                                </div>
                            </a>
                        </div>
                    </div>`;
                setupDashboardFeatures();
            } catch (error) {
                dashboardContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری داشبورد: ${error.message}</p>`;
            }
        }

        async function renderEngineerDashboard() {
            dashboardContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                // ۱. دریافت اطلاعات مخصوص داشبورد مهندس
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getEngineerDashboardData&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                
                const { stats, activities } = result.data;

                // ۲. آماده‌سازی لیست دو فعالیت اخیر برای نمایش در کارت
                activities.sort((a, b) => new Date(b.LastModifiedDate) - new Date(a.LastModifiedDate));
                let activitiesListHtml = activities.slice(0, 2).map(act => `
                
                    <div class="p-2 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-sm text-gray-700 flex items-center">
                                ${act.Status === 'فعال' ? '<i class="fas fa-lock-open text-green-500 ml-2" title="فعالیت باز"></i>' : '<i class="fas fa-lock text-red-500 ml-2" title="فعالیت بسته"></i>'}
                                ${act.engineerActivity} ${act.engineerLevel}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">مهـندسی ${act.engineerField}</p>
                        </div>
                        
                        <div class="flex items-center gap-x-3 text-slate-600">
                            ${parseInt(act.incomingRequestCount) > 0 ? `<i class="fas fa-envelope-open text-blue-500" title="درخواست‌های دریافتی"></i><span class="font-bold text-lg">${toPersianNum(act.incomingRequestCount)}</span>` : ''}
                            ${parseInt(act.outgoingApplicationCount) > 0 ? `<div class="border-l h-5 border-slate-300"></div><i class="fas fa-paper-plane text-green-500" title="درخواست‌های ارسالی"></i><span class="font-bold text-lg">${toPersianNum(act.outgoingApplicationCount)}</span>` : ''}
                        </div>
                    </div>
                    <hr class="border-gray-300"/>`).join('');                   
                
                if (activities.length === 0) {
                    activitiesListHtml = '<p class="text-center text-sm text-gray-500 p-4">فعالیتی ثبت نشده است.</p>';
                }

                // ۳. ساخت کل ساختار HTML داشبورد با اطلاعات داینامیک
                dashboardContent.innerHTML = `
                    <div class="flex flex-col md:flex-row items-stretch gap-8">
                        <div class="w-full md:w-1/2 flex flex-col gap-8">
                            <a href="#" data-view="profile" class="main-card group rounded-2xl p-1 shadow-lg flex-grow block">
                                <div class="card-content bg-gradient-to-b from-white to-slate-100 rounded-xl p-4 w-full flex flex-col h-full">
                                    <div class="description-text text-center text-gray-600 text-sm opacity-0" data-text="اطلاعات کاربری خود را در این بخش مشاهده و ویرایش کنید."></div>
                                    <div class="mt-auto pt-4 flex items-center justify-start"><div class="icon-link flex items-center gap-x-3 font-bold text-slate-700 p-2 rounded-lg"><i class="far fa-user-circle text-2xl text-slate-500"></i><span class="text-lg">سـلام، ${userData.stepsData.step1.engineerFirstName || ''} ${userData.stepsData.step1.engineerLastName || 'کاربر'}</span></div></div>
                                </div>
                            </a>
                            <a href="#" data-view="create-activity" class="main-card group border-yellow-500 rounded-2xl p-1 shadow-lg flex-grow block">
                                <div class="bg-gradient-to-b from-white to-yellow-50 rounded-xl p-4 w-full flex flex-col h-full">
                                    <div class="bg-white rounded-xl border border-gray-300 overflow-hidden">
                                        <div class="p-4 flex justify-between h-24 bg-gradient-to-t from-green-100 to-white"><span class="text-xl font-bold text-green-700 self-end">فعـالـیت‌هـای بـاز</span><span class="text-3xl font-bold text-green-600 self-start">${toPersianNum(stats.active)}</span></div><hr class="border-gray-300"/>
                                        <div class="p-4 flex justify-between h-24 bg-gradient-to-t from-red-100 to-white"><span class="text-xl font-bold text-red-800 self-end">فعـالـیت‌هـای بسته</span><span class="text-3xl font-bold text-red-900 self-start">${toPersianNum(stats.inactive)}</span></div>
                                    </div>
                                    <div class="description-text text-center text-gray-600 text-sm" data-text="با ثبت یک فعالیت جدید، آمادگی خود را برای دریافت پروژه‌های جدید به کارفرمایان اعلام کنید."></div>
                                    <div class="mt-auto pt-4 flex items-center justify-start"><div class="icon-link flex items-center gap-x-2 font-bold text-orange-900 p-2 rounded-lg"><i class="far fa-square-plus text-3xl text-orange-800"></i><span class="text-xl">ثـبت فعـالـیت جـدید</span></div></div>
                                </div>
                            </a>
                        </div>
                        <div class="w-full md:w-1/2 flex flex-col gap-8">
                            <a href="#" data-view="my-activities" class="main-card group rounded-2xl p-1 shadow-lg flex-grow block">
                                <div class="card-content bg-gradient-to-b from-white to-slate-100 rounded-xl p-4 w-full flex flex-col h-full">
                                    <div class="bg-white rounded-xl border border-gray-300 overflow-hidden"><h2 class="text-center text-lg font-bold p-2 text-gray-800">آخـرین فعـالیت‌هـای من</h2><hr class="border-gray-300"/>${activitiesListHtml}</div>
                                    <div class="description-text text-center text-gray-600 text-sm opacity-0" data-text="فعالیت‌های ثبت شده شما برای نمایش به کارفرمایان در این بخش مدیریت می‌شوند."></div>
                                    <div class="mt-auto pt-4 flex items-center justify-start"><div class="icon-link flex items-center gap-x-2 font-bold text-slate-700 p-2 rounded-lg"><i class="fas fa-briefcase text-2xl text-slate-500"></i><span class="text-lg">فعـالیـت‌هـای من</span></div></div>
                                </div>
                            </a>
                            <a href="#" data-view="projects" class="main-card group rounded-2xl p-1 shadow-lg flex-grow block">
                                <div class="card-content bg-gradient-to-b from-white to-slate-100 rounded-xl p-4 w-full flex flex-col h-full">
                                    <div class="description-text text-center text-gray-600 text-sm opacity-0" data-text="لیست پروژه‌های باز کارفرمایان در اینجا نمایش داده می‌شود. می‌توانید برای همکاری درخواست ارسال کنید."></div>
                                    <div class="mt-auto pt-4 flex items-center justify-start"><div class="icon-link flex items-center gap-x-3 font-bold text-slate-700 p-2 rounded-lg"><i class="fas fa-search text-2xl text-slate-500"></i><span class="text-lg">جـستـجوی پـروژه</span></div></div>
                                </div>
                            </a>
                        </div>
                    </div>`;
                
                // ۴. فعال‌سازی افکت‌ها و قابلیت کلیک روی کارت‌ها
                setupDashboardFeatures();

            } catch (error) {
                dashboardContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری داشبورد: ${error.message}</p>`;
            }
        }
        
        async function renderEngineersPanel() {
            engineersContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getAllActiveActivities&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (result.success && result.data) {
                    fetchedEngineersActivities = result.data.activeActivities || [];
                    requestedCooperationIds = new Set(result.data.requestedActivityIds || []);
                    const container = document.createElement('div');
                    container.id = 'engineers-list-container';
                    if (fetchedEngineersActivities.length > 0) {
                        container.innerHTML = fetchedEngineersActivities.map(act => getActivityCardHTML(act, true)).join('');
                    } else {
                        container.innerHTML = '<p class="text-center text-slate-500 col-span-full">در حال حاضر هیچ مهندس فعالی یافت نشد.</p>';
                    }
                    engineersContent.innerHTML = '';
                    engineersContent.appendChild(container);
                } else {
                     engineersContent.innerHTML = `<p class="text-center text-red-500">${result.message || 'خطا در دریافت لیست مهندسان.'}</p>`;
                }
            } catch (error) {
                engineersContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری لیست مهندسان: ${error.message}</p>`;
            }
        }
        
        // --- Notification Logic ---
        async function renderNotifications() {
            notificationsContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getNotifications&email=${encodeURIComponent(userData.email)}&role=${userData.role}`);
                const result = await response.json();
                if (result.success && result.data) {
                    fetchedNotifications = result.data.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                    
                    if (fetchedNotifications.length > 0) {
                        const notificationsHtml = fetchedNotifications.map(notif => {
                            const isUnread = notif.Status === 'Unread';
                            return `
                                <div class="notification-item p-4 cursor-pointer flex items-center ${isUnread ? 'unread' : ''}" data-message-id="${notif.MessageID}">
                                    ${isUnread ? '<div class="dot ml-4"></div>' : '<div class="w-[10px] ml-4"></div>'}
                                    <div class="flex-grow">
                                        <div class="flex justify-between items-center">
                                            <p class="font-semibold text-slate-800">${notif.Title}</p>
                                            <p class="text-xs text-slate-500">${formatTimeAgo(notif.Timestamp)}</p>
                                        </div>
                                        <p class="text-sm text-slate-600 mt-1">از طرف: ${notif.Sender}</p>
                                    </div>
                                    <i class="fas fa-chevron-left text-slate-400 mr-4"></i>
                                </div>
                            `;
                        }).join('');
                        notificationsContent.innerHTML = `<div class="bg-white rounded-lg shadow-md overflow-hidden">${notificationsHtml}</div>`;
                    } else {
                        notificationsContent.innerHTML = '<p class="text-center text-slate-500">شما هیچ پیام جدیدی ندارید.</p>';
                    }
                    updateNotificationBadge();
                } else {
                    notificationsContent.innerHTML = `<p class="text-center text-red-500">${result.message || 'خطا در دریافت پیام‌ها.'}</p>`;
                }
            } catch (error) {
                notificationsContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری پیام‌ها: ${error.message}</p>`;
            }
        }

        function updateNotificationBadge() {
            const unreadCount = fetchedNotifications.filter(n => n.Status === 'Unread').length;
            const badge = document.getElementById('notification-badge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        async function openNotificationModal(messageId) {
            const notification = fetchedNotifications.find(n => n.MessageID === messageId);
            if (!notification) return;

            document.getElementById('notificationModalTitle').textContent = notification.Title;
            document.getElementById('notificationModalMeta').textContent = `از طرف: ${notification.Sender}  |  در تاریخ: ${new Date(notification.Timestamp).toLocaleString('fa-IR')}`;
            document.getElementById('notificationModalBody').innerHTML = notification.Body.replace(/\n/g, '<br>'); // Basic formatting
            document.getElementById('notificationModal').style.display = 'flex';

            if (notification.Status === 'Unread') {
                 try {
                    const payload = { action: 'markNotificationAsRead', messageId: notification.MessageID, email: userData.email };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        notification.Status = 'Read';
                        const itemEl = notificationsContent.querySelector(`.notification-item[data-message-id="${messageId}"]`);
                        if(itemEl) {
                            itemEl.classList.remove('unread');
                            itemEl.querySelector('.dot').style.display = 'none';
                        }
                        updateNotificationBadge();
                    }
                 } catch (error) {
                    console.error("Failed to mark notification as read:", error);
                 }
            }
        }

        document.getElementById('notificationModalCloseBtn').addEventListener('click', () => {
            document.getElementById('notificationModal').style.display = 'none';
        });

        // --- End Notification Logic ---

        
        async function handleCancelCooperation(activityId, button) {
            showModal('آیا از لغو درخواست همکاری با این مهندس مطمئن هستید؟', 'confirm', async () => {
                button.disabled = true;
                button.innerHTML = '<div class="spinner !w-5 !h-5 !border-2"></div>';
                try {
                    const payload = { action: 'cancelCooperation', employerEmail: userData.email, activityId };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showModal(result.message, 'success');
                        requestedCooperationIds.delete(activityId);
                        const card = button.closest('.activity-card');
                        if(card) card.outerHTML = getActivityCardHTML(fetchedEngineersActivities.find(a => a.ActivityID === activityId), true);
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showModal(`خطا: ${error.message}`, 'error');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-times-circle mr-2"></i>لغو درخواست همکاری';
                }
            });
        }

        async function handleCancelApplication(projectId, button) {
            showModal('آیا از لغو درخواست همکاری برای این پروژه مطمئن هستید؟', 'confirm', async () => {
                showLoader();
                try {
                    const payload = { 
                        action: 'cancelInteraction', 
                        projectId: projectId, 
                        engineerEmail: userData.email 
                    };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { 
                        method: 'POST',
                        body: JSON.stringify(payload) 
                    });
                    const result = await response.json();
                    showModal(result.message, result.status);

                    if (result.status === 'success') {
                        // آپدیت آنی کارت به جای رفرش کل صفحه
                        appliedProjectIds.delete(projectId); // حذف پروژه از لیست درخواست‌های ارسال شده
                        const projectData = fetchedProjects.find(p => p.ProjectID === projectId);
                        const card = button.closest('.project-card');
                        if (card && projectData) {
                            card.outerHTML = getProjectCardHTML(projectData, 'engineer', false);
                        }
                    }
                } catch (error) {
                    showModal(`خطا: ${error.message}`, 'error');
                } finally {
                    hideLoader();
                }
            });
        }
        
function handleEditProject(projectId) {
            const projectToEdit = fetchedProjects.find(p => p.ProjectID === projectId);
            if (projectToEdit) {
                // آدرس دکمه به نوار ناوبری جدید آپدیت شد
                const createProjectButton = document.getElementById('create-project-nav-item');
                if (createProjectButton) {
                    switchToView('create-project', createProjectButton);
                    setTimeout(() => renderProjectForm(projectToEdit), 50);
                } else {
                    console.error("دکمه ثبت پروژه در نوار ناوبری یافت نشد.");
                }
            }
        }

        async function handleChangeProjectStatus(projectId, newStatus) {
            const message = newStatus === 'بسته' ? 'آیا از بستن این پروژه مطمئن هستید؟' : 'آیا می‌خواهید این پروژه را دوباره باز کنید؟';
            showModal(message, 'confirm', async () => {
                welcomeLoader.style.opacity = '1';
                welcomeLoader.style.display = 'flex';
                try {
                    const payload = { action: 'changeProjectStatus', projectId, newStatus };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showModal(result.message, 'success');
                        renderEmployerProjects();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showModal(`خطا در تغییر وضعیت: ${error.message}`, 'error');
                } finally {
                    welcomeLoader.style.opacity = '0';
                    setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
                }
            });
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const btnText = btn.querySelector('span');
            const spinner = btn.querySelector('.spinner');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) return showModal('لطفاً تمام فیلدها را پر کنید.', 'error');
            if (newPassword !== confirmNewPassword) return showModal('رمز عبور جدید و تکرار آن یکسان نیستند.', 'error');
            if (newPassword.length < 6) return showModal('رمز عبور جدید باید حداقل ۶ کاراکتر باشد.', 'error');

            btn.disabled = true; btnText.classList.add('hidden'); spinner.classList.remove('hidden');
            try {
                const payload = { action: 'changePassword', email: userData.email, currentPassword, newPassword };
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`خطای سرور: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    changePasswordForm.reset();
                } else { throw new Error(result.message || 'خطای ناشناخته.'); }
            } catch (error) {
                showModal(error.message, 'error');
            } finally {
                btn.disabled = false; btnText.classList.remove('hidden'); spinner.classList.add('hidden');
            }
        }

        function setupPasswordToggle() {
            document.querySelectorAll('.password-toggle-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const targetId = icon.dataset.target;
                    const passwordInput = document.getElementById(targetId);
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });
        }
async function updateCoopStatus(interactionId, newStatus, container) {
            showLoader();
            try {
                const payload = { action: 'updateInteractionStatus', interactionId, newStatus };
                const response = await fetch(GOOGLE_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(payload) 
                });
                const result = await response.json();
                showModal(result.message, result.status);

                if (result.status === 'success') {
                    const mainButton = container.querySelector('button');
                    const options = container.querySelector('.action-options');
                    options.classList.add('hidden');
                    // تغییر ظاهر دکمه اصلی بر اساس وضعیت جدید
                    mainButton.innerHTML = `<span>${newStatus}</span>`;
                    mainButton.className = `btn !py-1 !px-3 ${newStatus === 'Accepted' ? 'btn-success' : (newStatus === 'Rejected' ? 'btn-danger' : 'btn-secondary')}`;
                }
            } catch (error) {
                showModal('خطای اتصال به سرور.', 'error');
            } finally {
                hideLoader();
            }
        }
async function updateAppStatus(interactionId, newStatus, container) {
            showLoader();
            try {
                const payload = { action: 'updateInteractionStatus', interactionId, newStatus };
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await response.json();
                showModal(result.message, result.status);

                if (result.status === 'success') {
                    
                    const options = container.querySelector('.action-options');
                    options.classList.add('hidden'); // بستن منو
                    const mainButton = container.querySelector('button[data-action="toggle-options"]');
                    
                    // دیکشنری برای متن و آیکن جدید
                    const statusStyles = {
                        Accepted: { text: 'پذیرفته شد', icon: 'fa-check-circle', class: 'btn-success' },
                        Rejected: { text: 'رد شد', icon: 'fa-times-circle', class: 'btn-danger' },
                        Reviewing: { text: 'در حال بررسی', icon: 'fa-clock', class: 'btn-secondary' }
                    };
                    
                    const style = statusStyles[newStatus];
                    
                    if (style) {
                        mainButton.disabled = true; // Make the button unclickable
                        mainButton.className = `btn !py-1 !px-3 w-full ${style.class}`; // Change its color
                        mainButton.innerHTML = `<i class="fas ${style.icon}"></i><span>${style.text}</span>`; // Change its icon and text
                    }
                }
            } catch (error) {
                 showModal('خطای اتصال به سرور.', 'error');
            } finally {
                hideLoader();
            }
        }

        async function handleSendRequestToEngineer(projectId, activityId, button) {
            showModal('آیا می‌خواهید برای این مهندس درخواست همکاری ارسال کنید؟', 'confirm', async () => {
                showLoader();
                try {
                    const payload = {
                        action: 'createInteraction',
                        ProjectID: projectId,
                        ActivityID: activityId,
                        InitiatorRole: 'Employer',
                        InitiatorEmail: userData.email
                    };
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    showModal(result.message, result.status);
                    if (result.status === 'success') {
                        // برای نمایش نتیجه، آکاردئون را رفرش می‌کنیم
                        const projectRow = button.closest('.project-row');
                        projectRow.classList.remove('open');
                        projectRow.querySelector('.project-body').dataset.loaded = 'false';
                        projectRow.querySelector('.project-header').click();
                    }
                } catch (error) {
                     showModal('خطا در ارسال درخواست.', 'error');
                } finally {
                    hideLoader();
                }
            });
        }

        // --- INITIALIZATION ---
        async function main() {
            document.body.classList.remove('hidden');
            const params = new URLSearchParams(window.location.search);
            const email = params.get('email');
            if (!email) {
                welcomeLoader.innerHTML = '<p class="text-red-600 font-bold p-8">خطا: ایمیل کاربر مشخص نشده است.</p>';
                return;
            }
            userData = await fetchUserProfile(email);
            if (userData) {
                userData.email = email;
                setupRoleSpecificUI(userData);
                updateBottomNavProfileIcon(userData);
                
                setTimeout(() => {
                    welcomeLoader.style.opacity = '0';
                    setTimeout(() => {
                        welcomeLoader.style.display = 'none';
                        renderProfile(); 
                        document.getElementById('home-nav-item').click();
                        renderNotifications();
                    }, 500);
                }, 1500);

            }
           
            setupViewSwitcher();
            setupPasswordToggle();
            changePasswordForm.addEventListener('submit', handleChangePassword);

            const contentAreaClickHandler = (e, contentId, handlers) => {
                if (document.getElementById(contentId).style.display !== 'block') return;
                const targetButton = e.target.closest('button');
                if (targetButton && targetButton.dataset.action) {
                    const action = targetButton.dataset.action;
                    if (handlers[action]) {
                        handlers[action](targetButton);
                    }
                }
                const notificationItem = e.target.closest('.notification-item');
                if (notificationItem && notificationItem.dataset.messageId) {
                    openNotificationModal(notificationItem.dataset.messageId);
                }
            };

document.querySelector('.main-content-area').addEventListener('click', e => {
                const button = e.target.closest('button, a');
                if (!button || !button.dataset.action) return;

                e.preventDefault();
                const action = button.dataset.action;
                const contentBody = button.closest('.content-body');
                if (!contentBody) return;

                // مدیریت اکشن‌ها بر اساس ID صفحه‌ای که در آن هستیم
                switch (contentBody.id) {
                    
                    // --- صفحه پروژه‌های من (کارفرما) ---
                    case 'projectsContent': {
                        const projectRow = button.closest('.project-row');
                    if (projectRow && (action === 'edit-project' || action === 'close-project' || action === 'open-project')) {
                        const projectId = projectRow.dataset.projectId;
                        if (action === 'edit-project') handleEditProject(projectId);
                        else if (action === 'close-project') handleChangeProjectStatus(projectId, 'بسته');
                        else if (action === 'open-project') handleChangeProjectStatus(projectId, 'باز');
                    }
                        
                    const interactionRow = button.closest('.interaction-row');
                    if (interactionRow) {
                        const interactionId = interactionRow.dataset.interactionId;
                        if (action === 'toggle-options') {
                            const options = button.nextElementSibling;
                            document.querySelectorAll('.action-options').forEach(opt => {
                                if (opt !== options) opt.classList.add('hidden');
                            });
                            options.classList.toggle('hidden');
                        } else if (action === 'set-status') {
                            const newStatus = button.dataset.status;
                            const container = button.closest('.action-btn-container');
                            // ارسال شناسه صحیح به تابع
                            updateAppStatus(interactionId, newStatus, container);
                        }
                    }
                        // این کد کلیک روی دکمه‌های جمع‌کننده لیست‌ها را مدیریت می‌کند
                        if (action === 'toggle-list') {
                            const listContent = button.parentElement.nextElementSibling; // محتوای لیست را پیدا می‌کند
                            button.classList.toggle('collapsed'); // حالت دکمه را عوض می‌کند (برای چرخش آیکن)
                            listContent.classList.toggle('collapsed'); // لیست را باز یا بسته می‌کند
                        }
                        // --- بخش جدید برای دکمه ارسال درخواست در لیست پیشنهادها ---
                        if (action === 'send-request') {
                            const projectRow = button.closest('.project-row');
                            if (projectRow) {
                                const projectId = projectRow.dataset.projectId;
                                const activityId = button.dataset.activityId;
                                // فراخوانی تابع جدید و اختصاصی
                                handleSendRequestToEngineer(projectId, activityId, button);
                            }
                        }
                        // منطق درخواست همکاری مهندس در همین صفحه نیز مدیریت می‌شود
                        if (userData.role === 'engineer' && (action === 'apply' || action === 'cancel-application')) {
                            if (action === 'apply') checkApplicationPrerequisites(button.dataset.projectId, button);
                            else if (action === 'cancel-application') handleCancelApplication(button.dataset.projectId, button);
                        }
                        break;
                    }
                    // --- صفحه فعالیت‌های من (مهندس) ---
                    case 'myActivitiesContent': {
                        // مدیریت دکمه‌های ویرایش و فعال/غیرفعال کردن در سربرگ
                        const activityRow = button.closest('.project-row');
                        if (activityRow && (action === 'edit-activity' || action === 'change-activity-status')) {
                            const activityId = activityRow.dataset.activityId;
                            if (action === 'edit-activity') handleEditActivity(activityId);
                            else if (action === 'change-activity-status') handleChangeActivityStatus(activityId, button.dataset.newStatus);
                            return; // پایان عملیات
                        }

                        // مدیریت دکمه‌های داخل لیست‌های پروژه
                        const interactionRow = button.closest('.interaction-row');
                        if (interactionRow) {
                            const interactionId = interactionRow.dataset.interactionId;

                            if (action === 'toggle-options') {
                                button.nextElementSibling.classList.toggle('hidden');
                            } else if (action === 'set-coop-status') {
                                const newStatus = button.dataset.status;
                                updateCoopStatus(interactionId, newStatus, button.closest('.action-btn-container'));
                            } else if (action === 'apply') {
                                checkApplicationPrerequisites(button.dataset.projectId, button);
                            } else if (action === 'cancel-application') { 
                                const projectId = button.dataset.projectId;
                                handleCancelApplication(projectId, button);
                            }
                        }
                        
                        // مدیریت دکمه جمع‌کردن لیست‌ها (توصیه سوم)
                        if (action === 'toggle-list') {
                            const listContent = button.parentElement.nextElementSibling;
                            button.classList.toggle('collapsed');
                            listContent.classList.toggle('collapsed');
                        }
                        break;
                    }
                    // --- صفحه جستجوی مهندس (کارفرما) ---
                    case 'engineersContent': {
                        const card = button.closest('.activity-card');
                        if (card) {
                            const activityId = card.querySelector('[data-activity-id]').dataset.activityId;
                            if (action === 'request-cooperation') {
                                const activity = fetchedEngineersActivities.find(act => act.ActivityID === activityId);
                                if(activity) checkCooperationPrerequisites(activity, button);
                            } else if (action === 'cancel-cooperation') {
                                // منطق لغو درخواست همکاری که قبلا نوشته شده
                                handleCancelCooperation(activityId, button);
                            }
                        }
                        break;
                    }
                }
            });
            
            document.getElementById('refresh-nav-item').addEventListener('click', (e) => {
                e.preventDefault();
                refreshCurrentView();
            });

            document.getElementById('logout-nav-item').addEventListener('click', (e) => {
                e.preventDefault();
                showModal('آیا می‌خواهید از حساب کاربری خود خارج شوید؟', 'confirm', () => {
                    window.location.href = window.location.pathname; 
                });
            });
        }

        function updateTime() {
            const dateElement = document.getElementById('desktop-date');
            const timeElement = document.getElementById('desktop-time');

            if (dateElement && timeElement) {
                const now = new Date();
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { weekday: 'long', hour: '2-digit', minute: '2-digit' };
                const persianDate = now.toLocaleDateString('fa-IR', dateOptions);
                const persianTime = now.toLocaleTimeString('fa-IR', timeOptions).replace('،', ' |');
                dateElement.innerText = persianDate;
                timeElement.innerText = persianTime;
            }
        }
        updateTime();
        setInterval(updateTime, 1000); // آپدیت در هر ثانیه

        createSlideshow('slideshow', 'slide-dots-container', 'info-box-text', SLIDESHOW_CONTENT_L);
        createSlideshow('slideshow-R', 'slide-dots-container-R', 'info-box-text-R', SLIDESHOW_CONTENT_R);
        

        main();
    })();
    </script>
</body>
</html>
