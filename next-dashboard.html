<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایستگاه کار - نظام تندیس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Leaflet (for maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Cropper.js (for image cropping) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- Persian Datepicker -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    <script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <style>
        body {
            font-family: 'Vazirmatn', 'Tahoma', sans-serif;
            background-color: #f8fafc;
        }
        .workstation-wrapper { display: flex; height: 100vh; max-height: 100vh; background-color: #ffffff; }
        #mainNavSidebar { width: 288px; background-color: #f1f5f9; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; transition: width 0.3s ease; }
        #mainContentArea { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #pageContent { flex-grow: 1; overflow-y: auto; padding: 1.5rem 2rem; }
        #pageContent::-webkit-scrollbar { width: 8px; }
        #pageContent::-webkit-scrollbar-track { background: #f1f5f9; }
        #pageContent::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 8px; }
        #pageContent::-webkit-scrollbar-thumb:hover { background: #64748b; }
        #advertisementSidebar { width: 288px; background-color: #f1f5f9; border-right: 1px solid #e2e8f0; transition: width 0.3s ease; }
        .main-nav-link { display: flex; align-items: center; padding: 0.875rem 1.25rem; border-radius: 0.5rem; color: #475569; font-weight: 600; transition: all 0.2s ease-in-out; border-right: 4px solid transparent; }
        .main-nav-link:hover { background-color: #e2e8f0; color: #1e293b; }
        .main-nav-link.active { background-color: #e0f2fe; color: #0c4a6e; border-right-color: #0ea5e9; }
        .main-nav-link i { margin-left: 0.75rem; width: 20px; text-align: center; }
        #slideshowContainer { position: relative; width: 100%; height: 200px; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        #slideshowContainer img { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: opacity 1s ease-in-out; }
        #slideshowContainer img.active { opacity: 1; }
        #slideshowNav { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10; }
        .slide-nav-dot { width: 10px; height: 10px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s ease; border: 1px solid rgba(0,0,0,0.2); }
        .slide-nav-dot.active { background-color: white; }
        
        .content-view { display: none; }
        .content-view.active { display: block; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 48px; height: 48px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(15, 23, 42, 0.6); }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 2rem 2.5rem; border: none; width: 90%; max-width: 600px; border-radius: 0.75rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        #cropperContainer { width: 100%; height: 400px; overflow: hidden; background: #f1f1f1; }
        #cropperContainer img { max-width: 100%; height: auto; }
        
        /* --- Profile Form Styles --- */
        .profile-form-step { display: none; }
        .profile-form-step.active { display: block; }
        .profile-step-indicator { display: flex; align-items: center; padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s ease; }
        .profile-step-indicator:hover { background-color: #e2e8f0; }
        .profile-step-indicator.active { background-color: #e0f2fe; color: #0c4a6e; font-weight: 600; }
        .profile-step-indicator .step-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #cbd5e1; color: #475569; margin-left: 0.75rem; }
        .profile-step-indicator.active .step-icon { background-color: #0ea5e9; color: white; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn-primary { background-color: #0ea5e9; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #0284c7; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #059669; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        input, select, textarea { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.625rem 0.875rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input:focus, select:focus, textarea:focus { border-color: #0ea5e9; background-color: white; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); outline: none; }
        input:disabled, select:disabled, textarea:disabled { background-color: #e2e8f0; cursor: not-allowed; color: #64748b; }
        .map-container { height: 220px; border-radius: 0.5rem; border: 1px solid #cbd5e1; z-index: 1; }
        @media (max-width: 1023px) { #mainNavSidebar, #advertisementSidebar { display: none; } }
    </style>
</head>
<body class="bg-slate-50">

    <div id="loadingModal" class="fixed inset-0 z-50 flex items-center justify-center" style="background-color: rgba(255, 255, 255, 0.9);">
        <!-- ... Loading Modal Content ... -->
    </div>

    <div id="appContainer" class="workstation-wrapper hidden">
        <aside id="mainNavSidebar" class="p-5">
            <div class="text-center mb-8">
                <div id="profileImageContainer" class="relative w-32 h-32 mx-auto mb-3 group cursor-pointer">
                    <img id="userProfileImage" src="https://placehold.co/128x128/EBF4FF/2196F3?text=User" alt="عکس پروفایل" class="w-full h-full object-cover rounded-full border-4 border-white shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/128x128/EBF4FF/2196F3?text=Error';">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-full">
                        <i class="fas fa-camera fa-lg"></i>
                        <span class="mr-2">تغییر عکس</span>
                    </div>
                </div>
                <h2 id="userProfileName" class="text-lg font-bold text-slate-800"></h2>
                <p id="userProfileRole" class="text-sm font-medium text-sky-600"></p>
            </div>
            <nav id="mainNav" class="flex flex-col space-y-2 flex-grow">
                <a href="#dashboard" data-view="dashboard" class="main-nav-link active"><i class="fas fa-tachometer-alt"></i><span>داشبورد</span></a>
                <a href="#profile" data-view="profile" class="main-nav-link"><i class="fas fa-user-circle"></i><span>پروفایل من</span></a>
            </nav>
            <div class="mt-auto border-t border-slate-300 pt-4 space-y-2">
                <a href="#settings" data-view="settings" class="main-nav-link"><i class="fas fa-cog"></i><span>تنظیمات</span></a>
                <a href="#" id="logoutButton" class="main-nav-link hover:bg-red-100 hover:text-red-700"><i class="fas fa-sign-out-alt"></i><span>خروج از حساب</span></a>
            </div>
        </aside>

        <main id="mainContentArea">
            <header class="p-4 border-b border-slate-200 bg-white flex justify-between items-center">
                <h1 id="pageTitle" class="text-xl font-bold text-slate-800">داشبورد</h1>
                <!-- ... Header Icons ... -->
            </header>
            <div id="pageContent">
                <div id="dashboard-view" class="content-view active">
                    <!-- ... Dashboard Content ... -->
                </div>
                
                <!-- REBUILT PROFILE VIEW -->
                <div id="profile-view" class="content-view">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">پروفایل کاربری</h2>
                        <div>
                            <button id="editProfileButton" class="btn btn-primary"><i class="fas fa-edit"></i> ویرایش اطلاعات</button>
                            <button id="saveProfileButton" class="btn btn-success hidden"><i class="fas fa-save"></i> ذخیره تغییرات</button>
                            <button id="cancelEditButton" class="btn btn-secondary hidden ml-2"><i class="fas fa-times"></i> انصراف</button>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8">
                        <!-- Profile Step Navigation -->
                        <div id="profileStepsNav" class="w-full lg:w-1/4">
                            <!-- Step indicators will be populated by JS -->
                        </div>
                        
                        <!-- Profile Form Content -->
                        <div class="flex-grow">
                            <form id="profileForm">
                                <!-- Steps will be populated by JS -->
                            </form>
                        </div>
                    </div>
                </div>

                <div id="settings-view" class="content-view">
                    <!-- ... Settings Content ... -->
                </div>
            </div>
        </main>

        <aside id="advertisementSidebar" class="p-5 space-y-6">
            <!-- ... Advertisement Sidebar Content ... -->
        </aside>
    </div>

    <!-- Modals (Cropper, etc.) -->
    <div id="cropperModal" class="modal">
        <!-- ... Cropper Modal Content ... -->
    </div>
    <input type="file" id="profileImageInput" class="hidden" accept="image/*">

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- CONFIGURATION ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwURZkNTH6OZ78JqPWXqOBeAdWsgrj2lhPn16Yn0jdJ537qCioVAsofUJrbV6qvvG0N/exec'; 

        // --- DOM Elements ---
        const loadingModal = document.getElementById('loadingModal');
        const userProfileImage = document.getElementById('userProfileImage');
        const userProfileName = document.getElementById('userProfileName');
        const userProfileRole = document.getElementById('userProfileRole');
        const mainNav = document.getElementById('mainNav');
        const contentViews = document.querySelectorAll('.content-view');
        const profileViewContainer = document.getElementById('profile-view');
        const editProfileButton = document.getElementById('editProfileButton');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const profileForm = document.getElementById('profileForm');
        const profileStepsNav = document.getElementById('profileStepsNav');
        
        // --- State ---
        let currentUserEmail = '';
        let originalUserData = {};
        let isEditMode = false;
        let currentProfileStep = 1;
        let maps = {};

        // --- INITIALIZATION ---
        async function initializeWorkstation() {
            const urlParams = new URLSearchParams(window.location.search);
            currentUserEmail = urlParams.get('email');
            if (!currentUserEmail) {
                // Handle error: no email
                return;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?func=getUserProfile&email=${encodeURIComponent(currentUserEmail)}`);
                const result = await response.json();

                if (result.status === "success" && result.data?.stepsData) {
                    originalUserData = result.data;
                    populateStaticInfo(originalUserData);
                    buildProfileForm(originalUserData);
                    populateProfileForm(originalUserData);
                    setFormEditState(false); // Initially view-only
                    document.getElementById('appContainer').classList.remove('hidden');
                    loadingModal.style.display = 'none';
                } else {
                    throw new Error(result.message || 'پاسخ سرور معتبر نیست.');
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                // Handle error display
            }
        }

        function populateStaticInfo(data) {
            // Populate sidebar name, role, image etc.
            const profilePicUrl = data.files?.applicantImage?.fileUrl;
            userProfileImage.src = convertGoogleDriveUrl(profilePicUrl) || 'https://placehold.co/128x128/EBF4FF/2196F3?text=User';
            const firstName = data.stepsData?.step1?.engineerFirstName || data.stepsData?.step1?.employerFirstName || '';
            const lastName = data.stepsData?.step1?.engineerLastName || data.stepsData?.step1?.employerLastName || '';
            userProfileName.textContent = `${firstName} ${lastName}`;
            userProfileRole.textContent = data.role === 'engineer' ? 'مهندس' : 'کارفرما';
        }

        // --- PROFILE FORM BUILDING & MANAGEMENT ---
        
        function buildProfileForm(data) {
            const role = data.role;
            const stepDefs = getStepDefinitions(role);

            profileStepsNav.innerHTML = '';
            profileForm.innerHTML = '';

            stepDefs.forEach(step => {
                // Build step indicator in the navigation
                const indicator = document.createElement('div');
                indicator.className = 'profile-step-indicator';
                indicator.dataset.step = step.id;
                indicator.innerHTML = `<div class="step-icon"><i class="fas ${step.icon}"></i></div><span>${step.label}</span>`;
                indicator.addEventListener('click', () => showProfileStep(step.id));
                profileStepsNav.appendChild(indicator);

                // Build form step container
                const stepContainer = document.createElement('div');
                stepContainer.id = `profile-step-${step.id}`;
                stepContainer.className = 'profile-form-step';
                stepContainer.innerHTML = step.contentHtml;
                profileForm.appendChild(stepContainer);
            });
            
            showProfileStep(1); // Show the first step initially
        }

        function showProfileStep(stepId) {
            currentProfileStep = stepId;
            // Hide all steps, show the active one
            document.querySelectorAll('.profile-form-step').forEach(s => s.classList.remove('active'));
            document.getElementById(`profile-step-${stepId}`).classList.add('active');

            // Highlight active indicator
            document.querySelectorAll('.profile-step-indicator').forEach(ind => {
                ind.classList.toggle('active', parseInt(ind.dataset.step) === stepId);
            });
            
            // Initialize maps for the active step if needed
            initializeMapsForSection(stepId, originalUserData.role);
        }

        function populateProfileForm(data) {
            const role = data.role;
            const prefix = role === 'engineer' ? 'engineer' : 'employer';

            // Step 1: Personal Info
            const step1 = data.stepsData?.step1 || {};
            setInputValue(`profile-${prefix}FirstName`, step1[`${prefix}FirstName`]);
            setInputValue(`profile-${prefix}LastName`, step1[`${prefix}LastName`]);
            setInputValue(`profile-${prefix}NationalId`, step1[`${prefix}NationalId`]);
            setInputValue(`profile-${prefix}Dob`, step1[`${prefix}Dob`]);
            setInputValue(`profile-${prefix}Gender`, step1[`${prefix}Gender`]);
            setInputValue(`profile-${prefix}Mobile`, step1[`${prefix}Mobile`]);

            // Step 2: Contact Info
            const step2 = data.stepsData?.step2 || {};
            setInputValue(`profile-${prefix}Phone`, step2[`${prefix}Phone`]);
            setInputValue(`profile-${prefix}PostalCode`, step2[`${prefix}PostalCode`]);
            setInputValue(`profile-${prefix}Province`, step2[`${prefix}Province`]);
            setInputValue(`profile-${prefix}City`, step2[`${prefix}City`]);
            setInputValue(`profile-${prefix}ResidentialAddress`, step2[`${prefix}ResidentialAddress`]);

            // Step 3: Professional Info
            const step3 = data.stepsData?.step3 || {};
            if (role === 'engineer') {
                setInputValue('profile-licenseFirstIssueDate', step3.licenseFirstIssueDate);
                setInputValue('profile-licenseStartDate', step3.licenseStartDate);
                setInputValue('profile-licenseValidity', step3.licenseValidity);
                setInputValue('profile-licenseNumber', step3.licenseNumber);
                setInputValue('profile-membershipNumber', step3.membershipNumber);
                setInputValue('profile-licenseActivityProvince', step3.licenseActivityProvince);
                // ... and so on for all engineer fields (grades, types, etc.)
            } else {
                setInputValue('profile-employerCompanyName', step3.employerCompanyName);
                setInputValue('profile-employerCompanyRegNumber', step3.employerCompanyRegNumber);
                setInputValue('profile-employerCompanyAddress', step3.employerCompanyAddress);
            }
            
            // Step 4: Documents
             // You can show links to existing documents here
            const docContainer = document.getElementById('profile-step-4')?.querySelector('.document-links');
            if (docContainer) {
                docContainer.innerHTML = ''; // Clear previous
                const files = data.files || {};
                for (const key in files) {
                    if (files[key]?.fileUrl) {
                        const link = document.createElement('a');
                        link.href = files[key].fileUrl;
                        link.target = '_blank';
                        link.className = 'text-sky-600 hover:underline';
                        link.textContent = `مشاهده ${key}`;
                        docContainer.appendChild(link);
                        docContainer.appendChild(document.createElement('br'));
                    }
                }
            }
        }
        
        function setFormEditState(isEditing) {
            isEditMode = isEditing;
            const formElements = profileForm.querySelectorAll('input, select, textarea');
            formElements.forEach(el => {
                el.disabled = !isEditing;
            });
            editProfileButton.classList.toggle('hidden', isEditing);
            saveProfileButton.classList.toggle('hidden', !isEditing);
            cancelEditButton.classList.toggle('hidden', !isEditing);
        }

        editProfileButton.addEventListener('click', () => setFormEditState(true));
        cancelEditButton.addEventListener('click', () => {
            populateProfileForm(originalUserData); // Revert changes
            setFormEditState(false);
        });
        saveProfileButton.addEventListener('click', saveProfileChanges);
        
        async function saveProfileChanges() {
            // 1. Collect data from the form into a `stepsData` object
            const updatedStepsData = collectFormData();
            
            // 2. Add validation logic here if needed
            
            // 3. Prepare payload for Google Script
            const payload = {
                action: 'updateFullProfile', // New action for the script
                email: currentUserEmail,
                stepsData: updatedStepsData
            };
            
            // 4. Show loading indicator
            saveProfileButton.disabled = true;
            saveProfileButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ذخیره سازی...';

            // 5. Send data to server
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || 'خطا در سرور');
                }
                // Success
                originalUserData.stepsData = updatedStepsData; // Update local data
                setFormEditState(false);
                alert('تغییرات با موفقیت ذخیره شد.');

            } catch (error) {
                console.error('Save failed:', error);
                alert(`خطا در ذخیره سازی: ${error.message}`);
            } finally {
                saveProfileButton.disabled = false;
                saveProfileButton.innerHTML = '<i class="fas fa-save"></i> ذخیره تغییرات';
            }
        }
        
        function collectFormData() {
            const data = { step1: {}, step2: {}, step3: {}, step4: {} };
            const role = originalUserData.role;
            const prefix = role === 'engineer' ? 'engineer' : 'employer';

            // Step 1
            data.step1[`${prefix}FirstName`] = getInputValue(`profile-${prefix}FirstName`);
            // ... collect all other fields for step 1
            
            // Step 2
            data.step2[`${prefix}Phone`] = getInputValue(`profile-${prefix}Phone`);
            // ... collect all other fields for step 2

            // ... and so on for step 3 and 4
            
            return data;
        }

        // --- HELPERS ---
        function setInputValue(id, value) {
            const el = document.getElementById(id);
            if (el) {
                if (el.type === 'checkbox') el.checked = !!value;
                else el.value = value || '';
            }
        }
        function getInputValue(id) {
            const el = document.getElementById(id);
            if (el) {
                if (el.type === 'checkbox') return el.checked;
                return el.value;
            }
            return null;
        }
        function convertGoogleDriveUrl(url) {
            if (!url || typeof url !== 'string' || !url.includes('drive.google.com')) return url;
            const fileIdMatch = url.match(/(?:d\/|id=)([-\w]{25,})/);
            if (fileIdMatch && fileIdMatch[1]) {
                return `https://drive.google.com/uc?export=view&id=${fileIdMatch[1]}`;
            }
            return url;
        }
        
        function getStepDefinitions(role) {
            const prefix = role === 'engineer' ? 'engineer' : 'employer';
            const commonStep1 = `
                <h3 class="font-bold text-lg mb-4">مشخصات فردی</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>نام</label><input type="text" id="profile-${prefix}FirstName"></div>
                    <div><label>نام خانوادگی</label><input type="text" id="profile-${prefix}LastName"></div>
                    <div><label>کدملی</label><input type="text" id="profile-${prefix}NationalId"></div>
                    <div><label>تاریخ تولد</label><input type="text" id="profile-${prefix}Dob"></div>
                    <div><label>جنسیت</label><input type="text" id="profile-${prefix}Gender"></div>
                    <div><label>موبایل</label><input type="text" id="profile-${prefix}Mobile"></div>
                </div>`;
            
            const commonStep2 = `
                <h3 class="font-bold text-lg mb-4">اطلاعات تماس</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>تلفن ثابت</label><input type="text" id="profile-${prefix}Phone"></div>
                    <div><label>کدپستی</label><input type="text" id="profile-${prefix}PostalCode"></div>
                    <div><label>استان</label><select id="profile-${prefix}Province"></select></div>
                    <div><label>شهر</label><input type="text" id="profile-${prefix}City"></div>
                    <div class="md:col-span-2"><label>آدرس</label><textarea id="profile-${prefix}ResidentialAddress"></textarea></div>
                    <div class="md:col-span-2"><div id="map-profile-residential" class="map-container"></div></div>
                </div>`;
                
            const engineerStep3 = `
                <h3 class="font-bold text-lg mb-4">اطلاعات حرفه‌ای</h3>
                <!-- All engineer professional fields go here -->
            `;
            const employerStep3 = `
                <h3 class="font-bold text-lg mb-4">اطلاعات شرکت</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label>نام شرکت</label><input type="text" id="profile-employerCompanyName"></div>
                     <div><label>شماره ثبت</label><input type="text" id="profile-employerCompanyRegNumber"></div>
                     <div class="md:col-span-2"><label>آدرس شرکت</label><textarea id="profile-employerCompanyAddress"></textarea></div>
                     <div class="md:col-span-2"><div id="map-profile-company" class="map-container"></div></div>
                </div>
            `;
            
            const step4 = `
                <h3 class="font-bold text-lg mb-4">مدارک</h3>
                <div class="document-links"></div>
                <!-- File upload inputs can be added here for editing -->
            `;

            if (role === 'engineer') {
                return [
                    { id: 1, icon: 'fa-user', label: 'مشخصات فردی', contentHtml: commonStep1 },
                    { id: 2, icon: 'fa-map-marker-alt', label: 'اطلاعات تماس', contentHtml: commonStep2 },
                    { id: 3, icon: 'fa-id-card', label: 'اطلاعات حرفه‌ای', contentHtml: engineerStep3 },
                    { id: 4, icon: 'fa-cloud-upload-alt', label: 'مدارک', contentHtml: step4 }
                ];
            } else {
                 return [
                    { id: 1, icon: 'fa-user-tie', label: 'مشخصات فردی', contentHtml: commonStep1 },
                    { id: 2, icon: 'fa-address-book', label: 'اطلاعات تماس', contentHtml: commonStep2 },
                    { id: 3, icon: 'fa-building', label: 'اطلاعات شرکت', contentHtml: employerStep3 },
                    { id: 4, icon: 'fa-id-badge', label: 'مدارک', contentHtml: step4 }
                ];
            }
        }
        
        function initializeMapsForSection(stepId, role) {
            const prefix = role === 'engineer' ? 'engineer' : 'employer';
            if (stepId === 2) {
                const lat = getInputValue(`profile-${prefix}ResidentialLat`); // Need to add these hidden inputs
                const lng = getInputValue(`profile-${prefix}ResidentialLng`);
                initMap('map-profile-residential', parseFloat(lat), parseFloat(lng));
            }
            if (stepId === 3 && role === 'employer') {
                 const lat = getInputValue('profile-employerCompanyAddressLat');
                 const lng = getInputValue('profile-employerCompanyAddressLng');
                 initMap('map-profile-company', parseFloat(lat), parseFloat(lng));
            }
        }
        
        function initMap(mapId, lat, lng) {
            const mapContainer = document.getElementById(mapId);
            if (!mapContainer) return;
            if (maps[mapId]) maps[mapId].remove(); // Remove old instance
            
            const validLat = !isNaN(lat) ? lat : 35.7219; // Default to Tehran
            const validLng = !isNaN(lng) ? lng : 51.3347;

            const map = L.map(mapId).setView([validLat, validLng], 13);
            maps[mapId] = map;
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const marker = L.marker([validLat, validLng], { draggable: true }).addTo(map);

            marker.on('dragend', function(e) {
                if (!isEditMode) { // Prevent dragging in view mode
                    marker.setLatLng([validLat, validLng]);
                    return;
                }
                // Update hidden lat/lng inputs on drag
            });
            
             setTimeout(() => map.invalidateSize(), 100);
        }

        // --- Event Listeners & Initial Call ---
        mainNav.addEventListener('click', (e) => {
            const navLink = e.target.closest('.main-nav-link');
            if (!navLink) return;
            e.preventDefault();
            const viewName = navLink.dataset.view;
            document.querySelector('#mainNav .active')?.classList.remove('active');
            navLink.classList.add('active');
            contentViews.forEach(view => view.classList.toggle('active', view.id === `${viewName}-view`));
        });

        initializeWorkstation();
    });
    </script>
</body>
</html>
