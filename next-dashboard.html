<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایستگاه کاری - نظام تندیس</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (for maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Font Awesome (for icons) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css"/>
    
    <!-- Cropper.js (for image cropping) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <!-- Persian Datepicker -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    <script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <style>
        :root {
            --primary-color: #2196F3;
            --primary-color-dark: #1976D2;
            --special-color: #FFA000;      /* Golden Orange */
            --special-color-dark: #F57C00;   /* Darker Golden Orange */
            --notification-badge-color: #ef4444;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8fafc; }
        .workstation-wrapper { display: flex; height: 100vh; max-height: 100vh; overflow: hidden; }
        .main-content-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content-body { flex-grow: 1; overflow-y: auto; padding: 1.5rem 2rem; }
        /* --- MODIFICATION: Main sidebar width changed --- */
        .sidebar { width: 220px; flex-shrink: 0; background-color: #f1f5f9; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow-y: auto; }
        @media (max-width: 1024px) { .sidebar { display: none; } }
        .sidebar-profile-section { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #cbd5e1; }
        .sidebar-profile-image-container { position: relative; width: 60px; height: 60px; flex-shrink: 0; }
        .sidebar-profile-image { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid var(--primary-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sidebar-profile-image-edit-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; opacity: 0; transition: opacity 0.3s ease; cursor: pointer; }
        .sidebar-profile-image-container:hover .sidebar-profile-image-edit-overlay { opacity: 1; }
        .sidebar-profile-details { margin-right: 1rem; text-align: right; }
        .sidebar-profile-name { font-size: 1.05rem; font-weight: 700; color: #1e293b; }
        .sidebar-profile-role { font-size: 0.85rem; font-weight: 500; color: var(--primary-color); margin-top: 0.25rem; }
        .sidebar-nav { padding: 1rem; flex-grow: 1; }
        .nav-item { display: flex; align-items: center; padding: 0.75rem 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; color: #475569; font-weight: 500; transition: all 0.2s ease; cursor: pointer; position: relative; }
        .nav-item i { margin-left: 0.75rem; width: 20px; text-align: center; }
        .nav-item:hover { background-color: #e2e8f0; color: #1e293b; }
        .nav-item.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 6px -1px rgba(33, 150, 243, 0.2); }
        .notification-badge { position: absolute; top: 5px; left: 10px; background-color: var(--notification-badge-color); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .nav-item.btn-special-project { background-color: var(--special-color); color: white; font-weight: 700; justify-content: center; }
        .nav-item.btn-special-project:hover { background-color: var(--special-color-dark); }
        .nav-item.btn-special-project.active { background-color: var(--special-color-dark); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }

        .sidebar-footer { padding: 1rem; margin-top: auto; border-top: 1px solid #e2e8f0; }
        /* --- MODIFICATION: Advertisement sidebar width changed --- */
        .advertisement-sidebar { width: 270px; flex-shrink: 0; background-color: #f8fafc; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow-y: auto; padding: 1.5rem 1rem; }
        @media (max-width: 1280px) { .advertisement-sidebar { display: none; } }
        .slideshow-container { position: relative; border-radius: 0.5rem; overflow: hidden; }
        .slide-image { width: 100%; display: none; aspect-ratio: 4/5; object-fit: cover; }
        .slide-image.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0.4; } to { opacity: 1; } }
        .slide-dots { text-align: center; padding-top: 0.75rem; }
        .dot { cursor: pointer; height: 10px; width: 10px; margin: 0 4px; background-color: #cbd5e1; border-radius: 50%; display: inline-block; transition: background-color 0.3s ease; }
        .dot.active, .dot:hover { background-color: var(--primary-color); }
        .profile-section { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; margin-bottom: 1.5rem; overflow: hidden; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; cursor: pointer; user-select: none; background-color: #fdfdfe; border-bottom: 1px solid #e2e8f0; }
        .section-header.open { border-bottom-color: #e2e8f0; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: #334155; }
        .section-title i { margin-left: 0.75rem; color: var(--primary-color); }
        .section-toggle-icon { transition: transform 0.3s ease; }
        .section-header.open .section-toggle-icon { transform: rotate(180deg); }
        .section-content { padding: 1.5rem; display: none; }
        .section-content.open { display: block; }
        .section-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }
        label.required-field::after { content: "*"; color: red; margin-right: 4px; }   
        .password-input-container { position: relative; }
        .password-toggle-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6b7280; }
        /* استایل جدید برای دکمه‌های انتخاب قیمت */
        .price-btn { padding: 0.75rem; border: 2px solid #e2e8f0; /* slate-200 */ border-radius: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; background-color: #f8fafc; /* slate-50 */ color: #475569; /* slate-600 */ font-size: 0.9rem; line-height: 1.4; }
        .price-btn:hover { border-color: #3b82f6; /* blue-500 */ background-color: #eff6ff; /* blue-50 */}
        .price-btn.active { border-color: #2563eb; /* blue-600 */ background-color: #dbeafe; /* blue-100 */ color: #1e3a8a; /* blue-900 */ font-weight: 600; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);}
        /* استایل جدید برای کادرهای متنی بلند (توضیحات و آدرس) */
        textarea#address, textarea#description { border: 1px solid #cbd5e1; /* slate-300 */ padding: 0.75rem 1rem; border-radius: 0.375rem; }
        textarea#address:focus, textarea#description:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2); outline: none;}
        /* مرحله ۱: استایل برای فیلدهای متنی (با ارتفاع و حاشیه استاندارد) */
        input[type="text"], input[type="date"], input[type="tel"], input[type="number"], input[type="password"] { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.375rem;  padding: 0.875rem 1rem; /* حاشیه داخلی استاندارد */ transition: all 0.2s ease; width: 100%; height: 2.75rem; /* ارتفاع استاندارد */}
        /* مرحله ۲: استایل اختصاصی فقط برای دکمه‌های کشویی (با حاشیه داخلی بیشتر) */
        select { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0 1.25rem; /* حاشیه داخلی بیشتر فقط برای چپ و راست */ transition: all 0.2s ease; width: 100%; height: 2.75rem; /* ارتفاع را با بقیه یکسان نگه می‌داریم */ -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        input[type="password"] { padding-left: 2.5rem; }
        textarea { padding: 1.5rem; }
        input:focus, textarea:focus, select:focus, input[type="password"]:focus { border-color: var(--primary-color); background-color: white; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2); outline: none; }
        input:disabled, select:disabled, textarea:disabled { background-color: #eef2f7; color: #64748b; cursor: not-allowed; border-color: #e2e8f0; } 
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-color-dark); }
        .btn-secondary { background-color: #e2e8f0; color: #1e293b; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-success:hover { background-color: #16a34a; }
        .btn-special { background-color: var(--special-color); color: white; }
        .btn-special:hover { background-color: var(--special-color-dark); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .map-container { height: 250px; border-radius: 0.5rem; border: 1px solid #cbd5e1; z-index: 1; }
        .map-info-display { background-color: #e0f2fe; border: 1px solid #bae6fd; color: #0c4a6e; padding: 0.75rem; border-radius: 0.375rem; font-size: 0.8rem; }
        .file-preview-container { width: 100%; height: 12rem; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 0.375rem; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f8fafc; }
        .file-preview-container img, .file-preview-container iframe { width: 100%; height: 100%; object-fit: cover; border: none; }
        .file-preview-container i { font-size: 2rem; color: #94a3b8; margin-bottom: 0.5rem; }
        .modal { display: none; align-items: center; justify-content: center; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .modal-content { background-color: #ffffff; margin: auto; padding: 2rem; border: none; width: 90%; max-width: 500px; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        #cropperModal .modal-content { max-width: 90vw; width: 600px; }
        #cropperContainer { width: 100%; height: 400px; overflow: hidden; background: #f1f1f1; }
        #cropperContainer img { max-width: 100%; height: auto; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 32px; height: 32px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #welcome-loader { display: flex; flex-direction: row; align-items: stretch; justify-content: center; position: fixed; inset: 0; z-index: 9999; background: linear-gradient(135deg, #FDFEFF 0%, #FCFDFF 50%, #EFF9FF 100%); transition: opacity 0.5s ease-out; }
        .welcome-banner { width: 20vw; max-width: 220px; min-width:150px; background-color: rgba(255,255,255,0.5); display: none; align-items: center; justify-content: center; overflow: hidden; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.03); margin: 2rem; height: calc(100vh - 8rem); } 
        .welcome-banner img { width: 100%; height: 100%; object-fit: cover; }
        .welcome-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        @media (min-width: 1024px) { .welcome-banner { display: flex; } }
        .project-card, .activity-card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.3s ease; }
        .project-card:hover, .activity-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .price-highlight { background-color: #f0fdf4; }
        .commission-highlight { background-color: #f8fafc; }
        .frosode-badge { background-color: #fef2f2; color: #dc2626; }
        .frosode-badge-container { text-align: center; }
        #project-list-container, #my-activities-container, #engineers-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }      
        #filter-container .grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; }
        @media (min-width: 768px) { #filter-container .grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1280px) { #filter-container .grid { grid-template-columns: repeat(4, 1fr); } }

        .neumorphic-card { background: #ffffff; border-radius: 20px; box-shadow: 8px 8px 16px #e0e0e0, -8px -8px 16px #ffffff; padding: 20px; margin: 20px auto; width: 100%; max-width: 800px; } 
        .neumorphic-button { background: #ffffff; border: none; border-radius: 10px; box-shadow: 4px 4px 8px #e0e0e0, -4px -4px 8px #ffffff; padding: 8px 16px; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; } 
        .neumorphic-button:hover { box-shadow: 2px 2px 4px #e0e0e0, -2px -2px 4px #ffffff; }
        .progress-bar { height: 6px; border-radius: 3px; background-color: #e9ecef; width: 100%; } 
        .progress-fill { height: 100%; border-radius: 3px; background-color: #3b82f6; transition: width 0.3s ease; }
        .needs-help { background-color: #fee2e2; padding: 4px 8px; border-radius: 4px; color: #dc2626; font-size: 0.875rem; }
        /* Notification Panel Styles */
        .notification-item { border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s ease; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item.unread { background-color: #eff6ff; font-weight: 600; }
        .notification-item:hover { background-color: #f8fafc; }
        .notification-item .dot { width: 10px; height: 10px; background-color: var(--primary-color); border-radius: 50%; flex-shrink: 0; }
        /* --- NEW: Info Box Style --- */
        .info-box { background-color: #e0f2fe; /* light-blue */ border-right: 4px solid #0ea5e9; /* sky-500 */ padding: 1rem; border-radius: 0.375rem; margin-top: 1.5rem; display: flex; align-items: flex-start; gap: 0.75rem; }
        .info-box i { color: #0284c7; /* sky-600 */ font-size: 1.25rem; margin-top: 0.25rem; }
        .info-box p { font-size: 0.875rem; color: #0c4a6e; /* sky-900 */ line-height: 1.6; }
        /* --- NEW: Sidebar Footer Style --- */
        .sidebar-brand-footer { margin-top: auto; /* این دستور جادویی، این بخش را به پایین هل می‌دهد */ display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem; border-top: 1px solid #e2e8f0; }
        .sidebar-brand-footer img { width: 40px; height: 40px; object-fit: contain; flex-shrink: 0; }
        .sidebar-brand-footer div { font-size: 0.75rem; color: #475569; line-height: 1.4; }
        .sidebar-brand-footer strong { font-weight: 600; color: #1e293b; }
        .custom-price-container { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.5rem; /* پدینگ کمتر برای جا دادن اینپوت */ }
        .custom-price-input { margin-top: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; padding: 0.25rem 0.5rem; width: 90%; text-align: center; background-color: white; }
        /* --- استایل‌های جدید برای فیلتر و مرتب‌سازی پیشرفته --- */
        .filter-sort-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; padding: 0.75rem; background-color: #ffffff; border-radius: 0.75rem; border: 1px solid #e2e8f0; margin-bottom: 1.5rem; }
        .filter-group { position: relative; }
        .filter-btn, .sort-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; background-color: #ffffff; color: #475569; font-weight: 500; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .filter-btn:hover, .sort-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .filter-btn.active, .sort-btn.active { background-color: var(--primary-color); border-color: var(--primary-color); color: white; }
        .filter-btn .close-icon, .sort-btn .close-icon { font-size: 0.8em; margin-right: -0.25rem; margin-left: 0.25rem; opacity: 0.7;}
        .filter-btn .close-icon:hover { opacity: 1; }
        .filter-dropdown { position: absolute; top: 100%; right: 0; z-index: 10; min-width: 200px; background-color: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 0.5rem; max-height: 250px; overflow-y: auto; display: none; /* به صورت پیش‌فرض مخفی است */ }
        .filter-dropdown-item { padding: 0.75rem 1rem; cursor: pointer; }
        .filter-dropdown-item:hover { background-color: #f1f5f9; }
    </style>
</head>
<body class="hidden">

    <div id="welcome-loader">
        <div class="welcome-banner">
             <img src="https://images.unsplash.com/photo-1657450717464-b2989dd69a66?w=600&auto=format&fit=crop&q=60" 
                  alt="گل‌های آبی" onerror="this.onerror=null;this.src='https://placehold.co/220x500/EBF4FF/2196F3?text=Flowers';">
        </div>
        <div class="welcome-content">
            <div class="flex items-center justify-center mb-6">
                <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="لوگوی تندیس" class="h-24 w-24 ml-4" loading="lazy">
                <div class="text-center">
                    <h1 class="text-4xl font-black text-blue-800">نظام تندیس</h1>
                    <p class="text-lg font-bold text-yellow-600 mt-1">تدارک نیازمندی دقیق و یکپارچه ساختمان</p>
                </div>
            </div>
            <div class="spinner mb-4"></div>
            <h2 id="welcome-message" class="text-xl font-semibold text-slate-700 mb-2">خوش آمدید!</h2>
            <p class="text-slate-600">پلتفرم تخصصی ارتباط مهندسان و کارفرمایان ساختمانی</p>
        </div>
         <div class="welcome-banner">
             <img src="https://images.unsplash.com/photo-1657450717464-b2989dd69a66?w=600&auto=format&fit=crop&q=60" 
                  alt="گل‌های آبی" onerror="this.onerror=null;this.src='https://placehold.co/220x500/FFF3E0/FFB300?text=Flowers';">
        </div>
    </div>

    <div class="workstation-wrapper">
        <!-- Main Sidebar (Right) -->
        <aside class="sidebar">
            <div class="sidebar-profile-section">
                <div class="sidebar-profile-image-container">
                    <img id="sidebarProfileImage" src="https://placehold.co/80x80/2196F3/FFFFFF?text=U" alt="عکس پروفایل" class="sidebar-profile-image">
                    <label for="profileImageInput" class="sidebar-profile-image-edit-overlay">
                        <i class="fas fa-camera"></i>
                    </label>
                    <input type="file" id="profileImageInput" class="hidden" accept="image/*">
                </div>
                <div class="sidebar-profile-details">
                    <h2 id="sidebarProfileName" class="sidebar-profile-name">...</h2>
                    <p id="sidebarProfileRole" class="sidebar-profile-role">...</p>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a data-view="dashboard" class="nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>داشبورد</span>
                </a>
                <a data-view="profile" class="nav-item">
                    <i class="fas fa-user-circle"></i>
                    <span>پروفایل</span>
                </a>
                <a data-view="notifications" class="nav-item">
                    <i class="fas fa-bell"></i>
                    <span>پیام‌ها</span>
                    <span id="notification-badge" class="notification-badge hidden"></span>
                </a>
                <a data-view="projects" class="nav-item" id="projects-nav-item" style="display: none;">
                    <i class="fas fa-tasks"></i>
                    <span>پروژه‌ها</span>
                </a>
                <a data-view="my-activities" class="nav-item" id="my-activities-nav-item" style="display: none;">
                    <i class="fas fa-list-check"></i>
                    <span>فعالیت‌های من</span>
                </a>
                <a data-view="engineers" class="nav-item" id="engineers-nav-item" style="display: none;">
                    <i class="fas fa-users-cog"></i>
                    <span>مهندسان</span>
                </a>
                <a data-view="create-project" class="nav-item btn-special-project mt-4" id="create-project-nav-item" style="display: none;">
                    <i class="fas fa-plus-circle"></i>
                    <span>ثبت پروژه جدید</span>
                </a>
                <a data-view="create-activity" class="nav-item btn-special-project mt-4" id="create-activity-nav-item" style="display: none;">
                    <i class="fas fa-bullhorn"></i>
                    <span>ثبت فعالیت جدید</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <a data-view="settings" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>تنظیمات</span>
                </a>
                <a href="#" id="logoutButton" class="nav-item">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>خروج از سیستم</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content-area">
            <header class="p-4 border-b border-slate-200 bg-white flex-shrink-0 flex justify-between items-center">
                <h1 id="main-header-title" class="text-2xl font-bold text-slate-800">داشبورد</h1>
                <!-- --- NEW: Refresh Button --- -->
                <button id="refresh-button" class="btn btn-secondary !p-2 text-sm" title="بروزرسانی صفحه">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </header>
            
            <div id="dashboardContent" class="content-body"></div>
            <div id="profileContent" class="content-body" style="display: none;"></div>
            <div id="notificationsContent" class="content-body" style="display: none;"></div>
            <div id="projectsContent" class="content-body" style="display: none;"></div>
            <div id="myActivitiesContent" class="content-body" style="display: none;"></div>
            <div id="engineersContent" class="content-body" style="display: none;"></div>
            <div id="settingsContent" class="content-body" style="display: none;">
                <div class="profile-section">
                    <div class="section-header !cursor-default">
                        <h3 class="section-title"><i class="fas fa-key"></i>تغییر رمز عبور</h3>
                    </div>
                    <div class="section-content open">
                        <form id="changePasswordForm">
                            <div class="space-y-4 max-w-lg mx-auto p-4">
                                <div>
                                    <label for="currentPassword" class="block text-sm font-medium text-slate-700 mb-1 required-field">رمز عبور فعلی</label>
                                    <div class="password-input-container">
                                        <input type="password" id="currentPassword" name="currentPassword" required class="mt-1">
                                        <i class="fas fa-eye password-toggle-icon" data-target="currentPassword"></i>
                                    </div>
                                </div>
                                <div>
                                    <label for="newPassword" class="block text-sm font-medium text-slate-700 mb-1 required-field">رمز عبور جدید</label>
                                    <div class="password-input-container">
                                        <input type="password" id="newPassword" name="newPassword" required class="mt-1">
                                        <i class="fas fa-eye password-toggle-icon" data-target="newPassword"></i>
                                    </div>
                                </div>
                                <div>
                                    <label for="confirmNewPassword" class="block text-sm font-medium text-slate-700 mb-1 required-field">تکرار رمز عبور جدید</label>
                                    <div class="password-input-container">
                                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required class="mt-1">
                                        <i class="fas fa-eye password-toggle-icon" data-target="confirmNewPassword"></i>
                                    </div>
                                </div>
                                <div class="pt-4">
                                     <button type="submit" class="btn btn-primary w-full justify-center">
                                        <i class="fas fa-save"></i>
                                        <span id="savePasswordBtnText">ذخیره تغییرات</span>
                                        <div id="savePasswordSpinner" class="spinner !w-5 !h-5 !border-2 hidden"></div>
                                     </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="createProjectContent" class="content-body" style="display: none;"></div>
            <div id="createActivityContent" class="content-body" style="display: none;"></div>
        </main>
        
        <aside class="advertisement-sidebar">
             <div class="flex items-center gap-4 mb-6 pb-6 border-b border-slate-300 justify-center">
                <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="لوگوی تندیس" class="w-16 h-16 mb-2 rounded-md object-contain">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-blue-800">نظام تندیس</h2>
                    <p class="text-sm font-bold text-yellow-600 mt-1">تـدارک نیـازمنـدی</p>
                    <p class="text-sm font-bold text-yellow-600 mt-1">دقیق و یکپارچه ساختمان</p>
                </div>
            </div>
            <div class="slideshow-container">
                <div id="slideshow" class="slideshow-container"></div>
                <div id="slide-dots-container" class="slide-dots"></div>
            </div>
            <!-- --- NEW: Info Box --- -->
            <div id="info-box-container" class="info-box">
                <i class="fas fa-info-circle"></i>
                <p id="info-box-text">به ایستگاه کاری خود خوش آمدید. از منوی سمت راست برای دسترسی به بخش‌های مختلف استفاده کنید.</p>
            </div>
            <!-- --- NEW: Sidebar Footer --- -->
            <div class="sidebar-brand-footer">
                <img src="https://shahraavand.ir/images/logoT.png" alt="لوگوی شرکت شهرآوند">
                <div class="text-center">
                    <strong>شرکت مهـندسین مشاور</strong><br>
                    <strong>شـهرآوند تبـریز</strong><br>
                    طراحی و نظارت ساختمان
                </div>
            </div>
        </aside>
    </div>

    <!-- Modals -->
    <div id="cropperModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">برش و تنظیم عکس پروفایل</h3>
            <div id="cropperContainer">
                <img id="imageToCrop" src="">
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="cancelCropButton" class="btn btn-secondary"><i class="fas fa-times"></i>انصراف</button>
                <button id="cropAndSaveButton" class="btn btn-primary"><i class="fas fa-crop-alt"></i>برش و ذخیره</button>
            </div>
        </div>
    </div>
    <div id="messageModal" class="modal">
        <div class="modal-content text-center">
            <div id="modalIconContainer" class="mb-4 text-5xl"></div>
            <p id="modalMessageText" class="text-slate-700 text-base"></p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="modalConfirmBtn" class="btn btn-primary"><i class="fas fa-check"></i>تایید</button>
                <button id="modalCancelBtn" class="btn btn-secondary"><i class="fas fa-times"></i>انصراف</button>
            </div>
        </div>
    </div>
     <div id="notificationModal" class="modal">
        <div class="modal-content !max-w-2xl text-right">
            <h3 id="notificationModalTitle" class="text-xl font-bold mb-2 text-slate-800"></h3>
            <p id="notificationModalMeta" class="text-sm text-slate-500 mb-4"></p>
            <div id="notificationModalBody" class="text-slate-700 text-base leading-relaxed max-h-96 overflow-y-auto border-t border-b py-4 my-4"></div>
            <div class="mt-6 flex justify-center">
                <button id="notificationModalCloseBtn" class="btn btn-primary"><i class="fas fa-check mr-2"></i>متوجه شدم</button>
            </div>
        </div>
    </div>

    <script>
    (async function() {
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX4wAA8HryxvmHPq1XgGPRZKbopHfdUr1DgP8uZw532kbmhFJXB_GFL_UtnzAVxlEE/exec'; // Please replace with your actual script URL
        const SLIDESHOW_IMAGES = [
            'https://images.unsplash.com/photo-1739467561973-e5015d7f9561?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHx0b3BpYy1mZWVkfDI4M3xNOGpWYkxiVFJ3c3x8ZW58MHx8fHx8',
            'https://images.unsplash.com/photo-1751908934325-5be793566bcc?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHx0b3BpYy1mZWVkfDQyfE04alZiTGJUUndzfHxlbnwwfHx8fHw%3D',
            'https://images.unsplash.com/photo-1746444342182-fc6679dd3b4d?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHx0b3BpYy1mZWVkfDE0OXxNOGpWYkxiVFJ3c3x8ZW58MHx8fHx8'
        ];
        const PROVINCES = ["آذربایجان شرقی", "آذربایجان غربی", "اردبیل", "اصفهان", "البرز", "ایلام", "بوشهر", "تهران", "چهارمحال و بختیاری", "خراسان جنوبی", "خراسان رضوی", "خراسان شمالی", "خوزستان", "زنجان", "سمنان", "سیستان و بلوچستان", "فارس", "قزوین", "قم", "کردستان", "کرمان", "کرمانشاه", "کهگیلویه و بویراحمد", "گلستان", "گیلان", "لرستان", "مازندران", "مرکزی", "هرمزگان", "همدان", "یزد"];

        // --- STATE ---
        let userData = null;
        let cropper = null;
        let currentSlide = 0;
        let activeMaps = {};
        let fetchedProjects = [];
        let fetchedActivities = [];
        let fetchedEngineersActivities = [];
        let appliedProjectIds = new Set();
        let requestedCooperationIds = new Set();
        let currentActivityData = {};
        let fetchedNotifications = [];
        let currentView = 'dashboard';
        let projectMap, projectMarker;

        // --- DOM ELEMENTS ---
        const welcomeLoader = document.getElementById('welcome-loader');
        const welcomeMessage = document.getElementById('welcome-message');
        const allContentBodies = document.querySelectorAll('.content-body');
        const mainHeaderTitle = document.getElementById('main-header-title');
        const sidebarProfileImage = document.getElementById('sidebarProfileImage');
        const sidebarProfileName = document.getElementById('sidebarProfileName');
        const sidebarProfileRole = document.getElementById('sidebarProfileRole');
        const profileImageInput = document.getElementById('profileImageInput');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const infoBoxText = document.getElementById('info-box-text');
        
        // --- HELPER FUNCTIONS ---
        function generateProvinceOptions(selectedValue, addSarasari = false) {
            let options = '<option value="">انتخاب استان</option>';
            if (addSarasari) {
                options += `<option value="سراسری" ${"سراسری" === selectedValue ? 'selected' : ''}>سراسری (کشوری)</option>`;
            }
            PROVINCES.forEach(province => {
                options += `<option value="${province}" ${province === selectedValue ? 'selected' : ''}>${province}</option>`;
            });
            return options;
        }
        
        function formatTimeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            const hours = Math.round(minutes / 60);
            const days = Math.round(hours / 24);
            const months = Math.round(days / 30.44);

            if (seconds < 60) return 'لحظاتی پیش';
            if (minutes < 60) return `${minutes} دقیقه پیش`;
            if (hours < 24) return `${hours} ساعت پیش`;
            if (days < 30) return `${days} روز پیش`;
            if (months < 12) return `${months} ماه پیش`;
            
            return new Date(dateString).toLocaleDateString('fa-IR');
        }

        function getDirectDriveLink(url) {
            if (!url || typeof url !== 'string') return '';
            const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (!match || !match[1]) return url;
            const fileId = match[1];
            return `https://lh3.googleusercontent.com/d/${fileId}`;
        }
        
        function getDirectDriveLinkForPdf(url) {
             if (!url || typeof url !== 'string') return '';
            const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (!match || !match[1]) return url;
            const fileId = match[1];
            return `https://drive.google.com/file/d/${fileId}/preview`;
        }

        function showModal(message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('messageModal');
            const modalMessageText = document.getElementById('modalMessageText');
            const modalIconContainer = document.getElementById('modalIconContainer');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            modalMessageText.textContent = message;
            let iconHtml = '';
            let confirmIcon = '<i class="fas fa-check"></i>';
            switch(type) {
                case 'error': iconHtml = `<i class="fas fa-times-circle text-red-500"></i>`; break;
                case 'success': iconHtml = `<i class="fas fa-check-circle text-green-500"></i>`; break;
                case 'confirm': 
                    iconHtml = `<i class="fas fa-question-circle text-yellow-500"></i>`;
                    confirmIcon = '<i class="fas fa-check"></i>';
                    break;
                default: iconHtml = `<i class="fas fa-info-circle text-blue-500"></i>`; break;
            }
            modalIconContainer.innerHTML = iconHtml;
            
            const closeModal = () => modal.style.display = 'none';

            if (onConfirm && typeof onConfirm === 'function') {
                modalConfirmBtn.style.display = 'inline-flex';
                modalCancelBtn.style.display = 'inline-flex';
                modalConfirmBtn.innerHTML = `${confirmIcon}<span class="mr-2">تایید</span>`;
                modalConfirmBtn.onclick = () => {
                    closeModal();
                    onConfirm();
                };
                modalCancelBtn.onclick = closeModal;
            } else {
                modalConfirmBtn.style.display = 'inline-flex';
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.innerHTML = `${confirmIcon}<span class="mr-2">متوجه شدم</span>`;
                modalConfirmBtn.onclick = closeModal;
            }

            modal.style.display = 'flex';
        }

        async function fetchUserProfile(email) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getUserProfile&email=${encodeURIComponent(email)}`);
                if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
                const result = await response.json();
                if (result.success) return result.data;
                throw new Error(result.message || "Could not find user profile.");
            } catch (error) {
                console.error("Error fetching user profile:", error);
                welcomeLoader.innerHTML = `<p class="text-red-600 font-bold text-center p-8">${error.message}</p>`;
                return null;
            }
        }

        async function updateProfileSection(sectionKey, sectionData) {
            welcomeLoader.style.opacity = '1';
            welcomeLoader.style.display = 'flex';
            try {
                const payload = { action: 'updateSection', email: userData.email, sectionKey, sectionData };
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal('اطلاعات با موفقیت ذخیره شد.', 'success');
                    const updatedData = await fetchUserProfile(userData.email);
                    if (updatedData) {
                        userData = { ...updatedData, email: userData.email };
                        renderProfile();
                    }
                    return true;
                }
                throw new Error(result.message || "Failed to update profile.");
            } catch (error) {
                console.error("Error updating profile section:", error);
                showModal(`خطا در ذخیره‌سازی: ${error.message}`, 'error');
                return false;
            } finally {
                 welcomeLoader.style.opacity = '0';
                 setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
            }
        }
        
        function initSlideshow() {
            const slideshowContainer = document.getElementById('slideshow');
            const dotsContainer = document.getElementById('slide-dots-container');
            if (!slideshowContainer || !dotsContainer) return;

            slideshowContainer.innerHTML = '';
            dotsContainer.innerHTML = '';

            SLIDESHOW_IMAGES.forEach((src, index) => {
                const img = document.createElement('img');
                img.src = src;
                img.alt = `Slide ${index + 1}`;
                img.className = 'slide-image';
                slideshowContainer.appendChild(img);

                const dot = document.createElement('span');
                dot.className = 'dot';
                dot.dataset.slideIndex = index;
                dot.onclick = () => showSlide(index);
                dotsContainer.appendChild(dot);
            });

            showSlide(0);
            setInterval(() => {
                currentSlide = (currentSlide + 1) % SLIDESHOW_IMAGES.length;
                showSlide(currentSlide);
            }, 5000);
        }

        function showSlide(index) {
           const slides = document.querySelectorAll('.slide-image');
            const dots = document.querySelectorAll('.dot');
            if (slides.length === 0) return;
            
            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            
            if (slides[index]) slides[index].classList.add('active');
            if (dots[index]) dots[index].classList.add('active');
            currentSlide = index;
        }

        function renderProfile() {
            if (!userData) return;
            const profileContent = document.getElementById('profileContent');

            const name = `${userData.stepsData.step1.engineerFirstName || userData.stepsData.step1.employerFirstName || ''} ${userData.stepsData.step1.engineerLastName || userData.stepsData.step1.employerLastName || ''}`;
            sidebarProfileName.textContent = name.trim() ? name : 'کاربر';
            sidebarProfileRole.textContent = userData.role === 'engineer' ? 'مهندس' : 'کارفرما';
            
            const directImageUrl = getDirectDriveLink(userData.files.applicantImage.fileUrl);
            sidebarProfileImage.src = directImageUrl || 'https://placehold.co/80x80/2196F3/FFFFFF?text=U';
            sidebarProfileImage.onerror = () => { sidebarProfileImage.src = 'https://placehold.co/80x80/2196F3/FFFFFF?text=U'; };

            const projectsNavItem = document.getElementById('projects-nav-item');
            const createProjectNavItem = document.getElementById('create-project-nav-item');
            const createActivityNavItem = document.getElementById('create-activity-nav-item');
            const myActivitiesNavItem = document.getElementById('my-activities-nav-item');
            const engineersNavItem = document.getElementById('engineers-nav-item');

            if (userData.role === 'employer') {
                projectsNavItem.style.display = 'flex';
                createProjectNavItem.style.display = 'flex';
                engineersNavItem.style.display = 'flex';
                createActivityNavItem.style.display = 'none';
                myActivitiesNavItem.style.display = 'none';
                projectsNavItem.querySelector('span').textContent = 'پروژه‌های من';
            } else if (userData.role === 'engineer') {
                projectsNavItem.style.display = 'flex';
                myActivitiesNavItem.style.display = 'flex';
                createActivityNavItem.style.display = 'flex';
                createProjectNavItem.style.display = 'none';
                engineersNavItem.style.display = 'none';
                projectsNavItem.querySelector('span').textContent = 'بازار کار پروژه‌ها';
            }

            profileContent.innerHTML = '';
            const sections = [
                { id: 'personal', title: 'مشخصات فردی', icon: 'fa-user-circle', content: getPersonalFieldsHTML(userData.stepsData.step1, userData.role) },
                { id: 'contact', title: 'اطلاعات تماس', icon: 'fa-address-card', content: getContactFieldsHTML(userData.stepsData.step2, userData.role) },
                { id: 'professional', title: 'اطلاعات حرفه‌ای', icon: 'fa-briefcase', content: getProfessionalFieldsHTML(userData.stepsData.step3, userData.role) },
                { id: 'documents', title: 'مدارک', icon: 'fa-file-alt', content: getDocumentsHTML(userData.files, userData.role) }
            ];
            sections.forEach(section => {
                profileContent.insertAdjacentHTML('beforeend', getSectionHTML(section.id, section.title, section.icon, section.content));
            });
            
            attachSectionEventListeners();
        }
        
        function getSectionHTML(id, title, icon, content) {
            return `
                <div id="section-${id}" class="profile-section">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas ${icon}"></i>${title}</h3>
                        <div class="flex items-center gap-4">
                            <button data-action="edit" data-section="${id}" class="btn btn-secondary !p-2 text-sm"><i class="fas fa-edit mr-1"></i> ویرایش</button>
                            <i class="fas fa-chevron-down section-toggle-icon"></i>
                        </div>
                    </div>
                    <div class="section-content">
                        <form id="form-${id}">
                            ${content}
                            <div class="section-actions mt-6 hidden">
                                <button type="button" data-action="cancel" data-section="${id}" class="btn btn-secondary"><i class="fas fa-times mr-2"></i>انصراف</button>
                                <button type="button" data-action="save" data-section="${id}" class="btn btn-primary"><i class="fas fa-save mr-2"></i>ذخیره تغییرات</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }
        
function getPersonalFieldsHTML(data, role) {
    const prefix = role === 'engineer' ? 'engineer' : 'employer';
    const jalaliDob = data[`${prefix}Dob`] || '';
    let gregorianDob = '';
    if (jalaliDob) {
        try {
            // فرمت ورودی را از 'YYYY/MM/DD' به 'YYYY-MM-DD' تغییر دادیم
            const dateObj = persianDate.parse(jalaliDob, 'YYYY-MM-DD').toDate();
            gregorianDob = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
        } catch(e) {
            console.error("تاریخ شمسی ورودی نامعتبر است:", jalaliDob);
        }
    }
    
    // بقیه کد این تابع بدون تغییر است
    return `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
        <div><label class="block text-sm font-medium text-slate-700 mb-1">نام</label><input type="text" name="${prefix}FirstName" value="${data[`${prefix}FirstName`] || ''}" disabled></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">نام خانوادگی</label><input type="text" name="${prefix}LastName" value="${data[`${prefix}LastName`] || ''}" disabled></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">کدملی</label><input type="text" name="${prefix}NationalId" value="${data[`${prefix}NationalId`] || ''}" disabled></div>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">تاریخ تولد</label>
            <input type="text" class="jalali-datepicker-display" value="${jalaliDob}" readonly disabled>
            <input type="hidden" name="${prefix}Dob" class="jalali-datepicker-value" value="${gregorianDob}">
        </div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">جنسیت</label><select name="${prefix}Gender" disabled><option value="مرد" ${data[`${prefix}Gender`] === 'مرد' ? 'selected' : ''}>مرد</option><option value="زن" ${data[`${prefix}Gender`] === 'زن' ? 'selected' : ''}>زن</option></select></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">تلفن موبایل</label><input type="tel" name="${prefix}Mobile" value="${data[`${prefix}Mobile`] || ''}" disabled></div>
    </div>`;
}
        
        function getContactFieldsHTML(data, role) {
            const prefix = role === 'engineer' ? 'engineer' : 'employer';
            const address = data[`${prefix}ResidentialAddress`] || data[`${prefix}Address`] || '';
            const mapId = `${prefix}LocationMap`;
            return `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                <div><label class="block text-sm font-medium text-slate-700 mb-1">تلفن ثابت</label><input type="tel" name="${prefix}Phone" value="${data[`${prefix}Phone`] || ''}" disabled></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">کدپستی</label><input type="text" name="${prefix}PostalCode" value="${data[`${prefix}PostalCode`] || ''}" disabled></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">استان</label><select name="${prefix}Province" disabled>${generateProvinceOptions(data[`${prefix}Province`])}</select></div>
                <div><label class="block text-sm font-medium text-slate-700 mb-1">شهر</label><input type="text" name="${prefix}City" value="${data[`${prefix}City`] || ''}" disabled></div>
            </div>
            <div class="mt-6">
                <label class="block text-sm font-medium text-slate-700 mb-1">آدرس و موقعیت مکانی</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea name="${prefix}ResidentialAddress" rows="4" class="min-h-[250px]" disabled>${address}</textarea>
                    <div id="${mapId}" class="map-container"></div>
                </div>
                <div id="${mapId}Info" class="mt-2 map-info-display">
                    ${data[`${prefix}ResidentialNeighborhood`] ? `<p>${data[`${prefix}ResidentialNeighborhood`]}</p>` : `<span class="text-slate-500 italic">موقعیت مکانی روی نقشه مشخص نشده است.</span>`}
                </div>
                <input type="hidden" name="${prefix}ResidentialLat" value="${data[`${prefix}ResidentialLat`] || ''}">
                <input type="hidden" name="${prefix}ResidentialLng" value="${data[`${prefix}ResidentialLng`] || ''}">
                <input type="hidden" name="${prefix}ResidentialNeighborhood" value="${data[`${prefix}ResidentialNeighborhood`] || ''}">
            </div>`;
        }
        
        function getProfessionalFieldsHTML(data, role) {
            if (role === 'employer') {
                const hasCompany = data.employerHasCompany;
                if (!hasCompany) {
                    return '<p class="text-slate-500">این کارفرما به عنوان شخص حقیقی فعالیت می‌کند.</p>';
                }
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">نام شرکت</label><input type="text" name="employerCompanyName" value="${data.employerCompanyName || ''}" disabled></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">شماره ثبت شرکت</label><input type="text" name="employerCompanyRegNumber" value="${data.employerCompanyRegNumber || ''}" disabled></div>
                    </div>
                    <div class="mt-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">آدرس شرکت</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <textarea name="employerCompanyAddress" rows="4" class="min-h-[250px]" disabled>${data.employerCompanyAddress || ''}</textarea>
                            <div id="employerCompanyMap" class="map-container"></div>
                        </div>
                        <div id="employerCompanyMapInfo" class="mt-2 map-info-display">
                            ${data.employerCompanyAddressNeighborhood ? `<p>${data.employerCompanyAddressNeighborhood}</p>` : `<span class="text-slate-500 italic">موقعیت مکانی روی نقشه مشخص نشده است.</span>`}
                        </div>
                        <input type="hidden" name="employerCompanyAddressLat" value="${data.employerCompanyAddressLat || ''}">
                        <input type="hidden" name="employerCompanyAddressLng" value="${data.employerCompanyAddressLng || ''}">
                        <input type="hidden" name="employerCompanyAddressNeighborhood" value="${data.employerCompanyAddressNeighborhood || ''}">
                    </div>
                `;
            }

            if (role === 'engineer') {
                return getProfessionalFieldsHTMLEditable(data, true); // Pass true for disabled mode
            }
            return '<p class="text-slate-500">اطلاعات حرفه‌ای برای این کاربر یافت نشد.</p>';
        }

        function getProfessionalFieldsHTMLEditable(data, isDisabled) {
            const disabledAttr = isDisabled ? 'disabled' : '';
            const gradeMap = { '3': 'پایه ۳', '2': 'پایه ۲', '1': 'پایه ۱', 'arshad': 'پایه ارشد' };
            const executorTypeMap = { 'individual': 'حقیقی', 'legal': 'حقوقی', 'none': 'فعالیت ندارم' };
            
    const jalaliToGregorian = (jalaliDate) => {
        if (jalaliDate) {
            try {
                // فرمت ورودی را اینجا هم به 'YYYY-MM-DD' تغییر دادیم
                const dateObj = persianDate.parse(jalaliDate, 'YYYY-MM-DD').toDate();
                return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
            } catch(e) { return ''; }
        }
        return '';
    };

    const jalaliFirstIssueDate = data.licenseFirstIssueDate || '';
    const gregorianFirstIssueDate = jalaliToGregorian(jalaliFirstIssueDate);
    const jalaliStartDate = data.licenseStartDate || '';
    const gregorianStartDate = jalaliToGregorian(jalaliStartDate);
            
            // --- بخش جدید برای بررسی و فرمت کردن تاریخ‌ها ---
            // 1. تاریخ اولین صدور پروانه
            const firstIssueDateValue = data.licenseFirstIssueDate;
            let formattedFirstIssueDate = '';
            if (firstIssueDateValue && new Date(firstIssueDateValue).getTime()) {
                formattedFirstIssueDate = new persianDate(new Date(firstIssueDateValue)).format('YYYY/MM/DD');
            }

            // 2. تاریخ شروع اعتبار پروانه
            const startDateValue = data.licenseStartDate;
            let formattedStartDate = '';
            if (startDateValue && new Date(startDateValue).getTime()) {
                formattedStartDate = new persianDate(new Date(startDateValue)).format('YYYY/MM/DD');
            }
            
            const createGradeSelect = (name, selected, disabled) => {
                let options = '<option value="">انتخاب پایه</option>';
                for (const [key, value] of Object.entries(gradeMap)) {
                    options += `<option value="${key}" ${key === selected ? 'selected' : ''}>${value}</option>`;
                }
                return `<select name="${name}" ${disabled} class="block w-full sm:text-sm bg-slate-100 mb-2">${options}</select>`;
            };

            const createExecutorRadios = (name, selected, disabled) => {
                let radios = '';
                for (const [key, value] of Object.entries(executorTypeMap)) {
                    radios += `<label class="inline-flex items-center"><input type="radio" name="${name}" value="${key}" ${key === selected ? 'checked' : ''} ${disabled} class="form-radio h-3 w-3 text-sky-600"><span class="mr-1 ml-1">${value}</span></label>`;
                }
                return `<div class="flex flex-col space-y-1 text-xs">${radios}</div>`;
            };
            
    return `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6">
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1 required-field">تاریخ اولین صدور پروانه</label>
            <input type="text" class="mt-1 block w-full sm:text-sm jalali-datepicker-display" readonly value="${jalaliFirstIssueDate}" ${disabledAttr}>
            <input type="hidden" name="licenseFirstIssueDate" class="jalali-datepicker-value" value="${gregorianFirstIssueDate}">
        </div>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1 required-field">تاریخ شروع اعتبار پروانه</label>
            <input type="text" class="mt-1 block w-full sm:text-sm jalali-datepicker-display" readonly value="${jalaliStartDate}" ${disabledAttr}>
            <input type="hidden" name="licenseStartDate" class="jalali-datepicker-value" value="${gregorianStartDate}">
        </div>
        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1 required-field">مدت اعتبار پروانه (سال)</label>
            <input type="number" name="licenseValidity" min="1" required class="mt-1 block w-full sm:text-sm" value="${data.licenseValidity || ''}" ${disabledAttr}>
        </div>
    </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-6 pt-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1 required-field">شماره پروانه</label>
                    <input type="text" name="licenseNumber" required class="mt-1 block w-full sm:text-sm" placeholder="0-13-30-012345" maxlength="14" value="${data.licenseNumber || ''}" ${disabledAttr}>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1 required-field">شماره عضویت</label>
                    <input type="text" name="membershipNumber" required class="mt-1 block w-full sm:text-sm" value="${data.membershipNumber || ''}" ${disabledAttr}>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1 required-field">استان فعالیت پروانه</label>
                    <select name="licenseActivityProvince" required class="mt-1 block w-full sm:text-sm" ${disabledAttr}>
                        ${generateProvinceOptions(data.licenseActivityProvince, true)}
                    </select>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-5">
                <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
                    <div class="flex items-center space-x-2 space-x-reverse mb-1">
                        <input type="checkbox" name="hasDesignLicense" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.hasDesignLicense ? 'checked' : ''} ${disabledAttr}>
                        <label class="text-sm font-medium text-slate-700">پروانه طراحی</label>
                    </div>
                    <div>${createGradeSelect('designLicenseGrade', data.designLicenseGrade, disabledAttr || !data.hasDesignLicense)}</div>
                    <div><label class="block text-xs font-medium text-slate-600 mb-1 mt-2">نوع صلاحیت طراحی:</label>${createExecutorRadios('designExecutorType', data.designExecutorType || 'none', disabledAttr)}</div>
                </div>
                <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
                    <div class="flex items-center space-x-2 space-x-reverse mb-1">
                        <input type="checkbox" name="hasSupervisionLicense" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.hasSupervisionLicense ? 'checked' : ''} ${disabledAttr}>
                        <label class="text-sm font-medium text-slate-700">پروانه نظارت</label>
                    </div>
                    <div>${createGradeSelect('supervisionLicenseGrade', data.supervisionLicenseGrade, disabledAttr || !data.hasSupervisionLicense)}</div>
                    <div><label class="block text-xs font-medium text-slate-600 mb-1 mt-2">نوع صلاحیت نظارت:</label>${createExecutorRadios('supervisionExecutorType', data.supervisionExecutorType || 'none', disabledAttr)}</div>
                </div>
                <div class="flex flex-col space-y-1 p-3 border border-slate-200 rounded-md bg-white shadow-sm">
                    <div class="flex items-center space-x-2 space-x-reverse mb-1">
                        <input type="checkbox" name="hasExecutionLicense" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.hasExecutionLicense ? 'checked' : ''} ${disabledAttr}>
                        <label class="text-sm font-medium text-slate-700">پروانه اجرا</label>
                    </div>
                    <div>${createGradeSelect('executionLicenseGrade', data.executionLicenseGrade, disabledAttr || !data.hasExecutionLicense)}</div>
                    <div><label class="block text-xs font-medium text-slate-600 mb-1 mt-2">نوع صلاحیت اجرا:</label>${createExecutorRadios('executionExecutorType', data.executionExecutorType || 'none', disabledAttr)}</div>
                </div>
            </div>
            
            <div id="legalExecutorFields" class="mt-8 space-y-6 bg-slate-100 p-5 rounded-lg border border-slate-200">
                <h3 class="text-md font-semibold">اطلاعات شرکت حقوقی</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1 required-field">نام شرکت حقوقی</label>
                        <input type="text" name="companyName" class="mt-1 block w-full sm:text-sm" value="${data.companyName || ''}" ${disabledAttr}>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">شماره ثبت شرکت</label>
                        <input type="text" name="companyRegNumber" class="mt-1 block w-full sm:text-sm" value="${data.companyRegNumber || ''}" ${disabledAttr}>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">آدرس دفتر شرکت</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                        <textarea name="companyOfficeAddress" rows="4" class="mt-1 block w-full sm:text-sm min-h-[220px]" ${disabledAttr}>${data.companyOfficeAddress || ''}</textarea>
                        <div id="companyOfficeMap" class="map-container min-h-[220px]"></div>
                    </div>
                    <div id="companyOfficeMapInfo" class="mt-2 map-info-display">${data.companyOfficeMapNeighborhood || 'موقعیت مکانی روی نقشه مشخص نشده است.'}</div>
                    <input type="hidden" name="companyOfficeMapLat" value="${data.companyOfficeMapLat || ''}">
                    <input type="hidden" name="companyOfficeMapLng" value="${data.companyOfficeMapLng || ''}">
                    <input type="hidden" name="companyOfficeMapNeighborhood" value="${data.companyOfficeMapNeighborhood || ''}">
                </div>
            </div>
            <div id="individualExecutorFieldsContainer">
                <div id="individualExecutorFields" class="mt-8 bg-slate-100 p-5 rounded-lg border border-slate-200">
                    <h3 class="text-md font-semibold mb-2">اطلاعات مهندس حقیقی (اجرا)</h3>
                    <div class="flex items-center">
                        <input type="checkbox" name="isAssistantExecutor" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.isAssistantExecutor ? 'checked' : ''} ${disabledAttr}>
                        <label class="ml-2 mr-2 block text-sm text-slate-700">فقط کمک مجری هستم</label>
                    </div>
                </div>
                <div class="mt-8"> 
                    <div class="flex items-center mb-4">
                        <input type="checkbox" name="engineerHasOfficeInfo" class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500" ${data.engineerHasOfficeInfo ? 'checked' : ''} ${disabledAttr}>
                        <label class="ml-2 mr-2 block text-sm text-slate-700">دفتر کار دارم</label>
                    </div>
                    <div id="engineerOfficeInfoFields" class="space-y-6 bg-slate-100 p-5 rounded-lg border border-slate-200">
                        <h3 class="text-lg font-semibold">اطلاعات دفتر کار</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1 required-field">نام دفتر کار مهندسی</label>
                                <input type="text" name="officeName" class="mt-1 block w-full sm:text-sm" value="${data.officeName || ''}" ${disabledAttr}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1 required-field">تلفن دفتر کار</label>
                                <input type="tel" name="officePhone" class="mt-1 block w-full sm:text-sm" value="${data.officePhone || ''}" ${disabledAttr}>
                            </div>
                        </div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">آدرس دفتر کار</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                            <textarea name="officeAddress" rows="4" class="mt-1 block w-full sm:text-sm min-h-[220px]" ${disabledAttr}>${data.officeAddress || ''}</textarea>
                            <div id="officeMap" class="map-container min-h-[220px]"></div>
                        </div>
                        <div id="officeMapInfo" class="mt-2 map-info-display">${data.officeMapNeighborhood || 'موقعیت مکانی روی نقشه مشخص نشده است.'}</div>
                        <input type="hidden" name="officeMapLat" value="${data.officeMapLat || ''}">
                        <input type="hidden" name="officeMapLng" value="${data.officeMapLng || ''}">
                        <input type="hidden" name="officeMapNeighborhood" value="${data.officeMapNeighborhood || ''}">
                    </div>
                </div>
            </div>
            `;
        }
        
        function getDocumentsHTML(data, role) {
            const nationalIdKey = role === 'engineer' ? 'nationalIdCardImageEngineer' : 'employerNationalIdCardImage';
            const workPermitKey = 'workPermitPdf';
            const resumeKey = 'employerOtherDocs';
            const nationalIdUrl = getDirectDriveLink(data[nationalIdKey]?.fileUrl);
            const workPermitUrl = getDirectDriveLinkForPdf(data[workPermitKey]?.fileUrl);
            const resumeUrl = getDirectDriveLinkForPdf(data[resumeKey]?.fileUrl);
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
            html += `<div><h4 class="font-semibold mb-2">تصویر کارت ملی</h4><div class="file-preview-container">${nationalIdUrl ? `<img src="${nationalIdUrl}" onerror="this.parentElement.innerHTML = '<i class=\\'fas fa-image text-slate-400\\'></i><p>نمایش ممکن نیست</p>';">` : `<i class="fas fa-image"></i><p>فایل یافت نشد</p>`}</div></div>`;
            if (role === 'engineer') {
                html += `<div><h4 class="font-semibold mb-2">پروانه اشتغال (PDF)</h4><div class="file-preview-container">${workPermitUrl ? `<iframe src="${workPermitUrl}"></iframe>` : '<i class="fas fa-file-pdf"></i><p>فایل یافت نشد</p>'}</div></div>`;
            }
            if (role === 'employer') {
                 html += `<div><h4 class="font-semibold mb-2">رزومه (اختیاری)</h4><div class="file-preview-container">${resumeUrl ? `<iframe src="${resumeUrl}"></iframe>` : '<i class="fas fa-file-alt"></i><p>ارسال نشده</p>'}</div></div>`;
            }
            html += '</div>';
            return html;
        }

        function attachSectionEventListeners() {
             document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('button[data-action="edit"]')) return;
                    const content = header.nextElementSibling;
                    header.classList.toggle('open');
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                    if (content.style.display === 'block') {
                        content.querySelectorAll('.map-container').forEach(mapDiv => {
                           if (!mapDiv.classList.contains('map-initialized')) {
                                initializeProfileMap(mapDiv.id, false);
                                mapDiv.classList.add('map-initialized');
                           }
                        });
                    }
                });
            });
            document.querySelectorAll('button[data-action="edit"]').forEach(b => b.addEventListener('click', handleEditClick));
            document.querySelectorAll('button[data-action="cancel"]').forEach(b => b.addEventListener('click', handleCancelClick));
            document.querySelectorAll('button[data-action="save"]').forEach(b => b.addEventListener('click', handleSaveClick));
        }

        function initializeProfileMap(mapId, isEditable) {
            const mapContainer = document.getElementById(mapId);
            if (!mapContainer) return;
            const form = mapContainer.closest('form');
            if (!form) return;

            const namePrefix = mapId.replace('Map', '');
            const latInput = form.querySelector(`input[name*="${namePrefix}Lat"]`);
            const lngInput = form.querySelector(`input[name*="${namePrefix}Lng"]`);
            const neighborhoodInput = form.querySelector(`input[name*="${namePrefix}Neighborhood"]`);
            const mapInfoDiv = document.getElementById(`${mapId}Info`);

            if (!latInput || !lngInput) {
                console.error(`Inputs for map ${mapId} not found.`);
                return;
            };
            
            if (activeMaps[mapId]) {
                activeMaps[mapId].remove();
                delete activeMaps[mapId];
            }
            
            const lat = parseFloat(latInput.value) || 38.08;
            const lng = parseFloat(lngInput.value) || 46.29;
            
            const map = L.map(mapId).setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            let marker;
            if (isEditable) {
                marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                map.on('click', (e) => {
                    marker.setLatLng(e.latlng);
                    updateMapLocationUI(e.latlng.lat, e.latlng.lng, latInput, lngInput, neighborhoodInput, mapInfoDiv);
                });
                marker.on('dragend', () => {
                    const ll = marker.getLatLng();
                    updateMapLocationUI(ll.lat, ll.lng, latInput, lngInput, neighborhoodInput, mapInfoDiv);
                });
            } else {
                marker = L.marker([lat, lng]).addTo(map);
            }
            activeMaps[mapId] = map;
            
            setTimeout(() => map.invalidateSize(), 100);
        }

        async function updateMapLocationUI(lat, lng, latInput, lngInput, neighborhoodInput, mapInfoDiv) {
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);
            if (mapInfoDiv) mapInfoDiv.innerHTML = `<span class="italic text-slate-500">در حال دریافت نام محله...</span>`;
            
            const address = await getAddressFromLatLng(lat, lng);
            if (neighborhoodInput) neighborhoodInput.value = address;
            if (mapInfoDiv) mapInfoDiv.innerHTML = `<p>${address}</p>`;
        }
        
function handleEditClick(e) {
    const sectionId = e.currentTarget.dataset.section;
    const sectionEl = document.getElementById(`section-${sectionId}`);
    if (sectionId === 'documents') {
        showModal('ویرایش مدارک در این بخش پشتیبانی نمی‌شود. لطفاً برای تغییر مدارک با پشتیبانی تماس بگیرید.', 'info');
        return;
    }

    const formEl = sectionEl.querySelector('form');
    if (sectionId === 'professional' && userData.role === 'engineer') {
        formEl.innerHTML = getProfessionalFieldsHTMLEditable(userData.stepsData.step3, false) + formEl.querySelector('.section-actions').outerHTML;
    }

    formEl.querySelectorAll('input, select, textarea').forEach(el => {
        el.disabled = false;
        
        // این بخش مربوط به تقویم است که اصلاح شده
        if (el.classList.contains('jalali-datepicker-display')) {
            $(el).persianDatepicker({
                // 1. به تقویم می‌گوییم که تاریخ را با خط تیره بخواند و ذخیره کند
                format: 'YYYY-MM-DD', 
                altFormat: 'YYYY-MM-DD',

                // 2. این گزینه مشکل یک روز اختلاف در تقویم را حل می‌کند
                locale: 'fa',

                altField: $(el).next('.jalali-datepicker-value'),
                observer: true,
                autoClose: true
            });
        }
    });

    if (sectionId === 'professional') {
        attachProfessionalFieldsListeners(formEl);
        updateProfessionalInfoVisibility(formEl);
    }

    sectionEl.querySelector('.section-actions').classList.remove('hidden');
    e.currentTarget.classList.add('hidden');
    sectionEl.querySelector('button[data-action="cancel"]').addEventListener('click', handleCancelClick);
    sectionEl.querySelector('button[data-action="save"]').addEventListener('click', handleSaveClick);
}
        
        function handleCancelClick(e) { renderProfile(); }
        
        async function handleSaveClick(e) {
            const sectionId = e.currentTarget.dataset.section;
            const form = document.getElementById(`form-${sectionId}`);
            const dataToSave = Object.fromEntries(new FormData(form).entries());
            
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                dataToSave[cb.name] = cb.checked;
            });

            await updateProfileSection(sectionId, dataToSave);
        }

        function attachProfessionalFieldsListeners(formEl) {
            formEl.querySelectorAll('input[name*="has"], input[name*="ExecutorType"], input[name="engineerHasOfficeInfo"]').forEach(el => {
                el.addEventListener('change', () => updateProfessionalInfoVisibility(formEl));
            });
        }

        function updateProfessionalInfoVisibility(formEl) {
            const getVal = (name) => formEl.querySelector(`input[name="${name}"]:checked`)?.value;
            const isChecked = (name) => formEl.querySelector(`input[name="${name}"]`)?.checked;

            const designType = getVal('designExecutorType');
            const supervisionType = getVal('supervisionExecutorType');
            const executionType = getVal('executionExecutorType');
            
            const isAnyLegal = designType === 'legal' || supervisionType === 'legal' || executionType === 'legal';
            const isAnyIndividual = designType === 'individual' || supervisionType === 'individual' || executionType === 'individual';
            const isExecutionIndividual = executionType === 'individual';

            formEl.querySelector('#legalExecutorFields').style.display = isAnyLegal ? 'block' : 'none';
            formEl.querySelector('#individualExecutorFieldsContainer').style.display = isAnyIndividual ? 'block' : 'none';
            formEl.querySelector('#individualExecutorFields').style.display = isExecutionIndividual ? 'block' : 'none';
            formEl.querySelector('#engineerOfficeInfoFields').style.display = isChecked('engineerHasOfficeInfo') ? 'block' : 'none';
            
            formEl.querySelector('select[name="designLicenseGrade"]').disabled = !isChecked('hasDesignLicense');
            formEl.querySelector('select[name="supervisionLicenseGrade"]').disabled = !isChecked('hasSupervisionLicense');
            formEl.querySelector('select[name="executionLicenseGrade"]').disabled = !isChecked('hasExecutionLicense');
        }
        
        function initializeCropper() {
            profileImageInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        document.getElementById('imageToCrop').src = reader.result;
                        document.getElementById('cropperModal').style.display = 'flex';
                        if (cropper) cropper.destroy();
                        cropper = new Cropper(document.getElementById('imageToCrop'), {
                            aspectRatio: 1, viewMode: 1, background: false, responsive: true,
                            modal: true, guides: true, center: true, highlight: false,
                            cropBoxMovable: true, cropBoxResizable: true,
                        });
                    };
                    reader.readAsDataURL(files[0]);
                }
            });

            document.getElementById('cancelCropButton').addEventListener('click', () => {
                document.getElementById('cropperModal').style.display = 'none';
                if (cropper) cropper.destroy();
                profileImageInput.value = '';
            });

            document.getElementById('cropAndSaveButton').addEventListener('click', () => {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' });
                    canvas.toBlob(async (blob) => {
                        document.getElementById('cropperModal').style.display = 'none';
                        cropper.destroy();
                        await uploadCroppedImage(blob);
                    }, 'image/png');
                }
            });
        }
        
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function uploadCroppedImage(blob) {
            welcomeLoader.style.opacity = '1';
            welcomeLoader.style.display = 'flex';
            try {
                const base64Data = await blobToBase64(blob);
                const payload = {
                    action: 'updateProfilePicture',
                    email: userData.email,
                    fileData: {
                        fileName: 'profile_image.png',
                        mimeType: blob.type,
                        base64Data: base64Data
                    }
                };

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success' && result.newUrl) {
                    showModal('عکس پروفایل با موفقیت به‌روز شد.', 'success');
                    const newImageUrl = getDirectDriveLink(result.newUrl);
                    sidebarProfileImage.src = newImageUrl;
                    userData.files.applicantImage.fileUrl = result.newUrl;
                } else {
                    throw new Error(result.message || "Failed to upload image.");
                }
            } catch (error) {
                console.error("Error uploading cropped image:", error);
                showModal(`خطا در آپلود عکس: ${error.message}`, 'error');
            } finally {
                welcomeLoader.style.opacity = '0';
                setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
            }
        }

        function setupViewSwitcher() {
            const navItems = document.querySelectorAll('.nav-item[data-view]');
            const viewInfo = {
                dashboard: 'از این بخش می‌توانید آمار کلی و خلاصه‌ای از فعالیت‌های خود را مشاهده کنید.',
                profile: 'اطلاعات کاربری خود را در این بخش مشاهده و ویرایش کنید. کامل بودن پروفایل به اعتبار شما می‌افزاید.',
                notifications: 'اطلاعیه‌ها، درخواست‌های همکاری و پیام‌های سیستمی در این قسمت نمایش داده می‌شوند.',
                projects: userData.role === 'employer' ? 'پروژه‌هایی که ثبت کرده‌اید را مدیریت کنید، وضعیت آن‌ها را تغییر دهید یا ویرایش کنید.' : 'لیست پروژه‌های باز کارفرمایان در اینجا نمایش داده می‌شود. می‌توانید برای همکاری درخواست ارسال کنید.',
                'my-activities': 'فعالیت‌های ثبت شده شما برای نمایش به کارفرمایان در این بخش مدیریت می‌شوند.',
                engineers: 'لیست مهندسان فعال را مشاهده کرده و برای پروژه‌های خود درخواست همکاری ارسال نمایید.',
                settings: 'تنظیمات حساب کاربری خود، مانند تغییر رمز عبور را از این بخش انجام دهید.',
                'create-project': 'یک پروژه جدید با تمام جزئیات ثبت کنید تا مهندسان متخصص برای آن درخواست همکاری ارسال کنند.',
                'create-activity': 'با ثبت یک فعالیت جدید، آمادگی خود را برای دریافت پروژه‌های جدید به کارفرمایان اعلام کنید.'
            };

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    currentView = e.currentTarget.dataset.view;
                    
                    allContentBodies.forEach(el => el.style.display = 'none');
                    navItems.forEach(nav => nav.classList.remove('active'));

                    const contentEl = document.getElementById(`${currentView.replace(/-/g, '')}Content`);
                    if (contentEl) contentEl.style.display = 'block';
                    mainHeaderTitle.textContent = e.currentTarget.querySelector('span').textContent;
                    infoBoxText.textContent = viewInfo[currentView] || 'اطلاعات این بخش در اینجا نمایش داده می‌شود.';
                    
                    switch(currentView) {
                        case 'dashboard': (userData.role === 'employer' ? renderEmployerDashboard : renderEngineerDashboard)(); break;
                        case 'profile': renderProfile(); break;
                        case 'notifications': renderNotifications(); break;
                        case 'projects': (userData.role === 'employer' ? renderEmployerProjects : renderProjectMarketplace)(); break;
                        case 'my-activities': renderMyActivities(); break;
                        case 'engineers': renderEngineersPanel(); break;
                        case 'create-project': renderProjectForm(); break;
                        case 'create-activity': renderActivityForm(); break;
                    }
                    e.currentTarget.classList.add('active');
                });
            });
        }

        async function refreshCurrentView() {
            const activeNavItem = document.querySelector('.nav-item.active');
            if (activeNavItem) {
                const view = activeNavItem.dataset.view;
                // Add a spinner or loading indicator to the content area
                const contentEl = document.getElementById(`${view.replace(/-/g, '')}Content`);
                if (contentEl) contentEl.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
                
                // Re-fetch data if necessary and re-render
                if (view === 'dashboard' || view === 'profile') {
                     const updatedData = await fetchUserProfile(userData.email);
                     if (updatedData) userData = { ...updatedData, email: userData.email };
                }
                
                activeNavItem.click();
            }
        }
        
        async function handleChangePassword(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const btnText = btn.querySelector('span');
            const spinner = btn.querySelector('.spinner');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) return showModal('لطفاً تمام فیلدها را پر کنید.', 'error');
            if (newPassword !== confirmNewPassword) return showModal('رمز عبور جدید و تکرار آن یکسان نیستند.', 'error');
            if (newPassword.length < 6) return showModal('رمز عبور جدید باید حداقل ۶ کاراکتر باشد.', 'error');

            btn.disabled = true; btnText.classList.add('hidden'); spinner.classList.remove('hidden');
            try {
                const payload = { action: 'changePassword', email: userData.email, currentPassword, newPassword };
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`خطای سرور: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    changePasswordForm.reset();
                } else { throw new Error(result.message || 'خطای ناشناخته.'); }
            } catch (error) {
                showModal(error.message, 'error');
            } finally {
                btn.disabled = false; btnText.classList.remove('hidden'); spinner.classList.add('hidden');
            }
        }

        function setupPasswordToggle() {
            document.querySelectorAll('.password-toggle-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const targetId = icon.dataset.target;
                    const passwordInput = document.getElementById(targetId);
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });
        }
        
        // --- All other functions from the original file are included below ---
        // --- They are not dummy functions anymore ---

function renderProjectForm(projectData = null) {
    const createProjectContent = document.getElementById('createProjectContent');
    const isEditMode = projectData !== null;
    // ساختار جدید HTML با چیدمان درخواستی شما
    createProjectContent.innerHTML = `
        <div id="projectEditCard" class="project-card bg-white rounded-lg overflow-hidden">
            <form id="projectForm">
                ${isEditMode ? `<input type="hidden" id="ProjectID" name="ProjectID" value="${projectData.ProjectID}">` : ''}
                <div class="p-6 space-y-6">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div><label for="projectName" class="block text-gray-700 font-medium mb-1 required-field">نام پروژه</label><input type="text" id="projectName" name="projectName" required value="${projectData?.projectName || ''}"></div>
                        <div><label for="ownerName" class="block text-gray-700 font-medium mb-1 required-field">نام کامل مالک</label><input type="text" id="ownerName" name="ownerName" required value="${projectData?.ownerName || ''}"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5">
                        <div><label for="province" class="block text-gray-700 font-medium mb-1 required-field">استان</label><select id="province" name="province" required>${generateProvinceOptions(projectData?.province || '')}</select></div>
                        <div><label for="city" class="block text-gray-700 font-medium mb-1 required-field">شهر</label><input type="text" id="city" name="city" required value="${projectData?.city || ''}"></div>
                        <div><label for="district" class="block text-gray-700 font-medium mb-1 required-field">منطقه شهرداری</label><input type="number" id="district" name="district" min="1" required value="${projectData?.district || ''}"></div>
                        <div><label for="usageType" class="block text-gray-700 font-medium mb-1 required-field">کاربری ملک</label><select id="usageType" name="usageType" required><option value="مسکونی">مسکونی</option><option value="تجاری">تجاری</option><option value="اداری">اداری</option><option value="صنعتی">صنعتی</option><option value="کشاورزی">کشاورزی</option></select></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5">
                        <div><label for="area" class="block text-gray-700 font-medium mb-1 required-field">متراژ (مترمربع)</label><input type="number" id="area" name="area" min="1" required value="${projectData?.area || ''}"></div>
                        <div><label for="floors" class="block text-gray-700 font-medium mb-1 required-field">تعداد طبقات</label><input type="number" id="floors" name="floors" min="1" required value="${projectData?.floors || ''}"></div>
                        <div><label for="basementFloors" class="block text-gray-700 font-medium mb-1 required-field">طبقات زیرزمین</label><input type="number" id="basementFloors" name="basementFloors" min="0" required value="${projectData?.basementFloors || '0'}"></div>
                        <div><label for="structureType" class="block text-gray-700 font-medium mb-1 required-field">نوع سازه</label><select id="structureType" name="structureType" required><option value="فلزی">فلزی</option><option value="بتنی">بتنی</option></select></div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-1 required-field">آدرس ملک</label>
                        <div class="flex items-center mb-2 text-sm text-gray-500">
                            <span>طول جغرافیایی: </span><span id="longitudeValue" class="mr-2 font-mono">...</span>
                            <span class="mr-4">عرض جغرافیایی: </span><span id="latitudeValue" class="mr-2 font-mono">...</span>
                        </div>
                        <div id="project-map" class="h-64 w-full z-10 rounded-lg border"></div>
                        <textarea id="address" name="address" rows="1" class="w-full mt-2" required placeholder="آدرس متنی در اینجا نمایش داده می‌شود...">${projectData?.address || ''}</textarea>
                        <input type="hidden" id="latitude" name="latitude" value="${projectData?.latitude || ''}">
                        <input type="hidden" id="longitude" name="longitude" value="${projectData?.longitude || ''}">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5">
                        <div><label for="fileType" class="block text-gray-700 font-medium mb-1 required-field">نوع پرونده</label><select id="fileType" name="fileType" required><option value="عادی">عادی</option><option value="فرسوده">فرسوده</option></select></div>
                        <div><label for="permitNumber" class="block text-gray-700 font-medium mb-1 required-field">شماره پروانه</label><input type="text" id="permitNumber" name="permitNumber" required value="${projectData?.permitNumber || ''}"></div>
                        <div><label for="permitValidity" class="block text-gray-700 font-medium mb-1 required-field">اعتبار پروانه (ماه)</label><input type="number" id="permitValidity" name="permitValidity" min="1" required value="${projectData?.permitValidity || ''}"></div>
                        <div><label for="contractMonths" class="block text-gray-700 font-medium mb-1 required-field">مدت قرارداد (ماه)</label><input type="number" id="contractMonths" name="contractMonths" min="1" required value="${projectData?.contractMonths || ''}"></div>
                    </div>

                    <div class="space-y-2">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">مشخصات مهندس مورد نیاز پروژه</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-5 pt-2">
                            <div><label for="engineerRank" class="block text-gray-700 font-medium mb-1 required-field">پایه مهندس</label><select id="engineerRank" name="engineerRank" required><option value="پایه 3">پایه 3</option><option value="پایه 2">پایه 2</option><option value="پایه 1">پایه 1</option><option value="پایه ارشد">پایه ارشد</option></select></div>
                            <div><label for="engineerField" class="block text-gray-700 font-medium mb-1 required-field">رشته مهندس</label><select id="engineerField" name="engineerField" required><option value="معماری">معماری</option><option value="عمران">عمران</option><option value="مکانیک">مکانیک</option><option value="برق">برق</option><option value="شهرسازی">شهرسازی</option><option value="ترافیک">ترافیک</option><option value="نقشه برداری">نقشه برداری</option></select></div>
                            <div><label for="engineerActivity" class="block text-gray-700 font-medium mb-1 required-field">نوع فعالیت مهندس</label><select id="engineerActivity" name="engineerActivity" required><option value="طراح">طراح</option><option value="ناظر">ناظر</option><option value="مجری">مجری</option></select></div>
                            <div><label for="permitType" class="block text-gray-700 font-medium mb-1 required-field">نوع پروانه مهندس</label><select id="permitType" name="permitType" required><option value="طراح حقوقی">طراح حقوقی</option><option value="ناظر حقوقی">ناظر حقوقی</option><option value="انبوه ساز">انبوه ساز</option><option value="مجری حقوقی">مجری حقوقی</option><option value="مهندس حقیقی">مهندس حقیقی</option><option value="کاردان">کاردان</option><option value="معمارتجربی">معمارتجربی</option></select></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 id="tariff-title" class="text-lg font-semibold text-gray-800 border-b pb-2">تعرفه پیشنهادی</h3>
                        <input type="hidden" id="unitPrice" name="unitPrice" value="${projectData?.unitPrice || '107000'}">
                        <div id="price-buttons-container" class="grid grid-cols-4 gap-3">
                            <button type="button" class="price-btn" data-price="107000">ساختمان ۱ تا ۲ طبقه<br><span class="font-bold">۱۰۷,۰۰۰ تومان</span></button>
                            <button type="button" class="price-btn" data-price="125000">ساختمان ۳ تا ۵ طبقه<br><span class="font-bold">۱۲۵,۰۰۰ تومان</span></button>
                            <button type="button" class="price-btn" data-price="127800">ساختمان ۶ تا ۷ طبقه<br><span class="font-bold">۱۲۷,۸۰۰ تومان</span></button>
                            <button type="button" class="price-btn" data-price="139500">ساختمان ۸ تا ۱۰ طبقه<br><span class="font-bold">۱۳۹,۵۰۰ تومان</span></button>
                            <button type="button" class="price-btn" data-price="142800">ساختمان ۱۱ تا ۱۲ طبقه<br><span class="font-bold">۱۴۲,۸۰۰ تومان</span></button>
                            <button type="button" class="price-btn" data-price="148800">ساختمان ۱۳ تا ۱۵ طبقه<br><span class="font-bold">۱۴۸,۸۰۰ تومان</span></button>
                            <button type="button" class="price-btn" data-price="159200">ساختمان بالای ۱۶ طبقه<br><span class="font-bold">۱۵۹,۲۰۰ تومان</span></button>
                            <div class="price-btn custom-price-container" data-price="custom">
                                <span>قیمت دلخواه (تومان)</span>
                                <input type="number" id="customPriceInput" class="custom-price-input" placeholder="مبلغ را وارد کنید">
                            </div>
                        </div>
                        
                        <div class="price-highlight p-3 rounded-lg mt-4">
                            <div class="flex items-center"><i class="fas fa-tag text-green-500 ml-2"></i><span class="text-gray-700 font-medium">قیمت واحد:</span><span id="unitPricePreview" class="mr-2 font-semibold"></span>
                            </div>
                            <div class="flex items-center mt-2"><i class="fas fa-calculator text-green-500 ml-2"></i><span class="text-gray-700 font-medium">قیمت کل:</span><span id="totalPricePreview" class="mr-2 font-bold text-green-600"></span>
                            </div>
                        </div>
                    </div>
                    <div><label for="description" class="block text-gray-700 font-medium mb-1">توضیحات</label><textarea id="description" name="description" rows="2" class="w-full">${projectData?.description || ''}</textarea>
                    </div>
                </div>
                <div class="border-t border-gray-200 mt-6 p-4 flex justify-end gap-4">
                    <button type="button" id="cancelProjectFormBtn" class="btn btn-secondary"><i class="fas fa-times mr-2"></i>انصراف</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-2"></i>${isEditMode ? 'ذخیره تغییرات' : 'ثبت پروژه'}</button>
                </div>
            </form>
        </div>
    `;
    //<div class="flex items-center mt-2"><i class="fas fa-hand-holding-usd text-blue-500 ml-2"></i><span class="text-gray-700 font-medium">کمیسیون (۱۵٪):</span><span id="commissionPreview" class="mr-2 font-bold" style="color: var(--primary-color)"></span></div>

    // این بخش کد برای حالت ویرایش است تا مقادیر قبلی را در فیلدها قرار دهد
    if (isEditMode) {
        ['usageType', 'structureType', 'fileType', 'engineerRank', 'engineerField', 'engineerActivity', 'permitType'].forEach(id => {
            const select = document.getElementById(id);
            if (select && projectData[id]) select.value = projectData[id];
        });
    }

    attachProjectFormListeners();
}

        function getProjectCardHTML(project, role, isApplied = false) {
            const formatNumber = (num) => num ? parseFloat(num).toLocaleString('fa-IR') : '0';
            const totalPrice = (parseFloat(project.area) || 0) * (parseFloat(project.unitPrice) || 0);
            const contractMonths = parseInt(project.contractMonths) || 1;
            const commission = Math.floor(((totalPrice * 0.05 * contractMonths) / 12) / 10000) * 10000;

            let starsHtml = '';
            const starsCount = { 'پایه 3': 1, 'پایه 2': 2, 'پایه 1': 3, 'پایه ارشد': 4 }[project.engineerRank] || 1;
            for (let i = 0; i < starsCount; i++) {
                starsHtml += '<i class="fas fa-star text-yellow-400"></i>';
            }
            
            let footerHtml = '';
            if (role === 'engineer') {
                if (isApplied) {
                    footerHtml = `<button data-action="cancel-application" data-project-id="${project.ProjectID}" class="btn btn-danger w-full"><i class="fas fa-times-circle mr-2"></i>لغو درخواست همکاری</button>`;
                } else {
                    footerHtml = `<button data-action="apply" data-project-id="${project.ProjectID}" class="btn btn-success w-full"><i class="fas fa-paper-plane mr-2"></i>درخواست همکاری</button>`;
                }
            } else if (role === 'employer') {
                const isProjectOpen = project.Status === 'باز';
                const statusChangeText = isProjectOpen ? 'بستن پروژه' : 'باز کردن پروژه';
                const statusChangeAction = isProjectOpen ? 'close-project' : 'open-project';
                const statusChangeBtnClass = isProjectOpen ? 'btn-danger' : 'btn-success';
                const statusChangeIcon = isProjectOpen ? 'fa-lock' : 'fa-lock-open';
                
                footerHtml = `
                    <div class="flex gap-2 w-full">
                         <button data-action="${statusChangeAction}" data-project-id="${project.ProjectID}" class="btn ${statusChangeBtnClass} flex-1"><i class="fas ${statusChangeIcon} mr-2"></i>${statusChangeText}</button>
                         <button data-action="edit-project" data-project-id="${project.ProjectID}" class="btn btn-secondary flex-1"><i class="fas fa-edit mr-2"></i>ویرایش پروژه</button>
                    </div>
                `;
            }

            return `
            <div class="project-card bg-white rounded-lg overflow-hidden">
                <div class="bg-white p-3 border-b">
                      
                    <p class="text-sm text-slate-500">${formatTimeAgo(project.lastModifiedDate)}</p>
                </div>
                <div class="bg-green-50 grid grid-cols-3 items-center justify-between justify-items-auto p-3">
                    <div class="flex items-center"><i class="fa fa-home fas ml-2 text-green-500"></i><span class="font-semibold text-gray-900">سازه ${project.structureType} ${project.usageType}</span></div>
                    <div class="text-center">
                        <div class="flex items-center justify-center mt-1 pb-2">${starsHtml}</div>
                        <div class="flex justify-center mb-1"><div class="font-bold text-gray-900 text-xl">${project.engineerActivity} ${project.engineerRank} ${project.engineerField}</div></div>
                    </div>
                    <div class="frosode-badge-container"><span class="frosode-badge px-3 py-1 rounded-full text-sm font-medium ${project.fileType === 'فرسوده' ? '' : 'hidden'}">فرسوده</span></div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between mb-4 mt-2"><div class="text-gray-900 font-semibold"><i class="fa-ruler-combined fas mx-2 text-gray-400"></i>${formatNumber(project.area)} مترمربع</div><div class="text-gray-900 font-semibold">${project.floors} طبقه + ${project.basementFloors} طبقه زیرزمین<i class="fa-building fas mx-2 text-gray-400"></i></div></div>
                    <div class="flex justify-between mb-4"><div class="text-gray-900 font-semibold"><i class="fa-map-marker-alt fas mx-2 text-gray-400"></i>منطقه ${project.district} ${project.city}</div><div class="text-gray-900 font-semibold">مدت قرارداد: ${project.contractMonths} ماه<i class="fa-calendar-alt far mx-2 text-gray-400"></i></div></div>
                    <div class="bg-gray-50 commission-highlight p-3 rounded-2xl">
                        <div class="grid ${role === 'engineer' ? 'grid-rows-3' : 'grid-rows-2'} items-center">
                            <div class="flex items-center pb-1 pt-0 px-3"><i class="fa-tag fas ml-2 self-center text-gray-400"></i><span class="font-medium text-gray-500">قیمت واحد:</span><div class="flex-auto font-semibold text-base text-gray-500 text-left">${formatNumber(project.unitPrice)} تومان</div></div>
                            <div class="bg-green-300 mb-0 price-highlight px-5 py-3 rounded-lg"><div class="flex items-center"><i class="fa-hand-holding-usd fas ml-2 text-green-700"></i><span class="font-medium text-green-800">قیمت کل پیشنهادی:</span><div class="flex-auto font-bold mt-1 text-green-800 text-left text-xl">${formatNumber(totalPrice)} تومان</div></div></div>

                            ${role === 'engineer' ? `
                            <div class="flex items-center pb-0 pt-1 px-3">
                                <i class="fa fa-percent fas ml-2 text-gray-400"></i><span class="font-medium text-gray-500">کمیسیون:</span><div class="flex-auto font-bold mt-1 text-left text-lg" style="color: var(--primary-color)">${formatNumber(commission)} تومان</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="flex justify-between p-4 bg-gray-50 border-t">
                    ${footerHtml}
                </div>
            </div>
            `;
        }
        // <h4 class="font-bold text-lg text-slate-800">${project.projectName || 'بدون نام'}</h4>
        
        function attachProjectFormListeners() {
            document.getElementById('projectForm').addEventListener('submit', submitProjectData);
            
            const cancelBtn = document.getElementById('cancelProjectFormBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    document.querySelector('.nav-item[data-view="dashboard"]').click();
                });
            }

            initializeProjectMap();

            const priceButtons = document.querySelectorAll('.price-btn');
            const unitPriceInput = document.getElementById('unitPrice');
            const customPriceInput = document.getElementById('customPriceInput');

            priceButtons.forEach(button => {
                button.addEventListener('click', () => {
                    priceButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    const priceType = button.dataset.price;
                    if (priceType === 'custom') {
                        unitPriceInput.value = customPriceInput.value || '0';
                        customPriceInput.focus();
                    } else {
                        unitPriceInput.value = priceType;
                    }
                    updatePriceCalculations();
                });
            });

            customPriceInput.addEventListener('input', () => {
                if (document.querySelector('.custom-price-container.active')) {
                    unitPriceInput.value = customPriceInput.value || '0';
                    updatePriceCalculations();
                }
            });
            
            const areaInput = document.getElementById('area');
            const contractMonthsInput = document.getElementById('contractMonths');

            // هر بار که کاربر عددی در این فیلد تایپ می‌کند، قیمت‌ها دوباره محاسبه می‌شوند
            if (areaInput) {
                areaInput.addEventListener('input', updatePriceCalculations);
            }

            // افزودن شنونده به فیلد مدت قرارداد
            if (contractMonthsInput) {
                contractMonthsInput.addEventListener('input', updatePriceCalculations);
            }

            // فعال کردن دکمه پیش‌فرض در هنگام بارگذاری فرم
            const initialPrice = unitPriceInput.value;
            let activeButton = document.querySelector(`.price-btn[data-price="${initialPrice}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            } else if (initialPrice && initialPrice !== '0') {
                activeButton = document.querySelector('.custom-price-container');
                if (activeButton) {
                    activeButton.classList.add('active');
                    customPriceInput.value = initialPrice;
                }
            } else {
                const firstButton = document.querySelector('.price-btn');
                if(firstButton) firstButton.classList.add('active');
            }
            updatePriceCalculations(); // محاسبه قیمت اولیه
        }

        async function getAddressFromLatLng(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=fa`);
                if (!response.ok) throw new Error(`Nominatim request failed: ${response.status}`);
                const data = await response.json();
                return data.display_name || 'محله یافت نشد';
            } catch (error) {
                console.error("Error fetching address: ", error);
                return 'خطا در دریافت نام محله';
            }
        }

        async function updateMapLocation(lat, lng) {
            document.getElementById('latitudeValue').textContent = lat.toFixed(4);
            document.getElementById('longitudeValue').textContent = lng.toFixed(4);
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            const addressField = document.getElementById('address');
            addressField.value = "در حال دریافت آدرس...";
            const address = await getAddressFromLatLng(lat, lng);
            addressField.value = address;
        }

        function initializeProjectMap() {
            if (projectMap) projectMap.remove();
            setTimeout(() => {
            const lat = parseFloat(document.getElementById('latitude').value) || 38.0766;
            const lng = parseFloat(document.getElementById('longitude').value) || 46.2970;
            const initialCoords = [lat, lng];
            projectMap = L.map('project-map').setView(initialCoords, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(projectMap);
            projectMarker = L.marker(initialCoords, { draggable: true }).addTo(projectMap);
            
            if (!document.getElementById('latitude').value) {
                 updateMapLocation(initialCoords[0], initialCoords[1]);
            } else {
                document.getElementById('latitudeValue').textContent = lat.toFixed(4);
                document.getElementById('longitudeValue').textContent = lng.toFixed(4);
            }

            projectMarker.on('dragend', (e) => updateMapLocation(e.target.getLatLng().lat, e.target.getLatLng().lng));
            projectMap.on('click', (e) => {
                projectMarker.setLatLng(e.latlng);
                updateMapLocation(e.latlng.lat, e.latlng.lng);
            });
                projectMap.invalidateSize();
        }, 1);
        }

        function updatePriceCalculations() {
            const unitPriceInput = document.getElementById('unitPrice');
            const customPriceInput = document.getElementById('customPriceInput');

            // اگر دکمه قیمت دلخواه فعال است، مطمئن شویم که مقدار از فیلد متنی خوانده می‌شود
            if (document.querySelector('.custom-price-container.active')) {
                unitPriceInput.value = customPriceInput.value || '0';
            }

            if (!unitPriceInput) return;
            
            let price = parseFloat(unitPriceInput.value) || 0;

            const area = parseFloat(document.getElementById('area').value) || 0;
            const floors = parseInt(document.getElementById('floors').value) || 0;
            const basementFloors = parseInt(document.getElementById('basementFloors').value) || 0;
            const totalFloors = floors + basementFloors;
            const contractMonths = parseInt(document.getElementById('contractMonths').value) || 1;

            const totalPrice = area * price;
            const commission = Math.floor(((totalPrice * 0.05 * contractMonths) / 12) / 10000) * 10000;
            const toPersianNum = (num) => num.toLocaleString('fa-IR');
            
            document.getElementById('tariff-title').textContent = `تعرفه پیشنهادی برای ساختمان ${toPersianNum(totalFloors)} طبقه`;
            document.getElementById('unitPricePreview').textContent = `${toPersianNum(price)} تومان بر مترمربع`;
            document.getElementById('totalPricePreview').textContent = `${toPersianNum(totalPrice)} تومان`;
            document.getElementById('commissionPreview').textContent = `${toPersianNum(commission)} تومان`;
        }
        
        async function submitProjectData(e) {
            e.preventDefault();
            const form = document.getElementById('projectForm');
            if (!form.checkValidity()) {
                showModal('لطفاً تمام فیلدهای الزامی (*) را پر کنید.', 'error');
                form.reportValidity();
                return;
            }
            const projectData = Object.fromEntries(new FormData(form).entries());
            const priceRadio = form.querySelector('input[name="priceOption"]:checked');
            projectData.unitPrice = priceRadio.id === 'priceOptionCustom' ? projectData.customPrice : priceRadio.value;

            const isUpdate = !!projectData.ProjectID;
            const action = isUpdate ? 'updateProject' : 'createProject';
            const payload = { action, employerEmail: userData.email, projectData };

            welcomeLoader.style.opacity = '1';
            welcomeLoader.style.display = 'flex';
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`خطای سرور: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    document.querySelector('.nav-item[data-view="dashboard"]').click();
                } else {
                    throw new Error(result.message || 'خطای ناشناخته.');
                }
            } catch (error) {
                showModal(`خطا در ثبت/ویرایش پروژه: ${error.message}`, 'error');
            } finally {
                welcomeLoader.style.opacity = '0';
                setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
            }
        }

        // --- Activity Logic ---
        
        function renderActivityForm(activityToEdit = null) {
            const formHtml = `<div id="activityFormContainer" class="neumorphic-card flex flex-col"></div>`;
            createActivityContent.innerHTML = formHtml;
            renderActivityEdit(activityToEdit || {});
        }

        function renderActivityEdit(data = {}) {
            const isEditMode = !!data.ActivityID;
            const container = document.getElementById('activityFormContainer');
            if (!container) return;
            
            let prices = {};
            if (data.prices) {
                try {
                    const parsedPrices = JSON.parse(data.prices);
                    if (Array.isArray(parsedPrices)) {
                        parsedPrices.forEach(p => { prices[p.label] = p.price; });
                    }
                } catch(e) { console.error("Could not parse prices:", data.prices); }
            }

            const priceOptions = [
                { label: 'ساختمان 1 تا 2 طبقه', default: '107,000' }, { label: 'ساختمان 3 تا 5 طبقه', default: '125,000' },
                { label: 'ساختمان 6 تا 7 طبقه', default: '127,800' }, { label: 'ساختمان 8 تا 10 طبقه', default: '139,500' },
                { label: 'ساختمان 11 تا 12 طبقه', default: '142,800' }, { label: 'ساختمان 13 تا 15 طبقه', default: '148,800' },
                { label: 'ساختمان بالای 16 طبقه', default: '159,200' },
            ];
            
            const priceRowsHtml = priceOptions.map(opt => `
                <div class="price-row grid grid-cols-2 gap-4 items-center">
                    <label class="flex items-center text-base">
                        <input type="checkbox" class="ml-4" ${isEditMode ? (prices[opt.label] ? 'checked' : '') : 'checked'}> 
                        <span>${opt.label}</span>
                    </label>
                    <input type="text" class="p-2 border border-gray-300 rounded-md text-base" value="${prices[opt.label] || opt.default}">
                </div>
            `).join('');

            const editHtml = `
                <div id="editMode" class="flex flex-col gap-4"> 
                    ${isEditMode ? `<input type="hidden" id="activityId" value="${data.ActivityID}">` : ''}
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="block text-gray-700 font-medium mb-1">استان</label><select id="province" class="w-full">${generateProvinceOptions(data.province || '')}</select></div>
                        <div><label class="block text-gray-700 font-medium mb-1">شهر</label><input type="text" id="city" class="w-full" value="${data.city || ''}"></div>
                        <div><label class="block text-gray-700 font-medium mb-1">نوع پروانه</label><select id="licenseType" class="w-full"><option>انبوه ساز</option><option>سازنده حقوقی</option><option>مهندس حقیقی</option><option>کاردان</option><option>معمارتجربی</option></select></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="block text-gray-700 font-medium mb-1">نوع فعالیت مهندس</label><select id="engineerActivity" class="w-full"><option>طراح</option><option>ناظر</option><option>مجری</option></select></div>
                        <div><label class="block text-gray-700 font-medium mb-1">پایه پروانه</label><select id="engineerLevel" class="w-full"><option>پایه 3</option><option>پایه 2</option><option>پایه 1</option><option>پایه ارشد</option></select></div>
                        <div><label class="block text-gray-700 font-medium mb-1">رشته مهندس</label><select id="engineerField" class="w-full"><option>معماری</option><option>عمران</option><option>مکانیک</option><option>برق</option><option>شهرسازی</option><option>ترافیک</option><option>نقشه برداری</option></select></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <div><label class="block text-gray-700 font-medium mb-1">حداکثر متراژ</label><input type="number" id="maxArea" class="w-full" value="${data.maxArea || '5000'}"></div>
                        <div><label class="block text-gray-700 font-medium mb-1">متراژ اشغال‌شده</label><input type="number" id="occupiedArea" class="w-full" value="${data.occupiedArea || '1250'}"></div>
                        <div><label class="block text-gray-700 font-medium mb-1">کارهای جاری</label><input type="number" id="currentProjects" class="w-full" value="${data.currentProjects || '2'}"></div>
                        <div><label class="block text-gray-700 font-medium mb-1">حداکثر کار</label><input type="number" id="maxProjects" class="w-full" value="${data.maxProjects || '4'}"></div>
                    </div>
                    <div class="mb-4"> 
                        <label class="block text-gray-700 font-medium mb-2 text-base text-center">قیمت پیشنهادی (هر متر مربع)</label>
                        <p class="text-xs text-center text-slate-500 mb-4">فقط ردیف ساختمانی که قصد همکاری دارید را انتخاب کنید و قیمت دلخواه برای همکاری را در مقابل آن وارد نمایید.</p>
                        <div id="priceRowsEdit" class="space-y-3">${priceRowsHtml}</div>
                    </div>
                    <div class="flex items-center mb-4"><input type="checkbox" id="needsHelpCheckbox" class="ml-2" ${data.needsHelp ? 'checked' : ''}><label for="needsHelpCheckbox" class="text-gray-700 text-base">نیازمند کمک مجری</label></div>
                    <div class="flex justify-end space-x-4"><button type="button" id="cancelActivityBtn" class="neumorphic-button">انصراف</button><button type="button" id="previewActivityBtn" class="neumorphic-button bg-blue-500 text-white">پیش‌نمایش و ثبت</button></div>
                </div>
            `;
            container.innerHTML = editHtml;

            if (isEditMode) {
                document.getElementById('licenseType').value = data.licenseType || 'مهندس حقیقی';
                document.getElementById('engineerLevel').value = data.engineerLevel || 'پایه 3';
                document.getElementById('engineerActivity').value = data.engineerActivity || 'ناظر';
                document.getElementById('engineerField').value = data.engineerField || 'عمران';
            }

            document.getElementById('previewActivityBtn').addEventListener('click', handlePreviewActivity);
            document.getElementById('cancelActivityBtn').addEventListener('click', () => {
                const navItem = userData.role === 'engineer' ? 'my-activities' : 'dashboard';
                document.querySelector(`.nav-item[data-view="${navItem}"]`).click();
            });
        }

        function handlePreviewActivity() {
            const isEditMode = !!document.getElementById('activityId');
            currentActivityData = {
                province: document.getElementById('province').value, city: document.getElementById('city').value,
                licenseType: document.getElementById('licenseType').value, engineerLevel: document.getElementById('engineerLevel').value,
                engineerActivity: document.getElementById('engineerActivity').value, engineerField: document.getElementById('engineerField').value,
                needsHelp: document.getElementById('needsHelpCheckbox').checked, maxArea: document.getElementById('maxArea').value,
                occupiedArea: document.getElementById('occupiedArea').value, currentProjects: document.getElementById('currentProjects').value,
                maxProjects: document.getElementById('maxProjects').value,
            };

            const prices = [];
            const priceRows = document.getElementById('priceRowsEdit').children;
            for (let row of priceRows) {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    prices.push({ label: row.querySelector('span').textContent.trim(), price: row.querySelector('input[type="text"]').value });
                }
            }
            currentActivityData.prices = JSON.stringify(prices);
            
            if(isEditMode) currentActivityData.ActivityID = document.getElementById('activityId').value;
            
            renderActivityPreview(currentActivityData);
        }

        function renderActivityPreview(data) {
            const container = document.getElementById('activityFormContainer');
            if (!container) return;
            
            const isEditMode = !!data.ActivityID;
            const pricesArray = JSON.parse(data.prices || '[]');
            const remainingArea = (data.maxArea || 0) - (data.occupiedArea || 0);
            const areaPercentage = data.maxArea > 0 ? (remainingArea / data.maxArea) * 100 : 0;
            const remainingProjects = (data.maxProjects || 0) - (data.currentProjects || 0);
            const projectPercentage = data.maxProjects > 0 ? (remainingProjects / data.maxProjects) * 100 : 0;

            let priceHtml = pricesArray.map(p => `<div class="price-row grid grid-cols-2 gap-4 items-center"><span>${p.label}</span><span class="text-left">${p.price} تومان</span></div>`).join('');

            const levelMap = { 'پایه 3': 1, 'پایه 2': 2, 'پایه 1': 3, 'پایه ارشد': 4 };
            const starsCount = levelMap[data.engineerLevel] || 1;
            const starsHtml = '<i class="fas fa-star text-yellow-400"></i>'.repeat(starsCount);

            const previewHtml = `
                <div class="flex flex-col">
                    <div class="bg-green-50 flex items-center justify-between mb-4 -mt-5 -mx-5 p-5" style="border-radius: 20px 20px 0px 0px; display:grid; grid-template-columns:1fr auto 1fr;"> 
                        <div class="flex items-center justify-start pr-5 space-x-2"><i class="fas fa-check-circle text-green-500" title="کاربر تایید شده"></i><span class="mr-6 pr-4 text-base">${data.licenseType}</span></div>
                        <div class="flex flex-col items-center justify-center"><span class="font-bold px-0 text-gray-800 text-lg">${data.engineerActivity} ${data.engineerLevel} ${data.engineerField}</span><div class="flex text-yellow-400">${starsHtml}</div></div>
                        <div class="place-self-end self-center text-center"><p class="font-semibold text-slate-700 text-sm">آخرین بروزرسانی:</p><p class="text-xs text-slate-500">${formatTimeAgo(data.LastModifiedDate || new Date())}</p></div>
                    </div>
                    <div class="flex flex-col gap-4">
                        <div class="flex items-center justify-between gap-2 p-2 bg-slate-100 rounded-md">
                            <div class="flex items-center gap-2"><i class="fas fa-map-marker-alt text-green-600"></i><span class="font-semibold text-slate-700">${data.province || 'استان ثبت نشده'} - ${data.city || 'شهر ثبت نشده'}</span></div>
                            ${data.needsHelp ? '<span class="needs-help">نیازمند کمک مجری</span>' : ''}
                        </div>
                        <div class="mt-2"> 
                            <div class="flex gap-4 items-center justify-between"><label class="font-medium text-base text-gray-700">متراژ کار باقی‌مانده</label><span class="text-gray-600 text-base">${remainingArea.toLocaleString('fa-IR')} متر مربع</span></div>
                            <div class="progress-bar mt-2"><div class="bg-green-500 progress-fill" style="width: ${areaPercentage}%"></div></div>
                        </div>
                        <div> 
                            <div class="flex gap-4 items-center justify-between"><label class="font-medium text-base text-gray-700">تعداد کار باقی‌مانده</label><span class="text-gray-600 text-base">${remainingProjects} از ${data.maxProjects}</span></div>
                            <div class="progress-bar mt-2"><div class="bg-blue-500 progress-fill" style="width: ${projectPercentage}%"></div></div>
                        </div>
                        <div class="bg-green-100 mt-2 pb-4 pt-5 px-5" style="border-radius: 16px;"> 
                            <label class="block font-medium mb-4 mt-0 text-base text-center text-green-900">قیمت پیشنهادی (هر متر مربع)</label>                     
                            <div class="space-y-3">${priceHtml || '<p class="text-center text-slate-500">قیمتی ثبت نشده است.</p>'}</div>
                        </div>
                        <div class="flex justify-between space-x-6 mt-4"> 
                            <button id="editActivityBtn" class="neumorphic-button text-lg"><i class="fas fa-edit"></i> ویرایش</button>
                            <button id="submitActivityBtn" class="bg-green-500 font-bold ml-1 neumorphic-button text-lg text-white"><i class="fas fa-paper-plane"></i> ${isEditMode ? 'ذخیره تغییرات' : 'ارسال معرفی فعالیت'}</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = previewHtml;

            document.getElementById('editActivityBtn').addEventListener('click', () => renderActivityEdit(data));
            document.getElementById('submitActivityBtn').addEventListener('click', submitActivityData);
        }

        async function submitActivityData() {
            const button = document.getElementById('submitActivityBtn');
            button.disabled = true;
            button.innerHTML = '<div class="spinner !w-5 !h-5 !border-2"></div>';
            
            const isUpdate = !!currentActivityData.ActivityID;
            const action = isUpdate ? 'updateActivity' : 'createActivity';
            const payload = { action, engineerEmail: userData.email, activityData: currentActivityData, activityId: currentActivityData.ActivityID };
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`خطای سرور: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    currentActivityData = {};
                    document.querySelector('.nav-item[data-view="my-activities"]').click();
                } else { throw new Error(result.message || 'خطای ناشناخته.'); }
            } catch (error) {
                 showModal(`خطا در ثبت فعالیت: ${error.message}`, 'error');
                 button.disabled = false;
                 button.innerHTML = `<i class="fas fa-paper-plane mr-2"></i>${isUpdate ? 'ذخیره تغییرات' : 'ارسال معرفی فعالیت'}`;
            }
        }
        
        async function renderMyActivities() {
            myActivitiesContent.innerHTML = `<div id="my-activities-container"><div class="spinner mx-auto mt-10"></div></div>`;
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getActivitiesByEngineer&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (result.success && result.data) {
                    fetchedActivities = result.data.sort((a,b) => new Date(b.LastModifiedDate) - new Date(a.LastModifiedDate));
                    const container = document.getElementById('my-activities-container');
                    if (fetchedActivities.length > 0) {
                        container.innerHTML = fetchedActivities.map(act => getActivityCardHTML(act)).join('');
                    } else {
                        container.innerHTML = '<p class="text-center text-slate-500 col-span-full">شما هنوز فعالیتی ثبت نکرده‌اید.</p>';
                    }
                } else {
                     myActivitiesContent.innerHTML = `<p class="text-center text-red-500">${result.message || 'خطا در دریافت اطلاعات فعالیت‌ها.'}</p>`;
                }
            } catch (error) {
                myActivitiesContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری فعالیت‌ها: ${error.message}</p>`;
            }
        }
        
        function getActivityCardHTML(data, forEmployer = false) {
            const remainingArea = (data.maxArea || 0) - (data.occupiedArea || 0);
            const areaPercentage = data.maxArea > 0 ? (remainingArea / data.maxArea) * 100 : 0;
            const remainingProjects = (data.maxProjects || 0) - (data.currentProjects || 0);
            const projectPercentage = data.maxProjects > 0 ? (remainingProjects / data.maxProjects) * 100 : 0;
            const levelMap = { 'پایه 3': 1, 'پایه 2': 2, 'پایه 1': 3, 'پایه ارشد': 4 };
            const starsCount = levelMap[data.engineerLevel] || 1;
            const starsHtml = '<i class="fas fa-star text-yellow-400"></i>'.repeat(starsCount);
            const isActive = data.Status === 'فعال';

            let footerHtml = '';
            if (forEmployer) {
                const isRequested = requestedCooperationIds.has(data.ActivityID);
                footerHtml = `<button data-action="${isRequested ? 'cancel-cooperation' : 'request-cooperation'}" data-activity-id="${data.ActivityID}" class="btn ${isRequested ? 'btn-danger' : 'btn-success'} w-full"><i class="fas ${isRequested ? 'fa-times-circle' : 'fa-paper-plane'} mr-2"></i>${isRequested ? 'لغو درخواست همکاری' : 'درخواست همکاری'}</button>`;
            } else {
                footerHtml = `
                    <button data-action="change-activity-status" data-activity-id="${data.ActivityID}" data-new-status="${isActive ? 'غیرفعال' : 'فعال'}" class="btn ${isActive ? 'btn-danger' : 'btn-success'} !py-1 !px-3 text-sm"><i class="fas ${isActive ? 'fa-eye-slash' : 'fa-eye'}"></i><span>${isActive ? 'غیرفعال کن' : 'فعال کن'}</span></button>
                    <button data-action="edit-activity" data-activity-id="${data.ActivityID}" class="btn btn-secondary !py-1 !px-3 text-sm"><i class="fas fa-edit"></i><span>ویرایش</span></button>
                `;
            }

            return `
            <div class="activity-card bg-white rounded-lg overflow-hidden ${!isActive && !forEmployer ? 'opacity-60 bg-slate-50' : ''}">
                <div class="p-4 border-b">
                     <div class="flex justify-between items-start">
                         <div class="flex flex-col"><h4 class="font-bold text-lg text-slate-800">${data.engineerActivity} ${data.engineerLevel} ${data.engineerField}</h4><div class="flex mt-1">${starsHtml}</div></div>
                         ${!forEmployer ? `<span class="px-3 py-1 text-sm font-semibold rounded-full ${isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${data.Status}</span>` : `<p class="text-sm text-slate-500 text-left">آخرین ویرایش:<br>${formatTimeAgo(data.LastModifiedDate)}</p>`}
                     </div>
                </div>
                <div class="p-4 space-y-4">
                     <div class="flex items-center justify-between gap-2 p-2 bg-slate-100 rounded-md">
                        <div class="flex items-center gap-2"><i class="fas fa-map-marker-alt text-green-600"></i><span class="font-semibold text-slate-700">${data.province} - ${data.city}</span></div>
                        ${data.needsHelp ? '<span class="needs-help">نیازمند کمک مجری</span>' : ''}
                     </div>
                    <div> 
                        <div class="flex gap-4 items-center justify-between text-sm"><label class="font-medium text-gray-700">متراژ باقی‌مانده</label><span class="text-gray-600">${remainingArea.toLocaleString('fa-IR')} متر</span></div>
                        <div class="progress-bar mt-1"><div class="progress-fill bg-green-500" style="width: ${areaPercentage}%"></div></div>
                    </div>
                    <div> 
                        <div class="flex gap-4 items-center justify-between text-sm"><label class="font-medium text-gray-700">کار باقی‌مانده</label><span class="text-gray-600">${remainingProjects} از ${data.maxProjects}</span></div>
                        <div class="progress-bar mt-1"><div class="progress-fill bg-blue-500" style="width: ${projectPercentage}%"></div></div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 p-3 bg-gray-50 border-t">${footerHtml}</div>
            </div>`;
        }
        
        function handleEditActivity(activityId) {
            const activityToEdit = fetchedActivities.find(act => act.ActivityID === activityId);
            if (activityToEdit) {
                document.querySelectorAll('.nav-item[data-view]').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.content-body').forEach(el => el.style.display = 'none');
                
                const navItem = document.querySelector('.nav-item[data-view="create-activity"]');
                navItem.classList.add('active');
                
                createActivityContent.style.display = 'block';
                mainHeaderTitle.textContent = 'ثبت / ویرایش فعالیت';
                
                renderActivityForm(activityToEdit);
            }
        }
        
        async function handleChangeActivityStatus(activityId, newStatus) {
            const message = newStatus === 'غیرفعال' ? 'آیا از غیرفعال کردن این فعالیت مطمئن هستید؟' : 'آیا می‌خواهید این فعالیت را دوباره فعال کنید؟';
            showModal(message, 'confirm', async () => {
                welcomeLoader.style.opacity = '1';
                welcomeLoader.style.display = 'flex';
                try {
                    const payload = { action: 'changeActivityStatus', activityId, newStatus };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showModal(result.message, 'success');
                        renderMyActivities();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showModal(`خطا در تغییر وضعیت: ${error.message}`, 'error');
                } finally {
                    welcomeLoader.style.opacity = '0';
                    setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
                }
            });
        }

// این تابع جدید جایگزین کامل تابع renderProjectsHeader می‌شود
function renderProjectMarketplaceHeader() {
    const headerHtml = `
        <div id="filter-sort-container" class="filter-sort-bar">
            <div class="filter-group">
                <button class="filter-btn" data-filter="province">
                    <i class="fas fa-map-marker-alt"></i><span>استان</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه استان‌ها</div>
                    ${PROVINCES.map(p => `<div class="filter-dropdown-item" data-value="${p}">${p}</div>`).join('')}
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="engineerField">
                    <i class="fas fa-drafting-compass"></i><span>رشته مهندس</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه رشته‌ها</div>
                    <div class="filter-dropdown-item" data-value="معماری">معماری</div>
                    <div class="filter-dropdown-item" data-value="عمران">عمران</div>
                    <div class="filter-dropdown-item" data-value="مکانیک">مکانیک</div>
                    <div class="filter-dropdown-item" data-value="برق">برق</div>
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="engineerRank">
                    <i class="fas fa-star"></i><span>پایه مهندس</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه پایه‌ها</div>
                    <div class="filter-dropdown-item" data-value="پایه 3">پایه 3</div>
                    <div class="filter-dropdown-item" data-value="پایه 2">پایه 2</div>
                    <div class="filter-dropdown-item" data-value="پایه 1">پایه 1</div>
                    <div class="filter-dropdown-item" data-value="پایه ارشد">پایه ارشد</div>
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="engineerActivity">
                    <i class="fas fa-briefcase"></i><span>نوع فعالیت</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه فعالیت ها</div>
                    <div class="filter-dropdown-item" data-value="طراح">طراح</div>
                    <div class="filter-dropdown-item" data-value="ناظر">ناظر</div>
                    <div class="filter-dropdown-item" data-value="مجری">مجری</div>
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="permitType">
                    <i class="fas fa-id-card"></i><span>نوع پروانه</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه پروانه ها</div>
                    <div class="filter-dropdown-item" data-value="طراح حقوقی">طراح حقوقی</div>
                    <div class="filter-dropdown-item" data-value="ناظر حقوقی">ناظر حقوقی</div>
                    <div class="filter-dropdown-item" data-value="انبوه ساز">انبوه ساز</div>
                    <div class="filter-dropdown-item" data-value="مجری حقوقی">مجری حقوقی</div>
                    <div class="filter-dropdown-item" data-value="مهندس حقیقی">مهندس حقیقی</div>
                    <div class="filter-dropdown-item" data-value="کاردان">کاردان</div>
                    <div class="filter-dropdown-item" data-value="معمارتجربی">معمارتجربی</div>
                </div>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-filter="fileType">
                    <i class="fas fa-file-alt"></i><span>نوع پرونده</span>
                </button>
                <div class="filter-dropdown">
                    <div class="filter-dropdown-item" data-value="">همه پرونده ها</div>
                    <div class="filter-dropdown-item" data-value="عادی">عادی</div>
                    <div class="filter-dropdown-item" data-value="فرسوده">فرسوده</div>
                </div>
            </div>
            <div class="flex-grow"></div> <button class="sort-btn active" data-sort="newest"><i class="fas fa-sort-amount-down"></i>جدیدترین</button>
            <button class="sort-btn" data-sort="oldest"><i class="fas fa-sort-amount-up"></i>قدیمی‌ترین</button>
            <button class="sort-btn" data-sort="cheapest"><i class="fas fa-dollar-sign"></i>ارزان‌ترین</button>
            <button class="sort-btn" data-sort="mostExpensive"><i class="fas fa-dollar-sign"></i>گران‌ترین</button>
        </div>
        <div id="project-list-container"></div>
    `;
    projectsContent.innerHTML = headerHtml;

    // منطق جدید برای فعال‌سازی دکمه‌های هوشمند
    const activeFilters = {};
    let activeSort = 'newest';

    function applyFiltersAndSort() {
        // 1. فیلتر کردن
        let filtered = fetchedProjects.filter(p => {
            return Object.entries(activeFilters).every(([key, value]) => {
                return !value || p[key] === value;
            });
        });

        // 2. مرتب‌سازی
        filtered.sort((a, b) => {
            switch (activeSort) {
                case 'oldest': return new Date(a.SubmissionDate) - new Date(b.SubmissionDate);
                case 'cheapest': return (a.area * a.unitPrice) - (b.area * b.unitPrice);
                case 'mostExpensive': return (b.area * b.unitPrice) - (a.area * a.unitPrice);
                case 'newest':
                default:
                    return new Date(b.SubmissionDate) - new Date(a.SubmissionDate);
            }
        });

        displayProjects(filtered);
    }

    // افزودن Event Listener به دکمه‌های فیلتر
    document.querySelectorAll('.filter-group').forEach(group => {
        const button = group.querySelector('.filter-btn');
        const dropdown = group.querySelector('.filter-dropdown');
        const buttonTextSpan = button.querySelector('span');
        const originalText = buttonTextSpan.textContent;

        button.addEventListener('click', (e) => {
            if (e.target.classList.contains('close-icon')) {
                // حذف فیلتر
                delete activeFilters[button.dataset.filter];
                button.classList.remove('active');
                buttonTextSpan.textContent = originalText;
                button.querySelector('.close-icon')?.remove();
                applyFiltersAndSort();
                return;
            }
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        dropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-dropdown-item')) {
                const value = e.target.dataset.value;
                const filterKey = button.dataset.filter;

                button.querySelector('.close-icon')?.remove(); // حذف ضربدر قبلی

                if (value) {
                    activeFilters[filterKey] = value;
                    button.classList.add('active');
                    buttonTextSpan.textContent = value;
                    button.insertAdjacentHTML('beforeend', `<i class="fas fa-times close-icon"></i>`);
                } else {
                    delete activeFilters[filterKey];
                    button.classList.remove('active');
                    buttonTextSpan.textContent = originalText;
                }

                applyFiltersAndSort();
                dropdown.style.display = 'none';
            }
        });
    });

    // افزودن Event Listener به دکمه‌های مرتب‌سازی
    const sortButtons = document.querySelectorAll('.sort-btn');
    sortButtons.forEach(button => {
        button.addEventListener('click', () => {
            sortButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            activeSort = button.dataset.sort;
            applyFiltersAndSort();
        });
    });

    // بستن منوهای کشویی با کلیک در بیرون از آن‌ها
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.filter-group')) {
            document.querySelectorAll('.filter-dropdown').forEach(d => d.style.display = 'none');
        }
    });

    applyFiltersAndSort(); // نمایش اولیه پروژه‌ها
}
        
        function displayProjects(projectsToDisplay) {
            const container = document.getElementById('project-list-container');
            if (!container) return;
            container.innerHTML = projectsToDisplay.length > 0 ? projectsToDisplay.map(p => getProjectCardHTML(p, 'engineer', appliedProjectIds.has(p.ProjectID))).join('') : '<p class="text-center text-slate-500 col-span-full">پروژه‌ای مطابق با فیلترهای شما یافت نشد.</p>';
        }

        function applyFilters() {
            const filters = {
                province: document.getElementById('filterProvince').value, city: document.getElementById('filterCity').value.trim().toLowerCase(),
                engineerField: document.getElementById('filterEngineerField').value, engineerRank: document.getElementById('filterEngineerRank').value,
                engineerActivity: document.getElementById('filterEngineerActivity').value, permitType: document.getElementById('filterPermitType').value,
            };
            const filtered = fetchedProjects.filter(p => 
                (!filters.province || p.province === filters.province) && (!filters.city || p.city.toLowerCase().includes(filters.city)) &&
                (!filters.engineerField || p.engineerField === filters.engineerField) && (!filters.engineerRank || p.engineerRank === filters.engineerRank) &&
                (!filters.engineerActivity || p.engineerActivity === filters.engineerActivity) && (!filters.permitType || p.permitType === filters.permitType)
            );
            displayProjects(filtered);
        }

        function resetFilters() {
            const filterContainer = document.getElementById('filter-container');
            if (filterContainer) {
                filterContainer.querySelectorAll('input, select').forEach(el => el.tagName === 'SELECT' ? el.selectedIndex = 0 : el.value = '');
            }
            displayProjects(fetchedProjects);
        }

async function renderProjectMarketplace() {
    projectsContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
    try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getMarketplaceData&email=${encodeURIComponent(userData.email)}`);
        const result = await response.json();
        if (result.success && result.data) {
            fetchedProjects = result.data.openProjects || [];
            appliedProjectIds = new Set(result.data.appliedProjectIds || []);

            // اینجا به جای تابع قدیمی، تابع جدید را فراخوانی می‌کنیم
            renderProjectMarketplaceHeader(); 

        } else {
             projectsContent.innerHTML = `<p class="text-center text-red-500">${result.message || 'خطا در دریافت اطلاعات پروژه‌ها.'}</p>`;
        }
    } catch (error) {
        projectsContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری پروژه‌ها: ${error.message}</p>`;
    }
}

        async function renderEmployerProjects() {
            projectsContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getProjectsByEmployer&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (result.success && Array.isArray(result.data)) {
                    fetchedProjects = result.data.sort((a,b) => new Date(b.lastModifiedDate) - new Date(a.lastModifiedDate));
                     if (fetchedProjects.length > 0) {
                        projectsContent.innerHTML = `<div id="project-list-container">${fetchedProjects.map(p => getProjectCardHTML(p, 'employer')).join('')}</div>`;
                     } else {
                        projectsContent.innerHTML = '<p class="text-center text-slate-500">شما هنوز پروژه‌ای ثبت نکرده‌اید.</p>';
                     }
                } else {
                    projectsContent.innerHTML = `<p class="text-center text-red-500">${result.message || 'خطا در دریافت اطلاعات پروژه‌ها.'}</p>`;
                }
            } catch (error) {
                projectsContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری پروژه‌ها: ${error.message}</p>`;
            }
        }
        
        async function renderEmployerDashboard() {
            dashboardContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getDashboardData&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                const { stats, projects } = result.data;
                let projectsListHtml = projects.sort((a,b) => new Date(b.lastModifiedDate) - new Date(a.lastModifiedDate))
                    .map(p => `<div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow"><div><p class="font-semibold text-slate-800">${p.projectName}</p><p class="text-sm text-slate-500">${p.Status === 'باز' ? 'وضعیت: باز' : 'وضعیت: بسته'}</p></div><div class="text-left"><p class="font-semibold" style="color: var(--primary-color)">${p.applicantCount} درخواست</p><p class="text-xs text-slate-400">همکاری</p></div></div>`).join('');
                if (projects.length === 0) projectsListHtml = '<p class="text-center text-slate-500 col-span-2">هنوز پروژه‌ای ثبت نکرده‌اید.</p>';
                dashboardContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-100 text-green-800 p-6 rounded-lg shadow"><p class="text-4xl font-bold">${stats.open}</p><p class="mt-2 font-semibold">پروژه‌های باز</p></div>
                        <div class="bg-red-100 text-red-800 p-6 rounded-lg shadow"><p class="text-4xl font-bold">${stats.closed}</p><p class="mt-2 font-semibold">پروژه‌های بسته</p></div>
                        <div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden flex flex-col-reverse md:flex-row items-center">
                            <div class="p-6 flex-grow w-full md:w-2/3"><h3 class="text-lg font-bold text-slate-800 mb-2">پروژه جدیدی دارید؟</h3><p class="text-slate-600 mb-4">با ثبت پروژه جدید، آن را در معرض دید صدها مهندس متخصص قرار دهید.</p><button id="dashboardCreateProjectBtn" class="btn btn-special"><i class="fas fa-plus-circle"></i><span>ثبت پروژه جدید</span></button></div>
                            <div class="w-full md:w-1/3 h-48 md:h-full flex-shrink-0"><img src="https://images.unsplash.com/photo-1580922942632-fb585198592e?w=600&auto=format&fit=crop&q=60" class="w-full h-full object-cover" alt=""></div>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-bold text-slate-800 mb-4">آخرین پروژه‌های شما</h3><div class="space-y-3">${projectsListHtml}</div></div>
                    </div>`;
                document.getElementById('dashboardCreateProjectBtn').addEventListener('click', () => document.querySelector('.nav-item[data-view="create-project"]').click());
            } catch (error) {
                dashboardContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری داشبورد: ${error.message}</p>`;
            }
        }

        async function renderEngineerDashboard() {
            dashboardContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getEngineerDashboardData&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                const { stats, activities } = result.data;
                let activitiesListHtml = activities.sort((a,b) => new Date(b.LastModifiedDate) - new Date(a.LastModifiedDate))
                    .map(act => `<div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow"><div><p class="font-semibold text-slate-800">${act.engineerActivity} ${act.engineerLevel} ${act.engineerField}</p><p class="text-sm text-slate-500">${act.province} - ${act.city}</p></div><div class="text-left"><span class="px-3 py-1 text-sm font-semibold rounded-full ${act.Status === 'فعال' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${act.Status}</span></div></div>`).join('');
                if (activities.length === 0) activitiesListHtml = '<p class="text-center text-slate-500 col-span-2">هنوز فعالیتی ثبت نکرده‌اید.</p>';

                dashboardContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-100 text-green-800 p-6 rounded-lg shadow"><p class="text-4xl font-bold">${stats.active}</p><p class="mt-2 font-semibold">فعالیت‌های فعال</p></div>
                        <div class="bg-red-100 text-red-800 p-6 rounded-lg shadow"><p class="text-4xl font-bold">${stats.inactive}</p><p class="mt-2 font-semibold">فعالیت‌های غیرفعال</p></div>
                        <div class="md:col-span-2 bg-white rounded-lg shadow overflow-hidden flex flex-col-reverse md:flex-row items-center">
                            <div class="p-6 flex-grow w-full md:w-2/3"><h3 class="text-lg font-bold text-slate-800 mb-2">آمادگی خود را اعلام کنید!</h3><p class="text-slate-600 mb-4">با ثبت فعالیت، کارفرمایان می‌توانند شما را پیدا کرده و برای پروژه‌های خود دعوت به همکاری کنند. این بهترین راه برای دیده شدن تخصص شماست.</p><button id="dashboardCreateActivityBtn" class="btn btn-special"><i class="fas fa-bullhorn"></i><span>ثبت فعالیت جدید</span></button></div>
                            <div class="w-full md:w-1/3 h-48 md:h-full flex-shrink-0"><img src="https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=600&auto=format&fit=crop&q=60" class="w-full h-full object-cover" alt=""></div>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-bold text-slate-800 mb-4">آخرین فعالیت‌های شما</h3><div class="space-y-3">${activitiesListHtml}</div></div>
                    </div>`;
                document.getElementById('dashboardCreateActivityBtn').addEventListener('click', () => document.querySelector('.nav-item[data-view="create-activity"]').click());
            } catch (error) {
                dashboardContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری داشبورد: ${error.message}</p>`;
            }
        }
        
        async function renderEngineersPanel() {
            engineersContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getAllActiveActivities&email=${encodeURIComponent(userData.email)}`);
                const result = await response.json();
                if (result.success && result.data) {
                    fetchedEngineersActivities = result.data.activeActivities || [];
                    requestedCooperationIds = new Set(result.data.requestedActivityIds || []);
                    const container = document.createElement('div');
                    container.id = 'engineers-list-container';
                    if (fetchedEngineersActivities.length > 0) {
                        container.innerHTML = fetchedEngineersActivities.map(act => getActivityCardHTML(act, true)).join('');
                    } else {
                        container.innerHTML = '<p class="text-center text-slate-500 col-span-full">در حال حاضر هیچ مهندس فعالی یافت نشد.</p>';
                    }
                    engineersContent.innerHTML = '';
                    engineersContent.appendChild(container);
                } else {
                     engineersContent.innerHTML = `<p class="text-center text-red-500">${result.message || 'خطا در دریافت لیست مهندسان.'}</p>`;
                }
            } catch (error) {
                engineersContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری لیست مهندسان: ${error.message}</p>`;
            }
        }
        
        // --- Notification Logic ---
        async function renderNotifications() {
            notificationsContent.innerHTML = '<div class="spinner mx-auto mt-10"></div>';
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?func=getNotifications&email=${encodeURIComponent(userData.email)}&role=${userData.role}`);
                const result = await response.json();
                if (result.success && result.data) {
                    fetchedNotifications = result.data.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                    
                    if (fetchedNotifications.length > 0) {
                        const notificationsHtml = fetchedNotifications.map(notif => {
                            const isUnread = notif.Status === 'Unread';
                            return `
                                <div class="notification-item p-4 cursor-pointer flex items-center ${isUnread ? 'unread' : ''}" data-message-id="${notif.MessageID}">
                                    ${isUnread ? '<div class="dot ml-4"></div>' : '<div class="w-[10px] ml-4"></div>'}
                                    <div class="flex-grow">
                                        <div class="flex justify-between items-center">
                                            <p class="font-semibold text-slate-800">${notif.Title}</p>
                                            <p class="text-xs text-slate-500">${formatTimeAgo(notif.Timestamp)}</p>
                                        </div>
                                        <p class="text-sm text-slate-600 mt-1">از طرف: ${notif.Sender}</p>
                                    </div>
                                    <i class="fas fa-chevron-left text-slate-400 mr-4"></i>
                                </div>
                            `;
                        }).join('');
                        notificationsContent.innerHTML = `<div class="bg-white rounded-lg shadow-md overflow-hidden">${notificationsHtml}</div>`;
                    } else {
                        notificationsContent.innerHTML = '<p class="text-center text-slate-500">شما هیچ پیام جدیدی ندارید.</p>';
                    }
                    updateNotificationBadge();
                } else {
                    notificationsContent.innerHTML = `<p class="text-center text-red-500">${result.message || 'خطا در دریافت پیام‌ها.'}</p>`;
                }
            } catch (error) {
                notificationsContent.innerHTML = `<p class="text-center text-red-500">خطا در بارگذاری پیام‌ها: ${error.message}</p>`;
            }
        }

        function updateNotificationBadge() {
            const unreadCount = fetchedNotifications.filter(n => n.Status === 'Unread').length;
            const badge = document.getElementById('notification-badge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        async function openNotificationModal(messageId) {
            const notification = fetchedNotifications.find(n => n.MessageID === messageId);
            if (!notification) return;

            document.getElementById('notificationModalTitle').textContent = notification.Title;
            document.getElementById('notificationModalMeta').textContent = `از طرف: ${notification.Sender}  |  در تاریخ: ${new Date(notification.Timestamp).toLocaleString('fa-IR')}`;
            document.getElementById('notificationModalBody').innerHTML = notification.Body.replace(/\n/g, '<br>'); // Basic formatting
            document.getElementById('notificationModal').style.display = 'flex';

            if (notification.Status === 'Unread') {
                 try {
                    const payload = { action: 'markNotificationAsRead', messageId: notification.MessageID, email: userData.email };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        notification.Status = 'Read';
                        const itemEl = notificationsContent.querySelector(`.notification-item[data-message-id="${messageId}"]`);
                        if(itemEl) {
                            itemEl.classList.remove('unread');
                            itemEl.querySelector('.dot').style.display = 'none';
                        }
                        updateNotificationBadge();
                    }
                 } catch (error) {
                    console.error("Failed to mark notification as read:", error);
                 }
            }
        }

        document.getElementById('notificationModalCloseBtn').addEventListener('click', () => {
            document.getElementById('notificationModal').style.display = 'none';
        });

        // --- End Notification Logic ---

        async function handleRequestCooperation(activityId, button) {
            button.disabled = true;
            button.innerHTML = '<div class="spinner !w-5 !h-5 !border-2"></div>';
            try {
                const payload = { action: 'requestCooperation', employerEmail: userData.email, activityId };
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    requestedCooperationIds.add(activityId);
                    const card = button.closest('.activity-card');
                    if(card) card.outerHTML = getActivityCardHTML(fetchedEngineersActivities.find(a => a.ActivityID === activityId), true);
                } else { throw new Error(result.message); }
            } catch (error) {
                showModal(`خطا: ${error.message}`, 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>درخواست همکاری';
            }
        }
        
        async function handleCancelCooperation(activityId, button) {
            showModal('آیا از لغو درخواست همکاری با این مهندس مطمئن هستید؟', 'confirm', async () => {
                button.disabled = true;
                button.innerHTML = '<div class="spinner !w-5 !h-5 !border-2"></div>';
                try {
                    const payload = { action: 'cancelCooperation', employerEmail: userData.email, activityId };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showModal(result.message, 'success');
                        requestedCooperationIds.delete(activityId);
                        const card = button.closest('.activity-card');
                        if(card) card.outerHTML = getActivityCardHTML(fetchedEngineersActivities.find(a => a.ActivityID === activityId), true);
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showModal(`خطا: ${error.message}`, 'error');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-times-circle mr-2"></i>لغو درخواست همکاری';
                }
            });
        }

        async function handleApplyForProject(projectId, button) {
            button.disabled = true;
            button.innerHTML = '<div class="spinner !w-5 !h-5 !border-2"></div>';
            try {
                const payload = { action: 'applyForProject', engineerEmail: userData.email, projectId };
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    appliedProjectIds.add(projectId);
                    const card = button.closest('.project-card');
                    if(card) card.outerHTML = getProjectCardHTML(fetchedProjects.find(p => p.ProjectID === projectId), 'engineer', true);
                } else { throw new Error(result.message); }
            } catch (error) {
                showModal(`خطا: ${error.message}`, 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>درخواست همکاری';
            }
        }
        
        async function handleCancelApplication(projectId, button) {
            showModal('آیا از لغو درخواست همکاری برای این پروژه مطمئن هستید؟', 'confirm', async () => {
                button.disabled = true;
                button.innerHTML = '<div class="spinner !w-5 !h-5 !border-2"></div>';
                try {
                    const payload = { action: 'cancelApplication', engineerEmail: userData.email, projectId };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showModal(result.message, 'success');
                        appliedProjectIds.delete(projectId);
                        const card = button.closest('.project-card');
                        if(card) card.outerHTML = getProjectCardHTML(fetchedProjects.find(p => p.ProjectID === projectId), 'engineer', false);
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showModal(`خطا: ${error.message}`, 'error');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-times-circle mr-2"></i>لغو درخواست همکاری';
                }
            });
        }
        
        function handleEditProject(projectId) {
            const projectToEdit = fetchedProjects.find(p => p.ProjectID === projectId);
            if (projectToEdit) {
                document.querySelector('.nav-item[data-view="create-project"]').click();
                setTimeout(() => renderProjectForm(projectToEdit), 50);
            }
        }

        async function handleChangeProjectStatus(projectId, newStatus) {
            const message = newStatus === 'بسته' ? 'آیا از بستن این پروژه مطمئن هستید؟' : 'آیا می‌خواهید این پروژه را دوباره باز کنید؟';
            showModal(message, 'confirm', async () => {
                welcomeLoader.style.opacity = '1';
                welcomeLoader.style.display = 'flex';
                try {
                    const payload = { action: 'changeProjectStatus', projectId, newStatus };
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showModal(result.message, 'success');
                        renderEmployerProjects();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showModal(`خطا در تغییر وضعیت: ${error.message}`, 'error');
                } finally {
                    welcomeLoader.style.opacity = '0';
                    setTimeout(() => { welcomeLoader.style.display = 'none'; }, 500);
                }
            });
        }

        function setupViewSwitcher() {
            const navItems = document.querySelectorAll('.nav-item[data-view]');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const targetView = e.currentTarget.dataset.view;
                    
                    document.querySelectorAll('.content-body').forEach(el => el.style.display = 'none');
                    navItems.forEach(nav => nav.classList.remove('active'));

                    switch(targetView) {
                        case 'dashboard':
                            dashboardContent.style.display = 'block';
                            mainHeaderTitle.textContent = 'داشبورد';
                            if (userData.role === 'employer') renderEmployerDashboard();
                            else renderEngineerDashboard();
                            break;
                        case 'profile': profileContent.style.display = 'block'; mainHeaderTitle.textContent = 'پروفایل کاربری'; break;
                        case 'settings': settingsContent.style.display = 'block'; mainHeaderTitle.textContent = 'تنظیمات'; break;
                        case 'notifications': notificationsContent.style.display = 'block'; mainHeaderTitle.textContent = 'پیام‌ها و اعلان‌ها'; renderNotifications(); break;
                        case 'projects':
                            projectsContent.style.display = 'block';
                            if (userData.role === 'employer') { mainHeaderTitle.textContent = 'پروژه‌های من'; renderEmployerProjects(); }
                            else { mainHeaderTitle.textContent = 'بازار کار پروژه‌ها'; renderProjectMarketplace(); }
                            break;
                        case 'my-activities': myActivitiesContent.style.display = 'block'; mainHeaderTitle.textContent = 'فعالیت‌های من'; renderMyActivities(); break;
                        case 'engineers': engineersContent.style.display = 'block'; mainHeaderTitle.textContent = 'لیست مهندسان'; renderEngineersPanel(); break;
                        case 'create-project': createProjectContent.style.display = 'block'; mainHeaderTitle.textContent = 'ثبت / ویرایش پروژه'; renderProjectForm(); break;
                        case 'create-activity': createActivityContent.style.display = 'block'; mainHeaderTitle.textContent = 'ثبت / ویرایش فعالیت'; renderActivityForm(); break;
                    }
                    e.currentTarget.classList.add('active');
                });
            });
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const btnText = btn.querySelector('span');
            const spinner = btn.querySelector('.spinner');
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) return showModal('لطفاً تمام فیلدها را پر کنید.', 'error');
            if (newPassword !== confirmNewPassword) return showModal('رمز عبور جدید و تکرار آن یکسان نیستند.', 'error');
            if (newPassword.length < 6) return showModal('رمز عبور جدید باید حداقل ۶ کاراکتر باشد.', 'error');

            btn.disabled = true; btnText.classList.add('hidden'); spinner.classList.remove('hidden');
            try {
                const payload = { action: 'changePassword', email: userData.email, currentPassword, newPassword };
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`خطای سرور: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    showModal(result.message, 'success');
                    changePasswordForm.reset();
                } else { throw new Error(result.message || 'خطای ناشناخته.'); }
            } catch (error) {
                showModal(error.message, 'error');
            } finally {
                btn.disabled = false; btnText.classList.remove('hidden'); spinner.classList.add('hidden');
            }
        }

        function setupPasswordToggle() {
            document.querySelectorAll('.password-toggle-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const targetId = icon.dataset.target;
                    const passwordInput = document.getElementById(targetId);
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });
        }

        // --- INITIALIZATION ---
        async function main() {
            document.body.classList.remove('hidden');
            const params = new URLSearchParams(window.location.search);
            const email = params.get('email');
            if (!email) {
                welcomeLoader.innerHTML = '<p class="text-red-600 font-bold p-8">خطا: ایمیل کاربر مشخص نشده است.</p>';
                return;
            }
            userData = await fetchUserProfile(email);
            if (userData) {
                userData.email = email;
                welcomeMessage.textContent = `${userData.stepsData.step1.engineerFirstName || userData.stepsData.step1.employerFirstName || 'کاربر'} عزیز، خوش آمدید!`;
                
                setTimeout(() => {
                    welcomeLoader.style.opacity = '0';
                    setTimeout(() => {
                        welcomeLoader.style.display = 'none';
                        renderProfile();
                        document.querySelector('.nav-item[data-view="dashboard"]').click();
                        renderNotifications(); // Fetch notifications on load
                    }, 500);
                }, 1500);

            }
            initSlideshow();
            setupViewSwitcher();
            setupPasswordToggle();
            changePasswordForm.addEventListener('submit', handleChangePassword);

            const contentAreaClickHandler = (e, contentId, handlers) => {
                if (document.getElementById(contentId).style.display !== 'block') return;
                const targetButton = e.target.closest('button');
                if (targetButton && targetButton.dataset.action) {
                    const action = targetButton.dataset.action;
                    if (handlers[action]) {
                        handlers[action](targetButton);
                    }
                }
                const notificationItem = e.target.closest('.notification-item');
                if (notificationItem && notificationItem.dataset.messageId) {
                    openNotificationModal(notificationItem.dataset.messageId);
                }
            };

            document.querySelector('.main-content-area').addEventListener('click', e => {
                contentAreaClickHandler(e, 'projectsContent', {
                    'apply': btn => handleApplyForProject(btn.dataset.projectId, btn),
                    'cancel-application': btn => handleCancelApplication(btn.dataset.projectId, btn),
                    'edit-project': btn => handleEditProject(btn.dataset.projectId),
                    'close-project': btn => handleChangeProjectStatus(btn.dataset.projectId, 'بسته'),
                    'open-project': btn => handleChangeProjectStatus(btn.dataset.projectId, 'باز')
                });
                contentAreaClickHandler(e, 'myActivitiesContent', {
                    'edit-activity': btn => handleEditActivity(btn.dataset.activityId),
                    'change-activity-status': btn => handleChangeActivityStatus(btn.dataset.activityId, btn.dataset.newStatus)
                });
                contentAreaClickHandler(e, 'engineersContent', {
                    'request-cooperation': btn => handleRequestCooperation(btn.dataset.activityId, btn),
                    'cancel-cooperation': btn => handleCancelCooperation(btn.dataset.activityId, btn)
                });
                contentAreaClickHandler(e, 'notificationsContent', {});
            });
            
            document.getElementById('refresh-button').addEventListener('click', refreshCurrentView);
        }

        main();
    })();
    </script>
</body>
</html>
