<!DOCTYPE html>
<html lang="fa" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ایستگاه کاری کارفرما - نظام تندیس</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Leaflet (for maps) -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <!-- Font Awesome (for icons) -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <!-- Vazirmatn Font -->
        <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css"/>
        <!-- Persian Datepicker -->
        <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
        <script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
        <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
        <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
        <!-- Toastify JS for notifications -->
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

        <style>
            body { font-family: 'Vazirmatn', 'Tahoma', sans-serif; background-color: #f8fafc; }
            .form-container-wrapper { display: flex; flex-direction: column; height: 100vh; max-height: 100vh; margin: 0 auto; background-color: white; overflow: hidden; }
            #stepsSidebar { background-color: #f1f5f9; border-left: 1px solid #e2e8f0; }
            #advertisementSidebar { background-color: #f1f5f9; border-right: 1px solid #e2e8f0; }
            .form-content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
            .form-content { padding: 1.5rem 2rem; overflow-y: auto; flex-grow: 1; }
            .app-footer { background-color: #f1f5f9; color: #475569; padding: 0.75rem; text-align: center; font-size: 0.75rem; border-top: 1px solid #e2e8f0; flex-shrink: 0; }
            
            /* Loading Screen Styles */
            #loadingScreen { display: flex; flex-direction: row; align-items: stretch; justify-content: center; height: 100%; text-align: center; background: linear-gradient(135deg, #FDFEFF 0%, #FCFDFF 50%, #EFF9FF 100%); }
            .loading-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
            .welcome-banner { width: 20vw; max-width: 220px; min-width:150px; background-color: rgba(255,255,255,0.5); display: none; align-items: center; justify-content: center; overflow: hidden; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.03); margin: 2rem; height: calc(100vh - 8rem); } 
            .welcome-banner img { width: 100%; height: 100%; object-fit: cover; }
            @media (min-width: 1024px) { .welcome-banner { display: flex; } }

            .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 48px; height: 48px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease infinite; margin-top: 2rem; margin-bottom: 1rem; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            
            /* Profile Section Styles */
            .profile-section { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; margin-bottom: 1.5rem; overflow: hidden; transition: all 0.3s ease; }
            .section-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; cursor: pointer; user-select: none; background-color: #fdfdfe; border-bottom: 1px solid #e2e8f0; }
            .section-header h3 { display: flex; align-items: center; gap: 0.75rem; font-size: 1.125rem; font-weight: 700; color: #334155; }
            .section-toggle-icon { transition: transform 0.3s ease; }
            .section-header.open .section-toggle-icon { transform: rotate(180deg); }
            .section-content { padding: 1.5rem; display: none; }
            .section-content.open { display: block; animation: fadeIn 0.5s ease; }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            .section-footer { padding: 1rem 1.5rem; background-color: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem; }
            
            /* General Styles */
            label.required::after { content: " *"; color: #ef4444; }
            input, textarea, select { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.625rem 0.875rem; transition: all 0.2s ease; width: 100%; }
            input:focus, textarea:focus, select:focus { border-color: #0ea5e9; background-color: white; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); outline: none; }
            input:disabled, select:disabled, textarea:disabled { background-color: #eef2f7; color: #64748b; cursor: not-allowed; border-color: #e2e8f0; }
            select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-left: 2.5rem; }
            .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; }
            .btn-primary { background-color: #0ea5e9; color: white; } .btn-primary:hover { background-color: #0284c7; }
            .btn-secondary { background-color: #e2e8f0; color: #1e293b; } .btn-secondary:hover { background-color: #cbd5e1; }
            .btn-success { background-color: #10b981; color: white; } .btn-success:hover { background-color: #059669; }
            .btn-danger { background-color: #f43f5e; color: white; } .btn-danger:hover { background-color: #e11d48; }
            .btn:disabled { opacity: 0.6; cursor: not-allowed; }
            .map-container { height: 220px; border-radius: 0.5rem; border: 1px solid #cbd5e1; }
            .file-preview-container { width: 100%; height: 12rem; overflow: hidden; border: 1px solid #e2e8f0; border-radius: 0.375rem; display: flex; align-items: center; justify-content: center; background-color: #f8fafc; }
            .file-preview-container img, .file-preview-container iframe { width: 100%; height: 100%; object-fit: contain; border: none; }
        </style>
    </head>
    <body class="bg-slate-50">
        <div id="app" class="form-container-wrapper"> 
            
            <div id="loadingScreen">
                <div class="welcome-banner">
                     <img src="https://images.unsplash.com/photo-1657450717464-b2989dd69a66?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8Ymx1ZSUyMGZsb3dlcnxlbnwwfDF8MHx8fDI%3D" 
                          alt="گل‌های آبی" 
                          onerror="this.onerror=null;this.src='https://placehold.co/220x500/EBF4FF/2196F3?text=Flowers';">
                </div>
                <div class="loading-content">
                    <div class="border-b-2 flex items-center justify-center pb-11 w-full">
                        <img src="https://tandis.shahraavand.ir/images/new-TLogo_B.avif" alt="لوگوی تندیس شهرآوند" class="h-30 w-30 ml-5" width="100" height="100" loading="lazy">
                        <div>
                            <h1 class="font-black text-4xl text-center text-blue-700">نظام تندیس</h1>
                            <p class="font-extrabold pt-2 text-lg leading-5 text-center text-yellow-600">تدارک نیازمندی دقیق و یکپارچه ساختمان</p>
                        </div>
                    </div>
                    <h2 class="font-bold text-2xl mt-8">خوش آمدید!</h2>
                    <div class="spinner"></div>
                    <p class="text-slate-600">در حال بارگذاری اطلاعات حساب کاربری شما...</p>
                </div>
                 <div class="welcome-banner">
                     <img src="https://images.unsplash.com/photo-1657450717464-b2989dd69a66?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8Ymx1ZSUyMGZsb3dlcnxlbnwwfDF8MHx8fDI%3D" 
                          alt="گل‌های آبی"
                          onerror="this.onerror=null;this.src='https://placehold.co/220x500/FFF3E0/FFB300?text=Flowers';">
                </div>
            </div>

            <div id="mainFormView" class="hidden flex-col md:flex-row flex-1 overflow-hidden"> 
                <div id="stepsSidebar" class="flex-shrink-0 hidden overflow-y-auto p-5 w-64 md:flex md:flex-col lg:w-72"> 
                    <div class="mb-5 text-center">
                        <div class="relative w-36 h-36 mx-auto mb-3 rounded-full overflow-hidden border-2 border-sky-400 shadow-lg"> 
                            <img id="sidebarProfileImagePreview" src="https://placehold.co/144x144/E0F2FE/0284C7?text=User" alt="عکس پروفایل" class="w-full h-full object-cover">
                        </div>
                        <h3 id="sidebarProfileName" class="text-md font-semibold text-slate-700">نام و نام خانوادگی</h3>
                        <p id="sidebarUserEmail" class="text-xs text-slate-500 mt-1"></p>
                    </div>
                    <div class="bg-sky-300 h-px my-4"></div>
                    <p class="text-sm text-center text-slate-600">به پنل کاربری خود در نظام تندیس خوش آمدید.</p>
                    <button id="logoutButton" class="btn btn-danger w-full mt-auto"><i class="fas fa-sign-out-alt"></i><span>خروج از حساب</span></button>
                </div>

                <div class="form-content-area flex-1"> 
                    <div class="form-content">
                        <!-- Section 1: Personal Info -->
                        <div id="section-1" class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-user-tie text-sky-500"></i>۱. مشخصات فردی</h3>
                                <div class="flex items-center gap-4">
                                    <span class="save-success-msg text-sm font-medium text-green-600 hidden"><i class="fas fa-check-circle"></i> ذخیره شد</span>
                                    <button class="btn btn-secondary !py-1 !px-3 text-sm edit-btn"><i class="fas fa-edit"></i> ویرایش</button>
                                    <i class="fas fa-chevron-down section-toggle-icon"></i>
                                </div>
                            </div>
                            <div class="section-content">
                                <form data-section="step1">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                                        <div><label for="employerFirstName" class="block text-sm font-medium text-slate-700 mb-1 required">نام</label><input type="text" id="employerFirstName" name="employerFirstName" required disabled></div>
                                        <div><label for="employerLastName" class="block text-sm font-medium text-slate-700 mb-1 required">نام خانوادگی</label><input type="text" id="employerLastName" name="employerLastName" required disabled></div>
                                        <div><label for="employerNationalId" class="block text-sm font-medium text-slate-700 mb-1 required">کدملی</label><input type="text" id="employerNationalId" name="employerNationalId" required pattern="\d{10}" disabled></div>
                                        <div><label for="employerDob" class="block text-sm font-medium text-slate-700 mb-1 required">تاریخ تولد</label><input type="text" id="employerDob" required class="jalali-datepicker-display" readonly disabled><input type="hidden" name="employerDob" class="jalali-datepicker-value"></div>
                                        <div><label class="block text-sm font-medium text-slate-700 mb-1 required">جنسیت</label><select id="employerGender" name="employerGender" required disabled><option value="مرد">مرد</option><option value="زن">زن</option></select></div>
                                        <div><label for="employerMobile" class="block text-sm font-medium text-slate-700 mb-1 required">تلفن موبایل</label><input type="tel" id="employerMobile" name="employerMobile" required pattern="09\d{9}" disabled></div>
                                    </div>
                                    <div class="section-footer hidden"><button type="button" class="btn btn-secondary cancel-btn">انصراف</button><button type="submit" class="btn btn-success save-btn">ذخیره تغییرات</button></div>
                                </form>
                            </div>
                        </div>

                        <!-- Section 2: Contact Info -->
                        <div id="section-2" class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-address-book text-sky-500"></i>۲. اطلاعات تماس</h3>
                                <div class="flex items-center gap-4">
                                    <span class="save-success-msg text-sm font-medium text-green-600 hidden"><i class="fas fa-check-circle"></i> ذخیره شد</span>
                                    <button class="btn btn-secondary !py-1 !px-3 text-sm edit-btn"><i class="fas fa-edit"></i> ویرایش</button>
                                    <i class="fas fa-chevron-down section-toggle-icon"></i>
                                </div>
                            </div>
                            <div class="section-content">
                                <form data-section="step2">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                                        <div><label for="employerPhone" class="block text-sm font-medium text-slate-700 mb-1 required">شماره تماس</label><input type="tel" id="employerPhone" name="employerPhone" required disabled></div>
                                        <div><label for="employerPostalCode" class="block text-sm font-medium text-slate-700 mb-1 required">کدپستی</label><input type="text" id="employerPostalCode" name="employerPostalCode" required pattern="\d{10}" disabled></div>
                                        <div><label for="employerProvince" class="block text-sm font-medium text-slate-700 mb-1 required">استان سکونت</label><select id="employerProvince" name="employerProvince" required disabled></select></div>
                                        <div><label for="employerCity" class="block text-sm font-medium text-slate-700 mb-1">شهر سکونت</label><input type="text" id="employerCity" name="employerCity" disabled></div>
                                    </div>
                                    <div class="mt-8">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">آدرس</label>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                                            <textarea id="employerAddress" name="employerAddress" rows="4" class="min-h-[220px]" disabled></textarea>
                                            <div id="employerAddressMap" class="map-container min-h-[220px]" data-map-initialized="false"></div>
                                        </div>
                                        <input type="hidden" id="employerAddressLat" name="employerAddressLat"><input type="hidden" id="employerAddressLng" name="employerAddressLng">
                                    </div>
                                    <div class="section-footer hidden"><button type="button" class="btn btn-secondary cancel-btn">انصراف</button><button type="submit" class="btn btn-success save-btn">ذخیره تغییرات</button></div>
                                </form>
                            </div>
                        </div>

                        <!-- Section 3: Company Info -->
                        <div id="section-3" class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-building text-sky-500"></i>۳. اطلاعات شرکت</h3>
                                <div class="flex items-center gap-4">
                                    <span class="save-success-msg text-sm font-medium text-green-600 hidden"><i class="fas fa-check-circle"></i> ذخیره شد</span>
                                    <button class="btn btn-secondary !py-1 !px-3 text-sm edit-btn"><i class="fas fa-edit"></i> ویرایش</button>
                                    <i class="fas fa-chevron-down section-toggle-icon"></i>
                                </div>
                            </div>
                            <div class="section-content">
                                <form data-section="step3">
                                    <div class="flex items-center mb-4">
                                        <input type="checkbox" id="employerHasCompany" name="employerHasCompany" class="h-4 w-4 text-sky-600" disabled>
                                        <label for="employerHasCompany" class="ml-2 mr-2 block text-sm text-slate-700">شرکت دارم (شخص حقوقی هستم)</label>
                                    </div>
                                    <div id="employerCompanyFields" class="space-y-6">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                                            <div><label for="employerCompanyName" class="block text-sm font-medium text-slate-700 mb-1 required">نام شرکت</label><input type="text" id="employerCompanyName" name="employerCompanyName" disabled></div>
                                            <div><label for="employerCompanyRegNumber" class="block text-sm font-medium text-slate-700 mb-1 required">شماره ثبت</label><input type="text" id="employerCompanyRegNumber" name="employerCompanyRegNumber" disabled></div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-1">آدرس شرکت</label>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                                                <textarea id="employerCompanyAddress" name="employerCompanyAddress" rows="4" class="min-h-[220px]" disabled></textarea>
                                                <div id="employerCompanyMap" class="map-container min-h-[220px]" data-map-initialized="false"></div>
                                            </div>
                                            <input type="hidden" id="employerCompanyAddressLat" name="employerCompanyAddressLat"><input type="hidden" id="employerCompanyAddressLng" name="employerCompanyAddressLng">
                                        </div>
                                    </div>
                                    <div class="section-footer hidden"><button type="button" class="btn btn-secondary cancel-btn">انصراف</button><button type="submit" class="btn btn-success save-btn">ذخیره تغییرات</button></div>
                                </form>
                            </div>
                        </div>

                        <!-- Section 4: Documents -->
                        <div id="section-4" class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-id-badge text-sky-500"></i>۴. مدارک</h3>
                                <div class="flex items-center gap-4"><i class="fas fa-chevron-down section-toggle-icon"></i></div>
                            </div>
                            <div class="section-content">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6"> 
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">تصویر کارت ملی</label>
                                        <div id="employerNationalIdCardImagePreviewContainer" class="mt-2 file-preview-container"><span class="text-slate-500">بارگذاری نشده</span></div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">رزومه کاری (اختیاری)</label>
                                        <div id="employerOtherDocsPreviewContainer" class="mt-2 file-preview-container"><span class="text-slate-500">بارگذاری نشده</span></div>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 mt-4 text-center">برای تغییر مدارک، لطفاً با پشتیبانی تماس بگیرید.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="advertisementSidebar" class="hidden md:flex flex-col flex-shrink-0 w-64 lg:w-72 bg-slate-100 p-5"></div>
            </div>
            <div class="app-footer"><p>&copy; تمامی حقوق سایت نظام تندیس متعلق به شرکت شهرآوند است. - ۱۴۰۳</p></div>
        </div>

        <script>
        (async function() {
            // --- CONFIGURATION ---
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJJuU5p02dO4az5iWxcblihnwdwMMTlFvP5VJXqCNGmCVkhRL0BwGbvzPx11lsuEsC/exec';
            const PROVINCES = ["آذربایجان شرقی", "آذربایجان غربی", "اردبیل", "اصفهان", "البرز", "ایلام", "بوشهر", "تهران", "چهارمحال و بختیاری", "خراسان جنوبی", "خراسان رضوی", "خراسان شمالی", "خوزستان", "زنجان", "سمنان", "سیستان و بلوچستان", "فارس", "قزوین", "قم", "کردستان", "کرمان", "کرمانشاه", "کهگیلویه و بویراحمد", "گلستان", "گیلان", "لرستان", "مازندران", "مرکزی", "هرمزگان", "همدان", "یزد"];

            // --- STATE ---
            let userData = null;
            const authToken = sessionStorage.getItem('authToken');
            const maps = {};

            // --- DOM ELEMENTS ---
            const loadingScreen = document.getElementById('loadingScreen');
            const mainFormView = document.getElementById('mainFormView');
            const sidebarProfileName = document.getElementById('sidebarProfileName');
            const sidebarUserEmail = document.getElementById('sidebarUserEmail');
            const sidebarProfileImagePreview = document.getElementById('sidebarProfileImagePreview');
            const logoutButton = document.getElementById('logoutButton');

            // --- API HELPER ---
            async function fetchProtectedData(payload) {
                if (!authToken) {
                    window.location.href = 'index.html';
                    return Promise.reject('No token found');
                }
                payload.token = authToken;
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('Network response was not ok');
                    const result = await response.json();
                    if (result.reason === 'AUTH_FAILED') {
                        showMessage(result.message, 'error');
                        sessionStorage.removeItem('authToken');
                        setTimeout(() => window.location.href = 'index.html', 2500);
                        throw new Error('Authentication failed');
                    }
                    return result;
                } catch (error) {
                    console.error("Fetch error:", error);
                    showMessage('خطا در ارتباط با سرور. لطفاً صفحه را رفرش کنید.', 'error');
                    throw error;
                }
            }
            
            // --- UI FUNCTIONS ---
            function showMessage(message, type = 'info') {
                Toastify({
                    text: message, duration: 5000, close: true, gravity: "top", position: "center",
                    style: { fontFamily: "Vazirmatn, sans-serif", background: type === 'success' ? "#10b981" : '#f43f5e', borderRadius: "8px" }
                }).showToast();
            }

            function populateProfileData(data) {
                userData = JSON.parse(JSON.stringify(data)); // Deep copy to store original data
                
                const step1Data = data.stepsData?.step1 || {};
                sidebarProfileName.textContent = `${step1Data.employerFirstName || ''} ${step1Data.employerLastName || ''}`;
                sidebarUserEmail.textContent = data.email || '';
                if (data.files?.applicantImage?.fileUrl) {
                    sidebarProfileImagePreview.src = getDirectDriveLink(data.files.applicantImage.fileUrl);
                }

                Object.keys(data.stepsData || {}).forEach(sectionKey => {
                    const sectionData = data.stepsData[sectionKey] || {};
                    const form = document.querySelector(`form[data-section="${sectionKey}"]`);
                    if (form) {
                        for (const fieldName in sectionData) {
                            const field = form.elements[fieldName];
                            if (field) {
                                if (field.type === 'checkbox') {
                                    field.checked = sectionData[fieldName];
                                } else if (field.classList.contains('jalali-datepicker-value')) {
                                    const displayInput = field.previousElementSibling;
                                    if(sectionData[fieldName]) {
                                        field.value = sectionData[fieldName];
                                        try {
                                          $(displayInput).persianDatepicker('setDate', new persianDate(new Date(sectionData[fieldName])).valueOf());
                                        } catch(e){ console.error("Error setting date:", e); }
                                    }
                                } else {
                                    field.value = sectionData[fieldName];
                                }
                            }
                        }
                    }
                });

                const hasCompanyCheckbox = document.getElementById('employerHasCompany');
                const companyFieldsContainer = document.getElementById('employerCompanyFields');
                if(companyFieldsContainer && hasCompanyCheckbox){
                    companyFieldsContainer.style.display = hasCompanyCheckbox.checked ? 'block' : 'none';
                    if(hasCompanyCheckbox.checked){
                        document.getElementById('employerCompanyName').required = true;
                        document.getElementById('employerCompanyRegNumber').required = true;
                    }
                }

                populateFilePreview('employerNationalIdCardImagePreviewContainer', data.files?.employerNationalIdCardImage?.fileUrl);
                populateFilePreview('employerOtherDocsPreviewContainer', data.files?.employerOtherDocs?.fileUrl, 'pdf');
            }

            function populateFilePreview(containerId, url, type = 'image') {
                const container = document.getElementById(containerId);
                if (!container) return;
                if (url) {
                    const fileUrl = getDirectDriveLink(url, type);
                    container.innerHTML = type === 'pdf' ? `<iframe src="${fileUrl}" class="w-full h-full"></iframe>` : `<img src="${fileUrl}" alt="Preview" class="w-full h-full object-contain">`;
                } else {
                    container.innerHTML = '<span class="text-slate-500">بارگذاری نشده</span>';
                }
            }

            function getDirectDriveLink(url, type = 'image') {
                if (!url || typeof url !== 'string') return '';
                const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (!match) return url;
                return type === 'pdf' ? `https://drive.google.com/file/d/${match[1]}/preview` : `https://lh3.googleusercontent.com/d/${match[1]}`;
            }

            // --- EVENT HANDLERS ---
            function setupEventListeners() {
                document.querySelectorAll('.profile-section').forEach(section => {
                    const header = section.querySelector('.section-header');
                    const content = section.querySelector('.section-content');
                    const editBtn = section.querySelector('.edit-btn');
                    const saveBtn = section.querySelector('.save-btn');
                    const cancelBtn = section.querySelector('.cancel-btn');
                    const form = section.querySelector('form');
                    const fields = form ? Array.from(form.elements).filter(el => el.name) : [];

                    header.addEventListener('click', (e) => {
                        if (e.target.closest('button')) return;
                        const isOpen = content.style.display === 'block';
                        content.style.display = isOpen ? 'none' : 'block';
                        header.classList.toggle('open', !isOpen);
                        
                        if (!isOpen) { 
                            const mapContainer = content.querySelector('.map-container');
                            if (mapContainer && mapContainer.dataset.mapInitialized !== 'true') {
                                const mapId = mapContainer.id;
                                let lat, lng;
                                const isEditing = !editBtn.classList.contains('hidden');
                                if (mapId === 'employerAddressMap') {
                                    lat = userData.stepsData.step2.employerAddressLat;
                                    lng = userData.stepsData.step2.employerAddressLng;
                                } else if (mapId === 'employerCompanyMap') {
                                    lat = userData.stepsData.step3.employerCompanyAddressLat;
                                    lng = userData.stepsData.step3.employerCompanyAddressLng;
                                }
                                initMap(mapId, lat, lng, isEditing);
                                mapContainer.dataset.mapInitialized = 'true';
                            } else if (mapContainer && maps[mapContainer.id]) {
                                setTimeout(() => maps[mapContainer.id].invalidateSize(), 10);
                            }
                        }
                    });

                    if (editBtn) {
                        editBtn.addEventListener('click', () => {
                            fields.forEach(field => field.disabled = false);
                            section.querySelector('.section-footer').classList.remove('hidden');
                            editBtn.classList.add('hidden');
                            const mapContainer = content.querySelector('.map-container');
                            if(mapContainer && maps[mapContainer.id]){
                                maps[mapContainer.id].eachLayer(layer => {
                                    if(layer instanceof L.Marker) layer.dragging.enable();
                                });
                            }
                        });
                    }
                    
                    if (cancelBtn) {
                        cancelBtn.addEventListener('click', () => {
                            populateProfileData(userData);
                            fields.forEach(field => field.disabled = true);
                            section.querySelector('.section-footer').classList.add('hidden');
                            editBtn.classList.remove('hidden');
                        });
                    }

                    if (form) {
                        form.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const sectionKey = form.dataset.section;
                            const formData = new FormData(form);
                            const sectionData = Object.fromEntries(formData.entries());
                            
                            if (sectionKey === 'step3' && !sectionData.employerHasCompany) {
                                sectionData.employerHasCompany = false;
                            }

                            saveBtn.innerHTML = '<div class="spinner !w-5 !h-5 !border-2"></div>';
                            saveBtn.disabled = true;

                            try {
                                const result = await fetchProtectedData({ action: 'updateProfileSection', sectionKey, sectionData });
                                if (result.success) {
                                    userData.stepsData[sectionKey] = sectionData;
                                    fields.forEach(field => field.disabled = true);
                                    const successMsg = section.querySelector('.save-success-msg');
                                    successMsg.classList.remove('hidden');
                                    setTimeout(() => successMsg.classList.add('hidden'), 3000);
                                    section.querySelector('.section-footer').classList.add('hidden');
                                    editBtn.classList.remove('hidden');
                                    showMessage('اطلاعات با موفقیت ذخیره شد.', 'success');
                                } else {
                                    showMessage('خطا در ذخیره اطلاعات: ' + result.message, 'error');
                                }
                            } catch (error) {
                                console.error('Save failed:', error);
                            } finally {
                                saveBtn.innerHTML = 'ذخیره تغییرات';
                                saveBtn.disabled = false;
                            }
                        });
                    }
                });

                document.getElementById('employerHasCompany').addEventListener('change', function() {
                    const companyFields = document.getElementById('employerCompanyFields');
                    const isChecked = this.checked;
                    companyFields.style.display = isChecked ? 'block' : 'none';
                    document.getElementById('employerCompanyName').required = isChecked;
                    document.getElementById('employerCompanyRegNumber').required = isChecked;
                });

                logoutButton.addEventListener('click', () => {
                    sessionStorage.removeItem('authToken');
                    window.location.href = 'index.html';
                });
            }

            // --- INITIALIZATION ---
            async function initializePage() {
                if (!authToken) { window.location.href = 'index.html'; return; }

                try {
                    const result = await fetchProtectedData({ action: 'getUserProfile' });
                    if (!result.success || result.data.role !== 'employer') {
                        showMessage('شما اجازه دسترسی به این صفحه را ندارید.', 'error');
                        sessionStorage.removeItem('authToken');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    const provinceSelect = document.getElementById('employerProvince');
                    provinceSelect.innerHTML = '<option value="">انتخاب استان</option>' + PROVINCES.map(p => `<option value="${p}">${p}</option>`).join('');
                    
                    $(".jalali-datepicker-display").persianDatepicker({
                        format: 'YYYY/MM/DD', altField: '.jalali-datepicker-value', altFormat: 'YYYY-MM-DD',
                        observer: true, autoClose: true
                    });

                    populateProfileData(result.data);
                    setupEventListeners();
                    
                    loadingScreen.style.display = 'none';
                    mainFormView.classList.remove('hidden');
                    mainFormView.style.display = 'flex';

                } catch (error) {
                    console.error("Initialization failed:", error);
                    loadingScreen.innerHTML = `<p class="text-red-600 font-bold p-4">امکان بارگذاری اطلاعات وجود ندارد. لطفاً دوباره وارد شوید.</p>`;
                }
            }

            function initMap(mapId, lat, lng, isEditable) {
                const mapContainer = document.getElementById(mapId);
                if (!mapContainer) return;
                
                const initialLat = parseFloat(lat) || 38.08;
                const initialLng = parseFloat(lng) || 46.29;

                if (maps[mapId]) maps[mapId].remove();
                
                const map = L.map(mapId).setView([initialLat, initialLng], 13);
                maps[mapId] = map;
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                
                let marker = L.marker([initialLat, initialLng], { draggable: isEditable }).addTo(map);

                if (isEditable) {
                    const latInput = document.getElementById(mapId.replace('Map', 'Lat'));
                    const lngInput = document.getElementById(mapId.replace('Map', 'Lng'));
                    
                    const updateInputs = (latlng) => {
                        if(latInput) latInput.value = latlng.lat.toFixed(6);
                        if(lngInput) lngInput.value = latlng.lng.toFixed(6);
                    };

                    marker.on('dragend', () => updateInputs(marker.getLatLng()));
                    map.on('click', (e) => {
                        marker.setLatLng(e.latlng);
                        updateInputs(e.latlng);
                    });
                }
            }

            initializePage();
        })();
        </script>
    </body>
</html>
